<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TARI - Premium Food Truck</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link    href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Righteous&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
    
    <style>
        
        /* =========================================
   PREMIUM PRELOADER (FINAL FIX)
   ========================================= */

#preloader { 
    position: fixed; 
    inset: 0; 
    background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%); 
    z-index: 9999; 
    display: flex; 
    flex-direction: column; 
    justify-content: center; 
    align-items: center; 
    
    /* 1. FORCE STARTING POSITION */
    transform: translateY(0);
    opacity: 1;

    /* 2. FORCE TRANSITION (Use 'all' to be safe) */
    transition: all 0.8s cubic-bezier(0.65, 0, 0.35, 1) !important;
    
    box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
    will-change: transform;
    pointer-events: all;
}

#preloader.loaded { 
    /* 3. SLIDE UP OFF SCREEN */
    transform: translateY(-100%) !important; 
    
    /* 4. PREVENT FADING (Keep it visible while it slides) */
    opacity: 1 !important; 
    pointer-events: none; 
}

/* --- Burger Animation Styles (Keep these the same) --- */
.burger-loader {
    width: 100px;
    height: 100px;
    position: relative;
    margin-bottom: 2rem;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    align-items: center;
}

.b-layer {
    width: 60%;
    height: 12px;
    border-radius: 10px;
    margin-bottom: -4px; 
    opacity: 0;
    animation: stackLayer 1.6s infinite ease-in-out;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
}

.b-bun-bottom { width: 70%; background: #F59E0B; height: 14px; border-radius: 4px 4px 12px 12px; animation-delay: 0s; }
.b-meat { width: 80%; background: #78350F; height: 14px; animation-delay: 0.15s; }
.b-cheese { width: 85%; height: 6px; background: #FCD34D; border-radius: 4px; margin-bottom: -2px; z-index: 2; animation-delay: 0.3s; }
.b-lettuce { width: 85%; height: 8px; background: #22c55e; border-radius: 8px; animation-delay: 0.45s; }
.b-bun-top { width: 75%; height: 24px; background: #F59E0B; border-radius: 20px 20px 4px 4px; position: relative; animation-delay: 0.6s; margin-bottom: -2px; }
.b-bun-top::after { content: '... : .'; position: absolute; top: 2px; left: 50%; transform: translateX(-50%); color: #fce7cf; font-size: 10px; font-weight: bold; letter-spacing: 2px; }

.loader-brand {
    font-family: 'Righteous', cursive;
    font-size: 3rem;
    color: white;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    text-shadow: 0 10px 30px rgba(0,0,0,0.5);
    animation: fadeInBrand 1.6s infinite alternate;
    margin: 0;
    line-height: 1;
    text-align: center;
}

.loader-caption {
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 0.75rem;
    color: #94a3b8; 
    font-weight: 700;
    letter-spacing: 0.3em;
    margin-top: 15px;
    text-transform: uppercase;
    text-align: center;
}

@keyframes stackLayer {
    0% { opacity: 0; transform: translateY(-40px) scale(0.8); }
    20% { opacity: 1; transform: translateY(0) scale(1.1); }
    40% { transform: scale(1); }
    90% { opacity: 1; transform: scale(1); }
    100% { opacity: 0; transform: translateY(10px); }
}

@keyframes fadeInBrand {
    0% { opacity: 0.5; transform: scale(0.98); }
    100% { opacity: 1; transform: scale(1); }
}

        

        /* PREMIUM DIRECTIONAL ANIMATIONS */

/* Slide from Right (Next) + Fade In */
@keyframes slideInRight {
    0% { 
        opacity: 0; 
        transform: translateX(30px); /* Starts 30px to the right */
    }
    100% { 
        opacity: 1; 
        transform: translateX(0);    /* Lands in center */
    }
}

/* Slide from Left (Prev) + Fade In */
@keyframes slideInLeft {
    0% { 
        opacity: 0; 
        transform: translateX(-30px); /* Starts 30px to the left */
    }
    100% { 
        opacity: 1; 
        transform: translateX(0);     /* Lands in center */
    }
}

/* Classes to trigger the animations */
.anim-next { 
    animation: slideInRight 1.0s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; 
}

.anim-prev { 
    animation: slideInLeft 1.0s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; 
}

        
        /* THE GHOST HEADER STRUCTURE */
.header-ghost-container {
    background: transparent !important; /* The container itself is invisible */
    overflow: visible !important;       /* Let the ghost layer hang down */
    position: relative;
    z-index: 40;
}

/* This creates the actual colored background + fade in one piece */
.header-ghost-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 140%; /* 100% covers the header, 40% hangs down as fade */
    
    /* The Magic Gradient: Solid color for top 70%, then fades to transparent */
    background: linear-gradient(
        to bottom, 
        var(--header-bg, #0f172a) 0%, 
        var(--header-bg, #0f172a) 75%, 
        transparent 100%
    );
    
    z-index: -1; /* Puts it behind the text/logo */
    pointer-events: none;
}


        /* ROBOTIC FONT (Updated: Cyan Color & No Shadow) */
.font-robotic {
    font-family: 'Righteous', cursive;
    color: #1EBBCF !important;       /* üëà The new color from your image */
    text-transform: uppercase;
    letter-spacing: 0.15em;
    line-height: 1;
    text-shadow: none !important;    /* üëà Removes the 3D shadow effect */
}


        
        /* SPLASH SCREEN ANIMATIONS */
.fade-in { 
    animation: fadeIn 0.4s ease-out forwards; 
}

@keyframes fadeIn { 
    from { opacity: 0; transform: scale(0.95); } 
    to { opacity: 1; transform: scale(1); } 
}

.fade-out { 
    animation: fadeOut 0.5s ease-out forwards; 
}

@keyframes fadeOut { 
    from { opacity: 1; transform: scale(1); } 
    to { opacity: 0; transform: scale(1.1); } 
}
/* ADD THIS TO YOUR CSS */
.splash-gone {
    display: none !important;
}



        /* GOLD BADGE SHINE ANIMATION */
.badge-shine-gold {
    /* REMOVED 'position: relative' to fix the conflict */
    background: linear-gradient(135deg, #FCD34D 0%, #F59E0B 100%); 
    color: #451a03; 
    overflow: hidden; /* Keeps the shine inside the box */
    box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    z-index: 20; /* Force it to stay on top */
}

/* The moving shine effect */
.badge-shine-gold::after {
    content: '';
    position: absolute;
    top: 0;
    left: -150%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent);
    transform: skewX(-20deg);
    animation: shineBadge 2.5s infinite ease-in-out;
}

@keyframes shineBadge {
    0% { left: -150%; }
    20% { left: 150%; }
    100% { left: 150%; } 
}

        
        #hero-slider-container {
    contain: paint;
    isolation: isolate;
    will-change: opacity;
}
        .modal-shell.active {
    pointer-events: auto;
}
.modal-shell {
    pointer-events: none;
}
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #F8FAFC; -webkit-tap-highlight-color: transparent; overflow-x: hidden; overscroll-behavior-y: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* THEME VARIABLES */
        :root { --primary: #FF5722; }
        .bg-brand { background-color: var(--primary) !important; }
        .text-brand { color: var(--primary) !important; }
        .border-brand { border-color: var(--primary) !important; }
        .nav-item.active { color: var(--primary); }
        .cat-btn.active { background-color: var(--primary) !important; color: white !important; border-color: var(--primary) !important; }

        /* ANIMATIONS */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .slide-up-enter { animation: slideUpEnter 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUpEnter { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        /* Force Green Button */
        .bg-green-force { background-color: #22c55e !important; color: white !important; border-color: #22c55e !important; }

        /* HERO SLIDER ‚Äì GPU STABLE VERSION */
.hero-slide {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;

    /* GPU stabilization */
    transform: translateZ(0) scale(1.05);
    opacity: 0;
    transition: opacity 0.8s ease-out, transform 0.8s ease-out;
    backface-visibility: hidden;
}

.hero-slide.active-slide {
    opacity: 1;
    transform: translateZ(0) scale(1);
}

        /* TOAST */
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #1E293B; color: white; padding: 12px 24px; border-radius: 50px; display: flex; align-items: center; gap: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 1000; opacity: 0; width: max-content; max-width: 90%; }
        #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        #toast i.error-icon { color: #F87171; }

        /* TRACKER STRIPE & SHINY DOT */
        .step-container { display: flex; align-items: center; justify-content: space-between; position: relative; margin-bottom: 24px; }
        .step-circle { width: 32px; height: 32px; border-radius: 50%; background: #F1F5F9; color: #94A3B8; font-weight: 800; font-size: 12px; display: flex; align-items: center; justify-content: center; z-index: 2; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: all 0.3s; }
        .step-circle.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(255, 87, 34, 0.3); transform: scale(1.1); }
        .step-line-container { position: absolute; top: 50%; left: 0; width: 100%; height: 4px; background: #E2E8F0; z-index: 1; transform: translateY(-50%); border-radius: 10px; overflow: hidden; }
        .step-line-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s ease-in-out; position: relative; }
        .step-line-fill::after { content: ''; position: absolute; top: 0; right: 0; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent); transform: translateX(-100%); animation: shinyDot 2s infinite ease-in-out; }
        @keyframes shinyDot { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        /* FLOATING ICONS */
        .floating-icon { position: absolute; font-size: 3.5rem; opacity: 0.8; z-index: 5; animation: floatHover 6s ease-in-out infinite; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }
        @keyframes floatHover { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-20px) rotate(10deg); } }

        /* CROPPER */
        #crop-modal { opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        #crop-modal.active { opacity: 1; pointer-events: auto; }
        
        /* SHIMMER BADGE */
        .shimmer { position: relative; overflow: hidden; }
        .shimmer::after { content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%; background: linear-gradient(to right, transparent 0%, rgba(255,255,255,0.4) 50%, transparent 100%); animation: shimmer 2s infinite; transform: skewX(-20deg); }
        @keyframes shimmer { 100% { left: 200%; } }

        /* SOLD OUT STATE */
        .sold-out-card { opacity: 0.6; filter: grayscale(100%); pointer-events: none; position: relative; }
        .sold-out-card::after { content: 'SOLD OUT'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-10deg); background: rgba(0,0,0,0.7); color: white; padding: 5px 15px; font-weight: 800; font-size: 12px; border-radius: 5px; z-index: 10; border: 2px solid white; white-space: nowrap; }

        /* SWIPE HANDLER */
        .drag-handle { width: 40px; height: 5px; background: #E2E8F0; border-radius: 10px; margin: 12px auto; }
        .modal-sheet { transition: transform 0.1s linear; will-change: transform; }
        .modal-sheet.snapping { transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }

        /* PRELOADER */
        #preloader { position: fixed; inset: 0; background: #F8FAFC; z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s; pointer-events: none; }      
       #preloader.loaded { opacity: 0; }
               /* PREMIUM GOLD ANIMATION */
        .text-gold-shine {
            background: linear-gradient(to right, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            background-size: 200% auto;
            animation: shineGold 3s linear infinite;
        }
        @keyframes shineGold {
            to { background-position: 200% center; }
        }
          
    </style>
</head>
<body class="text-slate-800 select-none">
     
    <div id="preloader">
    <div class="burger-loader">
        <div class="b-layer b-bun-top"></div>
        <div class="b-layer b-lettuce"></div>
        <div class="b-layer b-cheese"></div>
        <div class="b-layer b-meat"></div>
        <div class="b-layer b-bun-bottom"></div>
    </div>

    <h1 class="loader-brand">TARI</h1>
    
    <p class="loader-caption">Premium Quality</p>
</div>
<script>
    // Failsafe: Forces the exciting loader to open if data takes too long
    setTimeout(() => {
        const p = document.getElementById('preloader');
        if(p && !p.classList.contains('loaded')) {
            p.classList.add('loaded');
        }
    }, 7000); // 7 Seconds max wait
</script>

</div>

    <div id="toast"><i id="toast-icon" class="fa-solid fa-circle-check text-green-400 text-lg"></i><span id="toast-msg" class="font-bold text-sm">Notification</span></div>

    <div id="crop-modal" class="fixed inset-0 z-[200] bg-slate-900/95 backdrop-blur-sm flex flex-col items-center justify-center p-6">
        <div class="bg-white rounded-3xl w-full max-w-sm flex flex-col overflow-hidden shadow-2xl">
            <div class="p-4 border-b flex justify-between items-center bg-white z-10"><h3 class="font-bold text-lg">Adjust Profile Pic</h3><button onclick="closeCropper()" class="text-slate-400"><i class="fa-solid fa-xmark text-xl"></i></button></div>
            <div class="h-64 bg-slate-900 relative"><img id="crop-target" class="max-w-full max-h-full block"></div>
            <div class="p-4 border-t bg-white flex justify-end gap-3"><button onclick="finishCrop()" class="w-full bg-brand text-white py-3 rounded-xl font-bold shadow-lg">Save Picture</button></div>
        </div>
    </div>

    <div id="splash-screen" class="fixed inset-0 bg-slate-900 flex flex-col items-center justify-between pt-16 pb-10 px-6 z-[300] overflow-hidden transition-transform duration-700">        
        <div class="floating-icon" style="top: 20%; left: 10%; animation-delay: 0s;">üçî</div>
        <div class="floating-icon" style="top: 38%; right: 10%; animation-delay: 1.5s;">üçü</div>
        <div class="floating-icon" style="bottom: 20%; left: 15%; animation-delay: 0.5s;">ü•§</div>
        <div class="floating-icon" style="top: 50%; right: 20%; animation-delay: 2s;"></div>
        <div class="floating-icon" style="bottom: 15%; right: 5%; animation-delay: 1s;">ü•¨</div>
        <div class="floating-icon" style="top: 10%; left: 70%; animation-delay: 2.5s; font-size: 2.5rem;">ü•©</div>
        <img id="splash-bg-img" class="absolute inset-0 w-full h-full object-cover opacity-30 hidden z-0">
        <div class="absolute inset-0 bg-gradient-to-b from-transparent via-slate-900/60 to-slate-900 pointer-events-none z-0"></div>
        <div class="text-center z-10 flex flex-col items-center relative mt-10">
            <div class="text-center z-10 flex flex-col items-center relative mt-4"><div class="relative w-32 h-32 z-10 mb-4 rounded-3xl overflow-hidden animate-[fadeIn_0.5s] -mt-12 bg-transparent">
        <img id="splash-circle-img" src="https://images.unsplash.com/photo-1568901346375-23c9450c58cd" class="w-full h-full object-contain">
    </div>

    <h1 id="splash-title-text" class="text-5xl font-bold text-white mb-2 leading-tight tracking-tighter drop-shadow-lg whitespace-pre-line">TARI</h1>
    <p id="splash-intro" class="text-slate-300 text-sm font-medium max-w-[250px] leading-relaxed">ÿ®ÿ±ÿ¨ÿ± Ÿàÿ®ÿ∑ÿßÿ∑ÿ≥ ŸÑÿ∞Ÿäÿ∞ÿ© ŸÖÿ≠ÿ∂ÿ±ÿ© ÿ®ÿ¥ÿ∫ŸÅ Ÿàÿ™ŸÇÿØŸÖ ÿ∑ÿßÿ≤ÿ¨ÿ© ŸäŸàŸÖŸäÿßŸã.</p>
</div>
</div>

        <button onclick="hideSplash()" class="w-full bg-orange-500 text-white font-bold py-4 rounded-2xl shadow-xl shadow-orange-500/20 active:scale-95 transition text-lg z-10 animate-pulse btn-brand flex items-center justify-center gap-2">Order Now <i class="fa-solid fa-arrow-up"></i></button>
    </div>

    <div id="view-auth" class="hidden fixed inset-0 z-[200] bg-white flex flex-col items-center justify-center p-8 auth-hidden shadow-2xl transition-transform duration-300 transform translate-y-full">

        <button onclick="closeAuth()" class="absolute top-6 right-6 text-slate-400 p-2 hover:text-slate-800"><i class="fa-solid fa-xmark text-2xl"></i></button>
        <div class="w-20 h-20 bg-orange-500 rounded-2xl flex items-center justify-center mb-6 shadow-xl shadow-orange-200 btn-brand"><i class="fa-solid fa-lock text-4xl text-white"></i></div>
        <h1 class="text-3xl font-bold mb-2">Login Required</h1>
        <p class="text-slate-400 mb-8 text-center">Sign in to earn loyalty points<br>and track your food.</p>
        <div class="w-full max-w-sm space-y-4" id="auth-forms">
            <div id="login-form" class="space-y-4 fade-in">
                <input type="email" id="login-email" placeholder="Email Address" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none font-medium focus:border-orange-500">
                <input type="password" id="login-pass" placeholder="Password" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none font-medium focus:border-orange-500">
                <button onclick="handleLogin(this)" class="w-full bg-slate-900 text-white p-4 rounded-xl font-bold text-lg shadow-lg">Log In</button>
                <p class="text-center text-slate-500 text-sm mt-4">New here? <button onclick="toggleAuthMode()" class="text-orange-600 font-bold text-brand">Create Account</button></p>
            </div>
            <div id="signup-form" class="space-y-4 hidden fade-in">
                <input type="text" id="reg-name" placeholder="Full Name" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none font-medium focus:border-orange-500">
                <input type="email" id="reg-email" placeholder="Email Address" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none font-medium focus:border-orange-500">
                <div class="space-y-1">
    <div class="flex items-center border border-slate-200 rounded-xl overflow-hidden focus-within:border-orange-500 focus-within:ring-1 focus-within:ring-orange-200 transition-all bg-slate-50">
        <div class="bg-slate-200 px-4 py-4 border-r border-slate-300 text-slate-600 font-bold select-none">
            +966
        </div>
        <input type="tel" id="reg-phone" 
            class="w-full p-4 bg-transparent outline-none font-bold text-slate-800 placeholder:font-medium placeholder:text-slate-400" 
            placeholder="5√ó√ó√ó√ó√ó√ó√ó√ó" 
            maxlength="9">
    </div>
    <p id="phone-error-msg" class="text-xs text-red-500 font-bold hidden pl-1">
        <i class="fa-solid fa-circle-exclamation mr-1"></i> Phone number is not correct (must be 9 digits)
    </p>
</div>

                <input type="password" id="reg-pass" placeholder="Create Password" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none font-medium focus:border-orange-500">
                <button onclick="handleSignup(this)" class="w-full bg-orange-500 text-white p-4 rounded-xl font-bold text-lg shadow-lg btn-brand">Sign Up</button>
                <p class="text-center text-slate-500 text-sm mt-4">Have an account? <button onclick="toggleAuthMode()" class="text-slate-900 font-bold">Log In</button></p>
            </div>
        </div>
    </div>
                            <div id="app-header" class="header-ghost-container fixed top-0 w-full px-6 py-2 flex justify-between items-center h-18 transition-all z-40">
    
    <div class="flex flex-col justify-center items-start z-10">
        <h1 class="text-2xl tracking-wide text-white leading-none mb-0.5" style="font-family: 'Righteous', cursive;">
            TARI<span class="text-orange-500">.</span>
        </h1>
        <span class="font-robotic text-[8px]">
    Premium Food Truck
</span>

    </div>

    <div class="flex items-center justify-end z-10">
        <img id="header-truck-logo" class="h-10 w-auto object-contain drop-shadow-lg hidden transition-all duration-500"> 
    </div>

</div>


       
        <div id="view-home" class="pt-24 px-4 pb-24 fade-in">


            <div class="bg-slate-900 rounded-3xl p-6 text-white mb-6 relative overflow-hidden h-64 flex flex-col justify-center transform-gpu [mask-image:linear-gradient(white,white)]">

                <div id="hero-slider-container" class="absolute inset-0 z-0"></div>
                <div class="absolute inset-0 bg-gradient-to-r from-black/80 to-transparent z-0"></div>
                <div class="relative z-10">
                    <span class="bg-orange-500 text-white text-xs font-bold px-2 py-1 rounded-md mb-2 inline-block btn-brand">WELCOME</span>
                    <h2 id="hero-title-text" class="text-2xl font-bold mb-1">Hungry?</h2>
                    <p id="hero-subtitle-text" class="text-slate-200 text-sm mb-4 max-w-[200px]">Order premium burgers now.</p>
                </div>
            </div>

            <div id="best-seller-section" class="hidden mb-8">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2 text-slate-800"><i class="fa-solid fa-fire text-orange-500 text-brand"></i> Popular Now</h3>
                <div id="best-seller-list" class="flex gap-4 overflow-x-auto no-scrollbar pb-2"></div>
            </div>

            <div id="category-list" class="flex gap-3 overflow-x-auto no-scrollbar mb-6 pb-2">
    </div>

            
            
            <div id="menu-list" class="space-y-4 mb-10">
                <div class="text-center py-10 text-slate-400 animate-pulse"><i class="fa-solid fa-circle-notch fa-spin text-3xl text-orange-500 mb-3 text-brand"></i><p>Loading tasty food...</p></div>
            </div>
            
            <div class="bg-slate-900 rounded-3xl p-8 text-white relative overflow-hidden" id="info-section">
                <h3 class="text-2xl font-bold mb-6 relative z-10">Visit Us</h3>
                <div class="space-y-6 relative z-10">
                    <div class="flex gap-4"><div class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center flex-shrink-0 text-orange-500 text-brand"><i class="fa-solid fa-location-dot"></i></div><div><p class="text-xs text-slate-400 uppercase font-bold tracking-wider mb-1">Location</p><p class="font-medium text-sm leading-relaxed" id="info-location">Loading...</p></div></div>
                    <div class="flex gap-4"><div class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center flex-shrink-0 text-orange-500 text-brand"><i class="fa-solid fa-clock"></i></div><div><p class="text-xs text-slate-400 uppercase font-bold tracking-wider mb-1">Working Hours</p><div class="font-medium text-sm" id="info-hours">Loading...</div></div></div>
                    <div class="flex gap-4"><div class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center flex-shrink-0 text-orange-500 text-brand"><i class="fa-solid fa-phone"></i></div><div><p class="text-xs text-slate-400 uppercase font-bold tracking-wider mb-1">Contact</p><p class="font-medium text-sm" id="info-phone">Loading...</p></div></div>
                  
               </div>
            </div>
         
                             <div class="mt-12 pt-10 pb-0 text-center select-none">

                <div class="w-8 h-0.5 bg-slate-300 mx-auto rounded-full mb-4"></div>
                <p class="text-[8px] md:text-[10px] text-slate-900 font-black uppercase tracking-[0.3em] mb-1">
                    Powered by Tari Digital
                </p>
                <p class="text-[8px] md:text-[10px] text-slate-500 font-bold tracking-widest">
                    Ver 2.0 ‚Ä¢ ¬© <span id="footer-year">2025</span>
                </p>
            </div>    
          </div>                                                    
        <div id="view-track" class="pt-24 px-6 pb-24 hidden fade-in h-screen bg-white overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Order Status</h2>
                <div class="bg-red-500 text-white text-[10px] font-bold px-2 py-1 rounded-full animate-pulse flex items-center gap-1 shadow-lg shadow-red-500/30"><div class="w-2 h-2 bg-white rounded-full"></div> LIVE</div>
            </div>
            <div id="active-tracker-container" class="space-y-6 pb-20"><div class="text-center py-20 text-slate-400"><i class="fa-solid fa-receipt text-4xl mb-4"></i><p>No active orders.</p></div></div>
        </div>

        <div id="view-profile" class="pt-24 px-6 pb-24 hidden fade-in">
            <div class="flex flex-col items-center mb-8">
                <div class="relative w-32 h-32 mb-4">
                    <img id="profile-avatar" src="https://ui-avatars.com/api/?name=User&background=FF5722&color=fff" class="w-full h-full rounded-full object-cover border-4 border-white shadow-xl bg-slate-100">
                </div>
                <div class="flex items-center gap-3">
                    <label for="upload-input" class="bg-slate-900 text-white px-4 py-2 rounded-full text-xs font-bold cursor-pointer shadow hover:bg-slate-800 transition flex items-center gap-2"><i class="fa-solid fa-camera"></i> Change Photo</label>
                    <button onclick="removeAvatar()" class="bg-red-50 text-red-500 border border-red-100 px-4 py-2 rounded-full text-xs font-bold shadow-sm hover:bg-red-100 transition flex items-center gap-2"><i class="fa-solid fa-trash"></i> Remove</button>
                    <input type="file" id="upload-input" class="hidden" accept="image/*" onchange="startCrop(this)">
                </div>
                <h2 id="profile-name" class="text-2xl font-black text-slate-900 mt-4">User</h2>
            </div>
            
            <div class="bg-gradient-to-r from-orange-500 to-red-500 rounded-3xl p-6 text-white shadow-xl shadow-orange-500/20 mb-8 relative overflow-hidden bg-brand-gradient">
                <div class="absolute -right-6 -top-6 text-white/10 text-9xl"><i class="fa-solid fa-crown"></i></div>
                <div class="relative z-10">
                    <div class="flex justify-between items-start mb-4"><div class="bg-white/20 backdrop-blur-sm px-3 py-1 rounded-lg border border-white/30 text-xs font-bold">GOLD MEMBER</div></div>
                    <p class="text-sm font-medium text-orange-100">Loyalty Points</p>
                    <h3 class="text-5xl font-black mt-1" id="loyalty-points">0</h3>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm text-center">
                    <div class="w-8 h-8 mx-auto bg-blue-50 text-blue-500 rounded-full flex items-center justify-center mb-2"><i class="fa-solid fa-calendar"></i></div>
                    <p class="text-xs text-slate-400 font-bold uppercase">Joined</p>
                    <p class="font-bold text-slate-800" id="profile-joined">--</p>
                </div>
                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm text-center">
                    <div class="w-8 h-8 mx-auto bg-purple-50 text-purple-500 rounded-full flex items-center justify-center mb-2"><i class="fa-solid fa-receipt"></i></div>
                    <p class="text-xs text-slate-400 font-bold uppercase">Total Orders</p>
                    <p class="font-bold text-slate-800" id="profile-total-orders">0</p>
                </div>
            </div>

            <div class="bg-white rounded-3xl border border-slate-100 p-5 shadow-sm mb-8 space-y-5">
                <h3 class="font-bold text-lg">Personal Info</h3>
                <div><label class="text-xs font-bold text-slate-400 uppercase ml-1">Email Address</label><div class="flex items-center gap-3 bg-slate-50 p-3 rounded-xl mt-1 border border-slate-100"><i class="fa-solid fa-envelope text-slate-400"></i><span id="profile-email" class="font-bold text-slate-700 text-sm flex-1 truncate">--</span><i class="fa-solid fa-lock text-slate-300 text-xs"></i></div></div>
                <div><label class="text-xs font-bold text-slate-400 uppercase ml-1">Phone Number</label><div class="flex gap-2 mt-1"><div class="flex-1 flex items-center gap-3 bg-slate-50 p-3 rounded-xl border border-slate-100 transition-colors" id="phone-container"><i class="fa-solid fa-phone text-slate-400"></i><input id="profile-phone-input" type="tel" readonly class="bg-transparent font-bold text-slate-700 text-sm w-full outline-none disabled:text-slate-500" placeholder="No phone added"><i id="phone-lock" class="fa-solid fa-lock text-slate-300 text-xs"></i></div></div></div>
            </div>

            <div class="mb-8"><h3 class="font-bold text-lg mb-4 px-1">Order History</h3><div id="order-history" class="space-y-4"></div></div>
            
           
            <button onclick="handleLogout()" class="w-full text-red-500 font-bold bg-red-50 border border-red-100 px-6 py-4 rounded-2xl mb-6 active:scale-95 transition"><i class="fa-solid fa-right-from-bracket mr-2"></i> Log Out</button>
        </div>

        <div class="fixed bottom-0 w-full bg-white border-t border-slate-100 pb-safe z-50 flex justify-around items-center h-20 shadow-[0_-5px_20px_rgba(0,0,0,0.03)]">
            <button onclick="switchView('home')" class="nav-item active flex flex-col items-center gap-1 text-slate-400 w-16"><i class="fa-solid fa-house text-xl"></i><span class="text-[10px] font-bold">Home</span></button>
            <button onclick="switchView('track')" class="nav-item flex flex-col items-center gap-1 text-slate-400 w-16 relative"><i class="fa-solid fa-list-check text-xl"></i><span class="text-[10px] font-bold">Orders</span><div id="track-badge" class="absolute top-0 right-3 w-2.5 h-2.5 bg-orange-500 rounded-full border-2 border-white hidden bg-brand"></div></button>
            <button onclick="switchView('profile')" class="nav-item flex flex-col items-center gap-1 text-slate-400 w-16"><i class="fa-solid fa-user text-xl"></i><span class="text-[10px] font-bold">Profile</span></button>
        </div>
           <div id="fab-container" class="fixed bottom-24 left-6 right-6 z-40 transform translate-y-32 transition duration-300">
            <button onclick="openCart()" id="fab-btn" class="w-full bg-slate-900 text-white p-4 rounded-2xl shadow-xl flex justify-between items-center"><div class="flex items-center gap-3"><div class="bg-orange-500 w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold btn-brand" id="cart-count">0</div><span class="font-bold">View Basket</span></div><span class="font-bold text-lg" id="cart-total">SR 0.00</span></button>
        </div>
    </div>
    <div id="productModal"
     class="fixed inset-0 z-[100] hidden modal-shell">
        <div class="absolute inset-0 bg-transparent opacity-0 transition-opacity duration-300" id="productBackdrop" onclick="closeModal()"></div>
        
        <div id="productCard" onclick="event.stopPropagation()" class="absolute bottom-0 w-full sm:max-w-md left-0 right-0 mx-auto bg-white h-[90vh] rounded-t-3xl shadow-2xl transform translate-y-full transition-transform duration-300 ease-out flex flex-col overflow-hidden">
            <div id="productDrag" class="absolute top-0 left-0 right-0 h-10 z-50 flex items-center justify-center bg-white/50 backdrop-blur-sm" onclick="closeModal()"><div class="w-12 h-1.5 bg-slate-300 rounded-full"></div></div>
            
            <div class="relative h-72 bg-slate-200 shrink-0">
                <img id="modal-img" class="w-full h-full object-cover">
                <button onclick="closeModal()" class="absolute top-4 right-4 bg-white/80 p-2 rounded-full shadow text-slate-900 hover:bg-white transition z-50"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>

            <div class="p-6 flex-1 overflow-y-auto bg-white -mt-6 rounded-t-3xl relative z-10" id="productContent">
                <div class="flex justify-between items-start mb-2"><h2 id="modal-title" class="text-2xl font-black text-slate-800"></h2><span id="modal-price" class="text-2xl font-black text-orange-500"></span></div>
                <p id="modal-desc" class="text-slate-500 text-sm mb-6"></p>
                
                <div class="flex justify-between items-center mb-6 pb-6 border-b border-slate-50">
                    <span class="font-bold text-sm uppercase">Quantity</span>
                    <div class="flex items-center bg-slate-100 rounded-xl p-1">
                        <button onclick="adjustModalQty(-1)" class="w-10 h-10 flex items-center justify-center font-bold text-lg">-</button>
                        <span id="modal-qty" class="w-10 text-center font-bold">1</span>
                        <button onclick="adjustModalQty(1)" class="w-10 h-10 flex items-center justify-center font-bold text-lg">+</button>
                    </div>
                </div>
                <div id="modal-modifiers" class="space-y-3"></div>
            </div>

            <div class="p-6 border-t border-slate-50 bg-white shrink-0">
                <button id="addToCartBtn" class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition">Add to Order</button>
            </div>
        </div>
    </div>
    

            <div id="checkoutModal" class="fixed inset-0 z-[100] hidden modal-shell" aria-hidden="true">
    
    <div class="absolute inset-0 bg-black/60 opacity-0 transition-opacity duration-300" id="checkoutBackdrop" onclick="closeCart()"></div>
    
    <div id="checkoutCard" class="absolute bottom-0 w-full sm:max-w-md left-0 right-0 mx-auto bg-white h-[96vh] rounded-t-3xl shadow-2xl transform translate-y-full transition-transform duration-300 ease-out flex flex-col z-50 overflow-hidden">
        
        <div class="w-full h-6 flex items-center justify-center shrink-0 bg-white" onclick="closeCart()">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full mt-3"></div>
        </div>

        <div class="px-6 pb-2 shrink-0 flex justify-between items-center bg-white">
            <h2 class="text-2xl font-black text-slate-800">My Order</h2>
            <button onclick="closeCart()" class="w-8 h-8 bg-slate-50 text-slate-400 rounded-full flex items-center justify-center hover:text-slate-900 active:scale-90 transition">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>

        <div id="cart-items" class="flex-1 overflow-y-auto px-6 py-4 space-y-4 min-h-0 bg-white">
            </div>

        <div class="shrink-0 bg-white border-t border-slate-50 p-6 pb-safe shadow-[0_-10px_40px_rgba(0,0,0,0.03)] z-50">
    
    <div class="relative mb-6 no-drag h-12"> <input type="text" id="promo-input" 
    <div id="cart-coupon-btn"
               class="w-full h-full bg-slate-50 border border-slate-200 rounded-xl pl-4 pr-20 text-sm font-bold uppercase outline-none focus:border-slate-900 transition" 
               placeholder="Discount Code">
        
        <button id="btn-apply-promo" onclick="applyPromoCode()" 
                class="absolute right-2 top-1/2 -translate-y-1/2 h-8 w-16 bg-slate-900 text-white text-[10px] font-bold rounded-lg active:scale-95 transition flex items-center justify-center shadow-sm overflow-hidden">
            APPLY
        </button>
        
        <button id="btn-remove-promo" onclick="removePromo()" 
                class="hidden absolute right-2 top-1/2 -translate-y-1/2 h-8 w-16 bg-red-500 text-white text-[10px] font-bold rounded-lg active:scale-95 transition flex items-center justify-center shadow-sm overflow-hidden">
            <i class="fa-solid fa-xmark text-sm"></i>
        </button>

        <p id="promo-msg" class="absolute -bottom-5 left-1 text-[10px] font-bold transition-all empty:hidden"></p>
    </div>

    <div id="coupon-list" class="mb-3"> 
        <div
        <div id="cart-coupon-btn" onclick="useSavedCoupon('WELCOME30')" class="bg-gradient-to-r from-orange-50 to-yellow-50 border border-orange-100 rounded-xl p-3 flex items-center justify-between cursor-pointer active:scale-[0.98] transition relative overflow-hidden group no-drag">
            <div class="flex items-center gap-3 relative z-10">
                <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center text-lg shadow-sm">üéÅ</div>
                <div>
                    <p class="text-[10px] font-bold text-orange-400 uppercase tracking-wider">Welcome Gift</p>
                    <p id="cart-coupon-text" class="text-xs font-black text-slate-800">30% OFF Order</p>
                </div>
            </div>
            <span class="bg-white text-slate-900 text-[10px] font-bold px-3 py-1.5 rounded-lg shadow-sm">Redeem</span>
        </div>
    </div>

    <div class="mb-4">
        <textarea id="order-note" rows="1" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-xs font-bold text-slate-700 outline-none focus:border-slate-900 transition resize-none placeholder-slate-400" placeholder="Add a note (e.g. No onions, extra spicy...)"></textarea>
    </div>

    <div class="flex justify-between items-end mb-3">
        <span class="text-sm font-medium text-slate-500">Total Amount</span>
        <span id="checkout-total" class="text-2xl font-black text-slate-900">0.00 SR</span>
    </div>

    <button onclick="placeOrder(this)" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold text-lg shadow-xl active:scale-[0.98] transition flex items-center justify-center gap-2">
        Place Order <i class="fa-solid fa-arrow-right"></i>
    </button>
      </div>
  </div>
</div>

    <div id="welcome-splash" class="hidden fixed inset-0 z-[300] flex items-center justify-center bg-slate-900/90 backdrop-blur-sm fade-in">
    <div class="bg-white w-[90%] max-w-sm rounded-3xl p-8 text-center shadow-2xl relative overflow-hidden">
        
        <div class="absolute -top-10 -right-10 w-32 h-32 bg-yellow-400 rounded-full blur-3xl opacity-30"></div>
        <div class="absolute top-20 -left-10 w-24 h-24 bg-orange-500 rounded-full blur-3xl opacity-20"></div>

        <div class="mb-6 inline-flex items-center justify-center w-20 h-20 bg-yellow-100 text-yellow-600 rounded-full shadow-inner text-4xl animate-bounce">
            üéÅ
        </div>

        <h2 class="text-3xl font-black text-slate-800 mb-2">You're In!</h2>
        <p class="text-slate-500 text-sm mb-6">Welcome to the TARI family. Here is a special gift just for you.</p>

        <div class="bg-gradient-to-r from-orange-500 to-yellow-500 p-1 rounded-xl mb-8 shadow-lg transform rotate-[-2deg] hover:rotate-0 transition-all duration-300">
            <div class="bg-white border-2 border-dashed border-orange-200 rounded-lg p-4">
                <p class="text-xs font-bold text-orange-400 uppercase tracking-widest mb-1">Promo Code</p>
                <h3 id="splash-code" class="text-2xl font-black text-slate-800 tracking-wider">WELCOME30</h3>
                <p id="splash-desc" class="text-[10px] text-slate-400 mt-1">30% OFF (Max 30 SR) ‚Ä¢ First Order Only</p>
            </div>
        </div>

        <p class="text-xs text-slate-400 mb-6 italic">
            "Don't worry, we saved this code in your checkout list!"
        </p>

        <button onclick="closeSplashAndOrder()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold text-lg shadow-xl hover:scale-[1.02] active:scale-95 transition-all">
            Order Now üçî
        </button>
    </div>
</div>

<style>
    @keyframes floatZ { 0% { opacity: 0; transform: translateY(10px) translateX(-5px); } 50% { opacity: 1; } 100% { opacity: 0; transform: translateY(-20px) translateX(5px); } }
    .zzz-anim { position: absolute; font-weight: 900; color: #cbd5e1; animation: floatZ 2.5s infinite ease-in-out; }
    .delay-1 { animation-delay: 0s; font-size: 10px; right: 35%; top: 10%; }
    .delay-2 { animation-delay: 0.8s; font-size: 14px; right: 25%; top: 0%; }
    .delay-3 { animation-delay: 1.6s; font-size: 18px; right: 15%; top: -15%; }
</style>

<div id="closed-modal" class="fixed inset-0 z-[999] flex flex-col items-center justify-start pt-4 pointer-events-none transition-transform duration-700 -translate-y-full">
    <div class="absolute inset-0 bg-slate-900/20 backdrop-blur-[2px] opacity-0 transition-opacity duration-700" id="closed-backdrop"></div>

    <div class="bg-white w-[90%] max-w-sm rounded-[2rem] p-6 shadow-2xl border border-slate-100 text-center pointer-events-auto relative overflow-hidden transform transition-all duration-500 ease-out mt-4">
        
        <div class="relative w-24 h-24 mx-auto mb-4 flex items-center justify-center">
            <div class="text-6xl filter grayscale opacity-80">üçî</div>
            <span class="zzz-anim delay-1">z</span>
            <span class="zzz-anim delay-2">Z</span>
            <span class="zzz-anim delay-3">Z</span>
        </div>

        <h2 class="text-2xl font-black text-slate-800 mb-2">Sorry, We're Closed</h2>
        <p class="text-slate-500 text-sm mb-6 leading-relaxed">
            The kitchen is currently resting.<br>
            Feel free to check our menu for your next order!
        </p>

        <div class="bg-slate-50 rounded-xl p-4 mb-6 border border-slate-100">
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Opening Hours</p>
            <div id="closed-hours-display" class="text-sm font-bold text-slate-700 space-y-1">
                Loading...
            </div>
        </div>

        <button onclick="dismissClosedModal()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold text-lg shadow-xl active:scale-95 transition">
            Check Menu <i class="fa-solid fa-book-open ml-2"></i>
        </button>
    </div>
</div>


                          <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">

<div id="otp-modal" class="fixed inset-0 z-[400] bg-slate-900/80 backdrop-blur-sm hidden flex items-center justify-center p-4 fade-in">
    <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl relative overflow-hidden text-center">
        
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-orange-400 to-orange-600"></div>
        <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4 text-orange-500 text-2xl animate-bounce">
            üí¨
        </div>

        <h3 class="text-2xl font-black text-slate-800 mb-2">Verify Phone</h3>
        <p class="text-slate-500 text-sm mb-2">
            We sent a 4-digit code to <br>
            <span id="otp-target-number" class="font-bold text-slate-800">...</span>
        </p>
        <p class="text-orange-500 text-xs font-bold mb-6">
            <i class="fa-brands fa-whatsapp mr-1"></i> Check your WhatsApp
        </p>

        <div class="relative w-full max-w-[260px] mx-auto h-16 mb-6">
            <input type="tel" id="otp-input"
                   class="absolute inset-0 w-full h-full opacity-0 z-10 cursor-pointer font-bold text-transparent bg-transparent focus:outline-none caret-transparent"
                   maxlength="4" pattern="\d*" autocomplete="one-time-code">

            <div class="w-full h-full flex items-center justify-between pointer-events-none">
                <div id="otp-box-0" class="w-12 h-14 border-2 border-slate-200 rounded-xl flex items-center justify-center text-2xl font-black text-slate-800 bg-slate-50 transition-all"></div>
                <div class="text-slate-300 text-xl">‚Ä¢</div>
                <div id="otp-box-1" class="w-12 h-14 border-2 border-slate-200 rounded-xl flex items-center justify-center text-2xl font-black text-slate-800 bg-slate-50 transition-all"></div>
                <div class="text-slate-300 text-xl">‚Ä¢</div>
                <div id="otp-box-2" class="w-12 h-14 border-2 border-slate-200 rounded-xl flex items-center justify-center text-2xl font-black text-slate-800 bg-slate-50 transition-all"></div>
                <div class="text-slate-300 text-xl">‚Ä¢</div>
                <div id="otp-box-3" class="w-12 h-14 border-2 border-slate-200 rounded-xl flex items-center justify-center text-2xl font-black text-slate-800 bg-slate-50 transition-all"></div>
            </div>
        </div>
        
        <p id="otp-error" class="text-red-500 text-xs font-bold mb-4 hidden">
            <i class="fa-solid fa-circle-exclamation"></i> Incorrect or Expired Code
        </p>

        <div class="mb-6">
            <button id="btn-resend-otp" onclick="resendOtp()" disabled class="text-slate-400 text-xs font-bold py-2 px-4 rounded-full border border-slate-200 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50 transition-colors">
                Resend code in <span id="resend-timer">01:00</span>
            </button>
        </div>

        <div class="flex gap-3">
            <button onclick="closeOtpModal()" class="flex-1 py-4 rounded-xl font-bold text-slate-400 hover:text-slate-600 hover:bg-slate-50 transition">
                Cancel
            </button>
            <button onclick="confirmOtp()" id="btn-verify-otp" class="flex-1 bg-slate-900 text-white py-4 rounded-xl font-bold shadow-lg shadow-slate-900/20 active:scale-95 transition">
                Verify
            </button>
        </div>

    </div>
</div>


<script>
    
    // --- INSTANT SPLASH CHECK ---
// If the user has already seen the splash in this session, hide it immediately.
if (sessionStorage.getItem('tari_splash_seen') === 'true') {
    const style = document.createElement('style');
    style.innerHTML = '#splash-screen { display: none !important; }';
    document.head.appendChild(style);
}

    
    // --- GLOBAL VARIABLES ---
    var deviceId = "unknown_device"; 
    var userIP = "0.0.0.0";
    var currentUser = null; 
    var sheetTimer = null;
    let currentCatIndex = 0;
    // CART & PROMO STATE
    var cart = [];              
    var activeDiscount = 0;     
    var activePromoCode = "";   
    var currentPromoRule = null; 
    var isStoreOpen = true; 
    let pendingOtpCode = null;
    let pendingUserData = null;
    let otpExpiryTime = null;   // üÜï For the 5-minute limit
    let resendInterval = null;  // üÜï For the 1-minute countdown
    
    // DATA & UI STATE
    var userData = null;
    var allMenuItems = [];
    var allModifiers = [];
    var currentItem = null;
    var modalQty = 1;
    var editingCartIndex = -1;
    var modalOpen = false;
    var heroTimer = null;
    var lockProductSwipe = false;
    var userOrderCount = 0;
    var welcomeRule = { code: 'WELCOME30', value: 30, type: 'percent' };

    // LOYALTY SETTINGS
    var loyaltyRules = { type: 'fixed', value: 0 }; 
    
    // Supabase Config
    const SUPABASE_URL = "https://fpgspmhgwcmhaaxsphcd.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZ3NwbWhnd2NtaGFheHNwaGNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MjYyMTEsImV4cCI6MjA4MTQwMjIxMX0.QyChZ3agLF1MiTzB8XzbrP4pCgBXsT1i9VWfQqu_VOw";

    // --- 0. STYLE INJECTION ---
    function injectStyles() {
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes flashRed {
                0% { background-color: transparent; border-color: #E2E8F0; }
                50% { background-color: #FEF2F2; border-color: #EF4444; box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1); }
                100% { background-color: transparent; border-color: #E2E8F0; }
            }
            .flash-error { animation: flashRed 1s ease-in-out; border-radius: 12px; }
        `;
        document.head.appendChild(style);
    }
    injectStyles();

    function flashElement(element) {
        if(!element) return;
        element.classList.remove('flash-error');
        void element.offsetWidth; // Force reflow
        element.classList.add('flash-error');
        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // --- 1. INITIALIZE & TRACKING ---
    let sb;
    if (window.supabase) {
        sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        initFingerprint(); 
        getIP(); 
    } else {
        setTimeout(() => location.reload(), 2000); 
    }

    async function initFingerprint() {
        try {
            if (typeof FingerprintJS !== 'undefined') {
                const fpPromise = FingerprintJS.load();
                const fp = await fpPromise;
                const result = await fp.get();
                deviceId = result.visitorId;
                console.log("üîí Security ID Active:", deviceId); 
            } else { throw new Error("Library missing"); }
        } catch (e) {
            let storedId = localStorage.getItem('tari_backup_device_id');
            if (!storedId) {
                storedId = 'dev_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
                localStorage.setItem('tari_backup_device_id', storedId);
            }
            deviceId = storedId;
        }
    }
    
    async function getIP() {
        try {
            const response = await fetch('https://api64.ipify.org?format=json');
            const data = await response.json();
            userIP = data.ip;
            console.log("IP fetched:", userIP);
        } catch (e) {
            try {
                const response2 = await fetch('https://api.db-ip.com/v2/free/self');
                const data2 = await response2.json();
                userIP = data2.ipAddress;
            } catch (e2) {
                userIP = "127.0.0.1"; 
            }
        }
    }

// --- WELCOME SPLASH LOGIC ---

// 1. Show the Splash
function showSplash() {
    const splash = document.getElementById('welcome-splash');
    if(splash) {
        splash.classList.remove('hidden');
        splash.classList.remove('fade-out');
        splash.classList.add('fade-in');
    }
}

// 2. Close the Splash (with Animation)
window.closeSplashAndOrder = () => {
    const splash = document.getElementById('welcome-splash');
    
    // Switch to Home immediately so background is ready
    switchView('home'); 

    if(splash) {
        // Swap animation classes
        splash.classList.remove('fade-in');  
        splash.classList.add('fade-out');    
        
        // Wait 500ms for animation to finish, then hide
        setTimeout(() => {
            splash.classList.add('hidden');
            splash.classList.remove('fade-out'); 
        }, 500);
    }
}

    // --- 2. AUTHENTICATION ---
    if(sb) { 
        sb.auth.onAuthStateChange((event, session) => { 
            if (session) { 
                currentUser = session.user; 
                closeAuth(); 
                loadUserProfile(currentUser.id); 
                listenToOrders(currentUser.id); 
            } else { 
                currentUser = null; 
            } 
        }); 
    }        
    
        // UPDATED: Properly hides the login screen so it doesn't leak at the footer
    window.requireAuth = () => { 
        if (currentUser) { 
            switchView('profile'); 
        } else { 
            const authView = document.getElementById('view-auth');
            authView.classList.remove('hidden'); // 1. Make visible
            // Small delay to let browser realize it's visible before sliding
            setTimeout(() => {
                authView.classList.remove('translate-y-full'); // 2. Slide Up
            }, 10);
        } 
    };        

    window.closeAuth = () => { 
        const authView = document.getElementById('view-auth');
        authView.classList.add('translate-y-full'); // 1. Slide Down
        
        // Wait for animation (300ms) then hide completely
        setTimeout(() => {
            authView.classList.add('hidden'); // 2. Hide
        }, 300);
    };

    window.toggleAuthMode = () => { document.getElementById('login-form').classList.toggle('hidden'); document.getElementById('signup-form').classList.toggle('hidden'); };
    
    window.handleLogin = async (btn) => { 
        setBtnLoading(btn, true); 
        const { error } = await sb.auth.signInWithPassword({ email: document.getElementById('login-email').value, password: document.getElementById('login-pass').value }); 
        if (error) { showToast(error.message, true); setBtnLoading(btn, false); } 
    };
    
        // SIGNUP: 0 POINTS + SPLASH TRIGGER
        // 1. The Trigger: Validates Input & Sends Code
    window.handleSignup = async (btn) => { 
        const name = document.getElementById('reg-name').value; 
        const email = document.getElementById('reg-email').value; 
        const phoneInput = document.getElementById('reg-phone');
        const password = document.getElementById('reg-pass').value;
        const errorMsg = document.getElementById('phone-error-msg');

        // Clean the input (remove spaces/dashes)
        let rawNumber = phoneInput.value.replace(/\D/g, '');

        // VALIDATION: Must be exactly 9 digits
        if (rawNumber.length !== 9) {
            phoneInput.classList.add('border-red-500', 'text-red-600', 'bg-red-50');
            errorMsg.classList.remove('hidden');
            flashElement(phoneInput.parentElement); // Shake/Flash effect
            return;
        }

        // Clear errors if valid
        phoneInput.classList.remove('border-red-500', 'text-red-600', 'bg-red-50');
        errorMsg.classList.add('hidden');

        setBtnLoading(btn, true, 'Sending Code...'); 
        
        // Merge with Prefix
        const fullPhone = "+966" + rawNumber;

        // Generate Code
        const generatedCode = Math.floor(1000 + Math.random() * 9000).toString();

        // Send via Supabase Edge/RPC
        const { data: rpcData, error: rpcError } = await sb.rpc('send_whatsapp_otp', { 
            phone: fullPhone, 
            otp: generatedCode 
        });

                if (rpcError) { 
            // 1. Check specifically for the "Already Registered" case
            // We use optional chaining (?.) just in case message is missing
            if (rpcError.message?.includes('already registered')) {
                
                // It's an expected error, so we just show the Toast (No console noise!)
                showToast("This phone number is already registered!", true);
                
                // Highlight the input box
                phoneInput.classList.add('border-red-500', 'bg-red-50');
                flashElement(phoneInput.parentElement);

            } else {
                // 2. If it's any OTHER error (like network fail), LOG IT.
                // This helps you debug real problems later.
                console.error("System Error:", rpcError);
                showToast("Failed to send WhatsApp message", true); 
            }
            
            setBtnLoading(btn, false); 
            return; 
        }

        
        // Store data temporarily for the next step
        pendingOtpCode = generatedCode;
        pendingUserData = { email, password, name, phone: fullPhone, btnRef: btn };
        
        // üÜï NEW: Set Expiry (5 mins from now)
        otpExpiryTime = Date.now() + (5 * 60 * 1000);

        // üÜï NEW: Start the "Resend" countdown
        startResendTimer();

        // üÜï NEW: Clear the inputs (So it's empty if they try again)
        const ghostInput = document.getElementById('otp-input');
        ghostInput.value = ''; // Clear real input
        
        // Clear visual boxes manually
        for(let i=0; i<4; i++) {
             const box = document.getElementById(`otp-box-${i}`);
             box.innerText = '';
             box.classList.remove('border-orange-500', 'bg-white');
             box.classList.add('border-slate-200', 'bg-slate-50');
        }

        // Show the UI Modal
        document.getElementById('otp-target-number').innerText = fullPhone;
        document.getElementById('otp-modal').classList.remove('hidden');
        };

    // 2. The Verification: Checks the code
    window.confirmOtp = async () => {
        const input = document.getElementById('otp-input');
        const errorText = document.getElementById('otp-error');
        const verifyBtn = document.getElementById('btn-verify-otp');
        
        if (input.value !== pendingOtpCode) {
            errorText.classList.remove('hidden');
            input.classList.add('border-red-500', 'bg-red-50');
            flashElement(input);
            return;
        }

        // SUCCESS! 
        errorText.classList.add('hidden');
        input.classList.remove('border-red-500', 'bg-red-50');
        setBtnLoading(verifyBtn, true, 'Verifying...');

        // Create the Account
        const { email, password, name, phone, btnRef } = pendingUserData;
        
        const { data, error } = await sb.auth.signUp({ 
            email: email, 
            password: password, 
            options: { data: { name: name, phone: phone } } 
        }); 
        
        if (error) { 
            showToast(error.message, true); 
            setBtnLoading(verifyBtn, false); 
            setBtnLoading(btnRef, false); // Reset the original button too
            return; 
        } 
        
        if (data.user) { 
            await sb.from('users').insert({ 
                id: data.user.id, 
                name: name, 
                email: email, 
                phone: phone,
                points: 0, 
                joined: new Date().toLocaleDateString(), 
                avatar: `https://ui-avatars.com/api/?name=${name}&background=FF5722&color=fff` 
            }); 
            
            closeOtpModal();
            closeAuth(); 
            showToast("Verified & Welcome!"); 
            setTimeout(() => { showSplash(); }, 300); 
            
            // Reset buttons
            setBtnLoading(verifyBtn, false); 
            setBtnLoading(btnRef, false); 
        } 
    };
        // --- 4. REAL-TIME VALIDATION ---
    // This watches the typing and removes the red error immediately when fixed
    document.getElementById('reg-phone').addEventListener('input', function(e) {
        const input = e.target;
        const errorMsg = document.getElementById('phone-error-msg');
        
        // Remove any non-numbers just in case
        const raw = input.value.replace(/\D/g, '');

        // If they hit exactly 9 digits, clear the error!
        if(raw.length === 9) {
            input.classList.remove('border-red-500', 'text-red-600', 'bg-red-50');
            errorMsg.classList.add('hidden');
        }
    });


    // 3. Helper to close modal
    window.closeOtpModal = () => {
        document.getElementById('otp-modal').classList.add('hidden');
        // Reset the original signup button if they cancel
        if(pendingUserData && pendingUserData.btnRef) {
             setBtnLoading(pendingUserData.btnRef, false);
        }
        pendingOtpCode = null;
        pendingUserData = null;
    };


    
    window.handleLogout = async () => { await sb.auth.signOut(); location.reload(); }

    // --- 3. CORE UI & DATA LOADING ---
    window.hideSplash = () => { 
    // 1. Save a flag in the browser's session memory
    sessionStorage.setItem('tari_splash_seen', 'true');

    // 2. Do the animation as usual
    document.getElementById('splash-screen').style.transform = 'translateY(-100%)'; 
    setTimeout(() => document.getElementById('splash-screen').classList.add('splash-gone'), 600); 
};

    window.showToast = (msg, isErr=false) => { const t = document.getElementById('toast'); document.getElementById('toast-msg').innerText = msg; document.getElementById('toast-icon').className = isErr ? "fa-solid fa-circle-xmark text-red-400" : "fa-solid fa-circle-check text-green-400"; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); };
    window.setBtnLoading = (btn, isLoading, text='Processing') => { if(isLoading) { btn.dataset.org = btn.innerText; btn.innerHTML=`<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> ${text}`; btn.disabled=true; } else { btn.innerText = btn.dataset.org || 'Submit'; btn.disabled=false; } };                
        window.switchView = (v) => { 
        // 1. FIND THE TARGET PAGE
        const targetPage = document.getElementById('view-' + v);
        
        // üõë SAFETY GUARD: If the page is already open, DO NOTHING.
        // This stops the "Stuck" bug immediately.
        if (!targetPage.classList.contains('hidden')) return;

        // 2. AUTH CHECK (Keep your existing security)
        if((v=='track'||v=='profile') && !currentUser) return window.requireAuth(); 

        // 3. SWITCH THE PAGES
        document.querySelectorAll('[id^="view-"]').forEach(e => e.classList.add('hidden')); 
        targetPage.classList.remove('hidden'); 
        
        // 4. UPDATE THE BUTTONS (Visuals)
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); 
        
        // Safer way to highlight the correct button
        if(v=='home') document.querySelectorAll('.nav-item')[0].classList.add('active'); 
        if(v=='track') document.querySelectorAll('.nav-item')[1].classList.add('active'); 
        if(v=='profile') document.querySelectorAll('.nav-item')[2].classList.add('active'); 
    }


    async function loadData() {
        try {           
            if(!sb) return;
            
            await fetchCategories();
            
            const { data: loyalty } = await sb.from('settings').select('data').eq('id', 'loyalty_program').single();
            if(loyalty?.data) { loyaltyRules = loyalty.data; }

            const { data: hero } = await sb.from('settings').select('data').eq('id', 'hero').single(); 
            if(hero?.data?.images) { document.getElementById('hero-slider-container').innerHTML = hero.data.images.map((img,i) => `<img src="${img}" class="hero-slide ${i===0?'active-slide':''}">`).join(''); } 
            let slideIdx = 0; if (window.heroTimer) clearInterval(window.heroTimer);
            window.heroTimer = setInterval(() => { const slides = document.querySelectorAll('.hero-slide'); if (slides.length > 1) { slides[slideIdx].classList.remove('active-slide'); slideIdx = (slideIdx + 1) % slides.length; slides[slideIdx].classList.add('active-slide'); } }, 3000);

            const { data: splash } = await sb.from('settings').select('data').eq('id', 'splash').single();
            if(splash?.data) { if(splash.data.title) document.getElementById('splash-title-text').innerText = splash.data.title; if(splash.data.subtitle) document.getElementById('splash-subtitle-text').innerText = splash.data.subtitle; if(splash.data.intro) document.getElementById('splash-intro').innerText = splash.data.intro; if(splash.data.background) { const bg = document.getElementById('splash-bg-img'); bg.src = splash.data.background; bg.classList.remove('hidden'); } if(splash.data.circle) { document.getElementById('splash-circle-img').src = splash.data.circle; } }
            
            const { data: design } = await sb.from('settings').select('data').eq('id', 'design').single(); 
            if(design?.data?.primaryColor) { document.documentElement.style.setProperty('--primary', design.data.primaryColor); const style = document.createElement('style'); style.innerHTML = `.bg-brand{background-color:${design.data.primaryColor}!important}.text-brand{color:${design.data.primaryColor}!important}`; document.head.appendChild(style); } 

            const { data: web } = await sb.from('settings').select('data').eq('id', 'website_settings').single(); 
            
            if(web?.data) { 
                const header = document.getElementById('app-header'); 
                
                if(header && web.data.header_color) { 
                    // ONLY Update the variable (The CSS handles the rest)
                    header.style.setProperty('--header-bg', web.data.header_color);
                    
                    // Ensure we don't accidentally add a background class back
                    header.style.backgroundColor = 'transparent'; 
                } 
                if(web.data.logo) { const logoImg = document.getElementById('header-truck-logo'); if(logoImg) { logoImg.src = web.data.logo + '?t=' + Date.now(); logoImg.classList.remove('hidden'); } }
                if(web.data.bg_color) { document.body.style.backgroundColor = web.data.bg_color; document.documentElement.style.backgroundColor = web.data.bg_color; }
                if(web.data.bg_image) { document.body.style.backgroundImage = `url('${web.data.bg_image}')`; document.body.style.backgroundSize = "cover"; document.body.style.backgroundPosition = "center"; document.body.style.backgroundAttachment = "fixed"; document.body.style.backgroundRepeat = "no-repeat"; }
            }
            
             // 5. INFO
                const { data: info } = await sb.from('settings').select('data').eq('id', 'info').single(); 
                if (info && info.data) { 
                    if(info.data.location) document.getElementById('info-location').innerText = info.data.location; 
                    if(info.data.phone) document.getElementById('info-phone').innerText = info.data.phone; 
                    if(info.data.hours && Array.isArray(info.data.hours)) { 
                        document.getElementById('info-hours').innerHTML = info.data.hours.map(h => `<div class="flex justify-between w-full max-w-[200px] mb-1 text-slate-300"><span>${h.day}:</span> <span class="font-bold text-white">${h.time}</span></div>`).join(''); 
                    } 
                }

            const { data: mods } = await sb.from('modifier_groups').select('*').order('sort_order', {ascending: true}); allModifiers = mods || []; 
                        const { data: menu } = await sb.from('menu').select('*').order('sort_order', {ascending: true}); allMenuItems = menu || []; 
            
            // --- FIX: FETCH STORE STATUS ---
            const { data: store } = await sb.from('settings').select('data').eq('id', 'store_status').single();

          // Store closed 
          
                        if (store?.data?.open === false) {
                        isStoreOpen = false;
                // A. Show the "Closed" Slide-Down Window
                const modal = document.getElementById('closed-modal');
                const backdrop = document.getElementById('closed-backdrop');
                
                modal.classList.remove('-translate-y-full'); 
                backdrop.classList.remove('opacity-0');       

                // B. Fetch Hours Logic (Keep this as is)
                const { data: info } = await sb.from('settings').select('data').eq('id', 'info').single();
                if(info?.data?.hours) {
                    const hoursHtml = info.data.hours.map(h => 
                        `<div class="flex justify-between w-full max-w-[200px] mx-auto"><span>${h.day}:</span> <span>${h.time}</span></div>`
                    ).join('');
                    document.getElementById('closed-hours-display').innerHTML = hoursHtml;
                } else {
                     document.getElementById('closed-hours-display').innerText = "Check back later!";
                }

                // C. CLEAN BUTTON LOGIC (New & Improved)
                const cartBtn = document.getElementById('fab-btn');
                if(cartBtn) {
                    // 1. Disable Click
                    cartBtn.onclick = () => showToast("Store is closed", true);
                    
                    // 2. Visuals: Grey out & Center Content
                    cartBtn.classList.add('grayscale', 'opacity-80', 'cursor-not-allowed', 'justify-center'); // Added justify-center
                    cartBtn.classList.remove('justify-between'); // Removed space-between
                    
                    // 3. Hide The Clutter (Count & Total)
                    if(document.getElementById('cart-count')) document.getElementById('cart-count').style.display = 'none';
                    if(document.getElementById('cart-total')) document.getElementById('cart-total').style.display = 'none';

                    // 4. Set Clean Text
                    // Target the text span inside the button
                    const textSpan = cartBtn.querySelector('div span'); 
                    if(textSpan) {
                        textSpan.innerText = "Store Closed";
                        textSpan.className = "font-black text-lg uppercase tracking-widest"; // Make it look bold & premium
                    }
                }
            }

            // --- 2. FETCH DYNAMIC WELCOME GIFT ---
            const { data: newPromo } = await sb.from('settings').select('data').eq('id', 'new_user_promo').single();
            if(newPromo?.data) {
                welcomeRule = newPromo.data; // Update global variable
                
                // Update Splash Screen
                if(document.getElementById('splash-code')) {
                    document.getElementById('splash-code').innerText = welcomeRule.code;
                    const valText = welcomeRule.type === 'percent' ? `${welcomeRule.value}% OFF` : `${welcomeRule.value} SR OFF`;
                    document.getElementById('splash-desc').innerText = `${valText} ‚Ä¢ First Order Only`;
                }

                // Update Cart Coupon
                if(document.getElementById('cart-coupon-btn')) {
                    const btn = document.getElementById('cart-coupon-btn');
                    // Update the click function to use the NEW code
                    btn.onclick = function() { useSavedCoupon(welcomeRule.code); };
                    
                    const valText = welcomeRule.type === 'percent' ? `${welcomeRule.value}% OFF Order` : `${welcomeRule.value} SR OFF Order`;
                    document.getElementById('cart-coupon-text').innerText = valText;
                }
            }

            renderMenu(allMenuItems); renderBestSellers(allMenuItems);

        } catch (err) { console.log(err); } finally { document.getElementById('preloader').classList.add('loaded'); }
    }
    
    

    // --- 4. MENU & PRODUCT LOGIC ---
    function renderBestSellers(items) { 
        const best = items.filter(i => i.is_best_seller === true && i.available !== false); 
        const container = document.getElementById('best-seller-list'); 
        if(best.length > 0) { 
            document.getElementById('best-seller-section').classList.remove('hidden'); 
            container.innerHTML = best.map(i => { 
                const itemStr = JSON.stringify(i).replace(/'/g, "&#39;").replace(/"/g, "&quot;"); 
                return `<div onclick='openCartItemFromMenu(${itemStr})' class="flex-shrink-0 w-40 bg-white rounded-2xl p-3 shadow-md border border-slate-100 cursor-pointer active:scale-95 transition relative overflow-hidden group"><div class="h-32 w-full rounded-xl overflow-hidden mb-2 relative"><div class="absolute top-2 left-2 badge-shine-gold px-2 py-1 rounded-md z-10 text-[10px] font-black tracking-wider flex items-center gap-1"><i class="fa-solid fa-star text-[8px]"></i> TOP</div><img src="${i.image||'https://via.placeholder.com/150'}" class="w-full h-full object-cover"></div><h4 class="font-bold text-sm truncate mt-2 text-slate-800">${i.name}</h4><div class="flex justify-between items-center mt-1"><span class="text-orange-500 font-bold text-xs">SR ${i.price}</span><div class="w-6 h-6 bg-slate-900 text-white rounded-md flex items-center justify-center text-[10px] shadow-sm group-hover:bg-orange-500 transition"><i class="fa-solid fa-plus"></i></div></div></div>`; 
            }).join(''); 
        } else { document.getElementById('best-seller-section').classList.add('hidden'); } 
    }

        function renderMenu(items, animClass = 'fade-in') { 
        const list = document.getElementById('menu-list');
        
        if(!items.length) {
            list.innerHTML = `<div class="text-center py-10 text-slate-400">No items found.</div>`;
            return;
        }

        list.innerHTML = items.map((item, index) => { 
            const itemStr = JSON.stringify(item).replace(/'/g, "&#39;").replace(/"/g, "&quot;"); 
            const isSoldOut = item.available === false; 
            const bestSellerBadge = item.is_best_seller ? `<div class="absolute top-0 left-0 bg-orange-500 text-white text-[10px] font-bold px-2 py-1 rounded-br-lg z-10 shadow-sm">Best Seller</div>` : '';
            
            // STAGGER DELAY: Each item waits 50ms longer (0ms, 50ms, 100ms...)
            // This creates the "Waterfall" effect
            const delay = index * 50; 

            return `
            <div onclick='${isSoldOut ? '' : `openCartItemFromMenu(${itemStr})`}' 
                 style="animation-delay: ${delay}ms"
                 class="${animClass} opacity-0 bg-white p-3 rounded-2xl shadow-sm border border-slate-100 flex gap-4 cursor-pointer active:scale-[0.98] transition group relative overflow-hidden ${isSoldOut ? 'sold-out-card' : ''}">
                
                <div class="relative w-24 h-24 flex-shrink-0 rounded-xl overflow-hidden">
                    ${bestSellerBadge}
                    <img src="${item.image || 'https://via.placeholder.com/150'}" class="w-full h-full object-cover bg-slate-100 border-2 border-white shadow-sm">
                </div>
                
                <div class="flex flex-col justify-center flex-1">
                    <h3 class="font-bold text-slate-800 text-lg leading-tight mb-1">${item.name}</h3>
                    <p class="text-xs text-slate-500 line-clamp-2 mb-2">${item.description||''}</p>
                    <div class="flex justify-between items-center mt-auto">
                        <span class="font-bold text-slate-900">SR ${item.price}</span>
                        <div class="w-8 h-8 bg-slate-50 rounded-full flex items-center justify-center text-slate-400 group-hover:bg-orange-50 group-hover:text-orange-500 transition">
                            <i class="fa-solid fa-plus"></i>
                        </div>
                    </div>
                </div>
            </div>`; 
        }).join(''); 
    }


            window.filterMenu = (cat, btn) => { 
        // 1. Figure out Direction (Left or Right?)
        const allBtns = Array.from(document.getElementById('category-list').children);
        const newIndex = allBtns.indexOf(btn);
        
        let anim = 'fade-in'; // Default (first load)
        
        // If we picked a category to the RIGHT -> Items slide in from Right
        if(newIndex > currentCatIndex) anim = 'anim-next';
        
        // If we picked a category to the LEFT -> Items slide in from Left
        if(newIndex < currentCatIndex) anim = 'anim-prev';
        
        currentCatIndex = newIndex; // Save for next time

        // 2. Update Buttons (Active State)
        document.querySelectorAll('.cat-btn').forEach(b => {
            b.classList.remove('active', 'bg-slate-900', 'text-white', 'border-slate-900');
            b.classList.add('bg-white', 'text-slate-600', 'border-slate-200');
        });
        btn.classList.remove('bg-white', 'text-slate-600', 'border-slate-200');
        btn.classList.add('active', 'bg-slate-900', 'text-white', 'border-slate-900');
        
        // 3. Filter Data
        const filtered = cat === 'all' 
            ? allMenuItems 
            : allMenuItems.filter(i => (i.category === cat) || (i.name && i.name.toLowerCase().includes(cat.toLowerCase())));
            
        // 4. Render with Animation
        renderMenu(filtered, anim); 
    }



    // --- 5. CART & MODAL LOGIC ---
        function toggleSheet(id, show) {
        if (sheetTimer) clearTimeout(sheetTimer);
        const container = document.getElementById(id);
        const card = id === 'productModal' ? document.getElementById('productCard') : document.getElementById('checkoutCard');
        
        if (show) {
            modalOpen = true;  
            card.style.transition = 'none'; 
            card.style.transform = 'translateY(100%)'; 
            container.classList.add('modal-shell'); 
            void card.offsetHeight; // Force Reset
            
            container.classList.remove('hidden'); 
            container.classList.add('active'); // Blocks screen so you can't click background
            
            // OPEN SPEED (0.7s)
            requestAnimationFrame(() => { 
                card.style.transition = 'transform 0.9s cubic-bezier(0.32, 0.72, 0, 1)'; 
                card.style.transform = 'translateY(0)'; 
            });

        } else {
            // --- THE FIX IS HERE ---
            // 1. Unblock the screen IMMEDIATELY (Allow clicks to pass through)
            container.classList.remove('active'); 
            
            // 2. CLOSE SPEED (0.6s)
            card.style.transition = 'transform 0.9s cubic-bezier(0.32, 0.72, 0, 1)'; 
            card.style.transform = 'translateY(100%)';
            
            // 3. Hide completely only after animation finishes
            sheetTimer = setTimeout(() => { 
                container.classList.add('hidden'); 
                card.style.transform = ''; 
                card.style.transition = ''; 
                modalOpen = false; 
            }, 600); // Matches the 0.6s close speed
        }
    }


    window.openCartItemFromMenu = (item) => { editingCartIndex = -1; openProductModal(item); }
    window.editCartItem = (index) => { editingCartIndex = index; currentItem = cart[index]; closeCart(); setTimeout(() => openProductModal(currentItem, true), 350); }
    window.openProductModal = (item, isEdit = false) => {
        currentItem = item; modalQty = isEdit ? item.qty : 1;
        document.getElementById('modal-title').innerText = item.name; document.getElementById('modal-price').innerText = 'SR ' + item.price; document.getElementById('modal-desc').innerText = item.description||''; document.getElementById('modal-img').src = item.image||'https://via.placeholder.com/150'; document.getElementById('modal-qty').innerText = modalQty; document.getElementById('addToCartBtn').innerText = isEdit ? "Update Order" : "Add to Order";
        const container = document.getElementById('modal-modifiers'); container.innerHTML = "";
        if(item.modifier_group_ids && item.modifier_group_ids.length > 0) {
            const relevantGroups = allModifiers.filter(g => item.modifier_group_ids.includes(g.id));
            relevantGroups.forEach(g => {
                const options = typeof g.options === 'string' ? JSON.parse(g.options) : g.options;
                const html = `<div class="modifier-group mb-4"><h4 class="font-bold text-sm mb-2 mt-4 text-slate-800 uppercase tracking-wide border-b border-slate-100 pb-1">${g.name} ${g.required?'<span class="text-red-500">*</span>':''}</h4>` + options.map((opt, i) => {
                    let isChecked = false; if(isEdit && item.selectedMods) { isChecked = item.selectedMods.some(m => m.name === opt.name && m.group === g.name); }
                    return `<label class="no-drag flex justify-between items-center p-3 border border-slate-200 rounded-xl mb-2 bg-slate-50 cursor-pointer hover:border-orange-200 transition"><div class="flex items-center gap-3"><input type="${g.required?'radio':'checkbox'}" name="mod-${g.id}" class="mod-checkbox w-5 h-5 accent-orange-500" data-group="${g.name}" data-name="${opt.name}" data-price="${opt.price||0}" ${isChecked?'checked':''}><span class="font-medium text-sm">${opt.name}</span></div><span class="text-xs font-bold text-slate-500">+SR ${opt.price||0}</span></label>`;
                }).join('') + `</div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        }
        toggleSheet('productModal', true);
    }
    
    document.getElementById('addToCartBtn').addEventListener('click', () => {
        const btn = document.getElementById('addToCartBtn');
        let isValid = true; let missingGroups = [];
        if (currentItem.modifier_group_ids && currentItem.modifier_group_ids.length > 0) {
            currentItem.modifier_group_ids.forEach(gid => {
                const group = allModifiers.find(m => m.id === gid);
                if (group && group.required) { const checked = document.querySelector(`input[name="mod-${gid}"]:checked`); if (!checked) { isValid = false; missingGroups.push(group); } }
            });
        }
        if (!isValid) { 
            showToast(`Please select: ${missingGroups.map(g => g.name).join(', ')}`, true); 
            const firstGroup = missingGroups[0];
            const heading = [...document.querySelectorAll('#modal-modifiers h4')].find(h => h.textContent.includes(firstGroup.name));
            if (heading) { 
                const container = heading.closest('.modifier-group') || heading.parentElement;
                flashElement(container);
            }
            return; 
        }
        setBtnLoading(btn, true, 'Adding...');
        setTimeout(() => {
            let unitPrice = parseFloat(currentItem.price); let selectedMods = [];
            document.querySelectorAll('.mod-checkbox:checked').forEach(c => { let p = parseFloat(c.dataset.price) || 0; unitPrice += p; selectedMods.push({ name: c.dataset.name, price: p, group: c.dataset.group }); });
            const newItem = { ...currentItem, qty: modalQty, unitPrice, selectedMods };
            if (editingCartIndex > -1) { cart[editingCartIndex] = newItem; } else { const exist = cart.findIndex(c => c.id === newItem.id && JSON.stringify(c.selectedMods) === JSON.stringify(newItem.selectedMods)); if (exist > -1) cart[exist].qty += newItem.qty; else cart.push(newItem); }
            updateCartUI(); toggleSheet('productModal', false); setBtnLoading(btn, false);
        }, 300);
    });

    window.dismissClosedModal = () => {
        // Slide the window back up
        document.getElementById('closed-modal').classList.add('-translate-y-full');
        // Keep the cart disabled (so they can look but not buy)
    };

    window.closeModal = () => { toggleSheet('productModal', false); setTimeout(() => updateCartUI(), 200); if(editingCartIndex !== -1) setTimeout(openCart, 350); editingCartIndex = -1; }
    window.closeCart = () => { toggleSheet('checkoutModal', false); setTimeout(() => { const fab = document.getElementById('fab-container'); if (fab && cart.length > 0) fab.classList.remove('translate-y-32'); }, 200); }
    window.adjustModalQty = (c) => { if(modalQty + c > 0) { modalQty += c; document.getElementById('modal-qty').innerText = modalQty; } }
    window.changeCartQty = (index, delta) => { cart[index].qty += delta; if(cart[index].qty <= 0) cart.splice(index, 1); if(cart.length === 0) closeCart(); updateCartUI(); };
    window.removeFromCart = (i) => { cart.splice(i,1); if(cart.length === 0) closeCart(); updateCartUI(); };

    // --- 6. PROMO CODE LOGIC ---

    window.applyPromoCode = async () => {
        const btn = document.getElementById('btn-apply-promo');
        const input = document.getElementById('promo-input');
        const msg = document.getElementById('promo-msg');
        const code = input.value.trim().toUpperCase(); 

        if (!code) { 
            msg.innerText = "Enter code"; 
            msg.className = "absolute -bottom-5 left-1 text-[10px] font-bold text-red-500 transition-all"; 
            msg.classList.remove('hidden'); 
            return; 
        }

        const orgText = "APPLY";
        btn.disabled = true; btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i>`; 

        if (!currentUser) { btn.innerHTML = orgText; btn.disabled = false; window.requireAuth(); return; }

        try {
            // A. CALCULATE SECURITY SUBNET
            if (userIP === "0.0.0.0") { await getIP(); }
            let subnet = "unavailable";
            if (typeof userIP !== 'undefined' && userIP.includes('.')) { subnet = userIP.split('.').slice(0, 3).join('.'); }
            const userPhone = currentUser.user_metadata?.phone || "";

            // B. CHECK SECURITY
            const { data: isAbuser, error: rpcError } = await sb.rpc('check_promo_abuse', { 
                check_code: code, check_device: deviceId, check_phone: userPhone, check_subnet: subnet    
            });

            if (rpcError) { console.error("RPC Error:", rpcError); throw new Error("System Error"); }
            if (isAbuser === true) throw new Error("Usage limit reached");

                        // C. DYNAMIC WELCOME GIFT
            if (code === welcomeRule.code) {
                if (userOrderCount > 0) throw new Error("Only for new users");
                // Use the values from the Admin settings
                finalizePromo(welcomeRule.value, welcomeRule.type, welcomeRule.code, btn, orgText, msg, input);
                return;
            }

            // D. OTHER CODES
            const { data, error } = await sb.from('promocodes').select('*').ilike('code', code).single();
            if (error || !data) throw new Error("Invalid Code");
            
             // üö® NEW EXPIRY CHECK STARTS HERE üö®
            if (data.expires) {
                const now = new Date();
                const expiryDate = new Date(data.expires);
                if (now > expiryDate) {
                    throw new Error("Code Expired");
                }
            }
            // üö® END CHECK üö®

            // E. USAGE CHECK
            const { count: usageCount } = await sb.from('orders').select('*', { count: 'exact', head: true }).eq('user_id', currentUser.id).eq('promo_code', code);
            if (usageCount > 0) throw new Error("Code already used");
            
            
            
            // F. SUCCESS
            finalizePromo(data.value, data.type, data.code, btn, orgText, msg, input);

        } catch (e) {
            console.warn(e);
            let userMsg = "Invalid Code";
            if (e.message === "Invalid Code") userMsg = "Invalid Code";
            else if (e.message === "Code already used") userMsg = "You already used this code";
            else if (e.message === "Only for new users") userMsg = "First order only";
            else if (e.message === "Usage limit reached") userMsg = "Code limit reached";
            else if (e.message.includes("System Error")) userMsg = "System Error - Try Again";

            msg.innerText = userMsg; 
            msg.className = "absolute -bottom-5 left-1 text-[10px] font-bold text-red-500 transition-all";
            msg.classList.remove('hidden'); 
            
            btn.innerHTML = orgText; btn.disabled = false;
        }
    };

    window.finalizePromo = function(value, type, code, btn, orgText, msg, input) {
        currentPromoRule = { code: code, type: type, value: value }; 
        activePromoCode = code;
        
        msg.innerText = "Code applied!"; 
        msg.className = "absolute -bottom-5 left-1 text-[10px] font-bold text-green-600 transition-all";
        msg.classList.remove('hidden');
        
        input.disabled = true; btn.classList.add('hidden'); document.getElementById('btn-remove-promo').classList.remove('hidden');
        btn.innerHTML = orgText; btn.disabled = false;
        updateCartUI(); 
    };

    window.removePromo = () => {
        currentPromoRule = null;
        activeDiscount = 0; activePromoCode = "";
        const input = document.getElementById('promo-input'); if(input) { input.value = ""; input.disabled = false; }
        document.getElementById('btn-apply-promo').classList.remove('hidden'); document.getElementById('btn-remove-promo').classList.add('hidden');
        const msg = document.getElementById('promo-msg'); if(msg) msg.innerText = "";
        updateCartUI();
    }

    window.useSavedCoupon = (code) => {
        const input = document.getElementById('promo-input');
        if(input) {
            input.value = code;
            input.classList.add('bg-orange-50', 'text-orange-600');
            setTimeout(() => input.classList.remove('bg-orange-50', 'text-orange-600'), 300);
            applyPromoCode();
        }
    }

    // --- 7. CART CALCULATIONS ---
    window.updateCartUI = () => {
        const container = document.getElementById('cart-items');
        if (!container) return; 
        container.innerHTML = ""; 
        const fab = document.getElementById('fab-container');
        
        // 1. Calculate Total Items Count (FIXED)
        const totalQty = cart.reduce((sum, i) => sum + i.qty, 0);
        if(document.getElementById('cart-count')) {
            document.getElementById('cart-count').innerText = totalQty;
        }

        if (cart.length === 0) {
            container.innerHTML = `<div class="text-center py-10 opacity-50"><div class="text-4xl mb-2">üçî</div><p class="text-sm font-bold text-slate-400">Your basket is empty</p></div>`;
            currentPromoRule = null; activeDiscount = 0; activePromoCode = "";
            document.querySelectorAll('[id="cart-total"], [id="checkout-total"]').forEach(el => el.innerText = "0.00 SR");
            if (fab) fab.classList.add('translate-y-32'); 
            return;
        }

        const subtotal = cart.reduce((s, i) => s + (i.unitPrice * i.qty), 0);
        let discountAmount = 0;

        if (currentPromoRule) {
            if (currentPromoRule.type === 'percent') {
                let percentage = parseFloat(currentPromoRule.value);
                if (percentage > 1) percentage = percentage / 100;
                discountAmount = subtotal * percentage;
                if (discountAmount > 30) discountAmount = 30; 
            } else {
                discountAmount = parseFloat(currentPromoRule.value);
            }
            if(discountAmount > subtotal) discountAmount = subtotal;

            const pMsg = document.getElementById('promo-msg');
            if(pMsg) { 
                pMsg.innerText = `Code applied! (SR ${discountAmount.toFixed(2)} Off)`; 
                pMsg.className = "absolute -bottom-5 left-1 text-[10px] font-bold text-green-600 transition-all";
                pMsg.classList.remove('hidden');
            }
        }
        
        activeDiscount = discountAmount; 
        const total = Math.max(0, subtotal - discountAmount);

        cart.forEach((item, index) => {
            let modText = item.selectedMods && item.selectedMods.length > 0 ? item.selectedMods.map(m => m.name).join(', ') : 'Regular';
            container.innerHTML += `<div class="flex flex-col border-b border-slate-50 pb-3 mb-3 last:border-0"><div class="flex justify-between items-start mb-2"><div><h4 class="font-black text-slate-800 text-sm flex items-center gap-2">${item.name} <button onclick="editCartItem(${index})" class="text-xs text-slate-300 hover:text-orange-500"><i class="fa-solid fa-pen"></i></button></h4><p class="text-[10px] text-slate-400 font-bold mt-0.5 leading-tight">${modText}</p></div><p class="font-black text-slate-900 text-sm">${(item.unitPrice * item.qty).toFixed(2)}</p></div><div class="flex justify-between items-center"><div class="flex items-center bg-slate-50 rounded-lg h-8 border border-slate-100"><button onclick="changeCartQty(${index}, -1)" class="w-8 h-full text-slate-400 hover:text-slate-900 font-bold transition">-</button><span class="text-xs font-black text-slate-800 w-6 text-center">${item.qty}</span><button onclick="changeCartQty(${index}, 1)" class="w-8 h-full text-slate-400 hover:text-slate-900 font-bold transition">+</button></div><button onclick="removeFromCart(${index})" class="text-red-400 hover:text-red-600 text-xs w-8 h-8 flex items-center justify-center bg-red-50 rounded-lg transition active:scale-90"><i class="fa-solid fa-trash-can"></i></button></div></div>`;
        });

        document.querySelectorAll('[id="cart-total"], [id="checkout-total"]').forEach(el => el.innerText = total.toFixed(2) + " SR");
        
        const couponList = document.getElementById('coupon-list');
        if(couponList) { (currentUser && userOrderCount === 0) ? couponList.classList.remove('hidden') : couponList.classList.add('hidden'); }
        if (fab) fab.classList.remove('translate-y-32');
    };
    
    window.openCart = () => { updateCartUI(); toggleSheet('checkoutModal', true); };

    // --- 8. ORDER PLACEMENT (NO PAYMENT CHECK) ---
    window.placeOrder = async (btn) => { 
    if(!isStoreOpen) {
            showToast("Store is closed. Cannot place order.", true);
            return;
        }
        if(!currentUser) return window.requireAuth(); 
        
        // Removed Checkbox Validation - Auto set to "Pay at Pickup"
        const payMethod = "Pay at Pickup"; 

        btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Processing`; btn.disabled = true; 
        setTimeout(async () => { 
            const subtotal = cart.reduce((s,i) => s + (i.unitPrice * i.qty), 0); 
            const total = Math.max(0, subtotal - activeDiscount); 
            try { 
                await sb.from('orders').insert({ 
                    user_id: currentUser.id, 
                    user_ip: userIP, 
                    items: cart, 
                    subtotal: subtotal, 
                    discount: activeDiscount, 
                    promo_code: activePromoCode, 
                    total: total, 
                    status: 'New Order', 
                    payment_method: payMethod, 
                    note: document.getElementById('order-note')?.value || "", 
                    device_id: deviceId  
                }); 
                
                // LOYALTY
                let earnedPoints = 0;
                if(loyaltyRules.type === 'percentage') {
                    earnedPoints = Math.floor(total * (loyaltyRules.value / 100));
                } else {
                    earnedPoints = parseInt(loyaltyRules.value);
                }
                
                        if(earnedPoints > 0) {
                    const { data: userNow } = await sb.from('users').select('points').eq('id', currentUser.id).single();
                    const newTotalPoints = (userNow?.points || 0) + earnedPoints;
                    
                    // 1. Update Database
                    await sb.from('users').update({ points: newTotalPoints }).eq('id', currentUser.id);
                    
                    // 2. Update Global Data & UI (THIS WAS MISSING)
                    if(userData) userData.points = newTotalPoints;
                    if(document.getElementById('loyalty-points')) {
                        document.getElementById('loyalty-points').innerText = newTotalPoints;
                    }
                }

                removePromo(); cart = []; updateCartUI(); 
                btn.classList.add('bg-green-force'); btn.innerHTML = `<i class="fa-solid fa-check mr-2"></i> Success!`; showToast(`Order placed! +${earnedPoints} pts`); 
                setTimeout(async () => { closeCart(); if (typeof renderTrackerList === 'function') { await renderTrackerList(currentUser.id); } switchView('track'); btn.classList.remove('bg-green-force'); btn.innerHTML = `Place Order <i class="fa-solid fa-arrow-right"></i>`; btn.disabled = false; }, 1000); 
            } catch(e) { console.log("Order Error", e); btn.innerText = "Try Again"; btn.disabled = false; showToast("Failed to place order", true); } 
        }, 1500); 
    };

    // --- 9. PROFILE & UTILS ---
        async function loadUserProfile(uid) { 
        // 1. Try to fetch the user profile
        let { data, error } = await sb.from('users').select('*').eq('id', uid).single(); 
        
        // üõ†Ô∏è SELF-HEALING: If profile is missing (error or null), create it immediately!
        if(error || !data) { 
            console.log("‚ö†Ô∏è Profile missing. Auto-fixing...");
            
            // Fallback: Get data from the Auth Metadata (which we know exists)
            const meta = currentUser.user_metadata || {};
            
            // Construct a fresh profile object
            const recoveryProfile = { 
                id: uid, 
                name: meta.name || 'User',    // Use Auth name or default
                email: currentUser.email, 
                phone: meta.phone || '',      // Use Auth phone
                points: 0, 
                joined: new Date().toLocaleDateString(), 
                avatar: `https://ui-avatars.com/api/?name=${meta.name||'User'}&background=FF5722&color=fff` 
            };

            // Insert it into the DB so it's fixed forever
            const { error: insertErr } = await sb.from('users').insert(recoveryProfile);
            
            if(insertErr) console.error("Auto-fix failed:", insertErr);
            
            // Use this fresh data for the UI right now
            data = recoveryProfile;
        } 
        
        // 2. Update Global Data
        userData = data; 
        
        // 3. Update UI Elements
        document.getElementById('profile-name').innerText = userData.name || "User"; 
        document.getElementById('profile-email').innerText = userData.email || "No Email"; 
        
        // PHONE FIX: Set value and ensure it's locked
        const phoneInput = document.getElementById('profile-phone-input');
        phoneInput.value = userData.phone || "";
        phoneInput.readOnly = true;

        document.getElementById('loyalty-points').innerText = userData.points || 0; 
        document.getElementById('profile-joined').innerText = userData.joined || new Date(currentUser.created_at).toLocaleDateString(); 
        
        const av = userData.avatar || `https://ui-avatars.com/api/?name=${userData.name}&background=FF5722&color=fff`; 
        document.getElementById('profile-avatar').src = av; 
        const headerAvatar = document.getElementById('header-avatar');
        if (headerAvatar) headerAvatar.src = av; 
        
        // 4. Load Orders
        const { data: orders, count } = await sb.from('orders').select('*', { count: 'exact' }).eq('user_id', uid).order('created_at', {ascending: false}); 
        userOrderCount = count || 0; 
        document.getElementById('profile-total-orders').innerText = count || 0; 
        
        if(orders && orders.length) { 
            document.getElementById('order-history').innerHTML = orders.map(o => `<div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group"><div class="flex justify-between items-start mb-3"><div><span class="bg-slate-100 text-slate-600 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wider">#${o.id}</span><span class="text-[10px] text-slate-400 font-bold ml-2">${new Date(o.created_at).toLocaleDateString()}</span></div><span class="font-black text-slate-800">SR ${o.total.toFixed(2)}</span></div><div class="flex justify-between items-center border-t border-slate-50 pt-3"><span class="text-xs font-bold text-orange-500">${o.status}</span><button onclick="triggerReorder(${o.id})" class="bg-orange-50 text-orange-600 text-xs font-bold px-4 py-2 rounded-lg hover:bg-orange-100 transition"><i class="fa-solid fa-rotate-right mr-1"></i> Reorder</button></div></div>`).join(''); 
        } else { 
            document.getElementById('order-history').innerHTML = `<div class="text-center py-8 text-slate-400 text-sm">No past orders found.</div>`; 
        } 
    }

    async function togglePhoneEdit(btn) { const input = document.getElementById('profile-phone-input'); const container = document.getElementById('phone-container'); if (input.hasAttribute('readonly')) { input.removeAttribute('readonly'); input.focus(); btn.innerText = "Save"; btn.classList.add('bg-green-force'); container.classList.add('ring-2', 'ring-orange-100', 'bg-white'); } else { setBtnLoading(btn, true, 'Saving'); try { await sb.auth.updateUser({ data: { phone: input.value } }); await sb.from('users').update({ phone: input.value }).eq('id', currentUser.id); showToast("Phone Saved!"); input.setAttribute('readonly', true); btn.innerHTML = "Update"; btn.classList.remove('bg-green-force'); container.classList.remove('ring-2', 'ring-orange-100', 'bg-white'); } catch(e) { showToast("Error updating phone"); } btn.disabled = false; } }
    window.removeAvatar = async () => { if(!currentUser) return; await sb.from('users').update({ avatar: null }).eq('id', currentUser.id); loadUserProfile(currentUser.id); showToast("Avatar Removed"); }
    
    // IMAGE CROPPER
    let cropper = null; 
    window.startCrop = (input) => { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = (e) => { const img = document.getElementById('crop-target'); img.src = e.target.result; document.getElementById('crop-modal').classList.add('active'); if(cropper) cropper.destroy(); cropper = new Cropper(img, { aspectRatio: 1, viewMode: 1 }); input.value = ''; }; reader.readAsDataURL(input.files[0]); } }; 
    window.closeCropper = () => { document.getElementById('crop-modal').classList.remove('active'); if(cropper) { cropper.destroy(); cropper = null; } }; 
    window.finishCrop = () => { 
        if(!cropper) return; 
        const btn = document.querySelector('#crop-modal button'); setBtnLoading(btn, true, 'Saving');
        cropper.getCroppedCanvas({ maxWidth: 300, maxHeight: 300, fillColor: 'transparent' }).toBlob(async (blob) => { 
            const fileName = `${currentUser.id}-${Date.now()}.png`; 
            const { error: uploadErr } = await sb.storage.from('images').upload(fileName, blob); 
            if(uploadErr) { showToast("Image upload failed", true); setBtnLoading(btn, false, 'Save Picture'); return; }
            const { data } = sb.storage.from('images').getPublicUrl(fileName); 
            const { error: dbErr } = await sb.from('users').update({ avatar: data.publicUrl }).eq('id', currentUser.id);
            if (!dbErr) { 
    // 1. Update the big profile picture
    const profilePic = document.getElementById('profile-avatar');
    if(profilePic) profilePic.src = data.publicUrl;

    // 2. Safely try to update the header avatar (if it exists)
    const headerPic = document.getElementById('header-avatar');
    if(headerPic) headerPic.src = data.publicUrl;

    showToast("Profile Picture Saved!"); 
}

            setBtnLoading(btn, false, 'Save Picture'); closeCropper(); 
        }, 'image/png'); 
    };

// --- FETCH DYNAMIC CATEGORIES ---
async function fetchCategories() {
    // 1. Fetch from settings (same as Admin)
    const { data } = await sb.from('settings').select('data').eq('id', 'menu_categories').single();
    
    let cats = ["Burger", "Fries", "Drink"]; // Default fallback
    if(data?.data?.categories) cats = data.data.categories;

    // 2. Render Buttons
    const container = document.getElementById('category-list');
    if(container) {
        // Start with the "All" button
        let html = `<button onclick="filterMenu('all', this)" class="cat-btn active bg-slate-900 text-white border border-slate-900 px-6 py-2.5 rounded-full font-bold text-sm whitespace-nowrap shadow-md transition-all">All</button>`;
        
        // Loop through your categories and make buttons
        cats.forEach(c => {
            html += `<button onclick="filterMenu('${c}', this)" class="cat-btn bg-white text-slate-600 border border-slate-200 px-6 py-2.5 rounded-full font-bold text-sm whitespace-nowrap shadow-sm hover:border-orange-200 transition-all">${c}</button>`;
        });
        
        container.innerHTML = html;
    }
}

        window.triggerReorder = async (oid) => { 
        // üîí SECURITY CHECK
        if(!isStoreOpen) {
            showToast("Store is currently closed", true);
            return;
        }

        const { data } = await sb.from('orders').select('*').eq('id', oid).single(); 
        if(data && data.items) { 
            cart = data.items; 
            updateCartUI(); 
            openCart(); 
        } 
    }

    

    // --- 10. REALTIME TRACKER ---
    let orderSubscription = null;

    function listenToOrders(uid) {
        if (orderSubscription) sb.removeChannel(orderSubscription);
        const channelName = `orders-tracker-${uid}-${Date.now()}`;
        orderSubscription = sb.channel(channelName)
            .on(
                'postgres_changes', 
                { event: '*', schema: 'public', table: 'orders', filter: `user_id=eq.${uid}` }, 
                (payload) => {
                    console.log("üîî Order Update Detected:", payload);
                    renderTrackerList(uid); 
                    if(payload.new && payload.new.status === 'Completed') { loadUserProfile(uid); }
                }
            )
            .subscribe((status) => {
                if (status === 'SUBSCRIBED') { console.log("üü¢ Live Tracker Connected"); }
                else if (status === 'CHANNEL_ERROR') { setTimeout(() => listenToOrders(uid), 5000); }
            });
        renderTrackerList(uid); 
    }
    
    async function fetchQueueCount() { const { count } = await sb.from('orders').select('*', { count: 'exact', head: true }).or('status.eq.Preparing,status.eq.Cooking'); return count || 0; }
    
    async function renderTrackerList(uid) { 
        const {data} = await sb.from('orders').select('*').eq('user_id', uid).neq('status', 'Completed').order('created_at', {ascending: false}); 
        const container = document.getElementById('active-tracker-container'); 
        const queue = await fetchQueueCount(); 
        if(!data || !data.length) { if(document.getElementById('track-badge')) document.getElementById('track-badge').classList.add('hidden'); container.innerHTML='<div class="text-center py-20 text-slate-400"><i class="fa-solid fa-receipt text-4xl mb-4"></i><p>No active orders.</p></div>'; return; } 
        if(document.getElementById('track-badge')) document.getElementById('track-badge').classList.remove('hidden'); 
        container.innerHTML = data.map(order => createTrackerCard(order, queue)).join(''); 
        startTicker(); 
    }
    
    function startTicker() { 
        if(window.trackerInterval) clearInterval(window.trackerInterval); 
        window.trackerInterval = setInterval(() => { document.querySelectorAll('.dynamic-timer').forEach(el => { const status = el.dataset.status; if(status === 'New Order') { el.innerText = "--:--"; return; } if(status === 'Ready') { el.innerText = "Pickup Now"; return; } const target = parseInt(el.dataset.target); const now = Date.now(); const diff = target - now; if(diff <= 0) { el.innerText = "Finishing up..."; el.classList.add('text-green-600'); } else { const m = Math.floor(diff / 60000); const s = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0'); el.innerText = `${m}:${s}`; el.classList.remove('text-green-600'); } }); }, 1000); 
    }        
    
    function createTrackerCard(order, queueCount) { let step = 1; let txt = "We've received your order, waiting for the chef!";    const estimatedMins = order.estimated_mins || (10 + (queueCount * 3)); const createdAt = new Date(order.created_at).getTime(); const targetTime = createdAt + (estimatedMins * 60000); if(order.status === 'Preparing' || order.status === 'Cooking') { step = 2; txt = "Your food is sizzling on the grill!"; } if(order.status === 'Ready') { step = 3; txt = "It's ready! Come pick it up."; } let itemsHtml = order.items.map(i => { let mods = ''; if (i.selectedMods && i.selectedMods.length > 0) { mods = i.selectedMods.map(m => `<div class="text-xs text-slate-400 pl-4 py-0.5">‚Ä¢ ${m.name}</div>`).join(''); } return `<div class="mb-3 border-b border-slate-50 last:border-0 pb-2 last:pb-0"><div class="font-bold text-slate-700 text-sm flex justify-between"><span>${i.qty}x ${i.name}</span></div>${mods}</div>`; }).join(''); const payMethod = order.payment_method || 'Cash'; const promoBadge = order.promo_code ? `<span class="bg-purple-100 text-purple-600 px-1.5 py-0.5 rounded text-[10px] font-bold ml-1">PROMO: ${order.promo_code}</span>` : ''; const promoStrikethrough = order.promo_code ? `<span class="line-through text-slate-400 mr-2 text-[10px]">SR ${order.subtotal.toFixed(2)}</span>` : ''; return `<div class="bg-white rounded-3xl p-6 shadow-xl border border-slate-100 animate-[slideUp_0.4s] mb-4"><div class="flex justify-between items-center mb-6"><div><h3 class="text-xl font-bold">Order #${order.id}</h3><span class="dynamic-timer text-xs text-slate-400 font-bold" data-target="${targetTime}" data-status="${order.status}">Calculating...</span></div><span class="bg-slate-900 text-white text-xs px-2 py-1 rounded font-bold">${order.status}</span></div><div class="step-container flex justify-between items-center relative mb-6"><div class="step-line-container"><div class="step-line-fill" style="width: ${step === 1 ? '0%' : step === 2 ? '50%' : '100%'}"></div></div><div class="step-circle ${step >= 1 ? 'active' : ''}">1</div><div class="step-circle ${step >= 2 ? 'active' : ''}">2</div><div class="step-circle ${step >= 3 ? 'active' : ''}">3</div></div><div class="bg-orange-50 text-orange-600 rounded-xl p-4 text-center mb-6 text-sm font-bold shadow-sm"><i class="fa-solid fa-bell mr-2 animate-bounce"></i> ${txt}</div><div class="bg-slate-50 p-4 rounded-xl font-medium text-left">${itemsHtml}</div><div class="mt-3 pt-3 border-t border-slate-200 flex flex-col gap-2"><div class="flex justify-between items-center"><span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Total</span><div class="flex items-baseline">${promoStrikethrough}<span class="text-xs font-bold text-slate-800 mr-0.5">SR</span><span class="text-2xl font-black text-slate-900">${order.total.toFixed(2)}</span></div></div><div class="flex justify-between items-center"><span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Paid Via</span><div class="flex items-center"><span class="bg-orange-100 text-orange-600 px-2 py-0.5 rounded text-[10px] font-bold uppercase"><i class="fa-solid fa-credit-card mr-1"></i> ${payMethod}</span>${promoBadge}</div></div></div></div>`; }

    // --- 11. GESTURES ---
        const setupSwipe = (cardId, closeFn) => {
        const card = document.getElementById(cardId);
        const content = card.querySelector('.overflow-y-auto'); 
        let startY = 0, currentY = 0, isDragging = false;
        
        // ‚úÖ THRESHOLD: 50% of screen height (Must drag halfway down to close)
        const threshold = window.innerHeight * 0.4; 

        card.addEventListener('touchstart', e => {
            if (lockProductSwipe || e.target.closest('input, textarea, button, .no-drag')) return;
            // Only allow drag if we are at the top of the scrollable content
            if(content && content.scrollTop > 0) return;
            
            startY = e.touches[0].clientY; 
            currentY = startY; 
            isDragging = true;
        }, {passive: true});

        card.addEventListener('touchmove', e => {
            if(!isDragging) return;
            currentY = e.touches[0].clientY; 
            const diff = currentY - startY;
            
            // Only allow dragging downwards (positive diff)
            if (diff > 0) { 
                e.preventDefault(); 
                card.style.transition = 'none'; 
                card.style.transform = `translateY(${diff}px)`; 
            } else { 
                isDragging = false; 
            }
        }, {passive: false});

        card.addEventListener('touchend', e => {
            if(!isDragging) return; 
            isDragging = false; 
            
            // Add smooth transition for the snap
            card.style.transition = 'transform 0.6s cubic-bezier(0.32, 0.72, 0, 1)'; 
            
            if(currentY - startY > threshold) { 
                // Dragged far enough? CLOSE IT.
                closeFn(); 
            } else { 
                // Not far enough? SNAP BACK TO TOP.
                // ‚ùå OLD BUG: card.style.transform = ''; (This reset it to CLOSED)
                // ‚úÖ NEW FIX: Force it back to 0 (OPEN)
                card.style.transform = 'translateY(0)'; 
                
                setTimeout(() => { card.style.transition = ''; }, 600); 
            }
        });
    };
    
        // --- OTP VISUAL LOGIC ---
    // This listens to the invisible input and updates the visible boxes
    document.getElementById('otp-input').addEventListener('input', function(e) {
        const val = e.target.value.replace(/\D/g, ''); // Numbers only
        e.target.value = val; // Force input to be numbers
        
        // Fill the boxes
        for(let i=0; i<4; i++) {
            const box = document.getElementById(`otp-box-${i}`);
            if (val[i]) {
                box.innerText = val[i];
                box.classList.add('border-orange-500', 'bg-white');
                box.classList.remove('border-slate-200', 'bg-slate-50');
            } else {
                box.innerText = '';
                box.classList.remove('border-orange-500', 'bg-white');
                box.classList.add('border-slate-200', 'bg-slate-50');
            }
        }
    });

    // --- RESEND TIMER LOGIC ---
    function startResendTimer() {
        const btn = document.getElementById('btn-resend-otp');
        const label = document.getElementById('resend-timer');
        let timeLeft = 60; // 1 minute in seconds

        btn.disabled = true;
        btn.classList.add('text-slate-400');
        btn.classList.remove('text-orange-500', 'border-orange-200');

        if (resendInterval) clearInterval(resendInterval);

        resendInterval = setInterval(() => {
            timeLeft--;
            
            // Format time (e.g., "00:59")
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            label.innerText = `0${minutes}:${seconds < 10 ? '0'+seconds : seconds}`;

            if (timeLeft <= 0) {
                clearInterval(resendInterval);
                // Enable the button
                btn.disabled = false;
                label.innerText = "Now";
                btn.classList.remove('text-slate-400');
                btn.classList.add('text-orange-500', 'border-orange-200');
            }
        }, 1000);
    }

    window.resendOtp = async () => {
        if (!pendingUserData) return;

        const btn = document.getElementById('btn-resend-otp');
        setBtnLoading(btn, true, 'Sending...');

        // Generate NEW code
        const newCode = Math.floor(1000 + Math.random() * 9000).toString();
        
        // Send it
        const { error } = await sb.rpc('send_whatsapp_otp', { 
            phone: pendingUserData.phone, 
            otp: newCode 
        });

        if (error) {
            showToast("Failed to resend code", true);
            setBtnLoading(btn, false);
            return; // Don't reset timer if it failed
        }

        // Update Global Data
        pendingOtpCode = newCode;
        otpExpiryTime = Date.now() + (5 * 60 * 1000); // Reset 5-min expiry
        
        showToast("New code sent!");
        
        // Reset UI
        setBtnLoading(btn, false); // Stop loading spinner
        startResendTimer(); // Restart 1-min timer
    };
    
    async function forceAppSync() {
    // 1. Prevent spamming
    if(wakeThrottle) return;
    wakeThrottle = true;
    setTimeout(() => wakeThrottle = false, 5000); 

    console.log("üöÄ Wake-up detected. Syncing...");

    // 2. SHOW TOAST
    const t = document.getElementById('toast');
    if(t) {
        document.getElementById('toast-icon').className = "fa-solid fa-rotate fa-spin text-orange-500";
        document.getElementById('toast-msg').innerText = "Updating status...";
        t.classList.add('show');

        // üëá THE FIX: Force hide after 3 seconds NO MATTER WHAT
        // We do this immediately so it can never get stuck.
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    // 3. ATTEMPT SYNC (Safety Wrapped)
    try {
        // Wait 1.5s for Wi-Fi to reconnect
        await new Promise(r => setTimeout(r, 1500));

        if (currentUser) {
            await renderTrackerList(currentUser.id);
            
            // Refresh Realtime
            if (orderSubscription) await sb.removeChannel(orderSubscription);
            listenToOrders(currentUser.id);
        }
    } catch (err) {
        console.log("Sync warning:", err);
        // Even if this crashes, the toast is already gone!
    }
}


       
    setupSwipe('productCard', closeModal);
    setupSwipe('checkoutCard', closeCart);

    loadData();
</script>
</body>
</html>

