<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TARI Admin - Command Center</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        
        /* --- PRO TITLES & HEADERS --- */
.pro-header { 
    display: flex; align-items: center; justify-content: space-between; 
    background: white; padding: 20px; border-radius: 20px; 
    border: 1px solid #F1F5F9; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
    margin-bottom: 24px;
}
.pro-title { font-weight: 800; font-size: 1.5rem; letter-spacing: -0.02em; color: #1E293B; }
.pro-subtitle { font-size: 0.875rem; color: #94A3B8; font-weight: 600; margin-top: 4px; }

/* --- SMOOTH DRAG ANIMATIONS --- */
/* The item being dragged (High Z-Index, Pop effect) */
.sortable-drag { 
    opacity: 1 !important; background: white !important; 
    transform: scale(1.05) rotate(2deg); 
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
    cursor: grabbing !important; z-index: 9999;
}
/* The empty space where it will land */
.sortable-ghost { 
    opacity: 0.3; background: #F8FAFC; 
    border: 2px dashed #CBD5E1; border-radius: 16px; 
    transform: scale(0.95);
}
/* The item when you hold it but haven't moved yet */
.sortable-chosen {
    background: #FFF7ED;
}

/* --- ELEGANT INPUTS --- */
.input-box {
    width: 100%;
    padding: 14px 16px; /* Bigger padding for pro feel */
    background: #F8FAFC;
    border: 1px solid #E2E8F0;
    border-radius: 14px; /* Softer corners */
    outline: none;
    font-size: 14px;
    font-weight: 600;
    color: #334155;
    transition: all 0.2s;
}
.input-box::placeholder {
    color: #94A3B8;
    font-weight: 500;
}
.input-box:focus {
    border-color: #CBD5E1; /* Subtle focus border */
    background: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.03); /* Soft shadow on focus */
}

/* Custom Select Arrow */
select.input-box {
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394A3B8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 1em;
}

/* Remove Image Button */
.btn-remove-img {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(239, 68, 68, 0.9);
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transition: all 0.2s;
    z-index: 20;
}
.btn-remove-img:hover { transform: scale(1.1); background: #EF4444; }


        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #F8FAFC; -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass-card { background: white; border: 1px solid #E2E8F0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border-radius: 16px; transition: transform 0.2s; }
        .input-box { width: 100%; padding: 12px; background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 12px; outline: none; font-size: 14px; transition: all 0.2s; }
        .input-box:focus { border-color: #FF5722; background: white; }
        .btn-main { background: #1E293B; color: white; font-weight: 700; padding: 12px 24px; border-radius: 12px; transition: all 0.2s; text-align: center; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-main:active { transform: scale(0.96); }
        .btn-main:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
        
        /* Sidebar & Layout */
        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 50; }
        .sidebar-open { transform: translateX(0) !important; }
        #sidebar-overlay { transition: opacity 0.3s; pointer-events: none; opacity: 0; }
        .overlay-active { pointer-events: auto !important; opacity: 1 !important; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 12px; font-weight: 600; color: #64748B; cursor: pointer; transition: all 0.2s; margin-bottom: 4px; }
        .nav-item:hover { background-color: #F1F5F9; }
        .nav-item.active { background: linear-gradient(135deg, #FF5722 0%, #FF8A50 100%); color: white; box-shadow: 0 4px 12px rgba(255, 87, 34, 0.2); }
        
        /* Uploaders */
        .img-uploader { position: relative; border: 2px dashed #CBD5E1; border-radius: 16px; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; background: #F8FAFC; transition: all 0.2s; }
        .img-uploader:hover { border-color: #FF5722; background: #FFF7ED; }
        
        /* Cropper Modal */
        #crop-modal { opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 200; }
        #crop-modal.active { opacity: 1; pointer-events: auto; }
        
        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #22c55e; }
        .toggle-checkbox:checked + .toggle-label { background-color: #22c55e; }
        
        /* Preloader */
        #preloader { position: fixed; inset: 0; background: #F8FAFC; z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s; pointer-events: none; }
        #preloader.loaded { opacity: 0; }
        
        /* Utilities */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .sortable-ghost { opacity: 0.4; background: #FFF7ED; border: 2px dashed #FF5722; }
        #toast-container { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%) translateY(100px); opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 99999; pointer-events: none; }
        #toast-container.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col md:flex-row overflow-hidden bg-slate-50">

    <div id="preloader"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500"></div></div>
    
    <div id="crop-modal" class="fixed inset-0 bg-slate-900/95 backdrop-blur-sm flex flex-col items-center justify-center p-6">
        <div class="bg-white rounded-3xl w-full max-w-lg flex flex-col overflow-hidden shadow-2xl h-[70vh]">
            <div class="p-4 border-b flex justify-between items-center bg-white z-10">
                <h3 class="font-bold text-lg">Adjust Image</h3>
                <button onclick="closeCropper()" class="text-slate-400 hover:text-slate-800"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            <div class="flex-1 bg-slate-900 relative w-full overflow-hidden">
                <img id="crop-target" class="max-w-full max-h-full block">
            </div>
            <div class="p-4 border-t bg-white flex justify-end gap-3">
                <button onclick="finishCrop()" class="w-full bg-orange-500 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition">Save Crop</button>
            </div>
        </div>
    </div>

    <div id="toast-container" class="bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3"><i class="fa-solid fa-circle-check text-green-400 text-lg"></i><span id="toast-msg" class="font-bold text-sm">Success</span></div>

    <div id="auth-overlay" class="fixed inset-0 bg-slate-900 z-[150] flex items-center justify-center p-6">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm text-center">
            <div class="w-16 h-16 bg-orange-100 rounded-2xl flex items-center justify-center mx-auto mb-6 text-3xl">üöõ</div>
            <h2 class="text-2xl font-black mb-2">Admin Portal</h2>
            <input type="email" id="admin-email" placeholder="Email" class="input-box mb-3"><input type="password" id="admin-pass" placeholder="Password" class="input-box mb-6"><button onclick="handleAdminLogin()" id="btn-unlock" class="btn-main w-full bg-orange-600 shadow-lg">Unlock</button>
        </div>
    </div>

    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 z-30 bg-slate-900/20 backdrop-blur-sm md:hidden"></div>
    <aside id="sidebar" class="fixed inset-y-0 left-0 w-72 bg-white border-r border-slate-100 flex flex-col z-50 transform -translate-x-full md:translate-x-0 md:relative shadow-2xl md:shadow-none">
        <div class="p-8 hidden md:block">
            <h1 class="text-3xl font-black">TARI<span class="text-orange-500">.</span></h1>
            <p class="text-[10px] font-bold text-slate-400 uppercase mt-1">Admin Console</p>
            <div class="mt-6 flex items-center justify-between bg-slate-50 p-3 rounded-xl border border-slate-100">
                <span class="text-sm font-bold text-slate-600" id="store-status-text-d">Store Closed</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="store-toggle-d" class="sr-only peer" onchange="toggleStore(this.checked)">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                </label>
            </div>
        </div>
        
        <div class="p-6 md:hidden flex justify-between items-center border-b border-slate-50"><span class="font-black text-xl">Menu</span><button onclick="toggleSidebar()"><i class="fa-solid fa-xmark"></i></button></div>
        <nav class="flex-1 px-4 space-y-1 overflow-y-auto py-4">
            <div onclick="switchTab('dashboard')" class="nav-item active" id="nav-dashboard"><i class="fa-solid fa-chart-pie w-5"></i> Dashboard</div>
            <div onclick="switchTab('orders')" class="nav-item" id="nav-orders"><i class="fa-solid fa-fire-burner w-5"></i> Live Orders</div>
            <div onclick="switchTab('notifications')" class="nav-item" id="nav-notifications"><i class="fa-solid fa-bell w-5"></i> Notifications</div>
            <div onclick="switchTab('website')" class="nav-item" id="nav-website"><i class="fa-solid fa-globe w-5"></i> Website</div>
            <div onclick="switchTab('history')" class="nav-item" id="nav-history"><i class="fa-solid fa-clock-rotate-left w-5"></i> History</div>
            <div onclick="switchTab('menu')" class="nav-item" id="nav-menu"><i class="fa-solid fa-burger w-5"></i> Menu & Sorting</div>
            <div onclick="switchTab('promo')" class="nav-item" id="nav-promo"><i class="fa-solid fa-ticket w-5"></i> Promo Codes</div>
            <div onclick="switchTab('content')" class="nav-item" id="nav-content"><i class="fa-solid fa-images w-5"></i> App Content</div>
            <div onclick="switchTab('info')" class="nav-item" id="nav-info"><i class="fa-solid fa-store w-5"></i> Info & Hours</div>
            <div onclick="switchTab('trans')" class="nav-item" id="nav-trans">
    <i class="fa-solid fa-language w-5"></i> Arabic Translations
</div>

        </nav>
        <div class="p-6 border-t border-slate-50">
            <button onclick="logout()" class="w-full flex items-center justify-center gap-2 p-3 font-bold text-red-500 bg-red-50 hover:bg-red-100 rounded-xl transition text-sm">Log Out</button>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto relative pt-20 md:pt-8 px-4 md:px-10 pb-10 scroll-smooth h-full">
        <header class="md:hidden fixed top-0 left-0 w-full bg-white/90 backdrop-blur-md border-b border-slate-100 z-40 px-5 py-3 flex justify-between items-center pt-safe h-16">
            <div class="flex items-center gap-3"><button onclick="toggleSidebar()" class="w-10 h-10 bg-slate-50 rounded-xl flex items-center justify-center text-slate-600"><i class="fa-solid fa-bars text-lg"></i></button><h1 class="text-xl font-black">TARI<span class="text-orange-500">.</span></h1></div>
            <div class="flex items-center gap-3">
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="store-toggle-m" class="sr-only peer" onchange="toggleStore(this.checked)">
                    <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-500"></div>
                </label>
                <div class="bg-green-100 text-green-600 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-2"><div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> <span id="mobile-live-count">0</span></div>
            </div>
        </header>

        <div id="tab-dashboard" class="tab-content max-w-7xl mx-auto h-full animate-[fadeIn_0.2s]">
            <h2 class="text-2xl font-bold mb-6">Today's Overview</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><p class="text-slate-400 text-sm font-bold uppercase">Orders Today</p><h3 class="text-4xl font-black text-slate-800 mt-2" id="dash-orders">0</h3></div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><p class="text-slate-400 text-sm font-bold uppercase">Revenue</p><h3 class="text-4xl font-black text-orange-500 mt-2" id="dash-revenue">SR 0</h3></div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><p class="text-slate-400 text-sm font-bold uppercase">Top Item</p><h3 class="text-2xl font-bold text-slate-800 mt-2 truncate" id="dash-top-item">--</h3></div>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6"><h3 class="font-bold mb-4">Recent Activity</h3><div id="dash-activity" class="space-y-4 text-sm text-slate-500">Loading activity...</div></div>
        </div>

        <div id="tab-notifications" class="tab-content hidden max-w-4xl mx-auto animate-[fadeIn_0.2s]">

            <h2 class="text-2xl font-bold mb-6">Notification Center</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="glass-card p-6 h-fit">
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2"><i class="fa-solid fa-volume-high text-orange-500"></i> Alert Sound</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase">Select Sound</label>
                            <select id="sound-select" class="input-box mt-1" onchange="saveSoundSettings()">
                                <option value="bell">üõéÔ∏è Service Bell</option>
                                <option value="chime">‚ú® Magic Chime</option>
                                <option value="tech">ü§ñ Tech Alert</option>
                                <option value="custom">üìÇ Custom Upload</option>
                            </select>
                        </div>
                        
                        <div id="custom-sound-upload" class="hidden">
                            <label class="block w-full py-3 border-2 border-dashed border-slate-300 rounded-xl text-center cursor-pointer hover:bg-slate-50 transition">
                                <span class="text-xs font-bold text-slate-500"><i class="fa-solid fa-upload mr-1"></i> Upload MP3/WAV</span>
                                <input type="file" id="sound-file-input" class="hidden" accept="audio/*" onchange="uploadCustomSound(this)">
                            </label>
                            <p id="custom-file-name" class="text-xs text-green-500 font-bold mt-2 text-center"></p>
                        </div>

                        <button onclick="playNotification()" class="w-full py-3 bg-slate-900 text-white rounded-xl font-bold text-sm shadow-lg active:scale-95 transition"><i class="fa-solid fa-play mr-2"></i> Test Sound</button>
                    </div>
                </div>

                <div class="glass-card p-6 h-fit">
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2"><i class="fa-solid fa-bell text-orange-500"></i> Popups & Mobile</h3>
                    <div class="space-y-4">
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 flex justify-between items-center">
                            <div>
                                <p class="font-bold text-sm text-slate-700">Browser Permission</p>
                                <p id="perm-status" class="text-xs text-slate-400 font-bold">Checking...</p>
                            </div>
                            <div id="perm-indicator" class="w-3 h-3 rounded-full bg-slate-300"></div>
                        </div>
                        
                        <p class="text-xs text-slate-400 leading-relaxed">
                            <strong>Note for Android:</strong> You must click "Enable Notifications" below. If sound doesn't play automatically, click anywhere on the screen once to unlock audio permissions.
                        </p>

                        <button onclick="requestNotificationPermission()" class="w-full py-3 bg-orange-50 text-orange-600 border border-orange-200 rounded-xl font-bold text-sm shadow-sm active:scale-95 transition hover:bg-orange-100">Enable Notifications</button>
                    </div>
                </div>
            </div>
        </div>
<div id="tab-trans" class="tab-content hidden max-w-4xl mx-auto animate-[fadeIn_0.2s]">
    <div class="pro-header">
        <div>
            <h2 class="pro-title">Arabic Translation Manager</h2>
            <p class="pro-subtitle">Translate your menu and categories for the Arabic app.</p>
        </div>
        <button onclick="saveTranslations(this)" class="btn-main bg-slate-900 shadow-lg">
            <i class="fa-solid fa-floppy-disk"></i> Save Translations
        </button>
    </div>

    <div class="bg-orange-50 border border-orange-100 p-4 rounded-xl flex items-start gap-3 mb-6">
        <i class="fa-solid fa-circle-info text-orange-500 mt-0.5"></i>
        <div class="text-sm text-slate-600">
            <strong>How this works:</strong> The English name from your menu is the "Key". Type the Arabic equivalent in the box. 
            The customer app will automatically look up the Arabic name using the English Key.
        </div>
    </div>

    <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
        <span class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center text-xs"><i class="fa-solid fa-layer-group"></i></span>
        Categories
    </h3>
    <div id="trans-cat-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
        </div>

    <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
        <span class="w-8 h-8 rounded-lg bg-orange-100 text-orange-600 flex items-center justify-center text-xs"><i class="fa-solid fa-burger"></i></span>
        Menu Items
    </h3>
    <div id="trans-item-list" class="space-y-3">
        </div>
            <h3 class="font-bold text-lg mb-4 flex items-center gap-2 mt-8">
        <span class="w-8 h-8 rounded-lg bg-purple-100 text-purple-600 flex items-center justify-center text-xs"><i class="fa-solid fa-star"></i></span>
        Splash Screen
    </h3>
    <div id="trans-splash-list" class="grid grid-cols-1 gap-4 mb-8">
        </div>

    <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
        <span class="w-8 h-8 rounded-lg bg-green-100 text-green-600 flex items-center justify-center text-xs"><i class="fa-solid fa-list-check"></i></span>
        Modifiers & Options
    </h3>
    <div id="trans-mod-list" class="space-y-4">
        </div>

</div>

        <div id="tab-website" class="tab-content hidden max-w-4xl mx-auto h-full animate-[fadeIn_0.2s]">
            <h2 class="text-2xl font-bold mb-6">Website Settings</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="glass-card p-6 h-fit">
                    <h3 class="font-bold text-lg mb-4">Branding & Logo</h3>
                    <div class="space-y-4">
                        <div class="img-uploader h-32 bg-slate-50" onclick="document.getElementById('web-logo-input').click()">
                            <img id="web-logo-preview" class="absolute inset-0 w-full h-full object-contain p-2 hidden">
                            <div class="text-center">
                                <i class="fa-solid fa-image text-2xl text-slate-300 mb-1"></i>
                                <span class="block text-xs font-bold text-slate-400">Upload Truck Logo</span>
                            </div>
                            <input type="file" id="web-logo-input" class="hidden" accept="image/*" onchange="startCrop(this, 'web-logo')">
                        </div>
                        <p class="text-[10px] text-slate-400">This logo will appear at the top-left of the customer page.</p>
                    </div>
                </div>

                <div class="glass-card p-6 h-fit">
                    <h3 class="font-bold text-lg mb-4">Colors & Background</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase">Header Color</label>
                            <div class="flex items-center gap-3 mt-1">
                                <input type="color" id="web-header-color" class="w-12 h-10 rounded-lg cursor-pointer border border-slate-200" value="#ffffff">
                                <span class="text-sm font-bold text-slate-600">Top Bar Background</span>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase">Page Background Color</label>
                            <div class="flex items-center gap-3 mt-1">
                                <input type="color" id="web-bg-color" class="w-12 h-10 rounded-lg cursor-pointer border border-slate-200" value="#F8FAFC">
                                <span class="text-sm font-bold text-slate-600">Main Background</span>
                            </div>
                        </div>
                        
                        <div>
    <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Background Image (Optional)</label>
    <div class="img-uploader h-20" onclick="document.getElementById('web-bg-img-input').click()">
        <img id="web-bg-img-preview" class="absolute inset-0 w-full h-full object-cover hidden rounded-lg opacity-50">
        <span class="text-xs font-bold text-slate-400">Upload Background</span>
        <input type="file" id="web-bg-img-input" class="hidden" accept="image/*" onchange="startCrop(this, 'web-bg')">
    </div>
    <button id="btn-remove-bg" onclick="removeWebBg()" class="hidden w-full py-2 text-xs font-bold text-red-500 hover:bg-red-50 rounded-lg mt-1 transition"><i class="fa-solid fa-trash"></i> Remove Image</button>
</div>
            <button onclick="saveWebsiteSettings(this)" class="btn-main w-full mt-6 bg-slate-900 text-white shadow-lg">Save Website Changes</button>
          </div>
        </div>
     </div>
  </div>
 
        <div id="tab-orders" class="tab-content hidden max-w-7xl mx-auto h-full flex flex-col animate-[fadeIn_0.2s]">
            <div class="flex justify-between items-center mb-6"><div><h2 class="text-2xl font-bold">Kitchen Board</h2><p class="text-sm text-slate-400">Live order management</p></div><div class="bg-white px-4 py-2 rounded-xl shadow-sm border border-slate-100 font-bold text-sm flex items-center gap-2 hidden md:flex"><div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> <span id="live-count">0</span> Active</div></div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 flex-1 overflow-y-auto pb-safe">
                <div class="bg-slate-100/50 rounded-2xl p-4 border border-slate-200 flex flex-col h-fit md:h-auto"><h3 class="font-bold text-slate-500 text-xs uppercase mb-4 flex items-center gap-2 sticky top-0"><i class="fa-solid fa-circle text-blue-500 text-[8px]"></i> Incoming</h3><div id="col-new" class="space-y-3 flex-1 overflow-y-auto min-h-[100px]"></div></div>
                <div class="bg-orange-50/50 rounded-2xl p-4 border border-orange-100 flex flex-col h-fit md:h-auto"><h3 class="font-bold text-orange-600 text-xs uppercase mb-4 flex items-center gap-2 sticky top-0"><i class="fa-solid fa-circle text-orange-500 text-[8px]"></i> Cooking</h3><div id="col-cooking" class="space-y-3 flex-1 overflow-y-auto min-h-[100px]"></div></div>
                <div class="bg-green-50/50 rounded-2xl p-4 border border-green-100 flex flex-col h-fit md:h-auto"><h3 class="font-bold text-green-600 text-xs uppercase mb-4 flex items-center gap-2 sticky top-0"><i class="fa-solid fa-circle text-green-500 text-[8px]"></i> Ready</h3><div id="col-ready" class="space-y-3 flex-1 overflow-y-auto min-h-[100px]"></div></div>
            </div>
        </div>

        <div id="tab-history" class="tab-content hidden max-w-5xl mx-auto"><h2 class="text-2xl font-bold mb-6">Order History</h2><div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden"><table class="w-full text-left text-sm"><thead class="bg-slate-50 border-b border-slate-200"><tr><th class="p-4 font-bold">ID</th><th class="p-4 font-bold">Date</th><th class="p-4 font-bold">Items</th><th class="p-4 font-bold">Total</th><th class="p-4 font-bold">Payment</th></tr></thead><tbody id="history-list" class="divide-y divide-slate-100"></tbody></table></div></div>
        
        <div id="tab-menu" class="tab-content hidden max-w-5xl mx-auto">
    
    <div class="pro-header">
        <div>
            <h2 class="pro-title">Menu Manager</h2>
            <p class="pro-subtitle">Manage your food, categories, and options.</p>
        </div>
        <button onclick="saveMenuOrder(this)" id="save-order-btn" class="hidden bg-slate-900 text-white px-6 py-3 rounded-xl font-bold text-sm shadow-lg hover:bg-slate-800 transition transform active:scale-95">
            Save New Order
        </button>
    </div>

    <div class="flex gap-2 p-1 bg-slate-100 rounded-xl mb-8 w-fit">
        <button onclick="switchMenuSub('items')" id="sub-items" class="px-6 py-2.5 rounded-lg font-bold text-sm transition-all shadow-sm bg-white text-slate-900">Items</button>
        <button onclick="switchMenuSub('cats')" id="sub-cats" class="px-6 py-2.5 rounded-lg font-bold text-sm transition-all text-slate-500 hover:text-slate-900">Categories</button>
        <button onclick="switchMenuSub('mods')" id="sub-mods" class="px-6 py-2.5 rounded-lg font-bold text-sm transition-all text-slate-500 hover:text-slate-900">Modifiers</button>
    </div>

    <div id="view-items">
        <button onclick="openMenuModal()" class="w-full py-6 border-2 border-dashed border-slate-200 rounded-2xl text-slate-400 font-bold hover:bg-white hover:border-orange-400 hover:text-orange-500 transition mb-6 flex items-center justify-center gap-2 group">
            <div class="w-8 h-8 rounded-full bg-slate-100 group-hover:bg-orange-100 flex items-center justify-center transition"><i class="fa-solid fa-plus"></i></div> 
            Add New Menu Item
        </button>
        <div id="menu-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>

    <div id="view-cats" class="hidden">
        <div class="glass-card p-6 mb-6">
            <h3 class="font-bold text-lg mb-4">Add Category</h3>
            <div class="flex gap-3">
                <input id="new-cat-name" class="input-box" placeholder="Category Name (e.g. Burgers)">
                <button onclick="addCategory()" class="bg-slate-900 text-white px-6 rounded-xl font-bold text-sm hover:bg-slate-800 transition">Add</button>
            </div>
        </div>
        <div id="cats-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>

    <div id="view-mods" class="hidden">
        <button onclick="openModModal()" class="w-full py-6 border-2 border-dashed border-slate-200 rounded-2xl text-slate-400 font-bold hover:bg-white hover:border-orange-400 hover:text-orange-500 transition mb-6 flex items-center justify-center gap-2 group">
             <div class="w-8 h-8 rounded-full bg-slate-100 group-hover:bg-orange-100 flex items-center justify-center transition"><i class="fa-solid fa-layer-group"></i></div>
             Create Modifier Group
        </button>
        <div id="modifiers-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>
</div>

        
        <div id="tab-promo" class="tab-content hidden max-w-4xl mx-auto"><h2 class="text-2xl font-bold mb-6">Promotions</h2><div class="glass-card p-6 mb-8 bg-gradient-to-br from-orange-50 to-white border-orange-100"><div class="flex items-center gap-4 mb-4"><div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center text-orange-500 text-xl"><i class="fa-solid fa-user-plus"></i></div><div><h3 class="font-bold text-lg text-slate-800">New Customer Discount</h3><p class="text-sm text-slate-500">Applied to first order.</p></div></div><div class="flex flex-col gap-3">
    <div class="flex gap-3">
        <input id="new-user-code" type="text" class="input-box font-bold uppercase text-orange-600" placeholder="Code Name (e.g. WELCOME30)">
    </div>
    <div class="flex gap-3">
        <select id="new-user-type" class="input-box w-1/3"><option value="percent">% Off</option><option value="fixed">SR Off</option></select>
        <input id="new-user-val" type="number" class="input-box w-1/3" placeholder="Value">
        <button onclick="saveNewUserPromo(this)" class="btn-main w-1/3 bg-orange-500">Save</button>
    </div>
</div>
</div><div class="flex justify-between items-center mb-4"><h3<div class="glass-card p-6 mb-8 bg-gradient-to-br from-purple-50 to-white border-purple-100">
    <div class="flex items-center gap-4 mb-4">
        <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center text-purple-500 text-xl">
            <i class="fa-solid fa-crown"></i>
        </div>
        <div>
            <h3 class="font-bold text-lg text-slate-800">Loyalty Rewards</h3>
            <p class="text-sm text-slate-500">How do customers earn points?</p>
        </div>
    </div>
    
    <div class="flex gap-4 items-end">
        <div class="w-1/2">
            <label class="text-xs font-bold text-slate-400 uppercase">Reward Type</label>
            <select id="loyalty-type" class="input-box mt-1 bg-white">
                <option value="fixed">Fixed (Points per Order)</option>
                <option value="percentage">Percentage (1 Pt per 1 SR)</option>
            </select>
        </div>
        <div class="w-1/4">
             <label class="text-xs font-bold text-slate-400 uppercase">Value</label>
             <input id="loyalty-val" type="number" class="input-box mt-1" placeholder="10">
        </div>
        <button onclick="saveLoyaltySettings(this)" class="btn-main w-1/4 bg-purple-600 shadow-lg text-sm">Update</button>
    </div>
    <p class="text-[10px] text-slate-400 mt-2 italic">
        * "Percentage" means if they spend 50 SR, and value is 10%, they get 5 points.
    </p>
</div>   
       <div class="flex w-full justify-between items-center mb-4">
    <h3 class="font-bold text-lg text-slate-800">Active Codes</h3>
    <button onclick="openPromoModal()" class="text-orange-500 font-bold text-sm hover:text-orange-600 transition px-3 py-2 rounded-lg hover:bg-orange-50">
        + Add Code
    </button>
</div>
<div id="promo-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div></div>
        <div id="tab-content" class="tab-content hidden max-w-5xl mx-auto"><h2 class="text-2xl font-bold mb-6">Content</h2><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="glass-card p-6"><h3 class="font-bold mb-4">Splash</h3><div class="space-y-3"><input id="splash-title" class="input-box" placeholder="Title"><textarea id="splash-intro" class="input-box h-20" placeholder="Text..."></textarea><div class="grid grid-cols-2 gap-3"><div class="img-uploader h-24" onclick="document.getElementById('splash-bg-input').click()"><img id="splash-bg-preview" class="absolute inset-0 w-full h-full object-cover hidden rounded-lg"><span class="text-xs font-bold text-slate-400">Background</span><input type="file" id="splash-bg-input" class="hidden" accept="image/*" onchange="startCrop(this, 'splash-bg')"></div><div class="img-uploader h-24" onclick="document.getElementById('splash-c-input').click()"><img id="splash-c-preview" class="absolute inset-0 w-full h-full object-cover hidden rounded-lg"><span class="text-xs font-bold text-slate-400">Center Circle</span><input type="file" id="splash-c-input" class="hidden" accept="image/*" onchange="startCrop(this, 'splash-c')"></div></div><button onclick="saveSplashSettings(this)" class="btn-main w-full text-sm mt-2">Update Splash</button></div></div><div class="glass-card p-6"><h3 class="font-bold mb-4">Hero Slider</h3><div class="grid grid-cols-3 gap-2 mb-4" id="hero-list-container"></div><button onclick="document.getElementById('hero-input').click()" class="w-full py-2 border border-dashed rounded-xl text-slate-400 font-bold mb-4 text-sm">+ Add Image</button><input type="file" id="hero-input" class="hidden" accept="image/*" onchange="startCrop(this, 'hero')"><button onclick="saveHeroSettings(this)" class="btn-main w-full text-sm">Save Slider</button></div></div><div class="glass-card p-6 mt-6">
    <h3 class="font-bold mb-4">App Design</h3>
    <div class="grid grid-cols-2 gap-6 mb-4">
        <div>
            <label class="font-bold text-sm block mb-2">Primary Brand Color</label>
            <div class="flex items-center gap-3">
                <input type="color" id="design-color" class="w-full h-12 rounded-xl cursor-pointer border border-slate-200" value="#FF5722">
            </div>
        </div>
        <div>
            <label class="font-bold text-sm block mb-2">App Background</label>
            <div class="flex items-center gap-3">
                <input type="color" id="design-bg-color" class="w-full h-12 rounded-xl cursor-pointer border border-slate-200" value="#F8FAFC">
            </div>
        </div>
    </div>
    <button onclick="saveDesign(this)" class="btn-main w-full bg-slate-900 text-white shadow-lg">Update App Theme</button>
</div>
</div>
        <div id="tab-info" class="tab-content hidden max-w-2xl mx-auto"><h2 class="text-2xl font-bold mb-6">Business Info</h2><div class="glass-card p-6 mb-6 space-y-4"><div><label class="text-xs font-bold text-slate-400 uppercase">Address</label><input id="info-loc" class="input-box mt-1"></div><div><label class="text-xs font-bold text-slate-400 uppercase">Phone</label><input id="info-phone" class="input-box mt-1"></div><div><label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Working Hours</label><div id="hours-container" class="space-y-2 mb-2"></div><button onclick="addHourRow()" class="text-xs font-bold text-orange-500">+ Add Day</button></div><div class="pt-4"><label class="text-xs font-bold text-slate-400 uppercase">Social Links</label><div class="space-y-3 mt-2"><input id="info-insta" type="text" class="input-box" placeholder="Instagram URL"><input id="info-twit" type="text" class="input-box" placeholder="Twitter URL"><input id="info-tik" type="text" class="input-box" placeholder="TikTok URL"></div></div><button onclick="saveInfo(this)" class="btn-main w-full mt-4">Save Info</button></div></div>
    </main>

    <div id="timeModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
    
    <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl text-center animate-[scaleIn_0.2s]">
        <div class="w-14 h-14 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">‚è±Ô∏è</div>
        <h3 class="font-bold text-xl mb-2">Order Time?</h3>
        
        <div class="grid grid-cols-3 gap-3 mb-6">
            <button onclick="selectTime(10, this)" class="time-btn py-3 bg-slate-50 border border-slate-200 rounded-xl font-bold hover:bg-orange-50 hover:border-orange-500 transition">10m</button>
            <button onclick="selectTime(15, this)" class="time-btn py-3 bg-slate-50 border border-slate-200 rounded-xl font-bold hover:bg-orange-50 hover:border-orange-500 transition">15m</button>
            <button onclick="selectTime(20, this)" class="time-btn py-3 bg-slate-50 border border-slate-200 rounded-xl font-bold hover:bg-orange-50 hover:border-orange-500 transition">20m</button>
            <button onclick="selectTime(25, this)" class="time-btn py-3 bg-slate-50 border border-slate-200 rounded-xl font-bold hover:bg-orange-50 hover:border-orange-500 transition">25m</button>
            <button onclick="selectTime(30, this)" class="time-btn py-3 bg-slate-50 border border-slate-200 rounded-xl font-bold hover:bg-orange-50 hover:border-orange-500 transition">30m</button>
            <button onclick="selectTime(45, this)" class="time-btn py-3 bg-slate-50 border border-slate-200 rounded-xl font-bold hover:bg-orange-50 hover:border-orange-500 transition">45m</button>
        </div>

        <input id="custom-time" type="number" placeholder="Or type minutes..." class="input-box text-center font-bold text-lg mb-6" oninput="clearTimeSelection()">

        <button onclick="confirmTime()" class="btn-main w-full bg-orange-600 shadow-lg py-4 text-lg">Start Order</button>
    </div>
</div>

    <div id="menuModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-[100] flex items-end md:items-center justify-center p-0 md:p-4">
    
    <div class="bg-white w-full md:max-w-lg md:rounded-3xl rounded-t-3xl h-[85vh] flex flex-col shadow-2xl overflow-hidden animate-[slideUp_0.3s]">
        
        <div class="p-6 border-b border-slate-50 flex justify-between items-center bg-white z-10">
            <h3 class="font-black text-xl text-slate-800" id="menu-modal-title">Add New Item</h3>
            <button onclick="closeModal('menuModal')" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:text-slate-800 flex items-center justify-center transition">
                <i class="fa-solid fa-xmark text-lg"></i>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-5">
            <input type="hidden" id="menu-id">
            
            <div class="relative group">
                <div class="img-uploader h-48 bg-slate-50 border-2 border-dashed border-slate-200 rounded-2xl flex flex-col items-center justify-center cursor-pointer hover:bg-orange-50 hover:border-orange-200 transition" onclick="document.getElementById('menu-file').click()">
                    
                    <img id="m-img-preview" class="absolute inset-0 w-full h-full object-cover hidden rounded-2xl z-10">
                    
                    <div class="text-center">
                        <div class="w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center mx-auto mb-3 text-slate-300">
                            <i class="fa-solid fa-camera text-xl"></i>
                        </div>
                        <span class="text-slate-400 text-xs font-bold uppercase tracking-wider">Tap to Upload Image</span>
                    </div>
                    
                    <input type="file" id="menu-file" class="hidden" accept="image/*" onchange="startCrop(this, 'menu')">
                </div>

                <button id="btn-rm-menu-img" onclick="removeMenuImage(event)" class="btn-remove-img hidden">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>

            <div class="space-y-4">
                <input id="m-name" class="input-box text-lg" placeholder="Item Name">
                
                <div class="grid grid-cols-2 gap-4">
                    <input id="m-price" type="number" class="input-box" placeholder="Price (SR)">
                    
                    <select id="m-cat" class="input-box text-slate-700">
                        <option value="" disabled selected>Category</option>
                        </select>
                </div>
                
                <textarea id="m-desc" class="input-box h-28 resize-none leading-relaxed" placeholder="Description..."></textarea>
            </div>

            <div class="flex gap-4">
                <label class="flex items-center gap-3 p-4 border border-slate-200 rounded-2xl flex-1 justify-center cursor-pointer bg-white hover:border-slate-300 transition">
                    <input type="checkbox" id="m-available" class="accent-slate-900 w-5 h-5" checked> 
                    <span class="font-bold text-sm text-slate-700">Available</span>
                </label>
                <label class="flex items-center gap-3 p-4 border border-slate-200 rounded-2xl flex-1 justify-center cursor-pointer bg-white hover:border-slate-300 transition">
                    <input type="checkbox" id="m-best" class="accent-orange-500 w-5 h-5"> 
                    <span class="font-bold text-sm text-slate-700">Best Seller</span>
                </label>
            </div>

            <div class="bg-slate-50 p-5 rounded-2xl border border-slate-100">
                <h4 class="font-bold text-xs text-slate-400 uppercase tracking-widest mb-3">Modifiers</h4>
                <div id="item-modifier-list" class="space-y-2"></div>
            </div>
        </div>

        <div class="p-6 border-t border-slate-50 bg-white z-10">
            <button onclick="saveMenuItem(this)" class="btn-main w-full bg-slate-900 text-white shadow-xl py-4 text-lg rounded-2xl hover:scale-[1.01]">Save Item</button>
        </div>
    </div>
</div>

    <div id="modModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4"><div class="bg-white rounded-3xl w-full max-w-md p-6 shadow-2xl"><h3 class="font-bold text-lg mb-4" id="mod-modal-title">Edit Modifier Group</h3><input type="hidden" id="mod-id"><input id="mod-group-name" class="input-box mb-4" placeholder="Group Name (e.g. Sauces)"><div id="mod-options-container" class="space-y-2 mb-4 max-h-48 overflow-y-auto"></div><button onclick="addModOptionInput()" class="text-xs font-bold text-orange-500 mb-4">+ Add Option</button><div class="flex items-center gap-2 mb-4"><input type="checkbox" id="mod-required" class="accent-orange-500"><label for="mod-required" class="text-sm">Required?</label></div><div class="grid grid-cols-2 gap-3"><button onclick="closeModal('modModal')" class="btn-main bg-slate-100 text-slate-500">Cancel</button><button onclick="saveModGroup(this)" class="btn-main bg-slate-900">Save</button></div></div></div>
    <div id="promoModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4"><div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl"><h3 class="font-bold text-lg mb-4">Add Promo</h3><input id="p-code" class="input-box mb-3 uppercase font-black tracking-widest text-center" placeholder="CODE"><div class="grid grid-cols-2 gap-3 mb-3"><select id="p-type" class="input-box"><option value="percent">% Off</option><option value="fixed">SR Off</option></select><input id="p-val" type="number" class="input-box" placeholder="Val"></div><input type="datetime-local" id="p-exp" class="input-box mb-4"><div class="grid grid-cols-2 gap-3"><button onclick="closeModal('promoModal')" class="btn-main bg-slate-100 text-slate-500">Cancel</button><button onclick="savePromo(this)" class="btn-main">Create</button></div></div></div>
    <div id="confirmModal" class="fixed inset-0 z-[200] bg-slate-900/30 backdrop-blur-[2px] hidden flex items-center justify-center transition-opacity duration-200 opacity-0">
    <div class="bg-white rounded-3xl shadow-2xl p-8 w-[90%] max-w-sm transform scale-95 transition-all duration-200" id="confirmBox">
        <div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mb-6 mx-auto text-2xl animate-bounce">
             <i class="fa-solid fa-trash-can"></i>
        </div>
        <h3 class="text-xl font-black text-slate-800 mb-2 text-center">Are you sure?</h3>
        <p id="confirmMsg" class="text-sm text-slate-500 mb-8 text-center leading-relaxed">This action cannot be undone.</p>
        <div class="flex gap-3">
            <button onclick="resolveConfirm(false)" class="flex-1 py-3.5 rounded-2xl font-bold text-slate-500 bg-slate-50 hover:bg-slate-100 transition text-sm">Cancel</button>
            <button onclick="resolveConfirm(true)" class="flex-1 py-3.5 rounded-2xl font-bold bg-red-500 text-white shadow-lg shadow-red-500/30 hover:scale-[1.02] active:scale-95 transition text-sm">Yes, Delete</button>
        </div>
    </div>
</div>



    <script>
        window.addEventListener('error', () => {
  document.getElementById('preloader')?.classList.add('loaded');
  document.getElementById('auth-overlay')?.classList.remove('hidden');
});

window.addEventListener('unhandledrejection', () => {
  document.getElementById('preloader')?.classList.add('loaded');
  document.getElementById('auth-overlay')?.classList.remove('hidden');
});
        const SUPABASE_URL = "https://fpgspmhgwcmhaaxsphcd.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZ3NwbWhnd2NtaGFheHNwaGNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MjYyMTEsImV4cCI6MjA4MTQwMjIxMX0.QyChZ3agLF1MiTzB8XzbrP4pCgBXsT1i9VWfQqu_VOw";
        
        // --- CATEGORY MANAGER ---
let allCats = ["Burger", "Fries", "Drink"]; // Default Fallback
let allMenuItems = [];

window.fetchCategories = async () => {
    // Try to fetch from settings
    const { data } = await db.from('settings').select('data').eq('id', 'menu_categories').single();
    if(data?.data?.categories) {
        allCats = data.data.categories;
    }
    renderCategories();
};

// Global variable to track the sorter (Put this right above the function)
let catSortable = null; 

window.renderCategories = () => {
    const grid = document.getElementById('cats-grid');
    
    // 1. Render the HTML
    grid.innerHTML = allCats.map((cat, index) => `
        <div class="glass-card p-4 flex justify-between items-center group relative" data-cat="${cat}">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-grip-vertical text-slate-300 cursor-move hover:text-orange-500 transition"></i>
                
                <span class="font-bold text-lg text-slate-700">
                    <i class="fa-solid fa-tag text-slate-300 mr-2"></i> ${cat}
                </span>
            </div>
            <button onclick="deleteCategory(${index})" class="w-8 h-8 rounded-lg bg-red-50 text-red-500 hover:bg-red-500 hover:text-white transition flex items-center justify-center">
                <i class="fa-solid fa-trash text-xs"></i>
            </button>
        </div>
    `).join('');
    
    // 2. Update the "Add Item" Dropdown
    const dropdown = document.getElementById('m-cat');
    if(dropdown) dropdown.innerHTML = allCats.map(c => `<option value="${c}">${c}</option>`).join('');

    // --- THE FIX: DESTROY OLD INSTANCE FIRST ---
    if (catSortable) {
        catSortable.destroy();
        catSortable = null;
    }

    // 3. Create New Sorter
    catSortable = new Sortable(grid, {
        animation: 150,
        handle: '.cursor-move',
        ghostClass: 'sortable-ghost',
        onEnd: async () => {
            // Get new order
            const newOrder = Array.from(grid.children).map(el => el.dataset.cat);
            allCats = newOrder;
            
            await saveCategoriesToDb();
            showToast("Category Order Saved");
            
            // Re-render safely after a tiny delay (Prevents the "Stuck" bug)
            setTimeout(() => renderCategories(), 50);
        }
    });
};



// --- UPDATED DELETE FUNCTION ---
window.deleteCategory = async (index) => {
    // 1. Trigger the New Elegant Window (instead of the old confirm())
    const userSaidYes = await showConfirm("Do you really want to delete this category?");
    
    // 2. If they clicked "Cancel", stop here.
    if (!userSaidYes) return;
    
    // 3. If they clicked "Yes", delete it.
    allCats.splice(index, 1);
    await saveCategoriesToDb();
    renderCategories();
    showToast("Category Deleted");
};


window.saveCategoriesToDb = async () => {
    await db.from('settings').upsert({ id: 'menu_categories', data: { categories: allCats } });
};

        // RENAMED TO AVOID CONFLICT
        let db; 
let ordersChannel = null;
        // Force Loader Hide (Safety Net)
        setTimeout(() => {
            const p = document.getElementById('preloader');
            if(p && !p.classList.contains('loaded')) {
                p.classList.add('loaded');
            }
        }, 3000);
        
        // --- ADD CATEGORY FUNCTION (This was missing!) ---
window.addCategory = async () => {
    const input = document.getElementById('new-cat-name');
    const val = input.value.trim();
    
    // 1. Validation
    if(!val) return showToast("Enter a name", true);
    
    // 2. Add to Local List
    allCats.push(val);
    
    // 3. Save to Database
    await saveCategoriesToDb();
    
    // 4. Update UI
    input.value = ""; // Clear input
    renderCategories(); // Refresh grid
    showToast("Category Added");
};


// --- 1. THE CUSTOM POPUP LOGIC ---
let confirmResolver = null;

window.showConfirm = (msg) => {
    const modal = document.getElementById('confirmModal');
    const box = document.getElementById('confirmBox');
    
    document.getElementById('confirmMsg').innerText = msg;
    
    // Show & Animate
    modal.classList.remove('hidden');
    // Tiny timeout to let the browser render before fading in
    setTimeout(() => {
        modal.classList.remove('opacity-0');
        box.classList.remove('scale-95');
        box.classList.add('scale-100');
    }, 10);

    // Wait for user answer
    return new Promise((resolve) => {
        confirmResolver = resolve;
    });
};

window.resolveConfirm = (result) => {
    const modal = document.getElementById('confirmModal');
    const box = document.getElementById('confirmBox');
    
    // Hide & Animate
    modal.classList.add('opacity-0');
    box.classList.remove('scale-100');
    box.classList.add('scale-95');
    
    setTimeout(() => {
        modal.classList.add('hidden');
        if(confirmResolver) confirmResolver(result);
        confirmResolver = null;
    }, 200);
};

// --- TRANSLATION MANAGER ---
let translationMap = {};

window.fetchTranslations = async () => {
    // 1. Fetch the saved translations from 'settings' table
    const { data } = await db.from('settings').select('data').eq('id', 'app_translations').single();
    if (data?.data) translationMap = data.data;
    
    renderTranslationUI();
};

window.renderTranslationUI = () => {
    // 1. Render Categories
    const catContainer = document.getElementById('trans-cat-list');
    catContainer.innerHTML = allCats.map(cat => `
        <div class="glass-card p-4 flex flex-col gap-2">
            <span class="text-xs font-bold text-slate-400 uppercase">Category</span>
            <div class="font-bold text-slate-800 text-lg mb-1">${cat}</div>
            <input class="trans-input input-box bg-slate-50 border-slate-200 text-right font-medium text-blue-600" 
                   dir="rtl"
                   data-key="${cat}" placeholder="ÿßŸÑÿßÿ≥ŸÖ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿä" value="${translationMap[cat] || ""}">
        </div>`).join('');

    // 2. Render Menu Items (With Big Textarea & RTL)
    const itemContainer = document.getElementById('trans-item-list');
    itemContainer.innerHTML = allMenuItems.map(item => {
        const arabicName = translationMap[item.name] || "";
        const arabicDesc = translationMap[item.name + "_desc"] || ""; 
        
        return `
        <div class="glass-card p-4 flex flex-col md:flex-row gap-4 items-start">
            <img src="${item.image || 'https://via.placeholder.com/50'}" class="w-16 h-16 rounded-lg object-cover bg-slate-50">
            
            <div class="flex-1 w-full">
                <div class="flex justify-between mb-1">
                    <span class="font-bold text-slate-800">${item.name}</span>
                    <span class="text-xs font-bold text-slate-400">SR ${item.price}</span>
                </div>
                
                <input class="trans-input input-box mb-3 text-right text-sm font-bold" 
                       dir="rtl"
                       data-key="${item.name}" 
                       placeholder="ÿßŸÑÿßÿ≥ŸÖ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿä" 
                       value="${arabicName}">
                
                ${item.description ? `
                <p class="text-[10px] text-slate-400 mb-2 italic leading-relaxed">${item.description}</p>
                
                <textarea class="trans-input input-box text-right text-xs text-slate-600 min-h-[80px] resize-y leading-relaxed p-3" 
                       dir="rtl"
                       data-key="${item.name}_desc" 
                       placeholder="ŸàÿµŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿä... (ÿßÿ∂ÿ∫ÿ∑ Enter ŸÑÿ≥ÿ∑ÿ± ÿ¨ÿØŸäÿØ)">${arabicDesc}</textarea>
                ` : ''}
            </div>
        </div>`;
    }).join('');

    
        // 3. Render Splash Screen (Updated)
    const splashContainer = document.getElementById('trans-splash-list');
    const currentTitle = document.getElementById('splash-title').value || "TARI";
    const currentIntro = document.getElementById('splash-intro').value || "";
    
    splashContainer.innerHTML = `
        <div class="glass-card p-4">
            <span class="text-xs font-bold text-slate-400 uppercase">Main Title</span>
            <div class="font-bold text-slate-800 text-lg mb-2">${currentTitle}</div>
            
            <textarea class="trans-input input-box text-right min-h-[80px] resize-y" 
                      dir="rtl" 
                      data-key="${currentTitle}" 
                      placeholder="ÿßŸÑÿπŸÜŸàÿßŸÜ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿä (ÿßÿ∂ÿ∫ÿ∑ Enter ŸÑŸÑŸÜÿ≤ŸàŸÑ)">${translationMap[currentTitle] || ""}</textarea>
        </div>

        <div class="glass-card p-4">
            <span class="text-xs font-bold text-slate-400 uppercase">Intro Text</span>
            <div class="text-sm text-slate-600 mb-2">${currentIntro}</div>
            <textarea class="trans-input input-box text-right h-20" dir="rtl" data-key="${currentIntro}" placeholder="ÿßŸÑŸÜÿµ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿä">${translationMap[currentIntro] || ""}</textarea>
        </div>
    `;


    // 4. Render Modifiers
    const modContainer = document.getElementById('trans-mod-list');
    modContainer.innerHTML = allMods.map(group => {
        const options = typeof group.options === 'string' ? JSON.parse(group.options) : group.options;
        
        const optionsHtml = options.map(opt => `
            <div class="flex items-center gap-3 mt-2 pl-4 border-l-2 border-slate-100">
                <span class="text-xs font-bold text-slate-500 w-1/3">${opt.name}</span>
                <input class="trans-input input-box py-1 text-right text-xs w-2/3" 
                       dir="rtl"
                       data-key="${opt.name}" placeholder="ÿßŸÑÿÆŸäÿßÿ± ÿ®ÿßŸÑÿπÿ±ÿ®Ÿä" value="${translationMap[opt.name] || ""}">
            </div>
        `).join('');

        return `
        <div class="glass-card p-4">
            <div class="mb-3">
                <span class="text-xs font-bold text-orange-500 uppercase">Group Name</span>
                <div class="flex gap-3 mt-1">
                    <span class="font-bold text-slate-800 w-1/3 pt-2">${group.name}</span>
                    <input class="trans-input input-box text-right w-2/3" dir="rtl" data-key="${group.name}" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ¨ŸÖŸàÿπÿ© ÿ®ÿßŸÑÿπÿ±ÿ®Ÿä" value="${translationMap[group.name] || ""}">
                </div>
            </div>
            <div class="bg-slate-50 rounded-xl p-3">
                <span class="text-[10px] font-bold text-slate-400 uppercase">Options</span>
                ${optionsHtml}
            </div>
        </div>`;
    }).join('');
};



window.saveTranslations = async (btn) => {
    setBtnLoading(btn, true);
    
    // 1. Gather all inputs
    const inputs = document.querySelectorAll('.trans-input');
    const newMap = {};
    
    inputs.forEach(input => {
        const key = input.dataset.key;
        const val = input.value.trim();
        if (val) newMap[key] = val; // Only save if not empty
    });
    
    // 2. Save to Database
    const { error } = await db.from('settings').upsert({ 
        id: 'app_translations', 
        data: newMap 
    });
    
    if (error) {
        showToast("Error saving", true);
    } else {
        translationMap = newMap;
        showToast("Translations Published!");
    }
    setBtnLoading(btn, false);
};

// IMPORTANT: Add 'fetchTranslations()' to your initAdmin list!

        // DYNAMIC LOADER
        function loadSupabaseLib() {
    // If Supabase already exists, still init db + continue (your old code was "return;" which can break)
    if (window.supabase && window.supabase.createClient) {
        db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        checkAuth();
        return;
    }

    const script = document.createElement('script');

    // IMPORTANT: Use UMD build so `window.supabase` definitely exists
    script.src = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js";
    script.async = true;

    script.onload = () => {
        try {
            if (!window.supabase || !window.supabase.createClient) {
                throw new Error("Supabase loaded but window.supabase is missing (wrong build).");
            }
            db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            checkAuth();
        } catch (e) {
            console.error(e);
            document.getElementById('preloader')?.classList.add('loaded');
            document.getElementById('auth-overlay')?.classList.remove('hidden');
            alert("Supabase failed to init. Check console for details.");
        }
    };

    script.onerror = () => {
        const backup = document.createElement('script');

        // Backup UMD (also safe)
        backup.src = "https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js";
        backup.async = true;

        backup.onload = () => {
            try {
                if (!window.supabase || !window.supabase.createClient) {
                    throw new Error("Backup Supabase loaded but window.supabase is missing.");
                }
                db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                checkAuth();
            } catch (e) {
                console.error(e);
                document.getElementById('preloader')?.classList.add('loaded');
                document.getElementById('auth-overlay')?.classList.remove('hidden');
                alert("Supabase backup failed to init. Check console.");
            }
        };

        backup.onerror = () => {
            document.getElementById('preloader')?.classList.add('loaded');
            document.getElementById('auth-overlay')?.classList.remove('hidden');
            alert("Could not load Supabase library (both CDNs failed).");
        };

        document.body.appendChild(backup);
    };

    document.body.appendChild(script);
}

        const notificationAudio = new Audio();

        // --- AUTH & LOGIN ---
        window.handleAdminLogin = async () => { 
            if (!db) return alert("Connecting...");
            const btn = document.getElementById('btn-unlock');
            const email = document.getElementById('admin-email').value;
            const pass = document.getElementById('admin-pass').value;

            if (!email || !pass) return alert("Please enter email and password");

            btn.innerText = "Checking...";
            btn.disabled = true;

            const { data, error } = await db.auth.signInWithPassword({ email, password: pass }); 
            
            if (error) {
                alert("Login Failed: " + error.message);
                btn.innerText = "Unlock";
                btn.disabled = false;
            } else { 
                btn.innerText = "Success!";
                btn.classList.add('bg-green-600');
                
                // Unlock Audio
                notificationAudio.src = "https://assets.mixkit.co/sfx/preview/mixkit-service-bell-ring-1461.mp3"; 
                notificationAudio.play().then(() => { 
                    notificationAudio.pause(); 
                    notificationAudio.currentTime = 0; 
                }).catch(e => console.log("Audio unlock failed"));
                
                setTimeout(() => {
                    document.getElementById('auth-overlay').classList.add('hidden'); 
                    initAdmin();
                }, 500);
            } 
        };
        
        window.logout = async () => { await db.auth.signOut(); location.reload(); };

function startOrdersRealtime() {
    // Remove old channel if exists
    if (ordersChannel) {
        try { db.removeChannel(ordersChannel); } catch(e){}
        ordersChannel = null;
    }

    ordersChannel = db
        .channel('orders-live')
        .on(
            'postgres_changes',
            { event: 'INSERT', schema: 'public', table: 'orders' },
            (payload) => {
                console.log('üü¢ New order received', payload.new);
                fetchOrders();
                fetchDashboard();
                playNotification();
            }
        )
        .on(
            'postgres_changes',
            { event: 'UPDATE', schema: 'public', table: 'orders' },
            () => {
                fetchOrders();
                fetchDashboard();
            }
        )
        .subscribe((status) => {
            console.log('Realtime status:', status);
            if (status === 'SUBSCRIBED') {
                showToast("Kitchen Live");
            }
        });
}
        // --- INIT APP ---
        function initAdmin() { 
            // 1. Initial Data Fetch
            Promise.all([
                fetchOrders(), fetchMods(), fetchMenu(), fetchCategories(),
                fetchSettings(), fetchPromos(), fetchNewUserPromo(), 
                fetchLoyalty(),
                fetchDesign(), fetchInfo(), fetchDashboard(), fetchHistory(),
                fetchStoreStatus(), checkPermissionStatus(), fetchWebsiteSettings()
            ]).catch(err => console.error("Init Partial Error", err));

            // 2. Setup Realtime Listener
            startOrdersRealtime();
       
            // 3. Setup Sound
            const savedSound = localStorage.getItem('tari_sound') || 'bell';
            document.getElementById('sound-select').value = savedSound;
            if(savedSound === 'custom' && localStorage.getItem('tari_custom_sound')) {
                document.getElementById('custom-sound-upload').classList.remove('hidden');
                document.getElementById('custom-file-name').innerText = "Custom sound loaded";
            }
        }

        // --- WEBSITE SETTINGS ---
        let webLogo="", webBgImg="";
                window.fetchWebsiteSettings = async () => {
            const { data } = await db.from('settings').select('data').eq('id', 'website_settings').single();
            if(data?.data) {
                document.getElementById('web-header-color').value = data.data.header_color || "#ffffff";
                document.getElementById('web-bg-color').value = data.data.bg_color || "#F8FAFC";
                
                if(data.data.logo) { 
                    webLogo = data.data.logo; 
                    document.getElementById('web-logo-preview').src = webLogo; 
                    document.getElementById('web-logo-preview').classList.remove('hidden'); 
                }
                
                // FIXED: Show Preview AND Remove Button if image exists
                if(data.data.bg_image) { 
                    webBgImg = data.data.bg_image; 
                    document.getElementById('web-bg-img-preview').src = webBgImg; 
                    document.getElementById('web-bg-img-preview').classList.remove('hidden'); 
                    document.getElementById('btn-remove-bg').classList.remove('hidden'); // <--- Shows the button
                }
            }
        }

               // NEW: Clears the background image
window.removeWebBg = () => {
    if(!confirm("Remove the background image?")) return;
    
    webBgImg = ""; // Clear the variable
    
    // Hide the preview and the button
    document.getElementById('web-bg-img-preview').classList.add('hidden');
    document.getElementById('web-bg-img-preview').src = "";
    document.getElementById('btn-remove-bg').classList.add('hidden');
    
    // Clear the input so you can re-upload the same file if needed
    document.getElementById('web-bg-img-input').value = "";
}

                window.saveWebsiteSettings = async (btn) => {
            setBtnLoading(btn, true);
            const payload = {
                logo: webLogo,
                bg_image: webBgImg,
                header_color: document.getElementById('web-header-color').value,
                bg_color: document.getElementById('web-bg-color').value
            };
            
            // FIXED: Now we actually CHECK if it saved!
            const { error } = await db.from('settings').upsert({ id: 'website_settings', data: payload });
            
            if (error) {
                console.error("Save Error:", error);
                showToast("Save Failed: " + error.message, true); // <--- Shows you the real error
            } else {
                showToast("Website Updated");
            }
            setBtnLoading(btn, false);
        }

        // --- HELPERS ---
        window.setBtnLoading = (btn, isLoading) => { if(!btn) return; if(isLoading){ btn.dataset.org = btn.innerText; btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Saving...'; btn.disabled = true; } else { btn.innerHTML = btn.dataset.org; btn.disabled = false; } };
        window.showToast = (msg, isErr = false) => { const t = document.getElementById('toast-container'); document.getElementById('toast-msg').innerText = msg; t.querySelector('i').className = isErr ? "fa-solid fa-circle-xmark text-red-400 text-lg" : "fa-solid fa-circle-check text-green-400 text-lg"; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); };
        window.toggleSidebar = () => { document.getElementById('sidebar').classList.toggle('sidebar-open'); document.getElementById('sidebar-overlay').classList.toggle('overlay-active'); };
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.switchTab = (t) => { document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden')); document.getElementById('tab-'+t).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); if(document.getElementById('nav-'+t)) document.getElementById('nav-'+t).classList.add('active'); if(window.innerWidth < 768) { document.getElementById('sidebar').classList.remove('sidebar-open'); document.getElementById('sidebar-overlay').classList.remove('overlay-active'); } };
        window.switchMenuSub = (t) => { 
    document.getElementById('view-items').classList.toggle('hidden', t!=='items'); 
    document.getElementById('view-mods').classList.toggle('hidden', t!=='mods'); 
    document.getElementById('view-cats').classList.toggle('hidden', t!=='cats'); // New line

    // Update Buttons Styling
    const setBtn = (id, active) => {
        const el = document.getElementById(id);
        el.className = active 
            ? "px-6 py-2.5 rounded-lg font-bold text-sm transition-all shadow-sm bg-white text-slate-900"
            : "px-6 py-2.5 rounded-lg font-bold text-sm transition-all text-slate-500 hover:text-slate-900";
    };
    setBtn('sub-items', t==='items');
    setBtn('sub-mods', t==='mods');
    setBtn('sub-cats', t==='cats');
};


        // --- CROPPER ---
        let cropper, cropType; 
        window.startCrop = (input, type) => { 
            if (!input.files || !input.files[0]) return;
            const reader = new FileReader(); 
            reader.onload = (e) => { 
                cropType = type; 
                const img = document.getElementById('crop-target');
                img.src = e.target.result; 
                document.getElementById('crop-modal').classList.remove('hidden');
                document.getElementById('crop-modal').classList.add('active'); 
                if(cropper) cropper.destroy(); 
                cropper = new Cropper(img, { aspectRatio: NaN, autoCropArea: 1 }); 
                input.value = ""; 
            }; 
            reader.readAsDataURL(input.files[0]); 
        }; 
        window.closeCropper = () => { document.getElementById('crop-modal').classList.remove('active'); setTimeout(()=>document.getElementById('crop-modal').classList.add('hidden'), 300); if(cropper) cropper.destroy(); }; 
                // FIXED: Saves as PNG to keep transparent backgrounds (Logos/Icons)
        window.finishCrop = () => { 
            if(!cropper) return;

            // 1. Configure crop to keep transparency (fillColor: 'transparent')
            cropper.getCroppedCanvas({
                maxWidth: 800, 
                fillColor: 'transparent' 
            }).toBlob(async blob => { 
                
                showToast("Uploading...", false);
                // 2. Change file extension to .png
                const name = `upload-${Date.now()}.png`; 
                
                const { data, error } = await db.storage.from('images').upload(name, blob); 
                
                if (error) { showToast("Upload Failed", true); return; }

                const url = db.storage.from('images').getPublicUrl(name).data.publicUrl; 
                
                
                // Logic to put the image in the right place
                if(cropType === 'hero') {
                    heroImages.push(url);
                    document.getElementById('hero-list-container').innerHTML = heroImages.map((u,i) => `<div class="relative w-full h-24 rounded-lg overflow-hidden"><img src="${u}" class="w-full h-full object-cover"><button onclick="delHeroImg(${i})" class="absolute top-1 right-1 bg-red-500 text-white w-5 h-5 rounded-full text-xs flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button></div>`).join('');
                }

                if(cropType === 'menu') { menuImgUrl = url; document.getElementById('m-img-preview').src = url; document.getElementById('m-img-preview').classList.remove('hidden'); } 
                if(cropType === 'splash-bg') { splashBg = url; document.getElementById('splash-bg-preview').src = url; document.getElementById('splash-bg-preview').classList.remove('hidden'); } 
                if(cropType === 'splash-c') { splashC = url; document.getElementById('splash-c-preview').src = url; document.getElementById('splash-c-preview').classList.remove('hidden'); } 
                if(cropType === 'web-logo') { webLogo = url; document.getElementById('web-logo-preview').src = url; document.getElementById('web-logo-preview').classList.remove('hidden'); }
                if(cropType === 'web-bg') { webBgImg = url; document.getElementById('web-bg-img-preview').src = url; document.getElementById('web-bg-img-preview').classList.remove('hidden'); }
                
                closeCropper(); showToast("Image Set");

            }, 'image/png'); // <--- CRITICAL CHANGE: Saves as PNG
        };

        // --- NOTIFICATIONS & PERMISSIONS ---
        window.uploadCustomSound = (input) => {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    localStorage.setItem('tari_custom_sound', e.target.result);
                    document.getElementById('custom-file-name').innerText = file.name;
                    showToast("Sound Uploaded");
                };
                reader.readAsDataURL(file);
            }
        }
        window.playNotification = () => {
            const soundType = document.getElementById('sound-select').value;
            let src = "";
            if (soundType === 'custom') src = localStorage.getItem('tari_custom_sound') || "";
            else if(soundType === 'bell') src = "https://assets.mixkit.co/sfx/preview/mixkit-service-bell-ring-1461.mp3";
            else if(soundType === 'chime') src = "https://assets.mixkit.co/sfx/preview/mixkit-positive-notification-951.mp3";
            else if(soundType === 'tech') src = "https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3";
            
            if(src) { notificationAudio.src = src; notificationAudio.play().catch(e => console.log("Audio Error", e)); }
            if('Notification' in window && Notification.permission === "granted") { try { new Notification("New Order!", { body: "Check Kitchen Board" }); } catch(e) {} }
        }
        window.saveSoundSettings = () => {
            const val = document.getElementById('sound-select').value;
            localStorage.setItem('tari_sound', val);
            document.getElementById('custom-sound-upload').classList.toggle('hidden', val !== 'custom');
        }
        window.checkPermissionStatus = () => {
            if(!('Notification' in window)) return;
            const p = Notification.permission;
            document.getElementById('perm-status').innerText = p === 'granted' ? "Active" : "Blocked/Default";
            document.getElementById('perm-indicator').className = p === 'granted' ? "w-3 h-3 rounded-full bg-green-500" : "w-3 h-3 rounded-full bg-orange-500";
        }
        window.requestNotificationPermission = async () => {
            if (!('Notification' in window)) return showToast("Not Supported", true);
            const res = await Notification.requestPermission();
            checkPermissionStatus();
            if(res === 'granted') { showToast("Allowed"); new Notification("Test", {body:"OK"}); } else showToast("Denied", true);
        }

        // --- STORE ---
        window.fetchStoreStatus = async () => {
            const { data } = await db.from('settings').select('data').eq('id', 'store_status').single();
            const isOpen = data?.data?.open || false;
            document.getElementById('store-toggle-d').checked = isOpen;
            document.getElementById('store-toggle-m').checked = isOpen;
            updateStoreLabel(isOpen);
        }
        window.toggleStore = async (status) => {
            document.getElementById('store-toggle-d').checked = status;
            document.getElementById('store-toggle-m').checked = status;
            updateStoreLabel(status);
            await db.from('settings').upsert({ id: 'store_status', data: { open: status } });
            showToast(status ? "Store Opened" : "Store Closed");
        }
        function updateStoreLabel(status) {
            const el = document.getElementById('store-status-text-d');
            el.innerText = status ? "Store Open" : "Store Closed";
            el.className = status ? "text-sm font-bold text-green-600" : "text-sm font-bold text-slate-600";
        }

        // --- FETCHERS ---
        window.fetchDashboard = async () => { const today = new Date().toISOString().split('T')[0]; const { data: orders } = await db.from('orders').select('*').gte('created_at', today + 'T00:00:00'); const totalOrders = orders ? orders.length : 0; const totalRevenue = orders ? orders.reduce((sum, o) => sum + o.total, 0) : 0; let items = {}; (orders||[]).forEach(o => { if(typeof o.items === 'string') o.items = JSON.parse(o.items); if(Array.isArray(o.items)) o.items.forEach(i => items[i.name] = (items[i.name] || 0) + i.qty); }); const topItem = Object.keys(items).reduce((a, b) => items[a] > items[b] ? a : b, "--"); document.getElementById('dash-orders').innerText = totalOrders; document.getElementById('dash-revenue').innerText = 'SR ' + totalRevenue.toFixed(2); document.getElementById('dash-top-item').innerText = topItem; document.getElementById('dash-activity').innerHTML = (orders||[]).slice(-5).reverse().map(o => `<div class="flex justify-between items-center"><span class="font-bold text-slate-700">Order #${o.id}</span><span class="text-xs text-slate-400">${new Date(o.created_at).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span></div>`).join(''); };
        window.fetchHistory = async () => { const { data: orders } = await db.from('orders').select('*').eq('status', 'Completed').order('created_at', {ascending: false}).limit(20); document.getElementById('history-list').innerHTML = (orders||[]).map(o => `<tr><td class="p-4">#${o.id}</td><td class="p-4 text-slate-500">${new Date(o.created_at).toLocaleDateString()}</td><td class="p-4 text-xs font-medium">${(typeof o.items === 'string' ? JSON.parse(o.items) : o.items).length} items</td><td class="p-4 font-bold text-orange-500">SR ${o.total.toFixed(2)}</td><td class="p-4"><span class="bg-slate-100 px-2 py-1 rounded text-xs font-bold">${o.payment_method || 'Cash'}</span></td></tr>`).join(''); };
        let currentOrderToAccept = null;
                window.fetchOrders = async () => {
    const { data: orders } = await db.from('orders').select('*').order('created_at', {ascending: true});
    
    // 1. Fetch Users
    const { data: users } = await db.from('users').select('id, name, phone');
    
    // üîç DEBUG: Check the console to see if phone numbers are arriving!
    console.log("Admin Fetched Users:", users); 

    const userMap = {}; 
    (users||[]).forEach(u => userMap[u.id] = { name: u.name, phone: u.phone });
    
    const colNew = document.getElementById('col-new'); 
    const colCooking = document.getElementById('col-cooking'); 
    const colReady = document.getElementById('col-ready');
    colNew.innerHTML = ''; colCooking.innerHTML = ''; colReady.innerHTML = '';
    
    let activeCount = 0;
    (orders||[]).forEach(o => {
        if(o.status === 'Completed') return;
        activeCount++;
        
        // 2. Match User to Order
        const userObj = userMap[o.user_id] || { name: "Guest", phone: "" };
        const uName = userObj.name || "Guest";
        
        // 3. Create Phone HTML (Only if phone exists)
        const uPhone = userObj.phone 
            ? `<div class="text-xs text-slate-500 font-bold mt-1 bg-slate-100 px-2 py-1 rounded w-fit"><i class="fa-solid fa-phone text-[10px] mr-1"></i>${userObj.phone}</div>` 
            : `<div class="text-[10px] text-red-300 font-bold mt-1">No Phone Linked</div>`;

        const items = typeof o.items === 'string' ? JSON.parse(o.items) : o.items;
        const time = Math.floor((new Date() - new Date(o.created_at)) / 60000) + 'm';
        
        let nextAction = `openTimeModal(${o.id})`, btnTxt = "Accept", btnColor = "bg-slate-800";
        if(o.status === 'Preparing' || o.status === 'Cooking') { nextAction = `updateStatus(${o.id}, 'Ready')`; btnTxt = "Mark Ready"; btnColor = "bg-orange-500"; }
        if(o.status === 'Ready') { nextAction = `updateStatus(${o.id}, 'Completed')`; btnTxt = "Complete"; btnColor = "bg-green-600"; }

        const itemsHtml = items.map(i => { 
            let modsHtml = ''; 
            if(i.selectedMods && i.selectedMods.length > 0) modsHtml = `<div class="text-xs text-red-500 pl-2 mt-1 font-bold">${i.selectedMods.map(m => `- ${m.name}`).join('<br>')}</div>`; 
            return `<div class="flex justify-between items-start mb-2 border-b border-slate-50 pb-2 last:border-0 last:pb-0"><div><span class="font-bold text-slate-700 text-sm">${i.qty}x ${i.name}</span>${modsHtml}</div><span class="font-bold text-slate-900 text-xs">SR ${(i.qty * i.unitPrice).toFixed(2)}</span></div>`; 
        }).join('');
        
        const payBadge = `<span class="bg-orange-100 text-orange-600 px-2 py-1 rounded text-[10px] font-bold uppercase"><i class="fa-solid fa-credit-card mr-1"></i> ${o.payment_method || 'Cash'}</span>`;
        const promoSection = o.promo_code ? `<div class="flex justify-between items-center text-xs mt-1"><span class="text-slate-400 font-bold">Total</span><div><span class="line-through text-slate-400 mr-2">SR ${o.subtotal.toFixed(2)}</span><span class="font-black text-green-600 text-lg">SR ${o.total.toFixed(2)}</span></div></div><div class="text-xs text-purple-500 font-bold mt-1">Promo: ${o.promo_code}</div>` : `<div class="flex justify-between items-center mt-2"><span class="text-xs text-slate-400 font-bold uppercase">Total</span><span class="font-black text-slate-900 text-lg">SR ${o.total.toFixed(2)}</span></div>`;
        
        const card = `
        <div class="glass-card p-4 mb-3 animate-[fadeIn_0.3s]">
            <div class="flex justify-between mb-3">
                <div>
                    <span class="font-bold text-lg">#${o.id}</span> 
                    <span class="text-sm text-slate-800 font-bold block">${uName}</span>
                    ${uPhone}
                </div>
                <div class="flex flex-col items-end">
                    <span class="font-bold text-xs text-slate-400 bg-slate-50 px-2 py-1 rounded h-fit mb-1">${time}</span>
                    ${payBadge}
                </div>
            </div>
            <div class="bg-slate-50 p-3 rounded-xl mb-3">${itemsHtml}</div>
            ${promoSection}
            ${o.note ? `<div class="text-xs bg-red-50 text-red-500 p-2 rounded mt-3 font-bold"><i class="fa-solid fa-note-sticky mr-1"></i> ${o.note}</div>` : ''}
            <button onclick="${nextAction}" class="w-full py-3 rounded-lg text-white font-bold text-sm ${btnColor} shadow-lg active:scale-95 transition mt-4">${btnTxt}</button>
        </div>`;
        
        if(o.status === 'New Order') colNew.innerHTML += card; 
        else if(o.status === 'Preparing' || o.status === 'Cooking') colCooking.innerHTML += card; 
        else if(o.status === 'Ready') colReady.innerHTML += card;
    });
    document.getElementById('live-count').innerText = activeCount; document.getElementById('mobile-live-count').innerText = activeCount;
};


        // --- SMART TIMER LOGIC ---

window.openTimeModal = (id) => { 
    currentOrderToAccept = id; 
    document.getElementById('timeModal').classList.remove('hidden'); 
    
    // Reset Everything
    document.getElementById('custom-time').value = ''; 
    clearTimeSelection(); 
};
        window.selectTime = (mins, btn) => { 
    // 1. Set the hidden value
    document.getElementById('custom-time').value = mins; 
    
    // 2. Visual Feedback (Highlight button)
    clearTimeSelection();
    if(btn) btn.classList.add('active');
};

window.clearTimeSelection = () => {
    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
};

window.confirmTime = async () => { 
    const inputVal = document.getElementById('custom-time').value;
    const selectedMins = parseInt(inputVal) || 15;

    const btn = document.querySelector('#timeModal .btn-main');
    setBtnLoading(btn, true);

    try {
        const { data: order } = await db.from('orders').select('created_at').eq('id', currentOrderToAccept).single();
        if (!order) throw new Error("Order not found");

        const createdAt = new Date(order.created_at).getTime();
        const now = Date.now();
        
        // 1. Calculate how many minutes have passed since order came in
        const minutesPassed = (now - createdAt) / 60000; 
        
        // 2. Add passed time to selected time
        // Example: If order sat for 2.5 mins, and you chose 15, total is 17.5
        const preciseTotal = minutesPassed + selectedMins;

        // 3. THE FIX: Math.floor() removes the decimal (17.5 -> 17)
        // This stops the database crash AND keeps the timer from jumping up to "16"
        const realMinutesToSave = Math.floor(preciseTotal);

        // 4. Update Database
        await db.from('orders').update({ 
            status: 'Preparing', 
            estimated_mins: realMinutesToSave 
        }).eq('id', currentOrderToAccept);

        closeModal('timeModal'); 
        window.fetchOrders(); 
        showToast(`Order Started (${selectedMins}m)`); 
    
    } catch (e) {
        showToast("Error starting order", true);
        console.error("Timer Error:", e);
    }
    
    setBtnLoading(btn, false); 
};

        window.updateStatus = async (id, status) => { await db.from('orders').update({ status }).eq('id', id); window.fetchOrders(); window.fetchHistory(); window.fetchDashboard(); showToast("Status Updated"); };

        let allMods = []; let editMenuId = null; let editModId = null; let menuImgUrl = "";
        window.fetchMods = async () => { const { data } = await db.from('modifier_groups').select('*').order('sort_order', {ascending: true}); allMods = data || []; renderMods(); };
        function renderMods() { 
    const grid = document.getElementById('modifiers-grid'); 
    
    grid.innerHTML = allMods.map(g => {
        const options = typeof g.options === 'string' ? JSON.parse(g.options) : g.options;
        const optionsHtml = options.map(o => `<span class="text-[10px] bg-slate-50 border border-slate-200 px-2 py-1 rounded-md text-slate-600 font-bold">${o.name}</span>`).join('');
        
        return `
        <div class="glass-card p-4 relative flex items-center gap-4 group" data-id="${g.id}">
            <div class="cursor-move text-slate-300 px-2 py-2 hover:text-orange-500 transition">
                <i class="fa-solid fa-grip-vertical text-lg"></i>
            </div>

            <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                    <h4 class="font-bold text-slate-800 text-sm">${g.name}</h4>
                    ${g.required ? '<span class="text-[9px] bg-red-50 text-red-500 px-1.5 py-0.5 rounded font-bold uppercase border border-red-100">Required</span>' : ''}
                </div>
                <div class="flex flex-wrap gap-2">${optionsHtml}</div>
            </div>

            <div class="flex gap-3 pl-4 border-l border-slate-50">
                <button onclick='editMod(${JSON.stringify(g).replace(/'/g, "&#39;")})' class="text-slate-300 hover:text-blue-500 transition"><i class="fa-solid fa-pen"></i></button>
                <button onclick="delMod(${g.id})" class="text-slate-300 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button>
            </div>
        </div>`;
    }).join(''); 

    // AUTO-SAVE SORTABLE
    new Sortable(grid, { 
        animation: 150, 
        handle: '.cursor-move', 
        ghostClass: 'sortable-ghost', 
        onEnd: async () => {
            // 1. Get new order from DOM
            const newOrder = Array.from(grid.children).map((el, index) => ({
                id: el.dataset.id,
                sort_order: index
            }));

            // 2. Save to Database Immediately
            await Promise.all(newOrder.map(item => 
                db.from('modifier_groups').update({ sort_order: item.sort_order }).eq('id', item.id)
            ));

            showToast("Modifiers Saved");
        } 
    }); 
}


        window.openModModal = () => { editModId = null; document.getElementById('mod-modal-title').innerText="Create Group"; document.getElementById('mod-group-name').value=""; document.getElementById('mod-options-container').innerHTML=""; window.addModOptionInput(); document.getElementById('modModal').classList.remove('hidden'); };
        window.editMod = (g) => { editModId = g.id; document.getElementById('mod-modal-title').innerText="Edit Group"; document.getElementById('mod-group-name').value = g.name; document.getElementById('mod-required').checked = g.required; document.getElementById('mod-options-container').innerHTML = ""; (typeof g.options === 'string' ? JSON.parse(g.options) : g.options).forEach(o => window.addModOptionInput(o.name, o.price)); document.getElementById('modModal').classList.remove('hidden'); };
        window.addModOptionInput = (name = "", price = "") => document.getElementById('mod-options-container').insertAdjacentHTML('beforeend', `<div class="flex gap-2 mb-2 option-row"><input placeholder="Opt Name" class="input-box py-2 text-sm" value="${name}"><input type="number" placeholder="Price" class="input-box py-2 text-sm w-20" value="${price}"><i class="fa-solid fa-xmark text-slate-300 mt-3" onclick="this.parentElement.remove()"></i></div>`);
        window.saveModGroup = async (btn) => { setBtnLoading(btn, true); const name = document.getElementById('mod-group-name').value; const options = Array.from(document.querySelectorAll('.option-row')).map(r => ({ name: r.children[0].value, price: r.children[1].value })); const payload = { name, options, required: document.getElementById('mod-required').checked }; let err; if(editModId) { const {error} = await db.from('modifier_groups').update(payload).eq('id', editModId); err=error; } else { const {error} = await db.from('modifier_groups').insert(payload); err=error; } setBtnLoading(btn, false); if(err) showToast(err.message, true); else { closeModal('modModal'); window.fetchMods(); showToast("Saved"); } };
        // 2. DELETE MODIFIER GROUP
      window.delMod = async (id) => {
    // üõë Elegant Stop
    if(!await showConfirm("Delete this modifier group?")) return;

    // Proceed to Delete
    const { error } = await db.from('modifier_groups').delete().eq('id', id);
    if(error) {
        showToast("Error deleting group", true);
    } else {
        showToast("Group deleted");
        fetchMods(); // Refresh Grid
    }
};
        window.fetchMenu = async () => { 
    // 1. Fetch Data
    const { data } = await db.from('menu').select('*').order('sort_order', {ascending: true}); 
    
    // 2. Save to Global Variable (So Translation Manager can see it!)
    allMenuItems = data || [];

    // 3. Render Grid
    const grid = document.getElementById('menu-grid'); 
    grid.innerHTML = (allMenuItems).map(i => `
        <div class="glass-card flex gap-3 p-3 relative ${i.available===false?'item-off':''}" data-id="${i.id}">
            <div class="absolute left-2 top-1/2 -translate-y-1/2 cursor-move text-slate-300 px-2 py-4 hover:text-orange-500 transition">
                <i class="fa-solid fa-grip-vertical"></i>
            </div>
            
            <img src="${i.image||'https://via.placeholder.com/50'}" class="w-16 h-16 rounded-lg object-cover bg-slate-50 ml-8">
            
            <div class="flex-1">
                <h4 class="font-bold text-sm">${i.name}</h4>
                <p class="text-orange-500 font-bold text-xs">SR ${i.price}</p>
                <div class="flex gap-2 mt-1">
                    ${i.is_best_seller ? '<span class="text-[9px] bg-yellow-100 text-yellow-600 px-1.5 rounded font-bold">BEST</span>' : ''}
                    ${i.available===false ? '<span class="text-[9px] bg-red-100 text-red-600 px-1.5 rounded font-bold">OFF</span>' : ''}
                </div>
            </div>
            
            <div class="absolute top-3 right-3 flex gap-4">
                <button onclick='editItem(${JSON.stringify(i).replace(/'/g, "&#39;")})' class="text-slate-300 hover:text-blue-500"><i class="fa-solid fa-pen"></i></button>
                <button onclick="toggleAvailability(${i.id}, ${i.available})" class="text-slate-300 hover:text-green-500"><i class="fa-solid fa-power-off"></i></button>
                <button onclick="toggleBest(${i.id}, ${i.is_best_seller})" class="text-slate-300 hover:text-yellow-500"><i class="fa-solid fa-star"></i></button>
                <button onclick="delItem(${i.id})" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
            </div>
        </div>
    `).join(''); 
    
    // 4. Setup Drag & Drop
    new Sortable(grid, { 
        animation: 150, 
        handle: '.cursor-move', 
        ghostClass: 'sortable-ghost', 
        onEnd: async () => {
            const newOrder = Array.from(grid.children).map((el, index) => ({
                id: el.dataset.id,
                sort_order: index
            }));
            await Promise.all(newOrder.map(item => 
                db.from('menu').update({ sort_order: item.sort_order }).eq('id', item.id)
            ));
            showToast("Menu Order Saved");
        } 
    }); 

    // 5. Refresh Translations UI (The Fix)
    if(typeof fetchTranslations === 'function') {
        fetchTranslations();
    }
};



   
        window.saveMenuOrder = async (btn) => { setBtnLoading(btn, true); const items = Array.from(document.getElementById('menu-grid').children).map((el, index) => ({ id: el.dataset.id, sort_order: index })); const mods = Array.from(document.getElementById('modifiers-grid').children).map((el, index) => ({ id: el.dataset.id, sort_order: index })); for (const item of items) await db.from('menu').update({ sort_order: item.sort_order }).eq('id', item.id); for (const mod of mods) await db.from('modifier_groups').update({ sort_order: mod.sort_order }).eq('id', mod.id); showToast("Order Saved"); document.getElementById('save-order-btn').classList.add('hidden'); setBtnLoading(btn, false); };
        window.toggleAvailability = async (id, status) => { await db.from('menu').update({ available: !status }).eq('id', id); window.fetchMenu(); showToast("Updated"); };
        window.toggleBest = async (id, status) => { await db.from('menu').update({ is_best_seller: !status }).eq('id', id); window.fetchMenu(); showToast("Updated"); };
        window.openMenuModal = () => { editMenuId = null; document.getElementById('menu-modal-title').innerText="Add New Item"; document.getElementById('m-name').value=""; document.getElementById('m-price').value=""; document.getElementById('m-desc').value=""; document.getElementById('m-cat').value=""; menuImgUrl=""; document.getElementById('m-img-preview').classList.add('hidden'); document.getElementById('m-available').checked=true; document.getElementById('m-best').checked=false; document.getElementById('item-modifier-list').innerHTML = allMods.map(g => `<label class="flex items-center gap-2 text-sm p-2 border rounded"><input type="checkbox" value="${g.id}" class="mod-check accent-orange-500"> ${g.name}</label>`).join(''); document.getElementById('menuModal').classList.remove('hidden'); };
        window.editItem = (i) => { editMenuId = i.id; document.getElementById('menu-modal-title').innerText="Edit Item"; menuImgUrl = i.image; document.getElementById('m-name').value = i.name; document.getElementById('m-price').value = i.price; document.getElementById('m-cat').value = i.category || ""; document.getElementById('m-desc').value = i.description || ""; document.getElementById('m-available').checked = i.available !== false; document.getElementById('m-best').checked = i.is_best_seller === true; if(i.image) { document.getElementById('m-img-preview').src = i.image; document.getElementById('m-img-preview').classList.remove('hidden'); } document.getElementById('item-modifier-list').innerHTML = allMods.map(g => `<label class="flex items-center gap-2 text-sm p-2 border rounded"><input type="checkbox" value="${g.id}" class="mod-check accent-orange-500" ${(i.modifier_group_ids||[]).includes(g.id) ? 'checked' : ''}> ${g.name}</label>`).join(''); document.getElementById('menuModal').classList.remove('hidden'); };
        window.saveMenuItem = async (btn) => { setBtnLoading(btn, true); const mods = Array.from(document.querySelectorAll('.mod-check:checked')).map(c => parseInt(c.value)); const payload = { name: document.getElementById('m-name').value, price: parseFloat(document.getElementById('m-price').value), description: document.getElementById('m-desc').value, image: menuImgUrl, category: document.getElementById('m-cat').value, modifier_group_ids: mods, available: document.getElementById('m-available').checked, is_best_seller: document.getElementById('m-best').checked }; try { let { error } = editMenuId ? await db.from('menu').update(payload).eq('id', editMenuId) : await db.from('menu').insert(payload); if(error) throw error; closeModal('menuModal'); window.fetchMenu(); showToast("Saved"); } catch(err) { if(err.message.includes('category')) { delete payload.category; await (editMenuId ? db.from('menu').update(payload).eq('id', editMenuId) : db.from('menu').insert(payload)); closeModal('menuModal'); window.fetchMenu(); showToast("Saved"); } else showToast(err.message, true); } setBtnLoading(btn, false); };
        window.delItem = async (id) => {
    // üõë Elegant Stop
    if(!await showConfirm("Delete this food item permanently?")) return;

    // Proceed to Delete
    const { error } = await db.from('menu').delete().eq('id', id);
    if(error) {
        showToast("Error deleting item", true);
    } else {
        showToast("Item deleted");
        fetchMenu(); // Refresh Grid
    }
};

        window.fetchSettings = async () => { const { data: splash } = await db.from('settings').select('data').eq('id', 'splash').single(); if(splash?.data) { document.getElementById('splash-title').value = splash.data.title||""; document.getElementById('splash-intro').value = splash.data.intro||""; if(splash.data.background) { splashBg = splash.data.background; document.getElementById('splash-bg-preview').src = splashBg; document.getElementById('splash-bg-preview').classList.remove('hidden'); } } const { data: hero } = await db.from('settings').select('data').eq('id', 'hero').single(); if(hero?.data) { document.getElementById('hero-list-container').innerHTML = (hero.data.images||[]).map((u,i) => `<div class="relative w-full h-24 rounded-lg overflow-hidden"><img src="${u}" class="w-full h-full object-cover"><button onclick="delHeroImg(${i})" class="absolute top-1 right-1 bg-red-500 text-white w-5 h-5 rounded-full text-xs flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button></div>`).join(''); heroImages = hero.data.images || []; } };
                window.fetchDesign = async () => { 
            const { data } = await db.from('settings').select('data').eq('id', 'design').single(); 
            if(data?.data) {
                // Load Primary Color
                document.getElementById('design-color').value = data.data.primaryColor || "#FF5722";
                // Load Background Color (New)
                document.getElementById('design-bg-color').value = data.data.backgroundColor || "#F8FAFC";
            } 
        };
        let heroImages = [], splashBg="", splashC="";
        window.saveSplashSettings = async (btn) => { setBtnLoading(btn, true); await db.from('settings').upsert({ id: 'splash', data: { title: document.getElementById('splash-title').value, intro: document.getElementById('splash-intro').value, background: splashBg, circle: splashC } }); showToast("Splash Saved"); setBtnLoading(btn, false); };
        window.saveHeroSettings = async (btn) => { setBtnLoading(btn, true); await db.from('settings').upsert({ id: 'hero', data: { images: heroImages } }); showToast("Hero Saved"); setBtnLoading(btn, false); };
        window.delHeroImg = (i) => { heroImages.splice(i,1); window.saveHeroSettings(); window.fetchSettings(); };
                window.saveDesign = async (btn) => { 
            setBtnLoading(btn, true); 
            
            const payload = { 
                primaryColor: document.getElementById('design-color').value,
                backgroundColor: document.getElementById('design-bg-color').value
            };

            await db.from('settings').upsert({ id: 'design', data: payload }); 
            showToast("Design Saved"); 
            setBtnLoading(btn, false); 
        };
        let workingHours = []; 
        window.fetchInfo = async () => { const { data } = await db.from('settings').select('data').eq('id', 'info').single(); if(data?.data) { const d = data.data; document.getElementById('info-loc').value = d.location || ""; document.getElementById('info-phone').value = d.phone || ""; document.getElementById('info-insta').value = d.instagram || ""; document.getElementById('info-twit').value = d.twitter || ""; document.getElementById('info-tik').value = d.tiktok || ""; workingHours = d.hours || []; renderHours(workingHours); } };
        function renderHours(hoursData) { workingHours = hoursData; document.getElementById('hours-container').innerHTML = workingHours.map((h, i) => `<div class="flex gap-2 items-center mb-2"><input value="${h.day}" placeholder="Day" class="input-box py-2 w-1/3" onchange="updateHour(${i}, 'day', this.value)"><input value="${h.time}" placeholder="Time" class="input-box py-2 w-2/3" onchange="updateHour(${i}, 'time', this.value)"><button onclick="removeHour(${i})" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button></div>`).join(''); } 
        window.addHourRow = () => { workingHours.push({day:'', time:''}); renderHours(workingHours); }; 
        window.updateHour = (i, key, val) => { workingHours[i][key] = val; }; 
        window.removeHour = (i) => { workingHours.splice(i, 1); renderHours(workingHours); }; 
        window.saveInfo = async (btn) => { setBtnLoading(btn, true); const payload = { location:document.getElementById('info-loc').value, phone:document.getElementById('info-phone').value, instagram:document.getElementById('info-insta').value, twitter:document.getElementById('info-twit').value, tiktok:document.getElementById('info-tik').value, hours:workingHours }; await db.from('settings').upsert({ id: 'info', data: payload }); showToast("Info Saved"); setBtnLoading(btn, false); };
        window.fetchPromos = async () => { const { data } = await db.from('promocodes').select('*'); document.getElementById('promo-list').innerHTML = (data||[]).map(p => `<div class="glass-card p-3 flex justify-between"><div><b class="block">${p.code}</b><span class="text-xs">${p.type} ${p.value}</span></div><button onclick="delPromo(${p.id})" class="text-red-400"><i class="fa-solid fa-trash"></i></button></div>`).join(''); }; 
        // --- LOYALTY SETTINGS ---
window.fetchLoyalty = async () => {
    const { data } = await db.from('settings').select('data').eq('id', 'loyalty_program').single();
    if(data?.data) {
        document.getElementById('loyalty-type').value = data.data.type || 'fixed';
        document.getElementById('loyalty-val').value = data.data.value || 10;
    }
};

window.saveLoyaltySettings = async (btn) => {
    setBtnLoading(btn, true);
    const payload = {
        type: document.getElementById('loyalty-type').value,
        value: parseFloat(document.getElementById('loyalty-val').value)
    };
    
    const { error } = await db.from('settings').upsert({ id: 'loyalty_program', data: payload });
    
    if(error) showToast(error.message, true);
    else showToast("Loyalty Updated");
    
    setBtnLoading(btn, false);
};

        window.openPromoModal = () => { document.getElementById('p-code').value = ""; document.getElementById('p-val').value = ""; document.getElementById('p-exp').value = ""; document.getElementById('promoModal').classList.remove('hidden'); };
        window.savePromo = async (btn) => { const code = document.getElementById('p-code').value; const val = document.getElementById('p-val').value; if(!code || !val) { showToast("Missing Fields", true); return; } setBtnLoading(btn, true); const { error } = await db.from('promocodes').insert({ code: code.toUpperCase(), type: document.getElementById('p-type').value, value: parseFloat(val), expires: document.getElementById('p-exp').value }); if(error) showToast(error.message, true); else { closeModal('promoModal'); window.fetchPromos(); showToast("Promo Created"); } setBtnLoading(btn, false); }; 
        // 3. DELETE PROMO CODE
window.delPromo = async (id) => {
    // üõë Elegant Stop
    if(!await showConfirm("Revoke this promo code?")) return;

    // Proceed to Delete
    const { error } = await db.from('promocodes').delete().eq('id', id);
    if(error) {
        showToast("Error removing code", true);
    } else {
        showToast("Code removed");
        fetchPromos(); // Refresh List
    }
};
        window.fetchNewUserPromo = async () => { const { data } = await db.from('settings').select('data').eq('id', 'new_user_promo').single(); if(data && data.data)
        document.getElementById('new-user-code').value = data.data.code || 'WELCOME30'; { document.getElementById('new-user-type').value = data.data.type || 'percent'; document.getElementById('new-user-val').value = data.data.value || ''; } }; 
        window.saveNewUserPromo = async (btn) => { 
    setBtnLoading(btn, true); 
    const payload = { 
        code: document.getElementById('new-user-code').value.toUpperCase(), // New
        type: document.getElementById('new-user-type').value, 
        value: document.getElementById('new-user-val').value 
    }; 
    await db.from('settings').upsert({ id: 'new_user_promo', data: payload }); 
    showToast("New User Promo Saved"); 
    setBtnLoading(btn, false); 
};

        function checkAuth() {
    if (!db) {
        document.getElementById('preloader')?.classList.add('loaded');
        document.getElementById('auth-overlay')?.classList.remove('hidden');
        return;
    }

    db.auth.getSession()
      .then(({ data }) => {
          const session = data?.session;
          if (session) {
              document.getElementById('auth-overlay')?.classList.add('hidden');
              initAdmin();
          } else {
              document.getElementById('auth-overlay')?.classList.remove('hidden');
          }
      })
      .catch((err) => {
          console.error("checkAuth error:", err);
          document.getElementById('auth-overlay')?.classList.remove('hidden');
      })
      .finally(() => {
          document.getElementById('preloader')?.classList.add('loaded');
      });
}

document.addEventListener('visibilitychange', () => {
    if (!document.hidden && db) {
        console.log('üîÑ Page visible again ‚Üí restarting realtime');
        startOrdersRealtime();
        fetchOrders();
    }
});



        // Start App
        loadSupabaseLib();
    </script>
</body>
</html>
