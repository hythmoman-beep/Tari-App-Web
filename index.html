<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TARI - Ø¹Ø±Ø¨Ø© Ø·Ø¹Ø§Ù… ÙØ§Ø®Ø±Ø©</title>
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Marhey:wght@300..700&display=swap" rel="stylesheet">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=El+Messiri:wght@400..700&display=swap" rel="stylesheet">

    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Righteous&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#FF5722">
<link rel="apple-touch-icon" href="icon-192.png">

    
    <style>
        
/* AI FLYING ANIMATION CLASS */
.flying-hero {
    position: fixed !important;
    z-index: 9999 !important;
    transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1) !important;
    pointer-events: none;
}
@keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
.animate-spin-slow { animation: spin-slow 20s linear infinite; }

/* --- RELOAD MODE (Window Style) --- */
/* 1. The Active Window (Visible) */
#preloader.reload-mode {
    background-color: rgba(255, 255, 255, 0.95) !important;
    backdrop-filter: blur(5px);
    
    opacity: 1 !important; /* Start fully visible */
    transform: translateX(0) !important; /* STAY IN CENTER (Don't slide) */
    
    /* This transition controls the fade out speed */
    transition: opacity 0.8s ease-out !important; 
}

/* 2. The Exit State (Fade Out) */
/* We need this to override the default "Slide Left" behavior */
#preloader.reload-mode.loaded {
    opacity: 0 !important; /* Fade to transparent */
    transform: translateX(0) !important; /* STAY IN CENTER */
    pointer-events: none;
}

/* Hide truck in reload mode */
#preloader.reload-mode .loader-content { display: none !important; }

/* Show spinner in reload mode */
#preloader.reload-mode .spinner-content { display: flex !important; }


        
        /* --- LOYALTY SYSTEM STYLES --- */
.loyalty-progress-bg {
    background: #f1f5f9;
    border-radius: 99px;
    height: 8px;
    width: 100%;
    overflow: hidden;
    position: relative;
    margin-top: 8px;
    direction: ltr; /* Keep bar filling from left to right even in Arabic */
}

.loyalty-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #f97316, #fbbf24);
    border-radius: 99px;
    width: 0%;
    transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
}

/* Shiny effect */
.loyalty-progress-fill::after {
    content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
    transform: translateX(-100%); animation: shinyDot 2s infinite ease-in-out;
}

/* Gift Badge in Cart */
.badge-gift {
    background: linear-gradient(135deg, #8b5cf6, #d946ef);
    color: white; font-size: 10px; font-weight: 900; padding: 2px 8px;
    border-radius: 6px; display: inline-flex; align-items: center; gap: 4px;
    box-shadow: 0 2px 5px rgba(139, 92, 246, 0.3);
}

.loyalty-card.locked { filter: grayscale(1); opacity: 0.7; }

/* History Accordion Animation */
.details-wrapper { transition: grid-template-rows 0.3s ease-out; }

        
            /* --- NEW AI ANIMATIONS --- */
    @keyframes bounce-slow { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    .animate-bounce-slow { animation: bounce-slow 3s infinite ease-in-out; }
    
    @keyframes fade-up { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-up { animation: fade-up 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

    .ease-out-expo { transition-timing-function: cubic-bezier(0.19, 1, 0.22, 1); }

    /* Chip Buttons */
    .chip-btn {
        white-space: nowrap;
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        color: #94a3b8;
        padding: 8px 16px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 700;
        transition: all 0.2s;
        flex-shrink: 0;
    }
    .chip-btn:hover { background: rgba(255,255,255,0.1); color: white; border-color: rgba(255,255,255,0.2); transform: translateY(-1px); }
    .chip-btn:active { transform: scale(0.95); }

    /* Mask for chips fade effect */
    .mask-gradient { -webkit-mask-image: linear-gradient(to right, black 85%, transparent 100%); }
    
    /* --- OPTIMIZED GHOST ANIMATION --- */
    #ai-interface {
        transform-origin: bottom left; /* Expands from the button */
        will-change: transform, opacity;
        backface-visibility: hidden;
        transform: translateZ(0); 
        transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1), opacity 0.4s ease;
    }

    /* Hidden State (Ghosted) */
    .ai-ghost-hidden {
        transform: scale(0) translate(-50px, 100px); 
        opacity: 0;
        pointer-events: none;
        visibility: hidden; 
    }

    /* Visible State */
    .ai-ghost-visible {
        transform: scale(1) translate(0, 0);
        opacity: 1;
        pointer-events: auto;
        visibility: visible;
    }

    /* Typewriter Cursor */
    .typing-cursor::after {
        content: '|';
        animation: blink 1s step-start infinite;
        color: #f97316;
    }
    @keyframes blink { 50% { opacity: 0; } }

        
        /* FLASH ANIMATION (For Validation Errors) */
@keyframes flashRed {
    0% { background-color: transparent; border-color: #E2E8F0; }
    50% { background-color: #FEF2F2; border-color: #EF4444; box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1); }
    100% { background-color: transparent; border-color: #E2E8F0; }
}
.flash-error { 
    animation: flashRed 1s ease-in-out; 
    border-radius: 12px; 
}

/* =========================================
   CLASSIC TRUCK PULL LOADER (SLIDE FIX)
   ========================================= */

#preloader { 
    position: fixed; 
    inset: 0; 
    background: #ffffff !important; /* Force Pure White */
    z-index: 9999; 
    display: flex; 
    flex-direction: column; 
    justify-content: center; 
    align-items: center; 
    
    /* 1. STARTING STATE */
    transform: translateX(0%);
    opacity: 1;
    
    /* 2. THE EXIT MOVEMENT (Slide Left for Arabic/RTL) */
    /* ease-in: Starts slow (heavy pull), ends fast */
    transition: transform 0.8s cubic-bezier(0.5, 0, 0.1, 1) !important;
    
    box-shadow: 15px 0 40px rgba(0,0,0,0.1); 
    will-change: transform;
}

/* THE EXIT STATE (Triggered by JS) */
#preloader.loaded { 
    transform: translateX(-100%) !important; /* Move fully LEFT for RTL */
    opacity: 1 !important; 
    pointer-events: none; 
}

/* WRAPPER */
.loader-content {
    display: flex;
    flex-direction: column; 
    align-items: center;
    justify-content: center;
    width: 100%;
}

/* GIF STYLING */
.loader-gif {
    width: 180px; 
    height: auto;
    display: block;
    margin-bottom: 25px; 
    
    /* ğŸª„ COLOR MATCH FIX */
    filter: contrast(1.2) brightness(1.1);
    mix-blend-mode: multiply; 
}

/* STATUS BAR */
.loader-status {
    text-align: center;
    width: 160px; 
}

.loader-text {
    font-family: 'El Messiri', sans-serif; /* Arabic Font */
    color: #0f172a;
    font-size: 0.85rem; 
    letter-spacing: 0; /* No letter spacing for Arabic */
    margin-bottom: 10px;
    font-weight: 700;
    animation: pulseText 1.5s infinite alternate;
}

.loader-progress-bg {
    width: 100%;
    height: 4px;
    background: #f1f5f9;
    border-radius: 10px;
    overflow: hidden;
}

.loader-progress-fill {
    height: 100%;
    width: 30%;
    background: #FF5722; 
    border-radius: 10px;
    animation: loadBar 2s infinite cubic-bezier(0.4, 0, 0.2, 1);
}

/* ANIMATIONS */
@keyframes pulseText { from { opacity: 0.5; } to { opacity: 1; } }
@keyframes loadBar { 
    0% { width: 0%; transform: translateX(50%); } 
    50% { width: 70%; transform: translateX(0); } 
    100% { width: 100%; transform: translateX(-50%); } 
}


        /* FORCE GREEN BUTTON (For Success State) */
.bg-green-force { 
    background-color: #22c55e !important; 
    color: white !important; 
    border-color: #22c55e !important; 
}

        /* PRELOADER STYLES (From English Version) */
#preloader { 
    position: fixed; 
    inset: 0; 
    background: #F8FAFC; 
    z-index: 9999; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    transition: opacity 0.5s; 
    pointer-events: none; 
}

#preloader.loaded { 
    opacity: 0; 
}

        
        
    /* FORCE HIDE CROPPER UNTIL ACTIVE */
    #crop-modal:not(.active) {
        display: none !important;
    }



        /* OVERRIDE FONT FAMILY */
        body { 
    /* Roboto handles Numbers & English. El Messiri handles Arabic. */
    font-family: 'Roboto', 'El Messiri', sans-serif !important; 
    
    background-color: #F8FAFC; 
    -webkit-tap-highlight-color: transparent; 
    overflow-x: hidden; 
    overscroll-behavior-y: none;
}
 
    /* ... keep your other settings ... */
}

 
            background-color: #F8FAFC; 
            -webkit-tap-highlight-color: transparent; 
            overflow-x: hidden; 
            overscroll-behavior-y: none;
        }

        /* PREMIUM ANIMATIONS (Generic for both directions) */
        @keyframes slideInNext {
            0% { opacity: 0; transform: translateX(-30px); } /* RTL: Comes from Left */
            100% { opacity: 1; transform: translateX(0); }
        }
        @keyframes slideInPrev {
            0% { opacity: 0; transform: translateX(30px); } /* RTL: Comes from Right */
            100% { opacity: 1; transform: translateX(0); }
        }
        .anim-next { animation: slideInNext 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        .anim-prev { animation: slideInPrev 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }

        /* HEADER GHOST */
        .header-ghost-container {
            background: transparent !important;
            overflow: visible !important;
            position: relative;
            z-index: 40;
        }
        .header-ghost-container::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 140%;
            background: linear-gradient(to bottom, var(--header-bg, #0f172a) 0%, var(--header-bg, #0f172a) 75%, transparent 100%);
            z-index: -1; pointer-events: none;
        }

        /* BRAND FONT (Keep English Name in English Font) */
        .font-brand-en { font-family: 'Righteous', cursive; }
        
        .font-robotic {
    font-family: 'Righteous', cursive; /* âœ… Fixed */
    color: #1EBBCF !important;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    line-height: 1;
    text-shadow: none !important;
}


        /* SPLASH & MODALS */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        .fade-out { animation: fadeOut 0.5s ease-out forwards; }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(1.1); } }
        
        .splash-gone { display: none !important; }

        /* SHINE EFFECT (Mirrored for RTL) */
        .badge-shine-gold {
            background: linear-gradient(135deg, #FCD34D 0%, #F59E0B 100%);
            color: #451a03; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.2); z-index: 20;
        }
        .badge-shine-gold::after {
            content: ''; position: absolute; top: 0; right: -150%; /* RTL Start */
            width: 100%; height: 100%;
            background: linear-gradient(270deg, transparent, rgba(255,255,255,0.8), transparent);
            transform: skewX(20deg);
            animation: shineBadgeRTL 2.5s infinite ease-in-out;
        }
        @keyframes shineBadgeRTL {
            0% { right: -150%; } 20% { right: 150%; } 100% { right: 150%; }
        }

        /* HERO SLIDER */
        #hero-slider-container { contain: paint; isolation: isolate; will-change: opacity; }
        .hero-slide {
            position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover;
            transform: translateZ(0) scale(1.05); opacity: 0; transition: opacity 0.8s ease-out, transform 0.8s ease-out; backface-visibility: hidden;
        }
        .hero-slide.active-slide { opacity: 1; transform: translateZ(0) scale(1); }

        /* THEME UTILS */
        :root { --primary: #FF5722; }
        .bg-brand { background-color: var(--primary) !important; }
        .text-brand { color: var(--primary) !important; }
        .border-brand { border-color: var(--primary) !important; }
        .nav-item.active { color: var(--primary); }
        .cat-btn.active { background-color: var(--primary) !important; color: white !important; border-color: var(--primary) !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }

        /* TOAST (RTL Alignment) */
        #toast { 
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); 
            background: #1E293B; color: white; padding: 12px 24px; border-radius: 50px; 
            display: flex; align-items: center; gap: 12px; direction: rtl;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            z-index: 1000; opacity: 0; width: max-content; max-width: 90%; 
        }
        #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* TRACKER STRIPE (RTL Logic) */
        .step-container { display: flex; align-items: center; justify-content: space-between; position: relative; margin-bottom: 24px; direction: rtl; }
        .step-circle { width: 32px; height: 32px; border-radius: 50%; background: #F1F5F9; color: #94A3B8; font-weight: 800; font-size: 12px; display: flex; align-items: center; justify-content: center; z-index: 2; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: all 0.3s; }
        .step-circle.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(255, 87, 34, 0.3); transform: scale(1.1); }
        .step-line-container { position: absolute; top: 50%; right: 0; width: 100%; height: 4px; background: #E2E8F0; z-index: 1; transform: translateY(-50%); border-radius: 10px; overflow: hidden; }
        .step-line-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s ease-in-out; position: relative; float: right; }

        /* FLOATING ICONS */
        .floating-icon { position: absolute; font-size: 3.5rem; opacity: 0.8; z-index: 5; animation: floatHover 6s ease-in-out infinite; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }
        @keyframes floatHover { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-20px) rotate(10deg); } }

        /* MODAL SHEET */
        .modal-shell { pointer-events: none; }
        .modal-shell.active { pointer-events: auto; }
        
        /* CLOSED MODAL ANIM */
        .zzz-anim { position: absolute; font-weight: 900; color: #cbd5e1; animation: floatZ 2.5s infinite ease-in-out; }
        @keyframes floatZ { 0% { opacity: 0; transform: translateY(10px) translateX(5px); } 50% { opacity: 1; } 100% { opacity: 0; transform: translateY(-20px) translateX(-5px); } }

        /* GOLD TEXT */
        .text-gold-shine {
            background: linear-gradient(to left, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            -webkit-background-clip: text; background-clip: text; color: transparent; background-size: 200% auto; animation: shineGold 3s linear infinite;
        }
        @keyframes shineGold { to { background-position: -200% center; } }
    </style>
</head>
<body class="text-slate-800 select-none">
     
    <div id="preloader">
    <div id="loader-truck" class="loader-content" style="display: none;">
        <img src="https://i.postimg.cc/d3J4V4xc/grok-video-2026-01-04-23-09-44.gif" class="loader-gif" alt="Loading...">
        <div class="loader-status">
            <h2 class="loader-text" dir="rtl">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
            <div class="loader-progress-bg">
                <div class="loader-progress-fill"></div>
            </div>
        </div>
    </div>

    <div id="loader-spinner" class="spinner-content hidden flex-col items-center justify-center">
        <i class="fa-solid fa-circle-notch fa-spin text-5xl text-orange-500 mb-4 drop-shadow-md"></i>
        <p class="text-slate-800 font-bold text-sm animate-pulse">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...</p>
    </div>
</div>


<div id="ai-onboarding" class="fixed inset-0 z-[600] hidden flex items-center justify-center">
    
    <div id="ai-onboard-backdrop" class="absolute inset-0 bg-slate-900/60 backdrop-blur-md transition-opacity duration-500 opacity-0"></div>
    
    <div id="ai-onboard-card" class="relative w-[90%] max-w-sm bg-slate-900/90 border border-white/10 rounded-[2.5rem] p-8 text-center shadow-[0_0_50px_rgba(249,115,22,0.15)] transform scale-95 opacity-0 transition-all duration-500 cubic-bezier(0.34, 1.56, 0.64, 1) overflow-hidden">
        
        <div class="absolute -top-20 -left-20 w-40 h-40 bg-orange-500 rounded-full blur-[80px] opacity-20 animate-pulse"></div>
        <div class="absolute -bottom-20 -right-20 w-40 h-40 bg-blue-500 rounded-full blur-[80px] opacity-20 animate-pulse" style="animation-delay: 1s"></div>

        <div class="relative z-10 mb-6">
            <div class="relative w-40 h-40 mx-auto flex items-center justify-center">
                <div class="absolute inset-0 border-2 border-dashed border-orange-500/30 rounded-full animate-[spin_10s_linear_infinite]"></div>
                <div class="absolute inset-2 border border-white/10 rounded-full"></div>
                
                <div id="ai-hero-wrapper" class="w-full h-full relative z-20">
                    <lottie-player 
                        id="ai-hero-lottie"
                        background="transparent" 
                        speed="1" 
                        style="width: 100%; height: 100%;" 
                        loop 
                        autoplay>
                    </lottie-player>
                </div>
            </div>
        </div>
        
        <div class="relative z-10 space-y-2 mb-8">
            <h2 class="text-3xl font-black text-white tracking-tight">
                Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ <span class="text-orange-500">Ø§Ù„Ø°ÙƒÙŠ</span>
            </h2>
            <p class="text-slate-400 text-sm font-medium leading-relaxed">
                Ø£Ù†Ø§ Ø¬Ø§Ù‡Ø² Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ! 
                <br>Ù‡Ù„ Ù†Ø¨Ø¯Ø£ Ø¨Ø·Ù„Ø¨ ÙˆØ¬Ø¨Ø© Ù„Ø°ÙŠØ°Ø©ØŸ
            </p>
        </div>

        <button onclick="dropAiToSpot()" class="relative z-10 w-full bg-gradient-to-r from-orange-500 to-orange-600 text-white py-4 rounded-2xl font-black text-lg shadow-lg shadow-orange-500/25 active:scale-95 transition-transform hover:shadow-orange-500/40 group overflow-hidden">
            <span class="relative z-10 flex items-center justify-center gap-2">
                Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù† <i class="fa-solid fa-arrow-down group-hover:translate-y-1 transition-transform"></i>
            </span>
            <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
        </button>
    </div>
</div>


<div id="gender-modal" class="fixed inset-0 z-[400] bg-slate-900/95 backdrop-blur-sm hidden flex items-center justify-center p-6 fade-in">
    <div class="bg-white w-full max-w-xs rounded-3xl p-6 text-center shadow-2xl relative overflow-hidden">
        <h3 class="text-xl font-black text-slate-800 mb-2">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! ğŸ‘‹</h3>
        <p class="text-slate-500 text-sm mb-6">ÙƒÙŠÙ ÙŠÙˆØ¯ Ø§Ù„Ø´ÙŠÙ Ù…Ø®Ø§Ø·Ø¨ØªÙƒØŸ</p>
        
        <div class="flex gap-3">
            <button onclick="selectGender('male')" class="flex-1 bg-blue-50 border-2 border-blue-100 hover:border-blue-500 py-4 rounded-2xl transition group relative overflow-hidden">
                <div class="text-3xl mb-1 group-hover:scale-110 transition">ğŸ‘¨</div>
                <span class="font-bold text-blue-600 text-sm">Ø±Ø¬Ù„</span>
            </button>
            <button onclick="selectGender('female')" class="flex-1 bg-pink-50 border-2 border-pink-100 hover:border-pink-500 py-4 rounded-2xl transition group relative overflow-hidden">
                <div class="text-3xl mb-1 group-hover:scale-110 transition">ğŸ‘©</div>
                <span class="font-bold text-pink-600 text-sm">Ø§Ù…Ø±Ø£Ø©</span>
            </button>
        </div>
    </div>
</div>
<button onclick="toggleAi(true)" id="ai-trigger" class="fixed bottom-24 left-6 z-[100] w-16 h-16 rounded-full shadow-2xl flex items-center justify-center transform transition-all duration-500 hover:scale-110 active:scale-95 group overflow-hidden border-2 border-white/50 backdrop-blur-md bg-slate-900/80">
    <div class="absolute inset-0 bg-gradient-to-tr from-orange-500 to-yellow-500 opacity-20 group-hover:opacity-40 transition-opacity"></div>
    
     <lottie-player 
        id="ai-lottie-master"  
        src="https://fpgspmhgwcmhaaxsphcd.supabase.co/storage/v1/object/public/images/Headphone%20with%20blueberry%20cartoon%20(1).json" 
        background="transparent" 
        speed="1" 
        style="width: 50px; height: 50px; position: relative; z-index: 10;" 
        loop 
        autoplay>
    </lottie-player>

    <div id="ai-badge" class="absolute top-3 right-3 w-3 h-3 bg-red-500 rounded-full border-2 border-slate-900 hidden"></div>
</button>

<div id="ai-interface" class="fixed inset-x-0 bottom-0 z-[100] ai-ghost-hidden flex flex-col justify-end h-[85vh] sm:h-[650px]">

    <div onclick="toggleAi(false)" class="absolute inset-0 bg-black/40 backdrop-blur-[2px] pointer-events-auto transition-opacity duration-500 opacity-0" id="ai-backdrop"></div>

    <div class="relative w-full max-w-md mx-auto h-full bg-slate-900/90 backdrop-blur-xl border-t border-x border-white/10 rounded-t-[2.5rem] shadow-[0_-10px_40px_rgba(0,0,0,0.3)] flex flex-col overflow-hidden pointer-events-auto transform transition-transform duration-500 ease-out-expo">
        
        <div class="shrink-0 p-5 flex items-center justify-between border-b border-white/5 bg-gradient-to-b from-white/5 to-transparent">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center shadow-lg text-xl text-white">
                    <i class="fa-solid fa-robot"></i>
                </div>
                <div>
                    <h2 class="text-white font-black text-lg tracking-wide">CHEF TARI</h2>
                    <p class="text-[10px] text-orange-400 font-bold uppercase tracking-widest flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ
                    </p>
                </div>
            </div>
            <button onclick="toggleAi(false)" class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-white/50 hover:bg-white/20 hover:text-white transition">
                <i class="fa-solid fa-chevron-down"></i>
            </button>
        </div>

        <div id="ai-stream" class="flex-1 overflow-y-auto p-5 space-y-6 scroll-smooth">
            <div class="flex gap-4 animate-fade-up">
                <div class="w-8 h-8 rounded-full bg-slate-800 border border-white/10 flex items-center justify-center text-xs shrink-0">ğŸ¤–</div>
                <div class="bg-white/5 border border-white/10 p-4 rounded-2xl rounded-tr-none text-slate-200 text-sm leading-relaxed shadow-sm backdrop-blur-md">
                    Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ TARI! ğŸ”<br>
                    Ø£Ù†Ø§ Ù‡Ù†Ø§ Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ. ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…ØªØ§Ø¨Ø¹Ø© Ø·Ù„Ø¨ÙƒØŒ Ø§Ù‚ØªØ±Ø§Ø­ ÙˆØ¬Ø¨Ø§Øª Ù„Ø°ÙŠØ°Ø©ØŒ Ø£Ùˆ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ø³ØªÙØ³Ø§Ø±Ø§ØªÙƒ.
                </div>
            </div>
        </div>

        <div class="shrink-0 px-5 pt-2 pb-0 flex gap-2 overflow-x-auto no-scrollbar mask-gradient" dir="ltr">
             <button onclick="askAi('ÙˆØ´ ØªØ±Ø´Ø­ Ù„ÙŠØŸ')" class="chip-btn">ğŸ”¥ ÙˆØ´ ØªØ±Ø´Ø­ Ù„ÙŠØŸ</button>
            <button onclick="askAi('ÙˆÙŠÙ† Ø·Ù„Ø¨ÙŠØŸ')" class="chip-btn">ğŸ“¦ ÙˆÙŠÙ† Ø·Ù„Ø¨ÙŠØŸ</button>
            <button onclick="askAi('Ù‡Ù„ Ø§Ù„Ø£ÙƒÙ„ Ø­Ø§Ø±ØŸ')" class="chip-btn">ğŸŒ¶ï¸ ÙÙŠ Ø³Ø¨Ø§ÙŠØ³ÙŠØŸ</button>
            <button onclick="askAi('Ù…ØªÙ‰ ØªÙØªØ­ÙˆÙ†ØŸ')" class="chip-btn">ğŸ•’ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„</button>
        </div>

        <div class="p-5 shrink-0 bg-slate-900/50">
            <form onsubmit="handleAiSubmit(event)" class="relative group">
                <input id="ai-input" type="text" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..." 
                    class="w-full bg-slate-800/50 border border-white/10 text-white placeholder-slate-500 rounded-2xl pl-5 pr-14 py-4 text-sm font-medium focus:outline-none focus:border-orange-500/50 focus:bg-slate-800 transition-all shadow-inner text-right">
                
                <button type="submit" class="absolute left-2 top-2 bottom-2 w-10 bg-orange-500 text-white rounded-xl flex items-center justify-center shadow-lg shadow-orange-500/20 active:scale-95 transition hover:bg-orange-400">
                    <i class="fa-solid fa-paper-plane text-xs"></i>
                </button>
            </form>
            <p class="text-center text-[9px] text-slate-600 font-bold uppercase tracking-widest mt-3 opacity-50">Powered by Tari Intelligence</p>
        </div>
    </div>
</div>



    <div id="toast"><i id="toast-icon" class="fa-solid fa-circle-check text-green-400 text-lg"></i><span id="toast-msg" class="font-bold text-sm">ØªÙ…</span></div>

    <div id="crop-modal" class="fixed inset-0 z-[200] bg-slate-900/95 backdrop-blur-sm flex flex-col items-center justify-center p-6">
        <div class="bg-white rounded-3xl w-full max-w-sm flex flex-col overflow-hidden shadow-2xl">
            <div class="p-4 border-b flex justify-between items-center bg-white z-10"><h3 class="font-bold text-lg">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©</h3><button onclick="closeCropper()" class="text-slate-400"><i class="fa-solid fa-xmark text-xl"></i></button></div>
            <div class="h-64 bg-slate-900 relative"><img id="crop-target" class="max-w-full max-h-full block"></div>
            <div class="p-4 border-t bg-white flex justify-end gap-3"><button onclick="finishCrop()" class="w-full bg-brand text-white py-3 rounded-xl font-bold shadow-lg">Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©</button></div>
        </div>
    </div>

    <div id="splash-screen" class="fixed inset-0 bg-slate-900 flex flex-col items-center justify-between pt-16 pb-10 px-6 z-[300] overflow-hidden transition-transform duration-700">        
        <div class="floating-icon" style="top: 20%; left: 10%; animation-delay: 0s;">ğŸ”</div>
        <div class="floating-icon" style="top: 38%; right: 10%; animation-delay: 1.5s;">ğŸŸ</div>
        <div class="floating-icon" style="bottom: 20%; left: 15%; animation-delay: 0.5s;">ğŸ¥¤</div>
        <div class="floating-icon" style="top: 50%; right: 20%; animation-delay: 2s;"></div>
        <div class="floating-icon" style="bottom: 15%; right: 5%; animation-delay: 1s;">ğŸ¥¬</div>
        <div class="floating-icon" style="top: 10%; left: 70%; animation-delay: 2.5s; font-size: 2.5rem;">ğŸ¥©</div>
        <img id="splash-bg-img" class="absolute inset-0 w-full h-full object-cover opacity-30 hidden z-0">
        <div class="absolute inset-0 bg-gradient-to-b from-transparent via-slate-900/60 to-slate-900 pointer-events-none z-0"></div>
        <div class="text-center z-10 flex flex-col items-center relative mt-10">
            <div class="text-center z-10 flex flex-col items-center relative mt-4"><div class="relative w-32 h-32 z-10 mb-4 rounded-3xl overflow-hidden animate-[fadeIn_0.5s] -mt-12 bg-transparent">
        <img id="splash-circle-img" src="https://images.unsplash.com/photo-1568901346375-23c9450c58cd" class="w-full h-full object-contain">
    </div>

    <h1 id="splash-title-text" class="text-5xl font-bold text-white mb-2 leading-tight tracking-tighter drop-shadow-lg whitespace-pre-line">TARI</h1>
    <p id="splash-intro" class="text-slate-300 text-sm font-medium max-w-[250px] leading-relaxed">Ø¨Ø±Ø¬Ø± ÙˆØ¨Ø·Ø§Ø·Ø³ Ù„Ø°ÙŠØ°Ø© Ù…Ø­Ø¶Ø±Ø© Ø¨Ø´ØºÙ ÙˆØªÙ‚Ø¯Ù… Ø·Ø§Ø²Ø¬Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹.</p>
</div>
</div>
        
        <button onclick="hideSplash()" class="w-full bg-orange-500 text-white font-bold py-4 rounded-2xl shadow-xl shadow-orange-500/20 active:scale-95 transition text-lg z-10 animate-pulse btn-brand flex items-center justify-center gap-2">
            Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù† <i class="fa-solid fa-arrow-left"></i>
        </button>
    </div>

    <div id="view-auth" class="hidden fixed inset-0 z-[200] bg-white flex flex-col items-center justify-center p-8 auth-hidden shadow-2xl transition-transform duration-300 transform translate-y-full">

        <button onclick="closeAuth()" class="absolute top-6 left-6 text-slate-400 p-2 hover:text-slate-800"><i class="fa-solid fa-xmark text-2xl"></i></button>
        <div class="w-20 h-20 bg-orange-500 rounded-2xl flex items-center justify-center mb-6 shadow-xl shadow-orange-200 btn-brand"><i class="fa-solid fa-lock text-4xl text-white"></i></div>
        <h1 class="text-3xl font-bold mb-2">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
        <p class="text-slate-400 mb-8 text-center">Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ø¬Ù…Ø¹ Ù†Ù‚Ø§Ø· Ø§Ù„ÙˆÙ„Ø§Ø¡<br>ÙˆØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ùƒ.</p>
        <div class="w-full max-w-sm space-y-4" id="auth-forms">
            <div id="login-form" class="space-y-4 fade-in">
                <input type="email" id="login-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none font-medium focus:border-orange-500 text-right">
                <input type="password" id="login-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none font-medium focus:border-orange-500 text-right">
                <button onclick="handleLogin(this)" class="w-full bg-slate-900 text-white p-4 rounded-xl font-bold text-lg shadow-lg">Ø¯Ø®ÙˆÙ„</button>
                <div class="relative flex py-2 items-center">
    <div class="flex-grow border-t border-slate-200"></div>
    <span class="flex-shrink-0 mx-4 text-slate-400 text-xs font-bold uppercase">Ø£Ùˆ</span>
    <div class="flex-grow border-t border-slate-200"></div>
</div>
<button onclick="toggleSignin(true)" class="w-full bg-green-50 text-green-600 border border-green-100 p-4 rounded-xl font-bold text-lg shadow-sm hover:bg-green-100 transition flex items-center justify-center gap-2">
    <i class="fa-brands fa-whatsapp text-xl"></i> Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨
</button>

                <p class="text-center text-slate-500 text-sm mt-4">Ø¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§ØŸ <button onclick="toggleAuthMode()" class="text-orange-600 font-bold text-brand">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button></p>
            </div>
            <div id="signup-form" class="space-y-4 hidden fade-in">
                <input type="text" id="reg-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none font-medium focus:border-orange-500 text-right">
                <input type="email" id="reg-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none font-medium focus:border-orange-500 text-right">
                
                <div class="space-y-1">
                    <div class="flex items-center border border-slate-200 rounded-xl overflow-hidden focus-within:border-orange-500 focus-within:ring-1 focus-within:ring-orange-200 transition-all bg-slate-50" dir="ltr">
                         <div class="bg-slate-200 px-4 py-4 border-r border-slate-300 text-slate-600 font-bold select-none">
                            +966
                        </div>
                        <input type="tel" id="reg-phone" 
                            class="w-full p-4 bg-transparent outline-none font-bold text-slate-800 placeholder:font-medium placeholder:text-slate-400 text-left" 
                            placeholder="5Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—" 
                            maxlength="9">
                    </div>
                    <p id="phone-error-msg" class="text-xs text-red-500 font-bold hidden pr-1 text-right">
                        <i class="fa-solid fa-circle-exclamation ml-1"></i> Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 9 Ø£Ø±Ù‚Ø§Ù…)
                    </p>
                </div>

                <input type="password" id="reg-pass" placeholder="Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none font-medium focus:border-orange-500 text-right">
                <button onclick="handleSignup(this)" class="w-full bg-orange-500 text-white p-4 rounded-xl font-bold text-lg shadow-lg btn-brand">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
                <p class="text-center text-slate-500 text-sm mt-4">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <button onclick="toggleAuthMode()" class="text-slate-900 font-bold">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button></p>
            </div>
        </div>
    </div>

    <div id="app-header" class="header-ghost-container fixed top-0 w-full px-6 py-2 flex flex-row-reverse justify-between items-center h-18 transition-all z-40">
    
    <div class="flex flex-col justify-center items-start z-10" dir="ltr">
        <h1 class="text-2xl tracking-wide text-white leading-none mb-0.5" style="font-family: 'Righteous', cursive;">
            TARI<span class="text-orange-500">.</span>
        </h1>
        <span class="font-robotic text-[8px]">PREMIUM FOOD TRUCK</span>
    </div>

    <div class="flex items-center justify-end z-10">
        <img id="header-truck-logo" class="h-10 w-auto object-contain drop-shadow-lg hidden transition-all duration-500"> 
    </div>

</div>


    <div id="view-home" class="pt-24 px-4 pb-24 fade-in">
        <div class="bg-slate-900 rounded-3xl p-6 text-white mb-6 relative overflow-hidden h-64 flex flex-col justify-center transform-gpu [mask-image:linear-gradient(white,white)]">
            <div id="hero-slider-container" class="absolute inset-0 z-0"></div>
            <div class="absolute inset-0 bg-gradient-to-l from-black/80 to-transparent z-0"></div> <div class="relative z-10">
                <span class="bg-orange-500 text-white text-xs font-bold px-2 py-1 rounded-md mb-2 inline-block btn-brand">Ù…Ø±Ø­Ø¨Ø§Ù‹</span>
                <h2 id="hero-title-text" class="text-2xl font-bold mb-1">Ø¬ÙŠØ¹Ø§Ù†ØŸ</h2>
                <p id="hero-subtitle-text" class="text-slate-200 text-sm mb-4 max-w-[200px]">Ø§Ø·Ù„Ø¨ Ø£Ù„Ø° Ø¨Ø±Ø¬Ø± Ø§Ù„Ø¢Ù†.</p>
            </div>
        </div>
        

        <div id="best-seller-section" class="hidden mb-8">
            <h3 class="font-bold text-lg mb-4 flex items-center gap-2 text-slate-800"><i class="fa-solid fa-fire text-orange-500 text-brand"></i> Ø§Ù„Ø£ÙƒØ«Ø± Ø·Ù„Ø¨Ø§Ù‹</h3>
            <div id="best-seller-list" class="flex gap-4 overflow-x-auto no-scrollbar pb-2"></div>
        </div>

        <div id="category-list" class="flex gap-3 overflow-x-auto no-scrollbar mb-6 pb-2"></div>

        <div id="menu-list" class="space-y-4 mb-10">
            <div class="text-center py-10 text-slate-400 animate-pulse"><i class="fa-solid fa-circle-notch fa-spin text-3xl text-orange-500 mb-3 text-brand"></i><p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©...</p></div>
        </div>
        
        <div class="bg-slate-900 rounded-3xl p-8 text-white relative overflow-hidden" id="info-section">
            <h3 class="text-2xl font-bold mb-6 relative z-10">ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</h3>
            <div class="space-y-6 relative z-10">
                <div class="flex gap-4"><div class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center flex-shrink-0 text-orange-500 text-brand"><i class="fa-solid fa-location-dot"></i></div><div><p class="text-xs text-slate-400 uppercase font-bold tracking-wider mb-1">Ø§Ù„Ù…ÙˆÙ‚Ø¹</p><p class="font-medium text-sm leading-relaxed" id="info-location">Loading...</p><a id="btn-maps" href="#" target="_blank" class="hidden inline-flex items-center gap-2 mt-2 bg-slate-800 hover:bg-slate-700 text-white text-[10px] font-bold px-3 py-1.5 rounded-lg transition">
            <i class="fa-solid fa-map-location-dot"></i> ÙØªØ­ ÙÙŠ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        </a></div></div>
                <div class="flex gap-4"><div class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center flex-shrink-0 text-orange-500 text-brand"><i class="fa-solid fa-clock"></i></div><div><p class="text-xs text-slate-400 uppercase font-bold tracking-wider mb-1">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„</p><div class="font-medium text-sm" id="info-hours">Loading...</div></div></div>
                <div class="flex gap-4"><div class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center flex-shrink-0 text-orange-500 text-brand"><i class="fa-solid fa-phone"></i></div><div><p class="text-xs text-slate-400 uppercase font-bold tracking-wider mb-1">Ø§ØªØµÙ„ Ø¨Ù†Ø§</p><p class="font-medium text-sm" id="info-phone">Loading...</p></div></div>
            </div>
        </div>
        
        <div class="mt-12 pt-10 pb-0 text-center select-none">
            <div class="w-8 h-0.5 bg-slate-300 mx-auto rounded-full mb-4"></div>
            <p class="text-[8px] md:text-[10px] text-slate-900 font-black uppercase tracking-[0.3em] mb-1" style="font-family: 'Plus Jakarta Sans', sans-serif;">
    Powered by Tari Digital
</p>

            <p class="text-[10px] md:text-[10px] text-slate-500 font-bold tracking-widest">
                Ù†Ø³Ø®Ø© 2.0 â€¢ Â© <span id="footer-year">2026</span>
            </p>
        </div>    
    </div>                                                    

    <div id="view-track" class="pt-24 px-6 pb-24 hidden fade-in h-screen bg-white overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</h2>
            <div class="bg-red-500 text-white text-[10px] font-bold px-2 py-1 rounded-full animate-pulse flex items-center gap-1 shadow-lg shadow-red-500/30"><div class="w-2 h-2 bg-white rounded-full"></div> Ù…Ø¨Ø§Ø´Ø±</div>
        </div>
        <div id="active-tracker-container" class="space-y-6 pb-20"><div class="text-center py-20 text-slate-400"><i class="fa-solid fa-receipt text-4xl mb-4"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù†Ø´Ø·Ø©.</p></div></div>
    </div>
<div id="view-loyalty" class="pt-24 px-6 pb-24 hidden fade-in h-screen overflow-y-auto bg-slate-50">
    <div class="flex items-center justify-between mb-6">
        <button onclick="switchView('profile')" class="w-10 h-10 bg-white rounded-full shadow-sm flex items-center justify-center text-slate-900 active:scale-90 transition"><i class="fa-solid fa-arrow-right"></i></button>
        <h2 class="text-2xl font-black text-slate-800">Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª</h2>
        <div class="w-10"></div>
    </div>
    <div class="bg-slate-900 rounded-3xl p-6 text-white mb-8 relative overflow-hidden shadow-xl shadow-slate-900/20">
        <div class="relative z-10 text-center">
            <p class="text-xs text-slate-400 font-bold uppercase tracking-widest mb-1">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­</p>
            <h3 class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-l from-orange-400 to-yellow-400" id="loyalty-display-points">0</h3>
        </div>
    </div>
    <div id="loyalty-list" class="space-y-4"></div>
</div>

    <div id="view-profile" class="pt-24 px-6 pb-24 hidden fade-in">
        <div class="flex flex-col items-center mb-8">
            <div class="relative w-32 h-32 mb-4">
                <img id="profile-avatar" src="https://ui-avatars.com/api/?name=User&background=FF5722&color=fff" class="w-full h-full rounded-full object-cover border-4 border-white shadow-xl bg-slate-100">
            </div>
            <div class="flex items-center gap-3">
                <label for="upload-input" class="bg-slate-900 text-white px-4 py-2 rounded-full text-xs font-bold cursor-pointer shadow hover:bg-slate-800 transition flex items-center gap-2"><i class="fa-solid fa-camera"></i> ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©</label>
                <button onclick="removeAvatar()" class="bg-red-50 text-red-500 border border-red-100 px-4 py-2 rounded-full text-xs font-bold shadow-sm hover:bg-red-100 transition flex items-center gap-2"><i class="fa-solid fa-trash"></i> Ø­Ø°Ù</button>
                <input type="file" id="upload-input" class="hidden" accept="image/*" onchange="startCrop(this)">
            </div>
            <h2 id="profile-name" class="text-2xl font-black text-slate-900 mt-4">User</h2>
        </div>
        
        <div class="bg-gradient-to-l from-orange-500 to-red-500 rounded-3xl p-6 text-white shadow-xl shadow-orange-500/20 mb-8 relative overflow-hidden bg-brand-gradient">
    <div class="absolute -left-6 -top-6 text-white/10 text-9xl"><i class="fa-solid fa-crown"></i></div>
    <div class="relative z-10">
        <div class="flex justify-between items-start mb-4"><div class="bg-white/20 backdrop-blur-sm px-3 py-1 rounded-lg border border-white/30 text-xs font-bold">Ø¹Ø¶Ùˆ Ø°Ù‡Ø¨ÙŠ</div></div>
        <p class="text-sm font-medium text-orange-100">Ù†Ù‚Ø§Ø· Ø§Ù„ÙˆÙ„Ø§Ø¡</p>
        <h3 class="text-5xl font-black mt-1 mb-4" id="loyalty-points">0</h3>
        <button onclick="openLoyaltyView()" class="w-full bg-white text-orange-600 font-bold py-3 rounded-xl shadow-lg active:scale-95 transition flex items-center justify-center gap-2 text-sm">
            <i class="fa-solid fa-gift"></i> Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù†Ù‚Ø§Ø·
        </button>
    </div>
</div>

        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm text-center">
                <div class="w-8 h-8 mx-auto bg-blue-50 text-blue-500 rounded-full flex items-center justify-center mb-2"><i class="fa-solid fa-calendar"></i></div>
                <p class="text-xs text-slate-400 font-bold uppercase">Ø§Ù†Ø¶Ù… Ù…Ù†Ø°</p>
                <p class="font-bold text-slate-800" id="profile-joined">--</p>
            </div>
            <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm text-center">
                <div class="w-8 h-8 mx-auto bg-purple-50 text-purple-500 rounded-full flex items-center justify-center mb-2"><i class="fa-solid fa-receipt"></i></div>
                <p class="text-xs text-slate-400 font-bold uppercase">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>
                <p class="font-bold text-slate-800" id="profile-total-orders">0</p>
            </div>
        </div>

        <div class="bg-white rounded-3xl border border-slate-100 p-5 shadow-sm mb-8 space-y-5">
            <h3 class="font-bold text-lg">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</h3>
            <div><label class="text-xs font-bold text-slate-400 uppercase mr-1">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label><div class="flex items-center gap-3 bg-slate-50 p-3 rounded-xl mt-1 border border-slate-100"><i class="fa-solid fa-envelope text-slate-400"></i><span id="profile-email" class="font-bold text-slate-700 text-sm flex-1 truncate text-right">--</span><i class="fa-solid fa-lock text-slate-300 text-xs"></i></div></div>
            <div><label class="text-xs font-bold text-slate-400 uppercase mr-1">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><div class="flex gap-2 mt-1"><div class="flex-1 flex items-center gap-3 bg-slate-50 p-3 rounded-xl border border-slate-100 transition-colors" id="phone-container"><i class="fa-solid fa-phone text-slate-400"></i><input id="profile-phone-input" type="tel" readonly class="bg-transparent font-bold text-slate-700 text-sm w-full outline-none disabled:text-slate-500 text-right" placeholder="Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø±Ù‚Ù…" dir="ltr"><i id="phone-lock" class="fa-solid fa-lock text-slate-300 text-xs"></i></div></div></div>
        </div>

        <div class="mb-8">
    <h3 class="font-bold text-lg mb-4 px-1">Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
    <button onclick="openHistory()" class="w-full bg-white border border-slate-100 p-5 rounded-3xl shadow-sm flex items-center justify-between group active:scale-[0.98] transition relative overflow-hidden">
        <div class="flex items-center gap-5 relative z-10">
            <div class="w-14 h-14 bg-orange-50 text-orange-500 rounded-2xl flex items-center justify-center text-2xl group-hover:bg-orange-500 group-hover:text-white transition duration-300 shadow-sm"><i class="fa-solid fa-clock-rotate-left"></i></div>
            <div class="text-right">
                <h3 class="font-bold text-slate-800 text-lg">Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</h3>
                <p class="text-xs text-slate-400 font-bold mt-0.5">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨</p>
            </div>
        </div>
        <div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-300 group-hover:bg-orange-100 group-hover:text-orange-500 transition"><i class="fa-solid fa-chevron-left"></i></div>
    </button>
</div>
        
        <a href="en.html" class="w-full bg-white border border-slate-100 px-4 py-4 rounded-2xl mb-4 flex justify-between items-center shadow-sm active:scale-95 transition cursor-pointer">
    <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-600">
            <i class="fa-solid fa-globe text-lg"></i>
        </div>
        <div>
            <p class="font-bold text-slate-800 text-sm">Ø§Ù„Ù„ØºØ© / Language</p>
            <p class="text-[10px] text-slate-400 font-bold">ØªØºÙŠÙŠØ± Ù„Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</p>
        </div>
    </div>
    <span class="font-bold text-orange-500 text-sm" dir="ltr">English <i class="fa-solid fa-chevron-left mr-1 text-xs"></i></span>
</a>

       
        <button onclick="handleLogout()" class="w-full text-red-500 font-bold bg-red-50 border border-red-100 px-6 py-4 rounded-2xl mb-6 active:scale-95 transition"><i class="fa-solid fa-right-from-bracket ml-2"></i> ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="fixed bottom-0 w-full bg-white border-t border-slate-100 pb-safe z-50 flex justify-around items-center h-20 shadow-[0_-5px_20px_rgba(0,0,0,0.03)]">
        <button onclick="switchView('home')" class="nav-item active flex flex-col items-center gap-1 text-slate-400 w-16"><i class="fa-solid fa-house text-xl"></i><span class="text-[10px] font-bold">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></button>
        <button onclick="switchView('track')" class="nav-item flex flex-col items-center gap-1 text-slate-400 w-16 relative"><i class="fa-solid fa-list-check text-xl"></i><span class="text-[10px] font-bold">Ø·Ù„Ø¨Ø§ØªÙŠ</span><div id="track-badge" class="absolute top-0 left-3 w-2.5 h-2.5 bg-orange-500 rounded-full border-2 border-white hidden bg-brand"></div></button>
        <button onclick="switchView('profile')" class="nav-item flex flex-col items-center gap-1 text-slate-400 w-16"><i class="fa-solid fa-user text-xl"></i><span class="text-[10px] font-bold">Ø­Ø³Ø§Ø¨ÙŠ</span></button>
    </div>

    <div id="fab-container" class="fixed bottom-24 left-6 right-6 z-40 transform translate-y-32 transition duration-300">
        <button onclick="openCart()" id="fab-btn" class="w-full bg-slate-900 text-white p-4 rounded-2xl shadow-xl flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-orange-500 w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold btn-brand" id="cart-count">0</div>
                <span class="font-bold">Ø¹Ø±Ø¶ Ø§Ù„Ø³Ù„Ø©</span>
            </div>
            <span class="font-bold text-lg" id="cart-total">SR 0.00</span>
        </button>
    </div>

    <div id="productModal" class="fixed inset-0 z-[100] hidden modal-shell">
        <div class="absolute inset-0 bg-transparent opacity-0 transition-opacity duration-300" id="productBackdrop" onclick="closeModal()"></div>
        <div id="productCard" onclick="event.stopPropagation()" class="absolute bottom-0 w-full sm:max-w-md left-0 right-0 mx-auto bg-white h-[90vh] rounded-t-3xl shadow-2xl transform translate-y-full transition-transform duration-300 ease-out flex flex-col overflow-hidden">
            <div id="productDrag" class="absolute top-0 left-0 right-0 h-10 z-50 flex items-center justify-center bg-white/50 backdrop-blur-sm" onclick="closeModal()"><div class="w-12 h-1.5 bg-slate-300 rounded-full"></div></div>
            <div class="relative h-72 bg-slate-200 shrink-0">
                <img id="modal-img" class="w-full h-full object-cover">
                <button onclick="closeModal()" class="absolute top-4 left-4 bg-white/80 p-2 rounded-full shadow text-slate-900 hover:bg-white transition z-50"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6 flex-1 overflow-y-auto bg-white -mt-6 rounded-t-3xl relative z-10" id="productContent">
                <div class="flex justify-between items-start mb-2"><h2 id="modal-title" class="text-2xl font-black text-slate-800"></h2><span id="modal-price" class="text-2xl font-black text-orange-500"></span></div>
                <p id="modal-desc" class="text-slate-500 text-sm mb-6"></p>
                <div class="flex justify-between items-center mb-6 pb-6 border-b border-slate-50">
                    <span class="font-bold text-sm uppercase">Ø§Ù„ÙƒÙ…ÙŠØ©</span>
                    <div class="flex items-center bg-slate-100 rounded-xl p-1" dir="ltr"> <button onclick="adjustModalQty(-1)" class="w-10 h-10 flex items-center justify-center font-bold text-lg">-</button>
                        <span id="modal-qty" class="w-10 text-center font-bold">1</span>
                        <button onclick="adjustModalQty(1)" class="w-10 h-10 flex items-center justify-center font-bold text-lg">+</button>
                    </div>
                </div>
                <div id="modal-modifiers" class="space-y-3"></div>
            </div>
            <div class="p-6 border-t border-slate-50 bg-white shrink-0">
                <button id="addToCartBtn" class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø·Ù„Ø¨</button>
            </div>
        </div>
    </div>
    
    <div id="checkoutModal" class="fixed inset-0 z-[100] hidden modal-shell" aria-hidden="true">
        <div class="absolute inset-0 bg-black/60 opacity-0 transition-opacity duration-300" id="checkoutBackdrop" onclick="closeCart()"></div>
        <div id="checkoutCard" class="absolute bottom-0 w-full sm:max-w-md left-0 right-0 mx-auto bg-white h-[96vh] rounded-t-3xl shadow-2xl transform translate-y-full transition-transform duration-300 ease-out flex flex-col z-50 overflow-hidden">
            <div class="w-full h-6 flex items-center justify-center shrink-0 bg-white" onclick="closeCart()"><div class="w-12 h-1.5 bg-slate-200 rounded-full mt-3"></div></div>
            <div class="px-6 pb-2 shrink-0 flex justify-between items-center bg-white">
                <h2 class="text-2xl font-black text-slate-800">Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h2>
                <button onclick="closeCart()" class="w-8 h-8 bg-slate-50 text-slate-400 rounded-full flex items-center justify-center hover:text-slate-900 active:scale-90 transition"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="cart-items" class="flex-1 overflow-y-auto px-6 py-4 space-y-4 min-h-0 bg-white"></div>
            <div class="shrink-0 bg-white border-t border-slate-50 p-6 pb-safe shadow-[0_-10px_40px_rgba(0,0,0,0.03)] z-50">
                
                <div class="relative mb-6 no-drag h-12"> 
                    <input type="text" id="promo-input" class="w-full h-full bg-slate-50 border border-slate-200 rounded-xl pr-4 pl-20 text-sm font-bold uppercase outline-none focus:border-slate-900 transition text-right" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ…">
                    <button id="btn-apply-promo" onclick="applyPromoCode()" class="absolute left-2 top-1/2 -translate-y-1/2 h-8 w-16 bg-slate-900 text-white text-[10px] font-bold rounded-lg active:scale-95 transition flex items-center justify-center shadow-sm overflow-hidden">ØªØ·Ø¨ÙŠÙ‚</button>
                    <button id="btn-remove-promo" onclick="removePromo()" class="hidden absolute left-2 top-1/2 -translate-y-1/2 h-8 w-16 bg-red-500 text-white text-[10px] font-bold rounded-lg active:scale-95 transition flex items-center justify-center shadow-sm overflow-hidden"><i class="fa-solid fa-xmark text-sm"></i></button>
                    <p id="promo-msg" class="absolute -bottom-5 right-1 text-[10px] font-bold transition-all empty:hidden"></p>
                </div>

                <div id="coupon-list" class="mb-3"> 
                    <div id="cart-coupon-btn" class="bg-gradient-to-l from-orange-50 to-yellow-50 border border-orange-100 rounded-xl p-3 flex items-center justify-between cursor-pointer active:scale-[0.98] transition relative overflow-hidden group no-drag">
                        <div class="flex items-center gap-3 relative z-10">
                            <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center text-lg shadow-sm">ğŸ</div>
                            <div class="text-right">
                                <p class="text-[10px] font-bold text-orange-400 uppercase tracking-wider">Ù‡Ø¯ÙŠØ© ØªØ±Ø­ÙŠØ¨ÙŠØ©</p>
                                <p id="cart-coupon-text" class="text-xs font-black text-slate-800">Ø®ØµÙ… 30%</p>
                            </div>
                        </div>
                        <span class="bg-white text-slate-900 text-[10px] font-bold px-3 py-1.5 rounded-lg shadow-sm">Ø§Ø³ØªØ®Ø¯Ø§Ù…</span>
                    </div>
                </div>

                <div class="mb-4">
                    <textarea id="order-note" rows="1" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-xs font-bold text-slate-700 outline-none focus:border-slate-900 transition resize-none placeholder-slate-400 text-right" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ù…Ø«Ù„: Ø¨Ø¯ÙˆÙ† Ø¨ØµÙ„ØŒ ÙƒØ§ØªØ´Ø¨ Ø²ÙŠØ§Ø¯Ø©...)"></textarea>
                </div>

                <div class="flex justify-between items-end mb-3">
                    <span class="text-sm font-medium text-slate-500">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                    <span id="checkout-total" class="text-2xl font-black text-slate-900">0.00 SR</span>
                </div>

                <button onclick="placeOrder(this)" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold text-lg shadow-xl active:scale-[0.98] transition flex items-center justify-center gap-2">
                    Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ <i class="fa-solid fa-arrow-left"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="welcome-splash" class="hidden fixed inset-0 z-[300] flex items-center justify-center bg-slate-900/90 backdrop-blur-sm fade-in">
        <div class="bg-white w-[90%] max-w-sm rounded-3xl p-8 text-center shadow-2xl relative overflow-hidden">
            <div class="absolute -top-10 -left-10 w-32 h-32 bg-yellow-400 rounded-full blur-3xl opacity-30"></div>
            <div class="absolute top-20 -right-10 w-24 h-24 bg-orange-500 rounded-full blur-3xl opacity-20"></div>
            <div class="mb-6 inline-flex items-center justify-center w-20 h-20 bg-yellow-100 text-yellow-600 rounded-full shadow-inner text-4xl animate-bounce">ğŸ</div>
            <h2 class="text-3xl font-black text-slate-800 mb-2">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ!</h2>
            <p class="text-slate-500 text-sm mb-6">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¹Ø§Ø¦Ù„Ø© TARI. Ø¥Ù„ÙŠÙƒ Ù‡Ø¯ÙŠØ© Ø®Ø§ØµØ© Ù„Ùƒ.</p>
            <div class="bg-gradient-to-r from-orange-500 to-yellow-500 p-1 rounded-xl mb-8 shadow-lg transform rotate-[2deg] hover:rotate-0 transition-all duration-300">
                <div class="bg-white border-2 border-dashed border-orange-200 rounded-lg p-4">
                    <p class="text-xs font-bold text-orange-400 uppercase tracking-widest mb-1">ÙƒÙˆØ¯ Ø®ØµÙ…</p>
                    <h3 id="splash-code" class="text-2xl font-black text-slate-800 tracking-wider font-brand-en">WELCOME30</h3>
                    <p id="splash-desc" class="text-[10px] text-slate-400 mt-1">Ø®ØµÙ… 30% â€¢ Ù„Ù„Ø·Ù„Ø¨ Ø§Ù„Ø£ÙˆÙ„ ÙÙ‚Ø·</p>
                </div>
            </div>
            <p class="text-xs text-slate-400 mb-6 italic">"Ù„Ø§ ØªÙ‚Ù„Ù‚ØŒ Ø­ÙØ¸Ù†Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù„Ùƒ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¯ÙØ¹!"</p>
            <button onclick="closeSplashAndOrder()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold text-lg shadow-xl hover:scale-[1.02] active:scale-95 transition-all">Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù† ğŸ”</button>
        </div>
    </div>

    <div id="closed-modal" class="fixed inset-0 z-[999] flex flex-col items-center justify-start pt-4 pointer-events-none transition-transform duration-700 -translate-y-full">
        <div class="absolute inset-0 bg-slate-900/20 backdrop-blur-[2px] opacity-0 transition-opacity duration-700" id="closed-backdrop"></div>
        <div class="bg-white w-[90%] max-w-sm rounded-[2rem] p-6 shadow-2xl border border-slate-100 text-center pointer-events-auto relative overflow-hidden transform transition-all duration-500 ease-out mt-4">
            <div class="relative w-24 h-24 mx-auto mb-4 flex items-center justify-center">
                <div class="text-6xl filter grayscale opacity-80">ğŸ”</div>
                <span class="zzz-anim delay-1" style="left:35%">z</span>
                <span class="zzz-anim delay-2" style="left:25%">Z</span>
                <span class="zzz-anim delay-3" style="left:15%">Z</span>
            </div>
            <h2 class="text-2xl font-black text-slate-800 mb-2">Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„Ù…ØªØ¬Ø± Ù…ØºÙ„Ù‚</h2>
            <p class="text-slate-500 text-sm mb-6 leading-relaxed">Ø§Ù„Ù…Ø·Ø¨Ø® Ù…ØºÙ„Ù‚ Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ù„Ø±Ø§Ø­Ø©.<br>ØªÙØ¶Ù„ Ø¨ØªØµÙØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø·Ù„Ø¨Ùƒ Ø§Ù„Ù‚Ø§Ø¯Ù…!</p>
            <div class="bg-slate-50 rounded-xl p-4 mb-6 border border-slate-100">
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„</p>
                <div id="closed-hours-display" class="text-sm font-bold text-slate-700 space-y-1">Loading...</div>
            </div>
            <button onclick="dismissClosedModal()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold text-lg shadow-xl active:scale-95 transition">ØªØµÙØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© <i class="fa-solid fa-book-open mr-2"></i></button>
        </div>
    </div>

    <div id="otp-modal" class="fixed inset-0 z-[400] bg-slate-900/80 backdrop-blur-sm hidden flex items-center justify-center p-4 fade-in">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl relative overflow-hidden text-center">
            <div class="absolute top-0 right-0 w-full h-2 bg-gradient-to-l from-orange-400 to-orange-600"></div>
            <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4 text-orange-500 text-2xl animate-bounce">ğŸ’¬</div>
            <h3 class="text-2xl font-black text-slate-800 mb-2">ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù‚Ù…</h3>
            <p class="text-slate-500 text-sm mb-2">Ø£Ø±Ø³Ù„Ù†Ø§ Ø±Ù…Ø²Ø§Ù‹ Ù…ÙƒÙˆÙ†Ø§Ù‹ Ù…Ù† 4 Ø£Ø±Ù‚Ø§Ù… Ø¥Ù„Ù‰ <br><span id="otp-target-number" class="font-bold text-slate-800" dir="ltr">...</span></p>
            <p class="text-orange-500 text-xs font-bold mb-6"><i class="fa-brands fa-whatsapp ml-1"></i> ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</p>
            <div class="relative w-full max-w-[260px] mx-auto h-16 mb-6">
                <input type="tel" id="otp-input" class="absolute inset-0 w-full h-full opacity-0 z-10 cursor-pointer font-bold text-transparent bg-transparent focus:outline-none caret-transparent" maxlength="4" pattern="\d*" autocomplete="one-time-code">
                <div class="w-full h-full flex items-center justify-between pointer-events-none" dir="ltr">
                    <div id="otp-box-0" class="w-12 h-14 border-2 border-slate-200 rounded-xl flex items-center justify-center text-2xl font-black text-slate-800 bg-slate-50 transition-all"></div>
                    <div class="text-slate-300 text-xl">â€¢</div>
                    <div id="otp-box-1" class="w-12 h-14 border-2 border-slate-200 rounded-xl flex items-center justify-center text-2xl font-black text-slate-800 bg-slate-50 transition-all"></div>
                    <div class="text-slate-300 text-xl">â€¢</div>
                    <div id="otp-box-2" class="w-12 h-14 border-2 border-slate-200 rounded-xl flex items-center justify-center text-2xl font-black text-slate-800 bg-slate-50 transition-all"></div>
                    <div class="text-slate-300 text-xl">â€¢</div>
                    <div id="otp-box-3" class="w-12 h-14 border-2 border-slate-200 rounded-xl flex items-center justify-center text-2xl font-black text-slate-800 bg-slate-50 transition-all"></div>
                </div>
            </div>
            <p id="otp-error" class="text-red-500 text-xs font-bold mb-4 hidden"><i class="fa-solid fa-circle-exclamation"></i> Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</p>
            <div class="mb-6">
                <button id="btn-resend-otp" onclick="resendOtp()" disabled class="text-slate-400 text-xs font-bold py-2 px-4 rounded-full border border-slate-200 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50 transition-colors">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø®Ù„Ø§Ù„ <span id="resend-timer">01:00</span></button>
            </div>
            <div class="flex gap-3">
                <button onclick="closeOtpModal()" class="flex-1 py-4 rounded-xl font-bold text-slate-400 hover:text-slate-600 hover:bg-slate-50 transition">Ø¥Ù„ØºØ§Ø¡</button>
                <button onclick="confirmOtp()" id="btn-verify-otp" class="flex-1 bg-slate-900 text-white py-4 rounded-xl font-bold shadow-lg shadow-slate-900/20 active:scale-95 transition">ØªØ£ÙƒÙŠØ¯</button>
            </div>
        </div>
    </div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">

<div id="install-modal" class="fixed inset-0 z-[500] bg-black/60 backdrop-blur-sm hidden flex items-center justify-center p-4 fade-in">
    <div class="bg-white w-full max-w-sm rounded-3xl p-6 text-center shadow-2xl relative">
        <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4 text-orange-600 text-2xl animate-bounce">
            ğŸ“²
        </div>
        <h3 class="text-xl font-black text-slate-800 mb-2">ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŸ</h3>
        <p class="text-slate-500 text-sm mb-6 leading-relaxed">Ù‚Ù… Ø¨ØªØ«Ø¨ÙŠØª ØªØ·Ø¨ÙŠÙ‚ TARI Ù„Ù„Ø·Ù„Ø¨ Ø¨Ø´ÙƒÙ„ Ø£Ø³Ø±Ø¹!</p>
        
        <div class="flex gap-3">
            <button onclick="closeInstallModal()" class="flex-1 py-3 rounded-xl font-bold text-slate-400 hover:bg-slate-50">Ù„Ø§ Ø´ÙƒØ±Ø§Ù‹</button>
            
            <button id="install-btn-action" onclick="installPWA()" class="flex-1 bg-orange-500 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition">
                ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¢Ù†
            </button>
        </div>
    </div>
</div>
<div id="signin-modal" class="fixed inset-0 z-[400] bg-slate-900/80 backdrop-blur-sm hidden flex items-center justify-center p-4 fade-in">
    <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl relative overflow-hidden text-center">
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-green-400 to-green-600"></div>
        <button onclick="toggleSignin(false)" class="absolute top-4 left-4 text-slate-300 hover:text-slate-600 z-10"><i class="fa-solid fa-xmark text-xl"></i></button>

        <div class="w-16 h-16 bg-green-50 rounded-full flex items-center justify-center mx-auto mb-4 text-green-500 text-2xl animate-bounce"><i class="fa-brands fa-whatsapp"></i></div>

        <div id="si-stage-1">
            <h3 class="text-2xl font-black text-slate-800 mb-2">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ Ù…Ø¬Ø¯Ø¯Ø§Ù‹!</h3>
            <p class="text-slate-500 text-sm mb-6">Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø¨Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ ÙÙ‚Ø·.</p>
            <div class="flex items-center border border-slate-200 rounded-xl overflow-hidden mb-6 focus-within:border-green-500 bg-slate-50 transition-all shadow-sm" dir="ltr">
                <div class="bg-slate-200 px-4 py-4 border-r border-slate-300 text-slate-600 font-bold select-none">+966</div>
                <input type="tel" id="si-phone-input" class="w-full p-4 bg-transparent outline-none font-bold text-slate-800 placeholder:font-medium placeholder:text-slate-400 text-lg text-left" placeholder="5Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—" maxlength="9">
            </div>
            <button onclick="sendLoginCode(this)" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold text-lg shadow-xl active:scale-95 transition flex items-center justify-center gap-2">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø² <i class="fa-solid fa-paper-plane text-xs"></i></button>
        </div>

        <div id="si-stage-2" class="hidden">
            <h3 class="text-2xl font-black text-slate-800 mb-2">ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²</h3>
            <p class="text-slate-500 text-sm mb-6">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø² Ø¥Ù„Ù‰ <span id="si-display-phone" class="font-bold text-slate-900" dir="ltr">...</span></p>
            <div class="relative w-full max-w-[260px] mx-auto h-16 mb-8">
                <input type="tel" id="si-otp-input" class="absolute inset-0 w-full h-full opacity-0 z-10 cursor-pointer font-bold text-transparent bg-transparent focus:outline-none caret-transparent" maxlength="4" pattern="\d*" autocomplete="one-time-code">
                <div class="w-full h-full flex items-center justify-between pointer-events-none" dir="ltr">
                    <div id="si-box-0" class="w-12 h-14 border-2 border-slate-200 rounded-xl flex items-center justify-center text-2xl font-black text-slate-800 bg-slate-50 transition-all"></div>
                    <div class="text-slate-300 text-xl">â€¢</div>
                    <div id="si-box-1" class="w-12 h-14 border-2 border-slate-200 rounded-xl flex items-center justify-center text-2xl font-black text-slate-800 bg-slate-50 transition-all"></div>
                    <div class="text-slate-300 text-xl">â€¢</div>
                    <div id="si-box-2" class="w-12 h-14 border-2 border-slate-200 rounded-xl flex items-center justify-center text-2xl font-black text-slate-800 bg-slate-50 transition-all"></div>
                    <div class="text-slate-300 text-xl">â€¢</div>
                    <div id="si-box-3" class="w-12 h-14 border-2 border-slate-200 rounded-xl flex items-center justify-center text-2xl font-black text-slate-800 bg-slate-50 transition-all"></div>
                </div>
            </div>
            <button onclick="verifyLoginCode(this)" class="w-full bg-green-500 text-white py-4 rounded-xl font-bold text-lg shadow-xl shadow-green-500/20 active:scale-95 transition">ØªØ­Ù‚Ù‚ ÙˆØ¯Ø®ÙˆÙ„</button>
            <button onclick="resetSignin()" class="text-xs font-bold text-slate-400 mt-6 hover:text-slate-600 underline">Ø±Ù‚Ù… Ø®Ø§Ø·Ø¦ØŸ</button>
        </div>
    </div>
</div>
<div id="historyModal" class="fixed inset-0 z-[100] hidden modal-shell">
    <div class="absolute inset-0 bg-black/60 opacity-0 transition-opacity duration-300" id="historyBackdrop" onclick="closeHistory()"></div>
    <div id="historyCard" class="absolute bottom-0 w-full sm:max-w-md left-0 right-0 mx-auto bg-slate-50 h-[85vh] rounded-t-[2.5rem] shadow-2xl transform translate-y-full transition-transform duration-300 ease-out flex flex-col z-50 overflow-hidden">
        <div class="w-full h-6 flex items-center justify-center shrink-0 bg-white border-b border-slate-50" onclick="closeHistory()"><div class="w-12 h-1.5 bg-slate-200 rounded-full mt-1"></div></div>
        <div class="bg-white px-8 py-4 flex justify-between items-center shrink-0 shadow-sm z-10">
            <div><h2 class="text-2xl font-black text-slate-800">Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2><p class="text-xs text-slate-400 font-bold">Ø·Ù„Ø¨Ø§ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</p></div>
            <button onclick="closeHistory()" class="w-10 h-10 bg-slate-50 text-slate-400 rounded-full flex items-center justify-center hover:text-slate-900 active:scale-90 transition"><i class="fa-solid fa-xmark text-lg"></i></button>
        </div>
        <div id="order-history" class="flex-1 overflow-y-auto p-6 space-y-4 pb-safe"></div>
    </div>
</div>
<div id="loyalty-confirm-modal" class="fixed inset-0 z-[500] bg-slate-900/90 backdrop-blur-sm hidden flex items-center justify-center p-6 fade-in">
    <div class="bg-white w-full max-w-sm rounded-[2rem] p-8 text-center shadow-2xl relative overflow-hidden">
        <div class="w-20 h-20 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-6 text-purple-600 text-3xl animate-bounce">ğŸ</div>
        <h3 class="text-2xl font-black text-slate-800 mb-2">Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©ØŸ</h3>
        <p class="text-slate-500 text-sm mb-6 leading-relaxed">Ø³ÙŠØªÙ… Ø®ØµÙ… Ø§Ù„Ù†Ù‚Ø§Ø· Ù…Ù† Ø±ØµÙŠØ¯Ùƒ.<br><span class="text-xs text-orange-500 font-bold">(Ø¥Ø°Ø§ Ø£Ù„ØºÙŠØª Ø§Ù„Ø·Ù„Ø¨ØŒ Ø³ØªØ¹ÙˆØ¯ Ø§Ù„Ù†Ù‚Ø§Ø· Ù„Ùƒ!)</span></p>
        <div class="flex gap-3">
            <button onclick="closeLoyaltyConfirm()" class="flex-1 py-4 rounded-xl font-bold text-slate-400 hover:bg-slate-50 transition">Ø¥Ù„ØºØ§Ø¡</button>
            <button id="btn-confirm-redeem" class="flex-1 bg-gradient-to-l from-purple-600 to-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-purple-500/30 active:scale-95 transition">Ù†Ø¹Ù…ØŒ Ø§Ø³ØªØ¨Ø¯Ù„!</button>
        </div>
    </div>
</div>


<script>
    // --- GLOBAL VARIABLES ---
    var deviceId = "unknown_device"; 
    var userIP = "0.0.0.0";
    // --- âš¡ INSTANT RESTORE (Added to fix language switch) ---
var rawSession = localStorage.getItem('tari_wa_session') || localStorage.getItem('tari_user');
var currentUser = rawSession ? JSON.parse(rawSession) : null;

if (currentUser) {
    console.log("âš¡ Instant Restore: User Found (" + (currentUser.email || currentUser.phone) + ")");
}
 
    var sheetTimer = null;
    let currentCatIndex = 0;
    var langMap = {};
    
    // CART & PROMO STATE
    var cart = [];              
    var activeDiscount = 0;     
    var activePromoCode = "";   
    var currentPromoRule = null; 
    var isStoreOpen = true; 
    let pendingOtpCode = null;
    let pendingUserData = null;
    let otpExpiryTime = null;
    let resendInterval = null;
    
    // DATA & UI STATE
    var userData = null;
    var allMenuItems = [];
    var allModifiers = [];
    var currentItem = null;
    var modalQty = 1;
    var editingCartIndex = -1;
    var modalOpen = false;
    var heroTimer = null;
    var lockProductSwipe = false;
    var userOrderCount = 0;
    var welcomeRule = { code: 'WELCOME30', value: 30, type: 'percent' };
    
        // --- PRELOADER LOGIC (Glitch-Free) ---
    const isReloading = sessionStorage.getItem('tari_session_active');
    const truck = document.getElementById('loader-truck');
    const spinner = document.getElementById('loader-spinner');
    const preloader = document.getElementById('preloader');

    if (isReloading) {
        // 1. RELOAD: Show Spinner, Ensure Truck is GONE
        if(truck) truck.style.display = 'none';
        if(spinner) spinner.classList.remove('hidden');
        if(preloader) preloader.classList.add('reload-mode');

        // 2. Fade out
        setTimeout(() => {
            if(preloader && !preloader.classList.contains('loaded')) {
                preloader.classList.add('loaded');
            }
        }, 5000); 

    } else {
        // 3. FIRST VISIT: Manually turn on the Truck
        if(truck) truck.style.display = 'flex';
        sessionStorage.setItem('tari_session_active', 'true');
    }




    // LOYALTY SETTINGS
    var loyaltyRules = { type: 'fixed', value: 0 }; 
    
    // --- SHIFT LOGIC (SMART VERSION) ---
let shiftBaseId = 0;

async function fetchShiftBaseId() {
    const now = new Date();
    let shiftStart = new Date();
    shiftStart.setHours(17, 0, 0, 0); // Set to Today 5:00 PM

    // THE FIX: If right now is earlier than 5:00 PM (e.g. 2 PM or 2 AM),
    // we belong to Yesterday's shift.
    if (now < shiftStart) {
        shiftStart.setDate(shiftStart.getDate() - 1);
    }

    console.log("Shift Start Calculated:", shiftStart.toLocaleString());

    const { data } = await sb.from('orders')
        .select('id')
        .gte('created_at', shiftStart.toISOString())
        .order('id', {ascending: true})
        .limit(1)
        .single();

    shiftBaseId = data ? data.id : 0;
    console.log("Shift Base ID:", shiftBaseId);
}


    // --- AI & SYSTEM VARIABLES ---
    
let chatSession = [];
let userGender = localStorage.getItem('tari_user_gender'); // Remember gender
let wakeThrottle = false; // Prevents "wake up" spam

    
    // Supabase Config
    const SUPABASE_URL = "https://fpgspmhgwcmhaaxsphcd.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZ3NwbWhnd2NtaGFheHNwaGNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MjYyMTEsImV4cCI6MjA4MTQwMjIxMX0.QyChZ3agLF1MiTzB8XzbrP4pCgBXsT1i9VWfQqu_VOw";
    
    // --- HELPER: Flash & Scroll to Error ---
function flashElement(element) {
    if(!element) return;
    element.classList.remove('flash-error'); // Reset animation
    void element.offsetWidth; // Force Browser Reflow (Magic Trick) ğŸª„
    element.classList.add('flash-error'); // Restart animation
    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

    
    // The Magic Translator ğŸ©
function t(text) {
    if (!text) return "";
    // Check if we have an Arabic version, otherwise return the English one
    return langMap[text] || text;
}


    // --- 0. STYLE INJECTION ---
    function injectStyles() {
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes flashRed {
                0% { background-color: transparent; border-color: #E2E8F0; }
                50% { background-color: #FEF2F2; border-color: #EF4444; box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1); }
                100% { background-color: transparent; border-color: #E2E8F0; }
            }
            .flash-error { animation: flashRed 1s ease-in-out; border-radius: 12px; }
        `;
        document.head.appendChild(style);
    }
    injectStyles();

    function flashElement(element) {
        if(!element) return;
        element.classList.remove('flash-error');
        void element.offsetWidth; // Force reflow
        element.classList.add('flash-error');
        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // --- 1. INITIALIZE & TRACKING ---
    let sb;
    if (window.supabase) {
        sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        initFingerprint(); 
        getIP(); 
    } else {
        setTimeout(() => location.reload(), 2000); 
    }  


    async function initFingerprint() {
        try {
            if (typeof FingerprintJS !== 'undefined') {
                const fpPromise = FingerprintJS.load();
                const fp = await fpPromise;
                const result = await fp.get();
                deviceId = result.visitorId;
                console.log("ğŸ”’ Security ID Active:", deviceId); 
            } else { throw new Error("Library missing"); }
        } catch (e) {
            let storedId = localStorage.getItem('tari_backup_device_id');
            if (!storedId) {
                storedId = 'dev_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
                localStorage.setItem('tari_backup_device_id', storedId);
            }
            deviceId = storedId;
        }
    }
    
    async function getIP() {
        try {
            const response = await fetch('https://api64.ipify.org?format=json');
            const data = await response.json();
            userIP = data.ip;
        } catch (e) {
            userIP = "127.0.0.1"; 
        }
    }

    // --- WELCOME SPLASH LOGIC ---
    function showSplash() {
        const splash = document.getElementById('welcome-splash');
        if(splash) {
            splash.classList.remove('hidden');
            splash.classList.remove('fade-out');
            splash.classList.add('fade-in');
        }
    }

    window.closeSplashAndOrder = () => {
        const splash = document.getElementById('welcome-splash');
        switchView('home'); 
        if(splash) {
            splash.classList.remove('fade-in');  
            splash.classList.add('fade-out');    
            setTimeout(() => {
                splash.classList.add('hidden');
                splash.classList.remove('fade-out'); 
            }, 500);
        }
    }

    

    
        // UPDATED: Properly hides the login screen so it doesn't leak at the footer
    window.requireAuth = () => { 
        if (currentUser) { 
            switchView('profile'); 
        } else { 
            const authView = document.getElementById('view-auth');
            authView.classList.remove('hidden'); // 1. Make visible
            // Small delay to let browser realize it's visible before sliding
            setTimeout(() => {
                authView.classList.remove('translate-y-full'); // 2. Slide Up
            }, 10);
        } 
    };        

    window.closeAuth = () => { 
        const authView = document.getElementById('view-auth');
        authView.classList.add('translate-y-full'); // 1. Slide Down
        
        // Wait for animation (300ms) then hide completely
        setTimeout(() => {
            authView.classList.add('hidden'); // 2. Hide
        }, 300);
    };

        // --- AUTH SWITCHER (MISSING FUNCTION) ---
    window.toggleAuthMode = () => {
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const title = document.querySelector('#view-auth h1'); // The main header "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"

        if (loginForm.classList.contains('hidden')) {
            // Switch back to Login
            loginForm.classList.remove('hidden');
            signupForm.classList.add('hidden');
            if(title) title.innerText = "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
        } else {
            // Switch to Sign Up
            loginForm.classList.add('hidden');
            signupForm.classList.remove('hidden');
            if(title) title.innerText = "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯";
        }
    };

        window.handleLogin = async (btn) => { 
        const emailVal = document.getElementById('login-email').value;
        const passVal = document.getElementById('login-pass').value;

        setBtnLoading(btn, true, "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„..."); 
        
        // 1. Attempt Login
        const { data, error } = await sb.auth.signInWithPassword({ 
            email: emailVal, 
            password: passVal 
        }); 
        
        // 2. Handle Error
        if (error) { 
            showToast("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + error.message, true); 
            setBtnLoading(btn, false, "Ø¯Ø®ÙˆÙ„"); 
            return;
        } 

        // 3. Handle Success (THIS WAS MISSING)
        if (data.user) {
            // Check Security Block
            const isBlocked = await checkUserBlock();
            if (isBlocked) return; 

            currentUser = data.user;
            
            // Load Data & Close Window
            await loadUserProfile(currentUser.id);
            listenToOrders(currentUser.id);
            closeAuth(); // <--- Closes the modal
            
            showToast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!");
            setBtnLoading(btn, false, "Ø¯Ø®ÙˆÙ„");
        }
    };

    
    // SIGNUP & OTP LOGIC
        window.handleSignup = async (btn) => { 
        const name = document.getElementById('reg-name').value; 
        const email = document.getElementById('reg-email').value; 
        const phoneInput = document.getElementById('reg-phone');
        const password = document.getElementById('reg-pass').value;
        const errorMsg = document.getElementById('phone-error-msg');

        let rawNumber = phoneInput.value.replace(/\D/g, '');

        // --- VALIDATION UPDATE START ---
        // Check Length AND Starting Digit
        if (rawNumber.length !== 9 || rawNumber.charAt(0) !== '5') {
            phoneInput.classList.add('border-red-500', 'text-red-600', 'bg-red-50');
            
            // Set specific error message
            if (rawNumber.length > 0 && rawNumber.charAt(0) !== '5') {
                errorMsg.innerHTML = '<i class="fa-solid fa-circle-exclamation ml-1"></i> ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø±Ù‚Ù… Ø¨Ù€ 5';
            } else {
                errorMsg.innerHTML = '<i class="fa-solid fa-circle-exclamation ml-1"></i> Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 9 Ø£Ø±Ù‚Ø§Ù…)';
            }
            
            errorMsg.classList.remove('hidden');
            flashElement(phoneInput.parentElement);
            return;
        }
        // --- VALIDATION UPDATE END ---

        phoneInput.classList.remove('border-red-500', 'text-red-600', 'bg-red-50');
        errorMsg.classList.add('hidden');

        setBtnLoading(btn, true, 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...'); 
        
        const fullPhone = "+966" + rawNumber;
        const generatedCode = Math.floor(1000 + Math.random() * 9000).toString();

        const { data: rpcData, error: rpcError } = await sb.rpc('send_whatsapp_otp', { 
            phone: fullPhone, 
            otp: generatedCode 
        });

        if (rpcError) { 
            if (rpcError.message?.includes('already registered')) {
                showToast("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹!", true);
                phoneInput.classList.add('border-red-500', 'bg-red-50');
                flashElement(phoneInput.parentElement);
            } else {
                console.error("System Error:", rpcError);
                showToast("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨", true); 
            }
            setBtnLoading(btn, false, "ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯"); 
            return; 
        }

        pendingOtpCode = generatedCode;
        pendingUserData = { email, password, name, phone: fullPhone, btnRef: btn };
        otpExpiryTime = Date.now() + (5 * 60 * 1000);

        startResendTimer();

        const ghostInput = document.getElementById('otp-input');
        ghostInput.value = ''; 
        
        for(let i=0; i<4; i++) {
             const box = document.getElementById(`otp-box-${i}`);
             box.innerText = '';
             box.classList.remove('border-orange-500', 'bg-white');
             box.classList.add('border-slate-200', 'bg-slate-50');
        }

        document.getElementById('otp-target-number').innerText = fullPhone;
        document.getElementById('otp-modal').classList.remove('hidden');
    };



    window.confirmOtp = async () => {
        const input = document.getElementById('otp-input');
        const errorText = document.getElementById('otp-error');
        const verifyBtn = document.getElementById('btn-verify-otp');
        
        if (input.value !== pendingOtpCode) {
            errorText.classList.remove('hidden');
            input.classList.add('border-red-500', 'bg-red-50');
            flashElement(input);
            return;
        }

        errorText.classList.add('hidden');
        input.classList.remove('border-red-500', 'bg-red-50');
        setBtnLoading(verifyBtn, true, 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...');

        const { email, password, name, phone, btnRef } = pendingUserData;
        
        const { data, error } = await sb.auth.signUp({ 
            email: email, 
            password: password, 
            options: { data: { name: name, phone: phone } } 
        }); 
        
        if (error) { 
            showToast(error.message, true); 
            setBtnLoading(verifyBtn, false, "ØªØ£ÙƒÙŠØ¯"); 
            setBtnLoading(btnRef, false, "ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯"); 
            return; 
        } 
        
        if (data.user) { 
            await sb.from('users').insert({ 
                id: data.user.id, 
                name: name, 
                email: email, 
                phone: phone,
                points: 0, 
                joined: new Date().toLocaleDateString(), 
                avatar: `https://ui-avatars.com/api/?name=${name}&background=FF5722&color=fff` 
            }); 
            
            closeOtpModal();
            closeAuth(); 
            showToast("ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ØŒ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ!"); 
            setTimeout(() => { showSplash(); }, 300); 
            
            setBtnLoading(verifyBtn, false, "ØªØ£ÙƒÙŠØ¯"); 
            setBtnLoading(btnRef, false, "ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯"); 
        } 
    };

        document.getElementById('reg-phone').addEventListener('input', function(e) {
        const input = e.target;
        const errorMsg = document.getElementById('phone-error-msg');
        const raw = input.value.replace(/\D/g, '');
        
        // 1. Check if it starts with 5 (Instant Error)
        if (raw.length > 0 && raw.charAt(0) !== '5') {
            input.classList.add('border-red-500', 'text-red-600', 'bg-red-50');
            errorMsg.innerHTML = '<i class="fa-solid fa-circle-exclamation ml-1"></i> ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø±Ù‚Ù… Ø¨Ù€ 5';
            errorMsg.classList.remove('hidden');
        } else {
            // 2. If it starts with 5 (or empty), hide error immediately so they can type
            input.classList.remove('border-red-500', 'text-red-600', 'bg-red-50');
            errorMsg.classList.add('hidden');
        }
    });


    window.closeOtpModal = () => {
        document.getElementById('otp-modal').classList.add('hidden');
        if(pendingUserData && pendingUserData.btnRef) {
             setBtnLoading(pendingUserData.btnRef, false, "ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯");
        }
        pendingOtpCode = null;
        pendingUserData = null;
    };
    
    window.handleLogout = async () => { await sb.auth.signOut(); location.reload(); }

    // --- 3. CORE UI & DATA LOADING ---
    window.hideSplash = () => {
    // 1. Hide Splash UI
    document.getElementById('splash-screen').style.transform = 'translateY(-100%)'; 
    setTimeout(() => document.getElementById('splash-screen').classList.add('splash-gone'), 600);
    sessionStorage.setItem('tari_splash_seen', 'true');

    // 2. Check if user needs Intro
    const hasMetChef = localStorage.getItem('tari_chef_intro_seen');

    if (!hasMetChef) {
        // A. Hide real button initially
        const realBtn = document.getElementById('ai-trigger');
        if(realBtn) realBtn.classList.add('opacity-0', 'pointer-events-none');
        
        // B. Load source into the modal lottie (Safely)
        const masterLottie = document.getElementById('ai-lottie-master');
        const heroLottie = document.getElementById('ai-hero-lottie');
        
        // Use default URL if master is missing to prevent crash
        let animSrc = "https://fpgspmhgwcmhaaxsphcd.supabase.co/storage/v1/object/public/images/Headphone%20with%20blueberry%20cartoon%20(1).json";
        
        if(masterLottie && masterLottie.getAttribute('src')) {
            animSrc = masterLottie.getAttribute('src');
        }

        if(heroLottie) {
             heroLottie.load(animSrc);
        }

        // C. Show Window after splash clears
        setTimeout(() => showAiOnboarding(), 800);
    }
};
function showAiOnboarding() {
    const modal = document.getElementById('ai-onboarding');
    const backdrop = document.getElementById('ai-onboard-backdrop');
    const card = document.getElementById('ai-onboard-card');
    
    modal.classList.remove('hidden');
    requestAnimationFrame(() => {
        backdrop.classList.remove('opacity-0');
    });
    setTimeout(() => {
        card.classList.remove('scale-95', 'opacity-0');
        card.classList.add('scale-100', 'opacity-100');
    }, 100);
}

window.dropAiToSpot = () => {
    const heroWrapper = document.getElementById('ai-hero-wrapper');
    const targetBtn = document.getElementById('ai-trigger');
    const modal = document.getElementById('ai-onboarding');
    const backdrop = document.getElementById('ai-onboard-backdrop');
    const card = document.getElementById('ai-onboard-card');

    const startRect = heroWrapper.getBoundingClientRect();
    const targetRect = targetBtn.getBoundingClientRect();

    heroWrapper.style.position = 'fixed';
    heroWrapper.style.left = startRect.left + 'px';
    heroWrapper.style.top = startRect.top + 'px';
    heroWrapper.style.width = startRect.width + 'px';
    heroWrapper.style.height = startRect.height + 'px';
    heroWrapper.style.zIndex = '9999';
    heroWrapper.style.pointerEvents = 'none';
    heroWrapper.style.transition = 'all 0.8s cubic-bezier(0.5, 0, 0, 1)';
    
    document.body.appendChild(heroWrapper);

    backdrop.classList.add('opacity-0');
    card.style.transform = 'scale(0.9) translateY(20px)';
    card.style.opacity = '0';

    requestAnimationFrame(() => {
        const targetX = targetRect.left + (targetRect.width / 2) - (startRect.width / 2); 
        const targetY = targetRect.top + (targetRect.height / 2) - (startRect.height / 2);

        heroWrapper.style.transform = 'scale(0.3)';
        heroWrapper.style.left = targetX + 'px';
        heroWrapper.style.top = targetY + 'px';
        heroWrapper.style.opacity = '0';
    });

    setTimeout(() => {
        heroWrapper.remove();
        modal.classList.add('hidden');
        targetBtn.classList.remove('opacity-0', 'pointer-events-none');
        targetBtn.classList.add('scale-125', 'bg-white'); 
        setTimeout(() => targetBtn.classList.remove('scale-125', 'bg-white'), 300);
        localStorage.setItem('tari_chef_intro_seen', 'true');
    // ğŸ”¥ NEW: Wait just a tiny bit for the "flash" then open the Chat
        setTimeout(() => {
            toggleAi(true); 
        }, 100); 

    }, 800); 
};

    // --- âš¡ ADVANCED LOADING BUTTON (With 15s Failsafe) ---
window.setBtnLoading = (btn, isLoading, text='Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©', timeoutSecs = 10) => {
    if (!btn) return;

    // 1. Clear any existing kill-switch timer to prevent conflicts
    if (btn.dataset.timer) {
        clearTimeout(parseInt(btn.dataset.timer));
        btn.dataset.timer = "";
    }

    if (isLoading) {
        // 2. Save original text (only if not already saved)
        if (!btn.dataset.org) btn.dataset.org = btn.innerHTML;

        // 3. Show Spinner & Disable
        // Added 'dir="ltr"' to spinner to ensure it stays on the correct side
        btn.innerHTML = `<span class="flex items-center justify-center gap-2"><i class="fa-solid fa-circle-notch fa-spin"></i> ${text}</span>`;
        btn.disabled = true;
        btn.classList.add('opacity-80', 'cursor-not-allowed');

        // 4. START KILL SWITCH (The Safety Method)
        const timerId = setTimeout(() => {
            if (btn.disabled) { // Only run if it's STILL stuck loading
                console.warn(`âš ï¸ Action timed out on [${btn.innerText}] - forcing reset.`);
                
                // Force Reset
                btn.innerHTML = btn.dataset.org;
                btn.disabled = false;
                btn.classList.remove('opacity-80', 'cursor-not-allowed');
                
                // Alert User
                showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥ØªØµØ§Ù„ ØŒ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©", true); // "Network slow, try again"
            }
        }, timeoutSecs * 1000); // 15 Seconds default

        btn.dataset.timer = timerId;

    } else {
        // 5. RESTORE NORMAL STATE (Success/Error)
        btn.innerHTML = text || btn.dataset.org || 'Ø¥Ø±Ø³Ø§Ù„';
        btn.disabled = false;
        btn.classList.remove('opacity-80', 'cursor-not-allowed');
    }
};
                
    
    // âœ… ADD THIS MISSING FUNCTION
window.showToast = (msg, isError = false) => {
    const toast = document.getElementById('toast');
    const icon = document.getElementById('toast-icon');
    const msgEl = document.getElementById('toast-msg');
    
    if(!toast) return;

    msgEl.innerText = msg;
    if(isError) {
        icon.className = "fa-solid fa-circle-exclamation text-red-500 text-lg";
    } else {
        icon.className = "fa-solid fa-circle-check text-green-400 text-lg";
    }

    toast.classList.add('show');
    setTimeout(() => {
        toast.classList.remove('show');
    }, 5000);
};

        window.switchView = (v) => { 
        // 1. FIND THE TARGET PAGE
        const targetPage = document.getElementById('view-' + v);
        
        // Safety Guard
        if (!targetPage.classList.contains('hidden')) return;

        // 2. AUTH CHECK
        if((v=='track'||v=='profile') && !currentUser) return window.requireAuth(); 

        // 3. SWITCH THE PAGES
        document.querySelectorAll('[id^="view-"]').forEach(e => e.classList.add('hidden')); 
        targetPage.classList.remove('hidden'); 
        
        // 4. UPDATE NAVBAR
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); 
        if(v=='home') document.querySelectorAll('.nav-item')[0].classList.add('active'); 
        if(v=='track') document.querySelectorAll('.nav-item')[1].classList.add('active'); 
        if(v=='profile') document.querySelectorAll('.nav-item')[2].classList.add('active'); 

        // 5. ğŸ¤– ROBOT LOGIC (HOME ONLY)
        const aiBtn = document.getElementById('ai-trigger');
        if (aiBtn) {
            if (v === 'home') {
                aiBtn.classList.remove('hidden'); 
                aiBtn.style.display = 'flex'; // Force it to show
            } else {
                aiBtn.classList.add('hidden');
                aiBtn.style.display = 'none'; // Force it to hide
            }
        }
    }

    // --- CATEGORY FETCHING (Missing Function) ---
    async function fetchCategories() {
        // 1. Get categories from Supabase
        const { data } = await sb.from('settings').select('data').eq('id', 'menu_categories').single();
        
        // 2. Default if nothing found
        let cats = ["Burger", "Fries", "Drink"]; 
        if(data?.data?.categories) cats = data.data.categories;

        // 3. Render the buttons
        const container = document.getElementById('category-list');
        if(container) {
            // 'All' Button (Active by default)
            let html = `<button onclick="filterMenu('all', this)" class="cat-btn active bg-slate-900 text-white border border-slate-900 px-6 py-2.5 rounded-full font-bold text-sm whitespace-nowrap shadow-md transition-all">Ø§Ù„ÙƒÙ„</button>`;
            
            
            // Dynamic Category Buttons
            cats.forEach(c => {
                // ğŸ‘‡ USING t(c) HERE ğŸ‘‡
                html += `<button onclick="filterMenu('${c}', this)" class="cat-btn bg-white text-slate-600 border border-slate-200 px-6 py-2.5 rounded-full font-bold text-sm whitespace-nowrap shadow-sm hover:border-orange-200 transition-all">${t(c)}</button>`;
            });

            
            container.innerHTML = html;
        }
    }
    
    // --- ğŸ”’ SECURITY: CHECK BLOCK STATUS ---
async function checkUserBlock() {
    if (!currentUser) return false;

    // 1. Fetch Blocked List
    const { data: blockSettings } = await sb.from('settings').select('data').eq('id', 'blocked_users').single();
    const blockedIds = blockSettings?.data?.ids || [];

    // 2. Check if Current User is Blocked
    if (blockedIds.includes(currentUser.id)) {
        console.log("ğŸš« User is blocked. Restricting access.");
        
        // 3. Show Block Screen
        document.body.innerHTML = `
            <div style="height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; background:#f8fafc; text-align:center; padding:30px;" dir="rtl">
                <div style="font-size:50px; margin-bottom:20px;">ğŸš«</div>
                <h1 style="font-weight:900; font-size:24px; color:#1e293b; margin-bottom:10px; font-family:'Tajawal', sans-serif;">ØªÙ… ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„ÙˆØµÙˆÙ„</h1>
                <p style="color:#64748b; margin-bottom:30px; font-family:'Tajawal', sans-serif; line-height:1.6;">
                    ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø¤Ù‚ØªØ§Ù‹ Ø¨Ø³Ø¨Ø¨ <strong>Ø¹Ø¯Ù… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</strong>.<br><br>
                    ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø·Ø¹Ø§Ù… ÙˆØ¹Ø¯Ù… Ø§Ø³ØªÙ„Ø§Ù…Ù‡ ÙŠØªØ³Ø¨Ø¨ ÙÙŠ Ù‡Ø¯Ø± Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ ÙˆÙŠØ¤Ø«Ø± Ø³Ù„Ø¨Ø§Ù‹ Ø¹Ù„Ù‰ Ø¹Ù…Ù„ÙŠØ§ØªÙ†Ø§ Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©.
                
        `;
        
       
        return true; // Yes, blocked
    }
    return false; // No, safe
}


        async function loadData() {
        try {   
            if(!sb) return;      


            // 2. SHIFT & TRANSLATIONS
            await fetchShiftBaseId();
            
            const { data: transData } = await sb.from('settings').select('data').eq('id', 'app_translations').single();
            if(transData?.data) { langMap = transData.data; }
            await fetchCategories();
            
            // 3. LOYALTY
            const { data: loyalty } = await sb.from('settings').select('data').eq('id', 'loyalty_program').single();
            if(loyalty?.data) { loyaltyRules = loyalty.data; }

            // 4. HERO SLIDER
            const { data: hero } = await sb.from('settings').select('data').eq('id', 'hero').single(); 
            if(hero?.data?.images) { document.getElementById('hero-slider-container').innerHTML = hero.data.images.map((img,i) => `<img src="${img}" class="hero-slide ${i===0?'active-slide':''}">`).join(''); } 
            let slideIdx = 0; if (window.heroTimer) clearInterval(window.heroTimer);
            window.heroTimer = setInterval(() => { const slides = document.querySelectorAll('.hero-slide'); if (slides.length > 1) { slides[slideIdx].classList.remove('active-slide'); slideIdx = (slideIdx + 1) % slides.length; slides[slideIdx].classList.add('active-slide'); } }, 3000);

            // 5. SPLASH SCREEN
            const { data: splash } = await sb.from('settings').select('data').eq('id', 'splash').single();
            if (splash?.data) {
                if (splash.data.title) document.getElementById('splash-title-text').innerText = t(splash.data.title);
                if (splash.data.subtitle) document.getElementById('splash-subtitle-text').innerText = t(splash.data.subtitle);
                if (splash.data.intro) document.getElementById('splash-intro').innerText = t(splash.data.intro);
                if (splash.data.background) { const bg = document.getElementById('splash-bg-img'); bg.src = splash.data.background; bg.classList.remove('hidden'); }
                if (splash.data.circle) { document.getElementById('splash-circle-img').src = splash.data.circle; }
            }

            // 6. DESIGN & WEB SETTINGS
            const { data: design } = await sb.from('settings').select('data').eq('id', 'design').single(); 
            if(design?.data?.primaryColor) { document.documentElement.style.setProperty('--primary', design.data.primaryColor); const style = document.createElement('style'); style.innerHTML = `.bg-brand{background-color:${design.data.primaryColor}!important}.text-brand{color:${design.data.primaryColor}!important}`; document.head.appendChild(style); } 

            const { data: web } = await sb.from('settings').select('data').eq('id', 'website_settings').single(); 
            if(web?.data) { 
                const header = document.getElementById('app-header'); 
                if(header && web.data.header_color) { header.style.setProperty('--header-bg', web.data.header_color); header.style.backgroundColor = 'transparent'; } 
                if(web.data.logo) { const logoImg = document.getElementById('header-truck-logo'); if(logoImg) { logoImg.src = web.data.logo + '?t=' + Date.now(); logoImg.classList.remove('hidden'); } }
                if(web.data.bg_color) { document.body.style.backgroundColor = web.data.bg_color; document.documentElement.style.backgroundColor = web.data.bg_color; }
                if(web.data.bg_image) { document.body.style.backgroundImage = `url('${web.data.bg_image}')`; document.body.style.backgroundSize = "cover"; document.body.style.backgroundPosition = "center"; document.body.style.backgroundAttachment = "fixed"; document.body.style.backgroundRepeat = "no-repeat"; }
            }
            
                        // 7. INFO & TRANSLATIONS (UPDATED)
            const [infoSnap, transSnap] = await Promise.all([
                sb.from('settings').select('data').eq('id', 'info').single(),
                sb.from('settings').select('data').eq('id', 'app_translations').single()
            ]);

            const info = infoSnap.data?.data || {};
            const trans = transSnap.data?.data || {}; // The translation dictionary

            if (info) { 
                // A. Location (Use Arabic Translation if available)
                const locText = trans['store_address_ar'] || info.location || "Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
                document.getElementById('info-location').innerText = locText;

                // B. Maps Link
                const mapBtn = document.getElementById('btn-maps');
                if(mapBtn && info.maps_link) {
                    mapBtn.href = info.maps_link;
                    mapBtn.classList.remove('hidden');
                }

                // C. Phone
                if(info.phone) document.getElementById('info-phone').innerText = info.phone; 

                // D. Hours (With Translation)
                if(info.hours && Array.isArray(info.hours)) { 
                    document.getElementById('info-hours').innerHTML = info.hours.map(h => {
                        // Check for translated Day and Time
                        const dayName = trans[h.day] || h.day;
                        const timeStr = trans[h.time] || h.time;
                        
                        return `<div class="flex justify-between w-full max-w-[200px] mb-1 text-slate-300">
                            <span>${dayName}:</span> 
                            <span class="font-bold text-white" dir="ltr">${timeStr}</span>
                        </div>`;
                    }).join(''); 
                } 
            }


            // 8. MENU
            const { data: mods } = await sb.from('modifier_groups').select('*').order('sort_order', {ascending: true}); allModifiers = mods || []; 
            const { data: menu } = await sb.from('menu').select('*').order('sort_order', {ascending: true}); allMenuItems = menu || []; 
            
            // 9. STORE STATUS (Was missing/broken)
            const { data: store } = await sb.from('settings').select('data').eq('id', 'store_status').single();
            if (store?.data?.open === false) {
                isStoreOpen = false;
                const modal = document.getElementById('closed-modal');
                const backdrop = document.getElementById('closed-backdrop');
                modal.classList.remove('-translate-y-full'); 
                backdrop.classList.remove('opacity-0');       

                if(info?.data?.hours) {
                    const hoursHtml = info.data.hours.map(h => `<div class="flex justify-between w-full max-w-[200px] mx-auto"><span>${h.day}:</span> <span>${h.time}</span></div>`).join('');
                    document.getElementById('closed-hours-display').innerHTML = hoursHtml;
                } else {
                     document.getElementById('closed-hours-display').innerText = "Ø±Ø§Ø¬Ø¹Ù†Ø§ ÙÙŠ ÙˆÙ‚Øª Ù„Ø§Ø­Ù‚!";
                }

                const cartBtn = document.getElementById('fab-btn');
                if(cartBtn) {
                    cartBtn.onclick = () => showToast("Ø§Ù„Ù…ØªØ¬Ø± Ù…ØºÙ„Ù‚ Ø­Ø§Ù„ÙŠØ§Ù‹", true);
                    cartBtn.classList.add('grayscale', 'opacity-80', 'cursor-not-allowed', 'justify-center');
                    cartBtn.classList.remove('justify-between');
                    if(document.getElementById('cart-count')) document.getElementById('cart-count').style.display = 'none';
                    if(document.getElementById('cart-total')) document.getElementById('cart-total').style.display = 'none';
                    const textSpan = cartBtn.querySelector('div span'); 
                    if(textSpan) { textSpan.innerText = "Ø§Ù„Ù…ØªØ¬Ø± Ù…ØºÙ„Ù‚"; textSpan.className = "font-black text-lg uppercase tracking-widest"; }
                }
            }

            // 10. DYNAMIC WELCOME GIFT
            const { data: newPromo } = await sb.from('settings').select('data').eq('id', 'new_user_promo').single();
            if(newPromo?.data) {
                welcomeRule = newPromo.data; 
                if(document.getElementById('splash-code')) {
                    document.getElementById('splash-code').innerText = welcomeRule.code;
                    const valText = welcomeRule.type === 'percent' ? `Ø®ØµÙ… ${welcomeRule.value}%` : `Ø®ØµÙ… ${welcomeRule.value} Ø±ÙŠØ§Ù„`;
                    document.getElementById('splash-desc').innerText = `${valText} â€¢ Ù„Ù„Ø·Ù„Ø¨ Ø§Ù„Ø£ÙˆÙ„ ÙÙ‚Ø·`;
                }
                if(document.getElementById('cart-coupon-btn')) {
                    const btn = document.getElementById('cart-coupon-btn');
                    btn.onclick = function() { useSavedCoupon(welcomeRule.code); };
                    const valText = welcomeRule.type === 'percent' ? `Ø®ØµÙ… ${welcomeRule.value}%` : `Ø®ØµÙ… ${welcomeRule.value} Ø±ÙŠØ§Ù„`;
                    document.getElementById('cart-coupon-text').innerText = valText;
                }
            }

            // 11. RENDER
            renderMenu(allMenuItems); 
            renderBestSellers(allMenuItems);
            
            // 12. LISTEN FOR LIVE STATUS
            listenToStoreStatus();

        } catch (err) { 
            console.log(err); 
        } finally { 
            document.getElementById('preloader').classList.add('opacity-0', 'pointer-events-none'); 
        }
    }

    
    // --- 4. MENU & PRODUCT LOGIC ---
        function renderBestSellers(items) { 
        const best = items.filter(i => i.is_best_seller === true && i.available !== false); 
        const container = document.getElementById('best-seller-list'); 
        if(best.length > 0) { 
            document.getElementById('best-seller-section').classList.remove('hidden'); 
            container.innerHTML = best.map(i => { 
                const itemStr = JSON.stringify(i).replace(/'/g, "&#39;").replace(/"/g, "&quot;"); 
                // ğŸ‘‡ TRANSLATION APPLIED HERE: ${t(i.name)} ğŸ‘‡
                return `<div onclick='openCartItemFromMenu(${itemStr})' class="flex-shrink-0 w-40 bg-white rounded-2xl p-3 shadow-md border border-slate-100 cursor-pointer active:scale-95 transition relative overflow-hidden group"><div class="h-32 w-full rounded-xl overflow-hidden mb-2 relative"><div class="absolute top-2 right-2 badge-shine-gold px-2 py-1 rounded-md z-10 text-[10px] font-black tracking-wider flex items-center gap-1"><i class="fa-solid fa-star text-[8px]"></i> Ù…Ù…ÙŠØ²</div><img src="${i.image||'https://via.placeholder.com/150'}" class="w-full h-full object-cover"></div><h4 class="font-bold text-sm truncate mt-2 text-slate-800">${t(i.name)}</h4><div class="flex justify-between items-center mt-1"><span class="text-orange-500 font-bold text-xs">SR ${i.price}</span><div class="w-6 h-6 bg-slate-900 text-white rounded-md flex items-center justify-center text-[10px] shadow-sm group-hover:bg-orange-500 transition"><i class="fa-solid fa-plus"></i></div></div></div>`; 
            }).join(''); 
        } else { document.getElementById('best-seller-section').classList.add('hidden'); } 
    }


        function renderMenu(items, animClass = 'fade-in') { 
        const list = document.getElementById('menu-list');
        if(!items.length) {
            list.innerHTML = `<div class="text-center py-10 text-slate-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±.</div>`;
            return;
        }
        list.innerHTML = items.map((item, index) => { 
            const itemStr = JSON.stringify(item).replace(/'/g, "&#39;").replace(/"/g, "&quot;"); 
            const isSoldOut = item.available === false; 
            const bestSellerBadge = item.is_best_seller ? `<div class="absolute top-0 right-0 bg-orange-500 text-white text-[10px] font-bold px-2 py-1 rounded-bl-lg z-10 shadow-sm">Ø§Ù„Ø£ÙƒØ«Ø± Ø·Ù„Ø¨Ø§Ù‹</div>` : '';
            const delay = index * 50; 

            // ğŸ‘‡ TRANSLATION LOGIC APPLIED BELOW ğŸ‘‡
            return `
            <div onclick='${isSoldOut ? '' : `openCartItemFromMenu(${itemStr})`}' 
                 style="animation-delay: ${delay}ms"
                 class="${animClass} bg-white p-3 rounded-2xl shadow-sm border border-slate-100 flex gap-4 cursor-pointer active:scale-[0.98] transition group relative overflow-hidden ${isSoldOut ? 'sold-out-card' : ''}">
                <div class="relative w-24 h-24 flex-shrink-0 rounded-xl overflow-hidden">
                    ${bestSellerBadge}
                    <img src="${item.image || 'https://via.placeholder.com/150'}" class="w-full h-full object-cover bg-slate-100 border-2 border-white shadow-sm">
                </div>
                <div class="flex flex-col justify-center flex-1">
                    <h3 class="font-bold text-slate-800 text-lg leading-tight mb-1">${t(item.name)}</h3>
                    <p class="text-xs text-slate-500 line-clamp-2 mb-2">${langMap[item.name + '_desc'] || item.description || ''}</p>
                    <div class="flex justify-between items-center mt-auto">
                        <span class="font-bold text-slate-900">SR ${item.price}</span>
                        <div class="w-8 h-8 bg-slate-50 rounded-full flex items-center justify-center text-slate-400 group-hover:bg-orange-50 group-hover:text-orange-500 transition"><i class="fa-solid fa-plus"></i></div>
                    </div>
                </div>
            </div>`; 
        }).join(''); 
    }


        window.filterMenu = (cat, btn) => { 
        // 1. Update Active Button Style
        document.querySelectorAll('.cat-btn').forEach(b => {
            b.classList.remove('active', 'bg-slate-900', 'text-white', 'border-slate-900');
            b.classList.add('bg-white', 'text-slate-600', 'border-slate-200');
        });
        btn.classList.remove('bg-white', 'text-slate-600', 'border-slate-200');
        btn.classList.add('active', 'bg-slate-900', 'text-white', 'border-slate-900');
        
        // 2. Filter the Data
        const filtered = cat === 'all' 
            ? allMenuItems 
            : allMenuItems.filter(i => (i.category === cat) || (i.name && i.name.toLowerCase().includes(cat.toLowerCase())));
            
        // 3. Render with 'fade-in' (Always)
        // We removed the 'anim-next' / 'anim-prev' logic here!
        renderMenu(filtered, 'fade-in'); 
    }

    // --- 5. CART & MODAL LOGIC ---
    function toggleSheet(id, show) {
        if (sheetTimer) clearTimeout(sheetTimer);
        const container = document.getElementById(id);
        const card = id === 'productModal' ? document.getElementById('productCard') : document.getElementById('checkoutCard');
        
        if (show) {
            modalOpen = true;  
            card.style.transition = 'none'; 
            card.style.transform = 'translateY(100%)'; 
            container.classList.add('modal-shell'); 
            void card.offsetHeight; 
            
            container.classList.remove('hidden'); 
            container.classList.add('active'); 
            
            requestAnimationFrame(() => { 
                card.style.transition = 'transform 0.9s cubic-bezier(0.32, 0.72, 0, 1)'; 
                card.style.transform = 'translateY(0)'; 
            });

        } else {
            container.classList.remove('active'); 
            card.style.transition = 'transform 0.9s cubic-bezier(0.32, 0.72, 0, 1)'; 
            card.style.transform = 'translateY(100%)';
            
            sheetTimer = setTimeout(() => { 
                container.classList.add('hidden'); 
                card.style.transform = ''; 
                card.style.transition = ''; 
                modalOpen = false; 
            }, 600); 
        }
    }

    window.openCartItemFromMenu = (item) => { editingCartIndex = -1; openProductModal(item); }
    window.editCartItem = (index) => { editingCartIndex = index; currentItem = cart[index]; closeCart(); setTimeout(() => openProductModal(currentItem, true), 350); }
    
        window.openProductModal = (item, isEdit = false) => {
        currentItem = item; modalQty = isEdit ? item.qty : 1;
        
        // Basic Info with Translations
        document.getElementById('modal-title').innerText = t(item.name); 
        document.getElementById('modal-price').innerText = 'SR ' + item.price; 
        document.getElementById('modal-desc').innerText = langMap[item.name + '_desc'] || item.description || '';   
        document.getElementById('modal-img').src = item.image || 'https://via.placeholder.com/150'; 
        document.getElementById('modal-qty').innerText = modalQty; 
        document.getElementById('addToCartBtn').innerText = isEdit ? "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨" : "Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø·Ù„Ø¨"; 
        
        const container = document.getElementById('modal-modifiers'); 
        container.innerHTML = "";
        
        if(item.modifier_group_ids && item.modifier_group_ids.length > 0) {
            const relevantGroups = allModifiers.filter(g => item.modifier_group_ids.includes(g.id));
            
            relevantGroups.forEach(g => {
                const options = typeof g.options === 'string' ? JSON.parse(g.options) : g.options;
                
                // 1. Group Title (Added ID for scrolling, Translation applied)
                const html = `<div id="mod-group-${g.id}" class="modifier-group mb-4">
                    <h4 class="font-bold text-sm mb-2 mt-4 text-slate-800 uppercase tracking-wide border-b border-slate-100 pb-1 text-right">
                        ${t(g.name)} ${g.required?'<span class="text-red-500">*</span>':''}
                    </h4>` + options.map((opt, i) => {
                    
                    let isChecked = false; 
                    if(isEdit && item.selectedMods) { 
                        isChecked = item.selectedMods.some(m => m.name === opt.name && m.group === g.name); 
                    }
                    
                    // 2. The Checkbox Row (RTL Fixed)
                    // Removed 'flex-row-reverse'. Standard flex in dir="rtl" puts input on Right, Price on Left.
                    // Added t(opt.name) for translation.
                    // Added dir="ltr" to price so "SR 5" doesn't flip.
                    return `<label class="no-drag flex justify-between items-center p-3 border border-slate-200 rounded-xl mb-2 bg-slate-50 cursor-pointer hover:border-orange-200 transition">
                        
                        <div class="flex items-center gap-3">
                            <input type="${g.required?'radio':'checkbox'}" name="mod-${g.id}" class="mod-checkbox w-5 h-5 accent-orange-500" data-group="${g.name}" data-name="${opt.name}" data-price="${opt.price||0}" ${isChecked?'checked':''}>
                            <span class="font-medium text-sm">${t(opt.name)}</span>
                        </div>
                        
                        <span class="text-xs font-bold text-slate-500" dir="ltr">+SR ${opt.price||0}</span>
                    </label>`;
                }).join('') + `</div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        }
        toggleSheet('productModal', true);
    }
    
    // Clear old listeners to prevent duplicates (optional safety)
    const oldBtn = document.getElementById('addToCartBtn');
    const newBtn = oldBtn.cloneNode(true);
    oldBtn.parentNode.replaceChild(newBtn, oldBtn);

    // New Listener with Fixed Validation Logic
    newBtn.addEventListener('click', () => {
        const btn = document.getElementById('addToCartBtn');
        let isValid = true; 
        let missingGroups = [];

        // 1. VALIDATION CHECK
        if (currentItem.modifier_group_ids && currentItem.modifier_group_ids.length > 0) {
            currentItem.modifier_group_ids.forEach(gid => {
                const group = allModifiers.find(m => m.id === gid);
                if (group && group.required) { 
                    const checked = document.querySelector(`input[name="mod-${gid}"]:checked`); 
                    if (!checked) { 
                        isValid = false; 
                        missingGroups.push(group); 
                    } 
                }
            });
        }

        // 2. IF INVALID: STOP & FLASH ğŸš¨
        if (!isValid) { 
            showToast(`Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø±: ${missingGroups.map(g => t(g.name)).join(', ')}`, true); 
            
            // Find the visual box using the ID we set above
            const firstGroup = missingGroups[0];
            const groupContainer = document.getElementById(`mod-group-${firstGroup.id}`);
            
            if (groupContainer) { 
                flashElement(groupContainer); 
            }
            return; 
        }

        // 3. IF VALID: PROCEED TO CART âœ…
        setBtnLoading(btn, true, 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©...');
        setTimeout(() => {
            let unitPrice = parseFloat(currentItem.price); 
            let selectedMods = [];
            
            document.querySelectorAll('.mod-checkbox:checked').forEach(c => { 
                let p = parseFloat(c.dataset.price) || 0; 
                unitPrice += p; 
                // We save English names (dataset.name) to database, but user sees Arabic in UI
                selectedMods.push({ name: c.dataset.name, price: p, group: c.dataset.group }); 
            });
            
            const newItem = { ...currentItem, qty: modalQty, unitPrice, selectedMods };
            
            if (editingCartIndex > -1) { 
                cart[editingCartIndex] = newItem; 
            } else { 
                const exist = cart.findIndex(c => c.id === newItem.id && JSON.stringify(c.selectedMods) === JSON.stringify(newItem.selectedMods)); 
                if (exist > -1) cart[exist].qty += newItem.qty; 
                else cart.push(newItem); 
            }
            
            updateCartUI(); 
            toggleSheet('productModal', false); 
            setBtnLoading(btn, false);
        }, 300);
    });



    window.dismissClosedModal = () => {
        document.getElementById('closed-modal').classList.add('-translate-y-full');
    };

    window.closeModal = () => { toggleSheet('productModal', false); setTimeout(() => updateCartUI(), 200); if(editingCartIndex !== -1) setTimeout(openCart, 350); editingCartIndex = -1; }
    window.closeCart = () => { 
    toggleSheet('checkoutModal', false); 

    // Wait for the slide-down animation to finish before cleaning up
    setTimeout(() => { 
        const msg = document.getElementById('promo-msg');
        const input = document.getElementById('promo-input');

        // CHECK: If the message is NOT green (meaning it's an error or expired)
        // we wipe everything clean for a fresh start.
        if (msg && !msg.classList.contains('text-green-600')) {
            // 1. Clear the error text
            msg.innerText = "";
            msg.classList.add('hidden');

            // 2. Clear and reset the input box
            if (input) {
                input.value = "";
                input.disabled = false;
                input.classList.remove('bg-orange-50', 'text-orange-600');
            }

            // 3. Ensure the "Apply" button is visible again
            const applyBtn = document.getElementById('btn-apply-promo');
            const removeBtn = document.getElementById('btn-remove-promo');
            if (applyBtn) applyBtn.classList.remove('hidden');
            if (removeBtn) removeBtn.classList.add('hidden');
        }

        // Keep the floating basket button (FAB) logic
        const fab = document.getElementById('fab-container'); 
        if (fab && cart.length > 0) fab.classList.remove('translate-y-32'); 
    }, 400); 
}

    window.adjustModalQty = (c) => { if(modalQty + c > 0) { modalQty += c; document.getElementById('modal-qty').innerText = modalQty; } }
    window.changeCartQty = (index, delta) => { cart[index].qty += delta; if(cart[index].qty <= 0) cart.splice(index, 1); if(cart.length === 0) closeCart(); updateCartUI(); };
    window.removeFromCart = (i) => { cart.splice(i,1); if(cart.length === 0) closeCart(); updateCartUI(); };

    // --- 6. PROMO CODE LOGIC ---
    window.applyPromoCode = async () => {
        const btn = document.getElementById('btn-apply-promo');
        const input = document.getElementById('promo-input');
        const msg = document.getElementById('promo-msg');
        const code = input.value.trim().toUpperCase(); 

        if (!code) { 
            msg.innerText = "Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯"; 
            msg.className = "absolute -bottom-5 right-1 text-[10px] font-bold text-red-500 transition-all"; 
            msg.classList.remove('hidden'); 
            return; 
        }

        const orgText = "ØªØ·Ø¨ÙŠÙ‚";
        btn.disabled = true; btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i>`; 

        if (!currentUser) { btn.innerHTML = orgText; btn.disabled = false; window.requireAuth(); return; }

        try {
            if (userIP === "0.0.0.0") { await getIP(); }
            let subnet = "unavailable";
            if (typeof userIP !== 'undefined' && userIP.includes('.')) { subnet = userIP.split('.').slice(0, 3).join('.'); }
            const userPhone = currentUser.user_metadata?.phone || "";

            const { data: isAbuser, error: rpcError } = await sb.rpc('check_promo_abuse', { 
                check_code: code, check_device: deviceId, check_phone: userPhone, check_subnet: subnet    
            });

            if (rpcError) throw new Error("System Error");
            if (isAbuser === true) throw new Error("Usage limit reached");

            if (code === welcomeRule.code) {
                if (userOrderCount > 0) throw new Error("Only for new users");
                finalizePromo(welcomeRule.value, welcomeRule.type, welcomeRule.code, btn, orgText, msg, input);
                return;
            }

            const { data, error } = await sb.from('promocodes').select('*').ilike('code', code).single();
            if (error || !data) throw new Error("Invalid Code");
            
            // --- NEW: CHECK EXPIRY DATE ---
if(data.expires) {
    // Standardize the date by removing UTC offsets to match Saudi Local Time
    const rawDate = data.expires.split('+')[0].replace('Z', '');
    const expDate = new Date(rawDate);
    const now = new Date();

    if(now > expDate) {
        const msgEl = document.getElementById('promo-msg');
        if(msgEl) {
            // Updated: Simple message without the specific date
            msgEl.innerText = "Ø§Ù„ÙƒÙˆØ¯ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©"; 
            
            // Error styling to align with English LTR layout
            msgEl.className = "absolute -bottom-5 right-1 text-[10px] font-bold text-red-500 transition-all";
            msgEl.classList.remove('hidden');
        }
        
        // Reset the button state
        btn.innerHTML = orgText; 
        btn.disabled = false;
        
        return showToast("Ø§Ù„ÙƒÙˆØ¯ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©", true);
    }
}


            const { count: usageCount } = await sb.from('orders').select('*', { count: 'exact', head: true }).eq('user_id', currentUser.id).eq('promo_code', code);
            if (usageCount > 0) throw new Error("Code already used");
            
            finalizePromo(data.value, data.type, data.code, btn, orgText, msg, input);

        } catch (e) {
            console.warn(e);
            let userMsg = "ÙƒÙˆØ¯ ØºÙŠØ± ØµØ§Ù„Ø­";
            if (e.message === "Code already used") userMsg = "ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹";
            else if (e.message === "Only for new users") userMsg = "Ù„Ù„Ø·Ù„Ø¨ Ø§Ù„Ø£ÙˆÙ„ ÙÙ‚Ø·";
            else if (e.message === "Usage limit reached") userMsg = "ØªÙ… ØªØ¬Ø§ÙˆØ² Ø­Ø¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…";
            else if (e.message.includes("System Error")) userMsg = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… - Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰";

            msg.innerText = userMsg; 
            msg.className = "absolute -bottom-5 right-1 text-[10px] font-bold text-red-500 transition-all";
            msg.classList.remove('hidden'); 
            btn.innerHTML = orgText; btn.disabled = false;
        }
    };

    window.finalizePromo = function(value, type, code, btn, orgText, msg, input) {
        currentPromoRule = { code: code, type: type, value: value }; 
        activePromoCode = code;
        msg.innerText = "ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒÙˆØ¯!"; 
        msg.className = "absolute -bottom-5 right-1 text-[10px] font-bold text-green-600 transition-all";
        msg.classList.remove('hidden');
        input.disabled = true; btn.classList.add('hidden'); document.getElementById('btn-remove-promo').classList.remove('hidden');
        btn.innerHTML = orgText; btn.disabled = false;
        updateCartUI(); 
    };

    window.removePromo = () => {
        currentPromoRule = null;
        activeDiscount = 0; activePromoCode = "";
        const input = document.getElementById('promo-input'); if(input) { input.value = ""; input.disabled = false; }
        document.getElementById('btn-apply-promo').classList.remove('hidden'); document.getElementById('btn-remove-promo').classList.add('hidden');
        const msg = document.getElementById('promo-msg'); if(msg) msg.innerText = "";
        updateCartUI();
    }

    window.useSavedCoupon = (code) => {
        const input = document.getElementById('promo-input');
        if(input) {
            input.value = code;
            input.classList.add('bg-orange-50', 'text-orange-600');
            setTimeout(() => input.classList.remove('bg-orange-50', 'text-orange-600'), 300);
            applyPromoCode();
        }
    }

    // --- 7. CART CALCULATIONS ---
    window.updateCartUI = () => {
        const container = document.getElementById('cart-items');
        if (!container) return; 
        container.innerHTML = ""; 
        const fab = document.getElementById('fab-container');
        const totalQty = cart.reduce((sum, i) => sum + i.qty, 0);
        
        if(document.getElementById('cart-count')) {
            document.getElementById('cart-count').innerText = totalQty;
        }

        if (cart.length === 0) {
            container.innerHTML = `<div class="text-center py-10 opacity-50"><div class="text-4xl mb-2">ğŸ”</div><p class="text-sm font-bold text-slate-400">Ø³Ù„Ø© Ù…Ø´ØªØ±ÙŠØ§ØªÙƒ ÙØ§Ø±ØºØ©</p></div>`;
            currentPromoRule = null; activeDiscount = 0; activePromoCode = "";
            document.querySelectorAll('[id="cart-total"], [id="checkout-total"]').forEach(el => el.innerText = "0.00 SR");
            if (fab) fab.classList.add('translate-y-32'); 
            return;
        }

        const subtotal = cart.reduce((s, i) => s + (i.unitPrice * i.qty), 0);
        let discountAmount = 0;

        if (currentPromoRule) {
            if (currentPromoRule.type === 'percent') {
                let percentage = parseFloat(currentPromoRule.value);
                if (percentage > 1) percentage = percentage / 100;
                discountAmount = subtotal * percentage;
                if (discountAmount > 30) discountAmount = 30; 
            } else {
                discountAmount = parseFloat(currentPromoRule.value);
            }
            if(discountAmount > subtotal) discountAmount = subtotal;

            const pMsg = document.getElementById('promo-msg');
            if(pMsg) { 
                pMsg.innerText = `Ø®ØµÙ… (SR ${discountAmount.toFixed(2)})`; 
                pMsg.className = "absolute -bottom-5 right-1 text-[10px] font-bold text-green-600 transition-all";
                pMsg.classList.remove('hidden');
            }
        }
        
        activeDiscount = discountAmount; 
        const total = Math.max(0, subtotal - discountAmount);

                cart.forEach((item, index) => {
            // 1. Translate modifiers using t() and use Arabic comma
            let modText = item.selectedMods && item.selectedMods.length > 0 
                ? item.selectedMods.map(m => t(m.name)).join('ØŒ ')           
               : 'Ø¹Ø§Ø¯ÙŠ';
            const isGift = item.isLoyalty === true;

            // 1. Hide the Edit Pencil if it's a gift
            const editBtnHtml = isGift 
                ? '' 
                : `<button onclick="editCartItem(${index})" class="text-xs text-slate-300 hover:text-orange-500"><i class="fa-solid fa-pen"></i></button>`;
            container.innerHTML += `<div class="flex flex-col border-b border-slate-50 pb-3 mb-3 last:border-0">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h4 class="font-black text-slate-800 text-sm flex items-center gap-2">
                            ${t(item.name)} <button onclick="editCartItem(${index})" class="text-xs text-slate-300 hover:text-orange-500"><i class="fa-solid fa-pen"></i></button>
                        </h4>
                        <p class="text-[10px] text-slate-400 font-bold mt-0.5 leading-tight">${modText}</p>
                    </div>
                    <p class="font-black text-slate-900 text-sm" dir="ltr">${(item.unitPrice * item.qty).toFixed(2)}</p>
                </div>
                <div class="flex justify-between items-center">
                    <div class="flex items-center bg-slate-50 rounded-lg h-8 border border-slate-100">
                        <button onclick="changeCartQty(${index}, -1)" class="w-8 h-full text-slate-400 hover:text-slate-900 font-bold transition">-</button>
                        <span class="text-xs font-black text-slate-800 w-6 text-center">${item.qty}</span>
                        <button onclick="changeCartQty(${index}, 1)" class="w-8 h-full text-slate-400 hover:text-slate-900 font-bold transition">+</button>
                    </div>
                    <button onclick="removeFromCart(${index})" class="text-red-400 hover:text-red-600 text-xs w-8 h-8 flex items-center justify-center bg-red-50 rounded-lg transition active:scale-90"><i class="fa-solid fa-trash-can"></i></button>
                </div>
            </div>`;
        });

        document.querySelectorAll('[id="cart-total"], [id="checkout-total"]').forEach(el => el.innerText = total.toFixed(2) + " SR");
        
        const couponList = document.getElementById('coupon-list');
        if(couponList) { (currentUser && userOrderCount === 0) ? couponList.classList.remove('hidden') : couponList.classList.add('hidden'); }
        if (fab) fab.classList.remove('translate-y-32');
    };

    
    window.openCart = () => { updateCartUI(); toggleSheet('checkoutModal', true); };

       // --- 8. ORDER PLACEMENT (FIXED - NO DUPLICATES) ---
        window.placeOrder = async (btn) => { 
        // 1. Check Store Status
        if(!isStoreOpen) {
            showToast("Ø§Ù„Ù…ØªØ¬Ø± Ù…ØºÙ„Ù‚. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø·Ù„Ø¨.", true);
            return;
        }
        // 2. Check Auth
        if(!currentUser) return window.requireAuth(); 
        
        const payMethod = "Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…"; 

        // 3. Start Loading (With Failsafe protection)
        setBtnLoading(btn, true, 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©');
        
        setTimeout(async () => { 
            const subtotal = cart.reduce((s,i) => s + (i.unitPrice * i.qty), 0); 
            const total = Math.max(0, subtotal - activeDiscount); 
            
            try { 
                // A. Calculate Points Logic (Logic Only - Don't add yet)
                const pointsSpent = cart.reduce((sum, item) => item.isLoyalty ? sum + (item.pointsUsed || 0) : sum, 0);

                let earnedPoints = 0;
                if(loyaltyRules.type === 'percentage') {
                    earnedPoints = Math.floor(total * (loyaltyRules.value / 100));
                } else {
                    earnedPoints = parseInt(loyaltyRules.value);
                }

                // B. INSERT ORDER (CRITICAL FIX ğŸ›‘)
                // We capture the error here
                const { error: orderError } = await sb.from('orders').insert({ 
                    user_id: currentUser.id, 
                    user_ip: userIP, 
                    items: cart, 
                    subtotal: subtotal, 
                    discount: activeDiscount, 
                    promo_code: activePromoCode, 
                    total: total, 
                    status: 'New Order', 
                    payment_method: payMethod, 
                    note: document.getElementById('order-note')?.value || "", 
                    device_id: deviceId, 
                    lang: 'ar' 
                }); 
                
                // ğŸ›‘ THE GUARD DOG: If internet is off, STOP EVERYTHING!
                if (orderError) throw orderError;

                // C. UPDATE USER POINTS (DEDUCT ONLY)
                let pointsMsg = "";
                if(pointsSpent > 0) {
                    const currentBalance = userData.points || 0;
                    
                    // Deduct ONLY. Do NOT add earnedPoints here.
                    let newTotalPoints = currentBalance - pointsSpent; 
                    if(newTotalPoints < 0) newTotalPoints = 0; 

                    const { error: updateError } = await sb.rpc('update_user_points', { 
                        target_user_id: currentUser.id, 
                        new_points: newTotalPoints 
                    });
                    
                    if (!updateError) {
                        // Update Local Data immediately
                        if(userData) userData.points = newTotalPoints;
                        if(document.getElementById('loyalty-points')) document.getElementById('loyalty-points').innerText = newTotalPoints;
                        if(document.getElementById('loyalty-display-points')) document.getElementById('loyalty-display-points').innerText = newTotalPoints;
                        
                        pointsMsg = ` (Ø®ØµÙ… ${pointsSpent} Ù†Ù‚Ø·Ø©)`;
                    }
                }

                // D. SUCCESS STATE
                removePromo(); 
                cart = []; 
                updateCartUI(); 
                
                // Green Success Button
                btn.classList.add('bg-green-force'); 
                btn.innerHTML = `<i class="fa-solid fa-check ml-2"></i> ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!`; 
                showToast(`Ø³ÙŠØªÙ… Ø§Ø¶Ø§ÙØ© ${earnedPoints} Ù†Ù‚Ø·Ø© Ø¹Ù†Ø¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø·Ù„Ø¨`);
                
                // Redirect after 1 second
                setTimeout(async () => { 
                    closeCart(); 
                    if (typeof renderTrackerList === 'function') { await renderTrackerList(currentUser.id); } 
                    switchView('track'); 
                    
                    // Reset Button Style
                    btn.classList.remove('bg-green-force'); 
                    btn.innerHTML = `Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ <i class="fa-solid fa-arrow-left"></i>`; 
                    btn.disabled = false;
                    btn.classList.remove('opacity-80', 'cursor-not-allowed'); // Remove Failsafe styles
                }, 1000); 

            } catch(e) { 
                console.log("Order Error", e); 
                
                // ğŸ›‘ FAILSAFE RESET: Unlock Button Immediately
                btn.innerHTML = `Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ <i class="fa-solid fa-arrow-left"></i>`;
                btn.disabled = false; 
                btn.classList.remove('opacity-80', 'cursor-not-allowed');

                // Kill the timer so it doesn't double-reset later
                if(btn.dataset.timer) {
                    clearTimeout(parseInt(btn.dataset.timer));
                    btn.dataset.timer = "";
                }

                showToast("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ - ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„", true); 
            } 
        }, 1500); 
    };



    async function loadUserProfile(uid) { 
    // 1. Fetch User Data
    let { data, error } = await sb.from('users').select('*').eq('id', uid).single(); 
    
    // Auto-Fix if profile missing
    if(error || !data) { 
        const meta = currentUser.user_metadata || {};
        data = { 
            id: uid, name: meta.name || 'Ù…Ø³ØªØ®Ø¯Ù…', email: currentUser.email, phone: meta.phone || '', 
            points: 0, joined: new Date().toLocaleDateString(), 
            avatar: `https://ui-avatars.com/api/?name=${meta.name||'User'}&background=FF5722&color=fff` 
        };
        await sb.from('users').insert(data);
    } 
    
    userData = data; 
    
    // 2. Update Text Elements
    document.getElementById('profile-name').innerText = userData.name || "Ù…Ø³ØªØ®Ø¯Ù…"; 
    document.getElementById('profile-email').innerText = userData.email || "---"; 
    const phoneInput = document.getElementById('profile-phone-input');
    phoneInput.value = userData.phone || ""; phoneInput.readOnly = true;
    document.getElementById('loyalty-points').innerText = userData.points || 0; 
    document.getElementById('profile-joined').innerText = userData.joined || new Date(currentUser.created_at).toLocaleDateString(); 
    document.getElementById('profile-avatar').src = userData.avatar || `https://ui-avatars.com/api/?name=${userData.name}&background=FF5722&color=fff`; 
    
    // 3. Load & Render Orders (THE NEW SLIDE LOGIC)
    const { data: orders, count } = await sb.from('orders').select('*', { count: 'exact' }).eq('user_id', uid).order('created_at', {ascending: false}); 
    userOrderCount = count || 0; 
    document.getElementById('profile-total-orders').innerText = count || 0; 
    
    if(orders && orders.length) { 
        document.getElementById('order-history').innerHTML = orders.map(o => {
            // Translate Status
            let statusAr = o.status;
            if(statusAr === 'New Order') statusAr = 'Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯';
            else if(statusAr === 'Preparing') statusAr = 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±';
            else if(statusAr === 'Cooking') statusAr = 'ÙŠØªÙ… Ø§Ù„Ø·Ø¨Ø®';
            else if(statusAr === 'Ready') statusAr = 'Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù…';
            else if(statusAr === 'Completed') statusAr = 'Ù…ÙƒØªÙ…Ù„';
            else if(statusAr === 'Cancelled') statusAr = 'Ù…Ù„ØºÙŠ';
            
            // --- ğŸ”¥ NEW STATUS COLOR LOGIC ---
            const isCanceled = o.status.toLowerCase().includes('cancel');
            let statusColor = 'text-orange-500'; // Default
            if (o.status === 'Completed') statusColor = 'text-green-500';
            if (isCanceled) statusColor = 'text-red-500';

            // Generate Items List HTML
            const itemsHtml = o.items.map(i => {
                const isGift = i.isLoyalty === true;
                const priceDisplay = isGift ? '<span class="text-purple-500 font-bold">Ù‡Ø¯ÙŠØ©</span>' : `SR ${(i.qty * i.unitPrice).toFixed(2)}`;
                const mods = (i.selectedMods && i.selectedMods.length) 
                    ? `<div class="text-[10px] text-slate-400 mr-4">â€¢ ${i.selectedMods.map(m=> t(m.name)).join(', ')}</div>` 
                    : '';

                return `
                <div class="border-b border-slate-50 last:border-0 pb-2 mb-2 last:mb-0 last:pb-0">
                    <div class="flex justify-between text-xs text-slate-600 font-bold">
                        <span>${i.qty}x ${t(i.name)} ${isGift ? 'ğŸ' : ''}</span>
                        <span dir="ltr">${priceDisplay}</span>
                    </div>
                    ${mods}
                </div>`;
            }).join('');

            const dailyId = shiftBaseId > 0 ? (o.id - shiftBaseId + 1) : o.id;

            // RENDER THE SLIDING CARD
            return `
            <div onclick="toggleHistoryItem(this)" class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group cursor-pointer active:scale-[0.99] transition-all">
                
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <span class="bg-slate-100 text-slate-600 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wider">#${dailyId}</span>
                        <span class="text-[10px] text-slate-400 font-bold mr-2">${new Date(o.created_at).toLocaleDateString()}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-black text-slate-800" dir="ltr">SR ${o.total.toFixed(2)}</span>
                        <i class="fa-solid fa-chevron-down text-slate-300 text-xs transition-transform duration-300 chevron-icon"></i>
                    </div>
                </div>

                <div class="grid grid-rows-[0fr] transition-[grid-template-rows] duration-300 ease-out details-wrapper">
                    <div class="overflow-hidden">
                        <div class="pt-3 mt-2 border-t border-slate-100">
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø·Ù„Ø¨</p>
                            ${itemsHtml}
                            ${o.note ? `<div class="mt-2 bg-orange-50 text-orange-600 text-xs p-2 rounded-lg"><i class="fa-solid fa-note-sticky ml-1"></i> ${o.note}</div>` : ''}
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center pt-3 mt-1 border-t border-slate-50 relative z-10">
                    <span class="text-xs font-bold ${o.status==='Completed'?'text-green-500':'text-orange-500'}">${statusAr}</span>
                    
                    <button onclick="event.stopPropagation(); triggerReorder(${o.id})" class="bg-orange-50 text-orange-600 text-xs font-bold px-4 py-2 rounded-lg hover:bg-orange-100 transition">
                        <i class="fa-solid fa-rotate-right ml-1"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨
                    </button>
                </div>
            </div>`;
        }).join(''); 
    } else { 
        document.getElementById('order-history').innerHTML = `<div class="text-center py-8 text-slate-400 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø©.</div>`; 
    } 
}



    async function togglePhoneEdit(btn) { 
        const input = document.getElementById('profile-phone-input'); 
        const container = document.getElementById('phone-container'); 
        if (input.hasAttribute('readonly')) { 
            input.removeAttribute('readonly'); input.focus(); btn.innerText = "Ø­ÙØ¸"; btn.classList.add('bg-green-force'); container.classList.add('ring-2', 'ring-orange-100', 'bg-white'); 
        } else { 
            setBtnLoading(btn, true, 'Ø­ÙØ¸'); 
            try { 
                await sb.auth.updateUser({ data: { phone: input.value } }); await sb.from('users').update({ phone: input.value }).eq('id', currentUser.id); showToast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ù‚Ù…!"); input.setAttribute('readonly', true); btn.innerHTML = "ØªØ­Ø¯ÙŠØ«"; btn.classList.remove('bg-green-force'); container.classList.remove('ring-2', 'ring-orange-100', 'bg-white'); 
            } catch(e) { showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«"); } 
            btn.disabled = false; 
        } 
    }

    window.removeAvatar = async () => { if(!currentUser) return; await sb.from('users').update({ avatar: null }).eq('id', currentUser.id); loadUserProfile(currentUser.id); showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©"); }
    
    // IMAGE CROPPER
    let cropper = null; 
    window.startCrop = (input) => { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = (e) => { const img = document.getElementById('crop-target'); img.src = e.target.result; document.getElementById('crop-modal').classList.add('active'); if(cropper) cropper.destroy(); cropper = new Cropper(img, { aspectRatio: 1, viewMode: 1 }); input.value = ''; }; reader.readAsDataURL(input.files[0]); } }; 
    window.closeCropper = () => { document.getElementById('crop-modal').classList.remove('active'); if(cropper) { cropper.destroy(); cropper = null; } }; 
    window.finishCrop = () => { 
        if(!cropper) return; 
        const btn = document.querySelector('#crop-modal button'); setBtnLoading(btn, true, 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸');
        cropper.getCroppedCanvas({ maxWidth: 300, maxHeight: 300, fillColor: 'transparent' }).toBlob(async (blob) => { 
            const fileName = `${currentUser.id}-${Date.now()}.png`; 
            const { error: uploadErr } = await sb.storage.from('images').upload(fileName, blob); 
            if(uploadErr) { showToast("ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©", true); setBtnLoading(btn, false, 'Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©'); return; }
            const { data } = sb.storage.from('images').getPublicUrl(fileName); 
            await sb.from('users').update({ avatar: data.publicUrl }).eq('id', currentUser.id);
            
            const profilePic = document.getElementById('profile-avatar');
            if(profilePic) profilePic.src = data.publicUrl;

            showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø©!"); 
            setBtnLoading(btn, false, 'Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©'); closeCropper(); 
        }, 'image/png'); 
    };

    // --- UPDATED REORDER LOGIC (Fixes Window Overlap) ---
window.triggerReorder = async (oid) => {
    // 1. Security Check
    if(!isStoreOpen) { showToast("Ø§Ù„Ù…ØªØ¬Ø± Ù…ØºÙ„Ù‚ Ø­Ø§Ù„ÙŠØ§Ù‹", true); return; }
    
    // 2. Fetch Order Data
    const { data } = await sb.from('orders').select('*').eq('id', oid).single();
    
    if(data && data.items) {
        // 3. CLOSE HISTORY WINDOW FIRST (The Missing Part)
        closeHistory(); 

        // 4. Process Items (Security: Remove "Gift" status)
        cart = data.items.map(item => {
            if (item.isLoyalty === true) {
                // Revert gift to normal paid item
                return { 
                    ...item, 
                    isLoyalty: false, 
                    price: item.originalPrice, 
                    unitPrice: item.originalPrice, 
                    pointsUsed: 0, 
                    id: item.id.split('-gift-')[0] 
                };
            }
            return item;
        });

        // 5. Open Cart (Small delay allows History to slide down first)
        updateCartUI();
        setTimeout(() => {
            openCart();
        }, 300); 
    }
}


    // --- 10. REALTIME TRACKER ---
    let orderSubscription = null;
    function listenToOrders(uid) {
        if (orderSubscription) sb.removeChannel(orderSubscription);
        const channelName = `orders-tracker-${uid}-${Date.now()}`;
        orderSubscription = sb.channel(channelName)
            .on('postgres_changes', { event: '*', schema: 'public', table: 'orders', filter: `user_id=eq.${uid}` }, (payload) => {
                renderTrackerList(uid); 
                if(payload.new && payload.new.status === 'Completed') { loadUserProfile(uid); }
            }).subscribe();
        renderTrackerList(uid); 
    }
    
    async function fetchQueueCount() { const { count } = await sb.from('orders').select('*', { count: 'exact', head: true }).or('status.eq.Preparing,status.eq.Cooking'); return count || 0; }
    
    window.dismissOrder = (orderId) => {
    // 1. Get existing dismissed list
    const dismissed = JSON.parse(localStorage.getItem('tari_dismissed_orders') || '[]');
    
    // 2. Add this order ID
    if (!dismissed.includes(orderId)) {
        dismissed.push(orderId);
        localStorage.setItem('tari_dismissed_orders', JSON.stringify(dismissed));
    }
    
    // 3. Remove the card from the UI immediately (Visual Animation)
    const card = document.getElementById(`track-card-${orderId}`);
    if (card) {
        card.style.transition = 'all 0.5s ease';
        card.style.transform = 'translateX(-100%)'; // Slide out
        card.style.opacity = '0';
        
        setTimeout(() => {
            // Re-render to check if list is empty
            if (currentUser) renderTrackerList(currentUser.id);
        }, 500);
    }
};

    
    async function renderTrackerList(uid) { 
    // 1. Fetch Active AND Canceled (Everything except Completed)
    const {data} = await sb.from('orders')
        .select('*')
        .eq('user_id', uid)
        .neq('status', 'Completed')
        .order('created_at', {ascending: false}); 

    const container = document.getElementById('active-tracker-container'); 
    const queue = await fetchQueueCount(); 

    if(!data || !data.length) { 
        if(document.getElementById('track-badge')) document.getElementById('track-badge').classList.add('hidden'); 
        container.innerHTML='<div class="text-center py-20 text-slate-400"><i class="fa-solid fa-receipt text-4xl mb-4"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù†Ø´Ø·Ø©.</p></div>'; 
        return; 
    } 

    // 2. Filter Logic (Same as English)
    const dismissedIds = JSON.parse(localStorage.getItem('tari_dismissed_orders') || '[]');
    
    const visibleOrders = data.filter(order => {
        // Robust check for cancel
        const isCanceled = order.status && order.status.toLowerCase().includes('cancel');

        // Always show normal active orders
        if (!isCanceled) return true;

        // For Canceled:
        // A. Check dismissal
        if (dismissedIds.includes(order.id)) return false;

        // B. Check 30 min timer
        const lastUpdate = new Date(order.updated_at || order.created_at).getTime();
        const diffMins = (Date.now() - lastUpdate) / 60000;
        
        return diffMins < 30;
    });

    if (visibleOrders.length === 0) {
        if (document.getElementById('track-badge')) document.getElementById('track-badge').classList.add('hidden'); 
        container.innerHTML='<div class="text-center py-20 text-slate-400"><i class="fa-solid fa-receipt text-4xl mb-4"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù†Ø´Ø·Ø©.</p></div>'; 
        return; 
    }

    if(document.getElementById('track-badge')) document.getElementById('track-badge').classList.remove('hidden'); 
    container.innerHTML = visibleOrders.map(order => createTrackerCard(order, queue)).join(''); 
    startTicker(); 
}

    
    function startTicker() { 
        if(window.trackerInterval) clearInterval(window.trackerInterval); 
        window.trackerInterval = setInterval(() => { 
            document.querySelectorAll('.dynamic-timer').forEach(el => { 
                const status = el.dataset.status; 
                if(status === 'New Order') { el.innerText = "--:--"; return; } 
                if(status === 'Ready') { el.innerText = "Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù…"; return; } 
                const target = parseInt(el.dataset.target); const now = Date.now(); const diff = target - now; 
                if(diff <= 0) { el.innerText = "Ø§Ù„Ù„Ù…Ø³Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©..."; el.classList.add('text-green-600'); } 
                else { const m = Math.floor(diff / 60000); const s = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0'); el.innerText = `${m}:${s}`; el.classList.remove('text-green-600'); } 
            }); 
        }, 1000); 
    }        
    
            function createTrackerCard(order, queueCount) { 
    // Calculate Daily Number
    const dailyNum = shiftBaseId > 0 ? (order.id - shiftBaseId + 1) : 1;

    // --- 1. TRANSLATION DICTIONARY (Added Here) ---
    const cancelMap = {
        "Item is sold out": "Ù†Ø¹ØªØ°Ø± Ù…Ù†ÙƒØŒ Ù„Ù„Ø£Ø³Ù Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ù Ù†ÙØ¯ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.",
        "Store is closed": "Ù†Ø¹ØªØ°Ø± Ù…Ù†ÙƒØŒ Ø§Ù„Ù…ØªØ¬Ø± Ù…ØºÙ„Ù‚ Ø­Ø§Ù„ÙŠØ§Ù‹.",
        "Kitchen Maintenance": "Ù†Ø¹ØªØ°Ø± Ù…Ù†ÙƒØŒ ØªÙˆÙ‚Ù Ù…Ø¤Ù‚Øª Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø©.",
        "Cancelled by Store": "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…ØªØ¬Ø±."
    };

    // --- ğŸ›‘ CANCELED CARD UI (Arabic) ---
    if (order.status && order.status.toLowerCase().includes('cancel')) {
        // LOGIC: Check Dictionary first -> If not found, use custom text -> Default fallback
        const reason = cancelMap[order.cancel_reason] || order.cancel_reason || "Ù†Ø¹ØªØ°Ø± Ù…Ù†ÙƒØŒ Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø¥ÙƒÙ…Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨.";
        
        return `
        <div id="track-card-${order.id}" class="bg-white rounded-3xl p-6 shadow-xl border-2 border-red-100 animate-[slideUp_0.4s] mb-4 relative overflow-hidden">
            
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h3 class="text-xl font-black text-slate-800">Ø§Ù„Ø·Ù„Ø¨ #${dailyNum}</h3>
                    <p class="text-xs text-red-500 font-bold mt-1 uppercase tracking-wider">ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨</p>
                </div>
                <div class="w-12 h-12 bg-red-50 text-red-500 rounded-2xl flex items-center justify-center text-xl animate-pulse">
                    <i class="fa-solid fa-ban"></i>
                </div>
            </div>

            <div class="bg-red-50 rounded-2xl p-5 mb-6 pr-5 border border-red-100 relative">
                <div class="absolute -top-3 right-4 bg-white px-2 text-[10px] font-bold text-red-400 uppercase tracking-widest border border-red-100 rounded-md">
                    Ø§Ù„Ø³Ø¨Ø¨
                </div>
                <p class="text-sm font-bold text-slate-800 leading-relaxed text-right">
                    "${reason}"
                </p>
            </div>

            <button onclick="dismissOrder(${order.id})" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition flex items-center justify-center gap-2">
                Ø­Ø³Ù†Ø§Ù‹ØŒ ÙÙ‡Ù…Øª <i class="fa-solid fa-check"></i>
            </button>
        </div>`;
    }


        // 1. Status Translation
        let statusAr = "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
        if(order.status === 'New Order') statusAr = "Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯";
        else if(order.status === 'Preparing') statusAr = "ÙŠØªÙ… Ø§Ù„ØªØ¬Ù‡ÙŠØ²";
        else if(order.status === 'Cooking') statusAr = "ÙŠØªÙ… Ø§Ù„Ø·Ø¨Ø®";
        else if(order.status === 'Ready') statusAr = "Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù…";
        else if(order.status === 'Completed') statusAr = "Ù…ÙƒØªÙ…Ù„";
        else statusAr = order.status;

        // 2. Payment Method Translation
        let payMethod = order.payment_method || 'Ù†Ù‚Ø¯';
        if(payMethod.toLowerCase().includes('pickup') || payMethod.includes('cr')) {
            payMethod = "Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…";
        }

        let step = 1; 
        let txt = "Ø§Ø³ØªÙ„Ù…Ù†Ø§ Ø·Ù„Ø¨ÙƒØŒ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø´ÙŠÙ!";    
        const estimatedMins = order.estimated_mins || (10 + (queueCount * 3)); 
        const createdAt = new Date(order.created_at).getTime(); 
        const targetTime = createdAt + (estimatedMins * 60000); 
        
        if(order.status === 'Preparing' || order.status === 'Cooking') { step = 2; txt = "Ø·Ø¹Ø§Ù…Ùƒ ÙŠÙØ·Ù‡Ù‰ Ø§Ù„Ø¢Ù† Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø§Ø±!"; } 
        if(order.status === 'Ready') { step = 3; txt = "Ø·Ù„Ø¨Ùƒ Ø¬Ø§Ù‡Ø²! ØªÙØ¶Ù„ Ø¨Ø§Ø³ØªÙ„Ø§Ù…Ù‡."; } 
        
        // 3. Items List
        let itemsHtml = order.items.map(i => { 
            let mods = ''; 
            if (i.selectedMods && i.selectedMods.length > 0) { 
                mods = i.selectedMods.map(m => `<div class="text-xs text-slate-400 pr-4 py-0.5 flex items-center gap-1"><span class="w-1 h-1 rounded-full bg-slate-300"></span> ${t(m.name)}</div>`).join(''); 
            } 
            return `<div class="mb-3 border-b border-slate-50 last:border-0 pb-2 last:pb-0">
                <div class="font-bold text-slate-700 text-sm flex justify-between items-center">
                    <span>
                        <span class="text-xs text-slate-400 font-bold ml-1 bg-slate-100 px-1.5 py-0.5 rounded-md">x${i.qty}</span> 
                        ${t(i.name)} 
                    </span>
                </div>
                ${mods}
            </div>`; 
        }).join(''); 
        
        const promoBadge = order.promo_code ? `<span class="bg-purple-100 text-purple-600 px-1.5 py-0.5 rounded text-[10px] font-bold mr-1">ÙƒÙˆØ¯: ${order.promo_code}</span>` : ''; 
        const promoStrikethrough = order.promo_code ? `<span class="line-through text-slate-400 ml-2 text-[10px]">SR ${order.subtotal.toFixed(2)}</span>` : ''; 
        
        return `<div class="bg-white rounded-3xl p-6 shadow-xl border border-slate-100 animate-[slideUp_0.4s] mb-4">
            
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h3 class="text-xl font-bold leading-tight"> #${dailyNum}</h3>
                    <span class="dynamic-timer text-xs text-slate-400 font-bold block mt-1" data-target="${targetTime}" data-status="${order.status}">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨...</span>
                </div>
                <span class="bg-slate-900 text-white text-xs px-2 py-1 rounded font-bold mt-1">${statusAr}</span>
            </div>
            
            <div class="step-container flex justify-between items-center relative mb-6">
                <div class="step-line-container"><div class="step-line-fill" style="width: ${step === 1 ? '0%' : step === 2 ? '50%' : '100%'}"></div></div>
                <div class="step-circle ${step >= 1 ? 'active' : ''}">1</div>
                <div class="step-circle ${step >= 2 ? 'active' : ''}">2</div>
                <div class="step-circle ${step >= 3 ? 'active' : ''}">3</div>
            </div>
            
            <div class="bg-orange-50 text-orange-600 rounded-xl p-4 text-center mb-6 text-sm font-bold shadow-sm">
                <i class="fa-solid fa-bell ml-2 animate-bounce"></i> ${txt}
            </div>
            
            <div class="bg-slate-50 p-4 rounded-xl font-medium text-right">
                ${itemsHtml}
            </div>
            
            <div class="mt-3 pt-3 border-t border-slate-200 flex flex-col gap-2">
                <div class="flex justify-between items-center">
                    <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                    <div class="flex items-baseline" dir="ltr">
                        ${promoStrikethrough}
                        <span class="text-xs font-bold text-slate-800 mr-1">SR</span>
                        <span class="text-2xl font-black text-slate-900">${order.total.toFixed(2)}</span>
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</span>
                    <div class="flex items-center">
                        <span class="bg-orange-100 text-orange-600 px-2 py-0.5 rounded text-[10px] font-bold uppercase"><i class="fa-solid fa-credit-card ml-1"></i> ${payMethod}</span>
                        ${promoBadge}
                    </div>
                </div>
            </div>
        </div>`; 
    }



    // --- 11. GESTURES ---
    const setupSwipe = (cardId, closeFn) => {
        const card = document.getElementById(cardId);
        const content = card.querySelector('.overflow-y-auto'); 
        let startY = 0, currentY = 0, isDragging = false;
        const threshold = window.innerHeight * 0.4; 

        card.addEventListener('touchstart', e => {
            if (lockProductSwipe || e.target.closest('input, textarea, button, .no-drag')) return;
            if(content && content.scrollTop > 0) return;
            startY = e.touches[0].clientY; currentY = startY; isDragging = true;
        }, {passive: true});

        card.addEventListener('touchmove', e => {
            if(!isDragging) return;
            currentY = e.touches[0].clientY; const diff = currentY - startY;
            if (diff > 0) { e.preventDefault(); card.style.transition = 'none'; card.style.transform = `translateY(${diff}px)`; } 
            else { isDragging = false; }
        }, {passive: false});

        card.addEventListener('touchend', e => {
            if(!isDragging) return; isDragging = false; 
            card.style.transition = 'transform 0.6s cubic-bezier(0.32, 0.72, 0, 1)'; 
            if(currentY - startY > threshold) { closeFn(); } 
            else { card.style.transform = 'translateY(0)'; setTimeout(() => { card.style.transition = ''; }, 600); }
        });
    };
    
    // OTP VISUAL LOGIC
    document.getElementById('otp-input').addEventListener('input', function(e) {
        const val = e.target.value.replace(/\D/g, ''); e.target.value = val;
        for(let i=0; i<4; i++) {
            const box = document.getElementById(`otp-box-${i}`);
            if (val[i]) { box.innerText = val[i]; box.classList.add('border-orange-500', 'bg-white'); box.classList.remove('border-slate-200', 'bg-slate-50'); } 
            else { box.innerText = ''; box.classList.remove('border-orange-500', 'bg-white'); box.classList.add('border-slate-200', 'bg-slate-50'); }
        }
    });

    function startResendTimer() {
        const btn = document.getElementById('btn-resend-otp');
        const label = document.getElementById('resend-timer');
        let timeLeft = 60; 

        btn.disabled = true;
        btn.classList.add('text-slate-400');
        btn.classList.remove('text-orange-500', 'border-orange-200');
        if (resendInterval) clearInterval(resendInterval);

        resendInterval = setInterval(() => {
            timeLeft--;
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            label.innerText = `0${minutes}:${seconds < 10 ? '0'+seconds : seconds}`;
            if (timeLeft <= 0) {
                clearInterval(resendInterval);
                btn.disabled = false; label.innerText = "Ø§Ù„Ø¢Ù†";
                btn.classList.remove('text-slate-400'); btn.classList.add('text-orange-500', 'border-orange-200');
            }
        }, 1000);
    }    

    window.resendOtp = async () => {
        if (!pendingUserData) return;
        const btn = document.getElementById('btn-resend-otp');
        setBtnLoading(btn, true, 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...');
        const newCode = Math.floor(1000 + Math.random() * 9000).toString();
        const { error } = await sb.rpc('send_whatsapp_otp', { phone: pendingUserData.phone, otp: newCode });

        if (error) { showToast("ÙØ´Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„", true); setBtnLoading(btn, false, "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„"); return; }

        pendingOtpCode = newCode;
        otpExpiryTime = Date.now() + (5 * 60 * 1000);
        showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯!");
        setBtnLoading(btn, false, "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„"); startResendTimer(); 
    };
    
    /* =========================================
   AI CONCIERGE LOGIC (CHEF TARI)
   ========================================= */

function toggleAi(show) {
    // 1. Check Gender First (If opening)
    if (show && !userGender) {
        document.getElementById('gender-modal').classList.remove('hidden');
        return;
    }

    const ui = document.getElementById('ai-interface');
    const backdrop = document.getElementById('ai-backdrop');
    const trigger = document.getElementById('ai-trigger');
    
    if(show) {
        ui.classList.remove('ai-ghost-hidden');
        void ui.offsetWidth; // Force Reflow
        ui.classList.add('ai-ghost-visible');
        
        backdrop.classList.remove('opacity-0');
        trigger.classList.add('scale-0', 'opacity-0');
    } else {
        ui.classList.remove('ai-ghost-visible');
        ui.classList.add('ai-ghost-hidden');
        
        backdrop.classList.add('opacity-0');
        trigger.classList.remove('scale-0', 'opacity-0');
    }
}

function selectGender(g) {
    userGender = g;
    localStorage.setItem('tari_user_gender', g);
    document.getElementById('gender-modal').classList.add('hidden');
    toggleAi(true); // Re-open chat now that gender is set
}

function handleAiSubmit(e) {
    e.preventDefault();
    const input = document.getElementById('ai-input');
    const txt = input.value.trim();
    if(!txt) return;
    askAi(txt);
    input.value = '';
}

function askAi(text) {
    // 1. User Bubble (Right Side for Arabic)
    const stream = document.getElementById('ai-stream');
    stream.insertAdjacentHTML('beforeend', `
    <div class="flex animate-fade-up mb-4">
        <div class="bg-orange-500 text-white px-4 py-3 rounded-2xl rounded-tr-none text-sm font-medium shadow-lg shadow-orange-500/20 max-w-[85%] text-right">
            ${text}
        </div>
    </div>
`);
    scrollToBottom();

    // 2. Loading Bubbles
    const typeId = 'typing-' + Date.now();
    stream.insertAdjacentHTML('beforeend', `
        <div id="${typeId}" class="flex gap-4 animate-fade-up mb-4">
            <div class="w-8 h-8 rounded-full bg-slate-800 border border-white/10 flex items-center justify-center text-xs shrink-0">ğŸ¤–</div>
            <div class="bg-white/5 border border-white/10 px-4 py-3 rounded-2xl rounded-tl-none flex items-center gap-1.5 h-[46px]">
                <div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce"></div>
                <div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                <div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            </div>
        </div>
    `);
    scrollToBottom();

    // 3. Process Response
    setTimeout(async () => {
        const response = await getSmartResponse(text);

        // Remove loading
        const loadingBubble = document.getElementById(typeId);
        if(loadingBubble) loadingBubble.remove();
        
        const msgId = 'msg-' + Date.now();
        const contentId = 'content-' + Date.now();

        // 4. AI Bubble Container
        stream.insertAdjacentHTML('beforeend', `
    <div id="${msgId}" class="flex flex-row-reverse gap-4 animate-fade-up group mb-4">
        <div class="w-8 h-8 rounded-full bg-slate-800 border border-white/10 flex items-center justify-center text-xs shrink-0 group-hover:bg-orange-500 transition-colors duration-500">ğŸ¤–</div>
        <div class="flex flex-col gap-2 max-w-[85%]">
            <div id="${contentId}" class="text-right bg-white/5 border border-white/10 p-4 rounded-2xl rounded-tl-none text-slate-200 text-sm leading-relaxed shadow-sm backdrop-blur-md whitespace-pre-wrap typing-cursor min-h-[50px]"></div>
        </div>
    </div>
`);

        // 5. Typewriter Effect
        const contentDiv = document.getElementById(contentId);
        let i = 0;
        const txt = response.text;
        
        function typeWriter() {
            if (i < txt.length) {
                contentDiv.textContent += txt.charAt(i);
                i++;
                scrollToBottom();
                setTimeout(typeWriter, 15); // Speed
            } else {
                contentDiv.classList.remove('typing-cursor');
                if(response.card) {
                   const cardWrapper = document.createElement('div');
                   cardWrapper.className = "animate-fade-up";
                   cardWrapper.innerHTML = response.card;
                   document.querySelector(`#${msgId} .flex-col`).appendChild(cardWrapper);
                   scrollToBottom();
                }
            }
        }
        typeWriter();
        if(navigator.vibrate) navigator.vibrate(10); 

    }, 500); 
}

function scrollToBottom() {
    const stream = document.getElementById('ai-stream');
    stream.scrollTop = stream.scrollHeight;
}

async function getSmartResponse(input) {
    chatSession.push({ role: 'user', text: input });

    try {
        const userName = currentUser?.user_metadata?.name || userData?.name || "Guest";
        const isFirstTime = userOrderCount === 0;
        
        const contextData = {
            name: userName,
            gender: userGender || 'male',
            isNewUser: isFirstTime,
            lang: 'ar' // Tell AI we want Arabic
        };

        const FUNCTION_URL = "https://fpgspmhgwcmhaaxsphcd.supabase.co/functions/v1/Tari_Ai";
        
        const res = await fetch(FUNCTION_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_KEY}` },
            body: JSON.stringify({ history: chatSession, context: contextData }) 
        });

        const data = await res.json();
        if (!data.reply) throw new Error("Empty reply");

        let cleanText = data.reply;
        let cardHtml = '';

        chatSession.push({ role: 'model', text: cleanText });

        // Product Card Logic (Translated)
        const itemRegex = /\[ITEM: (.*?)\]/g;
        const matches = [...cleanText.matchAll(itemRegex)];
        cleanText = cleanText.replace(itemRegex, '').trim();
        const processedItems = new Set();

        for (const match of matches) {
            const itemName = match[1];
            // Looser matching for Arabic/English names
            const foundItem = allMenuItems.find(i => 
                (i.name && i.name.toLowerCase().includes(itemName.toLowerCase())) ||
                (langMap[i.name] && langMap[i.name].includes(itemName))
            );
            
            if (foundItem && !processedItems.has(foundItem.id)) {
                processedItems.add(foundItem.id);
                const itemJson = JSON.stringify(foundItem).replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                
                // TRANSLATED CARD HTML
                cardHtml += `
                <div class="bg-slate-800/50 border border-white/10 p-3 rounded-xl flex gap-3 mt-2 cursor-pointer hover:bg-slate-800 transition group" onclick='toggleAi(false); openCartItemFromMenu(${itemJson})'>
                    <div class="w-16 h-16 rounded-lg overflow-hidden shrink-0 relative bg-white">
                         <img src="${foundItem.image || 'https://via.placeholder.com/150'}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500">
                    </div>
                    <div class="flex flex-col justify-center text-right flex-1">
                        <h4 class="font-bold text-white text-sm leading-tight">${t(foundItem.name)}</h4>
                        <p class="text-orange-400 font-bold text-xs mt-1">SR ${foundItem.price}</p>
                        <span class="text-[10px] text-slate-400 mt-1 flex items-center justify-end gap-1"><i class="fa-solid fa-plus-circle"></i> Ø§Ø¶ØºØ· Ù„Ù„Ø¥Ø¶Ø§ÙØ©</span>
                    </div>
                </div>`;
            }
        }

        return { text: cleanText, card: cardHtml };

    } catch (e) {
        console.error("AI Error:", e);
        return { 
            text: "Ø§Ù„Ù…Ø¹Ø°Ø±Ø©ØŒ Ù„Ù… Ø£Ø³Ù…Ø¹Ùƒ Ø¬ÙŠØ¯Ø§Ù‹ Ø¨Ø³Ø¨Ø¨ Ø¶Ø¬ÙŠØ¬ Ø§Ù„Ù…Ø·Ø¨Ø®! Ù‡Ù„ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ", 
            card: null 
        };
    }
}

    
    // Failsafe: Forces the exciting loader to open if data takes too long
setTimeout(() => {
    const p = document.getElementById('preloader');
    if(p && !p.classList.contains('loaded')) {
        p.classList.add('loaded');
    }
}, 7000); // 7 Seconds max wait

// --- AUTO-SYNC LOGIC ---
async function forceAppSync() {
    // 1. Prevent spamming (Throttle)
    if(wakeThrottle) return;
    wakeThrottle = true;
    setTimeout(() => wakeThrottle = false, 5000); 

    // 2. Check Network First
    if (!navigator.onLine) {
        const isAr = document.documentElement.lang === 'ar';
        showToast(isAr ? "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª" : "No Internet Connection", true);
        return;
    }

    console.log("ğŸš€ PWA Wake-up: Aggressive Reconnect...");

    // 3. SHOW TOAST (Status Update)
    const t = document.getElementById('toast');
    if(t) {
        document.getElementById('toast-icon').className = "fa-solid fa-rotate fa-spin text-orange-500";
        document.getElementById('toast-msg').innerText = document.documentElement.lang === 'ar' ? "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§ØªØµØ§Ù„..." : "Refreshing connection...";
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    try {
        // 4. HARD RESET: Kill all previous connections immediately
        await sb.removeAllChannels(); 

        // 5. Re-Establish Store Status (Open/Close check)
        listenToStoreStatus();

        // 6. Re-Establish User Data (If logged in)
        if (currentUser) {
            await renderTrackerList(currentUser.id);
            listenToOrders(currentUser.id);
        }
        
    } catch (err) {
        console.log("Sync warning:", err);
        
        // NEW: If the error looks like a dead connection, RESTART AUTH
        if (JSON.stringify(err).includes("JWT") || JSON.stringify(err).includes("fetch")) {
            console.log("â™»ï¸ Connection dead, re-initializing...");
            initAuth();
    }
}
}


// --- SMART PWA LOGIC (Android & iOS) ---
let deferredPrompt;

// 1. Detect if the device is iOS (iPhone/iPad)
const isIos = () => {
  const userAgent = window.navigator.userAgent.toLowerCase();
  return /iphone|ipad|ipod/.test(userAgent);
}

// 2. Detect if app is already installed (Standalone mode)
const isInStandaloneMode = () => ('standalone' in window.navigator) && (window.navigator.standalone);

if ('serviceWorker' in navigator) {
        window.addEventListener('load', async () => {
            try {
                // 1. UNREGISTER any existing workers first (Clean Slate)
                const registrations = await navigator.serviceWorker.getRegistrations();
                for(let registration of registrations) {
                    await registration.unregister();
                }

                // 2. REGISTER with timestamp to bypass browser cache
                // This forces the browser to treat it as a brand new file
                await navigator.serviceWorker.register('sw.js?v=' + Date.now());
                console.log('âœ… Service Worker Force-Updated');

                // 3. RELOAD if the controller changes (Un-breaks the app instantly)
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    window.location.reload();
                });

            } catch (err) {
                console.error('SW Registration Failed:', err);
            }
        });
}

// 4. Handle Android/Desktop (Automatic Install)
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    
    // Show the "Install App" button
    showInstallModal(false); 
});

// 5. Handle iOS (Manual Instructions)
// We check this on page load because iOS doesn't fire an event
window.addEventListener('load', () => {
    if (isIos() && !isInStandaloneMode()) {
        // Show the iOS-specific instructions
        showInstallModal(true);
    }
});

// --- UI FUNCTIONS ---

function showInstallModal(isIosDevice) {
    const modal = document.getElementById('install-modal');
    const title = modal.querySelector('h3');
    const desc = modal.querySelector('p');
    const actionBtn = document.getElementById('install-btn-action');
    
    // Wait a few seconds so it doesn't annoy the user immediately
    setTimeout(() => {
        modal.classList.remove('hidden');
        
        if (isIosDevice) {
            // iOS Instructions
            title.innerText = "ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø¢ÙŠÙÙˆÙ†"; // "Install on iPhone"
            desc.innerHTML = "Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:<br>1. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© <span class='text-xl'>â‹</span> Ø¨Ø§Ù„Ø£Ø³ÙÙ„<br>2. Ø§Ø®ØªØ± <b>'Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'</b>"; // Instructions
            actionBtn.innerText = "ÙÙ‡Ù…Øª"; // "Got it"
            actionBtn.onclick = closeInstallModal; // Just close, can't auto-install
        } else {
            // Android/Desktop Instructions (Default)
            // Text is already in HTML, just ensure button works
            actionBtn.onclick = installPWA;
        }
    }, 4000);
}

function installPWA() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
            deferredPrompt = null;
        });
    }
    closeInstallModal();
}

function closeInstallModal() {
    document.getElementById('install-modal').classList.add('hidden');
}

// âœ… NEW SECURE VERSION
async function initAuth() {
    console.log("ğŸ”’ Checking Auth...");
    const { data } = await sb.auth.getSession();
    
    if (data?.session?.user) {
        currentUser = data.session.user;
    } else {
        const customSession = localStorage.getItem('tari_wa_session');
        if (customSession) currentUser = JSON.parse(customSession);
    }
    
    if (currentUser) {
        // ğŸ›‘ STOP RIGHT HERE and check if blocked
        const isBlocked = await checkUserBlock();
        if (isBlocked) return; 

        loadUserProfile(currentUser.id);
        listenToOrders(currentUser.id);
    }
    
    // Prevent Logout on Refresh
            sb.auth.onAuthStateChange(async (event, session) => { 
            if (session) { 
                currentUser = session.user; 
                
                // ğŸ”¥ ADD THIS CHECK:
                const isBlocked = await checkUserBlock();
                if (isBlocked) return; // If blocked, stop!

                closeAuth(); 
                loadUserProfile(currentUser.id); 
                listenToOrders(currentUser.id); 
            }
                
        }); 
}



// Run immediately
initAuth(); 

// WhatsApp Login Logic
let loginPhone = "";
let loginOtp = "";

window.toggleSignin = (show) => {
    const m = document.getElementById('signin-modal');
    if (show) { m.classList.remove('hidden'); window.resetSignin(); } 
    else { m.classList.add('hidden'); }
};

window.resetSignin = () => {
    document.getElementById('si-stage-1').classList.remove('hidden');
    document.getElementById('si-stage-2').classList.add('hidden');
    document.getElementById('si-phone-input').value = "";
    document.getElementById('si-otp-input').value = "";
    for(let i=0; i<4; i++) {
        const box = document.getElementById(`si-box-${i}`);
        box.innerText = ''; box.className = "w-12 h-14 border-2 border-slate-200 rounded-xl flex items-center justify-center text-2xl font-black text-slate-800 bg-slate-50 transition-all";
    }
};

window.sendLoginCode = async (btn) => {
    const input = document.getElementById('si-phone-input');
    const raw = input.value.replace(/\D/g, '');
    if (raw.length !== 9) { showToast("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­ (9 Ø£Ø±Ù‚Ø§Ù…)", true); flashElement(input.parentElement); return; }
    
    setBtnLoading(btn, true, "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...");
    const fullPhone = "+966" + raw;
    const { data: users, error } = await sb.from('users').select('*').eq('phone', fullPhone).single();
    
    if (error || !users) { setBtnLoading(btn, false, "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²"); showToast("Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„. ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯!", true); return; }
    
    const code = Math.floor(1000 + Math.random() * 9000).toString();
    loginOtp = code; loginPhone = fullPhone;
    
    await sb.rpc('send_whatsapp_otp', { phone: fullPhone, otp: code });
    
    document.getElementById('si-display-phone').innerText = fullPhone;
    document.getElementById('si-stage-1').classList.add('hidden');
    document.getElementById('si-stage-2').classList.remove('hidden');
    setBtnLoading(btn, false, "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²");
};

window.verifyLoginCode = async (btn) => {
    const input = document.getElementById('si-otp-input');
    if (input.value !== loginOtp) { showToast("Ø§Ù„Ø±Ù…Ø² Ø®Ø§Ø·Ø¦!", true); flashElement(input); return; }
    
    setBtnLoading(btn, true, "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...");
    const { data: user } = await sb.from('users').select('*').eq('phone', loginPhone).single();
    
    if (user) {
        currentUser = { id: user.id, email: user.email, user_metadata: { name: user.name, phone: user.phone } };
        
        // ğŸ›‘ SECURITY CHECK
        const isBlocked = await checkUserBlock();
        if (isBlocked) {
            setBtnLoading(btn, false, "ØªØ­Ù‚Ù‚ ÙˆØ¯Ø®ÙˆÙ„");
            return; 
        }

        localStorage.setItem('tari_wa_session', JSON.stringify(currentUser));
        await loadUserProfile(user.id); listenToOrders(user.id);
        setBtnLoading(btn, false, "ØªØ­Ù‚Ù‚ ÙˆØ¯Ø®ÙˆÙ„");
        toggleSignin(false); closeAuth();
        showToast("Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ " + user.name.split(' ')[0]);
    }
};


// --- 2. LOYALTY SYSTEM (REWARDS) ---
const POINTS_PER_SR = 10; 
let pendingRedeemItem = null;
let currentLoyaltyMenu = [];

window.openLoyaltyView = () => { if(!currentUser) return window.requireAuth(); switchView('loyalty'); renderLoyaltyMenu(); }

window.renderLoyaltyMenu = () => {
    const container = document.getElementById('loyalty-list');
    const displayPoints = document.getElementById('loyalty-display-points');
    
    let usedPointsInCart = cart.reduce((sum, item) => item.isLoyalty ? sum + (item.pointsUsed || 0) : sum, 0);
    let currentBalance = (userData.points || 0) - usedPointsInCart;
    if(currentBalance < 0) currentBalance = 0;
    
    displayPoints.innerText = currentBalance;
    
    currentLoyaltyMenu = allMenuItems.filter(i => {
        const cat = (i.category || "").toLowerCase();
        return !cat.includes('drink') && !cat.includes('sauce');
    });

    if (currentLoyaltyMenu.length === 0) { container.innerHTML = `<div class="text-center py-10 text-slate-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙƒØ§ÙØ¢Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</div>`; return; }

    container.innerHTML = currentLoyaltyMenu.map((item, index) => {
        const cost = item.loyalty_points || Math.ceil(item.price * POINTS_PER_SR);
        const progress = Math.min(100, (currentBalance / cost) * 100);
        const isLocked = currentBalance < cost;
        const remaining = cost - currentBalance;
        
        const btnHtml = isLocked 
            ? `<div class="text-xs font-bold text-slate-400 mt-3 flex items-center gap-1"><i class="fa-solid fa-lock"></i> Ø¨Ø§Ù‚ÙŠ ${remaining} Ù†Ù‚Ø·Ø©</div>`
            : `<button onclick='initiateRedeem(${index})' class="w-full mt-3 bg-slate-900 text-white py-3 rounded-xl font-bold text-sm shadow-lg active:scale-95 transition flex items-center justify-center gap-2">Ø§Ø³ØªØ¨Ø¯Ù„ Ø¨Ù€ ${cost} Ù†Ù‚Ø·Ø© <i class="fa-solid fa-gift"></i></button>`;

        return `<div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 relative overflow-hidden ${isLocked ? 'loyalty-card locked' : ''}">
            <div class="flex gap-4">
                <div class="w-20 h-20 bg-slate-100 rounded-2xl overflow-hidden shrink-0"><img src="${item.image || 'https://via.placeholder.com/150'}" class="w-full h-full object-cover"></div>
                <div class="flex-1">
                    <h4 class="font-bold text-slate-800">${t(item.name)}</h4>
                    <p class="text-xs text-slate-400 mb-2">${cost} Ù†Ù‚Ø·Ø©</p>
                    <div class="loyalty-progress-bg"><div class="loyalty-progress-fill" style="width: ${progress}%"></div></div>
                </div>
            </div>
            ${btnHtml}
        </div>`;
    }).join('');
};

window.initiateRedeem = (index) => {
    pendingRedeemItem = currentLoyaltyMenu[index];
    document.getElementById('loyalty-confirm-modal').classList.remove('hidden');
}

window.closeLoyaltyConfirm = () => { document.getElementById('loyalty-confirm-modal').classList.add('hidden'); pendingRedeemItem = null; }

document.getElementById('btn-confirm-redeem').addEventListener('click', () => {
    if(!pendingRedeemItem) return;

    // 1. Capture the name BEFORE closing the modal (while data still exists)
    const itemName = t(pendingRedeemItem.name);

    const giftItem = {
        ...pendingRedeemItem, 
        id: pendingRedeemItem.id + '-gift-' + Date.now(), 
        price: 0, 
        unitPrice: 0, 
        originalPrice: pendingRedeemItem.price, 
        isLoyalty: true, 
        pointsUsed: pendingRedeemItem.loyalty_points || Math.ceil(pendingRedeemItem.price * 10), 
        qty: 1, 
        selectedMods: []
    };

    cart.push(giftItem);
    
    // 2. NOW close the modal (This wipes pendingRedeemItem to null)
    closeLoyaltyConfirm(); 

    // 3. Use the saved 'itemName' variable instead of the wiped global object
    showToast(`ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ${itemName}!`);
    
    updateCartUI(); 
    renderLoyaltyMenu();
});


// --- 3. UPDATED CART LOGIC (With Gift Support & Robot Move) ---
const originalUpdateCartUI = window.updateCartUI;
window.updateCartUI = function() {
    originalUpdateCartUI(); // Run original logic

    // Move Robot
    const fab = document.getElementById('fab-container');
    const aiBtn = document.getElementById('ai-trigger');
    if (fab && aiBtn) {
        if (!fab.classList.contains('translate-y-32')) aiBtn.classList.add('-translate-y-24');
        else aiBtn.classList.remove('-translate-y-24');
    }

    // Update Gift Badges
    const container = document.getElementById('cart-items');
    if(container) {
        cart.forEach((item, index) => {
            if(item.isLoyalty) {
                const row = container.children[index];
                if(row) {
                    const priceEl = row.querySelector('[dir="ltr"]'); 
                    if(priceEl) priceEl.innerHTML = `<div class="badge-gift"><i class="fa-solid fa-gift"></i> Ù‡Ø¯ÙŠØ©</div>`;
                    const qtyDiv = row.querySelector('.bg-slate-50');
                    if(qtyDiv) qtyDiv.classList.add('opacity-50', 'pointer-events-none');
                }
            }
        });
    }

    // --- ğŸ”„ SYNC PROFILE POINTS ---
    if (currentUser && userData) {
        // A. Calculate points currently "locked" in the cart
        const pointsInCart = cart.reduce((sum, item) => item.isLoyalty ? sum + (item.pointsUsed || 0) : sum, 0);
        
        // B. Calculate Live Balance
        const liveBalance = (userData.points || 0) - pointsInCart;
        
        // C. Update the UI
        const profilePointsEl = document.getElementById('loyalty-points');
        if (profilePointsEl) {
            profilePointsEl.innerText = liveBalance < 0 ? 0 : liveBalance;
        }

        // D. Also update the Rewards Page header if it's open
        const rewardsHeader = document.getElementById('loyalty-display-points');
        if (rewardsHeader) {
            rewardsHeader.innerText = liveBalance < 0 ? 0 : liveBalance;
        }
    } 
};


// --- HISTORY MODAL LOGIC ---

function openHistory() {
    const modal = document.getElementById('historyModal');
    const card = document.getElementById('historyCard');
    const backdrop = document.getElementById('historyBackdrop');

    if(!modal) return;

    // 1. Show Wrapper
    modal.classList.remove('hidden');
    modal.classList.add('active'); // Blocks clicks

    // 2. Animate In
    // Small delay to allow browser to render 'block' before animating transform
    requestAnimationFrame(() => {
        backdrop.classList.remove('opacity-0');
        card.style.transform = 'translateY(0)';
    });
}

function closeHistory() {
    const modal = document.getElementById('historyModal');
    const card = document.getElementById('historyCard');
    const backdrop = document.getElementById('historyBackdrop');

    if(!modal) return;

    // 1. Animate Out
    backdrop.classList.add('opacity-0');
    card.style.transform = 'translateY(100%)';

    // 2. Hide Wrapper after animation
    setTimeout(() => {
        modal.classList.remove('active');
        modal.classList.add('hidden');
    }, 300); // Matches CSS duration
}

// Enable Swipe-to-Close for History
// (Make sure this runs AFTER the page loads, e.g., at the bottom of your script)
setTimeout(() => {
    if(typeof setupSwipe === 'function') {
        setupSwipe('historyCard', closeHistory);
    }
}, 1000);


window.toggleHistoryItem = (card) => {
    const wrapper = card.querySelector('.details-wrapper');
    const icon = card.querySelector('.chevron-icon');
    if (wrapper.classList.contains('grid-rows-[0fr]')) {
        wrapper.classList.remove('grid-rows-[0fr]'); wrapper.classList.add('grid-rows-[1fr]');
        icon.classList.add('rotate-180'); card.classList.add('ring-2', 'ring-orange-100');
    } else {
        wrapper.classList.remove('grid-rows-[1fr]'); wrapper.classList.add('grid-rows-[0fr]');
        icon.classList.remove('rotate-180'); card.classList.remove('ring-2', 'ring-orange-100');
    }
}

// Override switchView for Loyalty Page
const originalSwitch = window.switchView;
window.switchView = (v) => {
    if (v === 'loyalty') {
        document.querySelectorAll('[id^="view-"]').forEach(e => e.classList.add('hidden')); 
        document.getElementById('view-loyalty').classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); 
        document.querySelectorAll('.nav-item')[2].classList.add('active'); 
        return;
    }
    originalSwitch(v);
}

// Splash Skip Logic
if (sessionStorage.getItem('tari_splash_seen') === 'true') {
    const style = document.createElement('style');
    style.innerHTML = '#splash-screen { display: none !important; }';
    document.head.appendChild(style);
}
const originalHideSplash = window.hideSplash;
window.hideSplash = () => { sessionStorage.setItem('tari_splash_seen', 'true'); originalHideSplash(); }


window.handleLogout = async () => {
    // 1. Clear the specific "Sticky" session keys
    localStorage.removeItem('tari_wa_session');
    localStorage.removeItem('tari_user');
    
    // 2. Clear global user variable
    currentUser = null;
    
    // 3. Sign out of Supabase
    await sb.auth.signOut();
    
    // 4. Reload the page to reset the state
    window.location.reload();
}
// --- OTP VISUALIZER ---
// Add this at the bottom of your script
document.getElementById('si-otp-input').addEventListener('input', function(e) {
    const val = e.target.value.replace(/\D/g, ''); // Allow numbers only
    e.target.value = val; 
    
    // Fill the 4 boxes
    for(let i=0; i<4; i++) {
        const box = document.getElementById(`si-box-${i}`);
        if (val[i]) {
            box.innerText = val[i];
            // Active Style (Green Border)
            box.className = "w-12 h-14 border-2 border-green-500 bg-white text-green-600 rounded-xl flex items-center justify-center text-2xl font-black transition-all shadow-sm";
        } else {
            box.innerText = '';
            // Empty Style (Gray Border)
            box.className = "w-12 h-14 border-2 border-slate-200 bg-slate-50 text-slate-800 rounded-xl flex items-center justify-center text-2xl font-black transition-all";
        }
    }
});

// --- FIX TOAST EXIT ANIMATION ---
// This makes the notifications fade in/out smoothly instead of just sliding
const toastStyle = document.createElement('style');
toastStyle.innerHTML = `
    #toast {
        /* Added opacity transition for smoother effect */
        transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.4s ease-in !important;
    }
`;
document.head.appendChild(toastStyle);

// --- AUTO-CLEANUP LOGIC ---

// 1. Promo Code: Clear error immediately when typing
const promoInput = document.getElementById('promo-input');
if (promoInput) {
    promoInput.addEventListener('input', function() {
        const msg = document.getElementById('promo-msg');
        if (msg && !msg.classList.contains('text-green-600')) {
            msg.innerText = "";
            msg.classList.add('hidden');
        }
    });
}

// 2. Clean up errors when closing Cart
const originalCloseCartCleanup = window.closeCart;
window.closeCart = function() {
    originalCloseCartCleanup(); 
    setTimeout(() => {
        const msg = document.getElementById('promo-msg');
        if (msg) {
            msg.innerText = "";
            msg.classList.add('hidden');
        }
    }, 500);
};

// 3. Clean up errors when switching tabs
const originalSwitchViewCleanup = window.switchView;
window.switchView = function(viewName) {
    originalSwitchViewCleanup(viewName); 

    // Clear Auth Errors
    const phoneError = document.getElementById('phone-error-msg');
    const phoneContainer = document.getElementById('reg-phone')?.parentElement;
    
    if (phoneError) phoneError.classList.add('hidden');
    if (phoneContainer) phoneContainer.classList.remove('border-red-500', 'bg-red-50');
    
    // Clear Toast
    const toast = document.getElementById('toast');
    if (toast) toast.classList.remove('show');
};
function listenToStoreStatus() {
    // Listen for updates to the 'settings' table where id = 'store_status'
    sb.channel('store-status-live')
    .on(
        'postgres_changes',
        { event: 'UPDATE', schema: 'public', table: 'settings', filter: 'id=eq.store_status' },
        (payload) => {
            console.log("ğŸ”” Store Status Changed:", payload.new.data);
            if (payload.new && payload.new.data) {
                // Apply the new status immediately
                applyStoreStatus(payload.new.data.open);
            }
        }
    )
    .subscribe();
}

async function applyStoreStatus(isOpen) {
    isStoreOpen = isOpen;
    const modal = document.getElementById('closed-modal');
    const backdrop = document.getElementById('closed-backdrop');
    const cartBtn = document.getElementById('fab-btn');

    if (isOpen) {
        // --- OPEN THE STORE ---
        console.log("âœ… Store is now OPEN");
        
        // 1. Hide the Closed Modal
        if(modal) modal.classList.add('-translate-y-full');
        if(backdrop) backdrop.classList.add('opacity-0');
        
        // 2. Re-enable the Cart Button
        if(cartBtn) {
            cartBtn.onclick = openCart; // Restore original function
            cartBtn.classList.remove('grayscale', 'opacity-80', 'cursor-not-allowed', 'justify-center');
            cartBtn.classList.add('justify-between'); // Restore spacing
            
            // Restore Text & Badges
            if(document.getElementById('cart-count')) document.getElementById('cart-count').style.display = 'flex';
            if(document.getElementById('cart-total')) document.getElementById('cart-total').style.display = 'block';
            
            const textSpan = cartBtn.querySelector('div span'); 
            if(textSpan) {
                // Check language to restore correct text
                const isArabic = document.documentElement.lang === 'ar';
                textSpan.innerText = isArabic ? "Ø¹Ø±Ø¶ Ø§Ù„Ø³Ù„Ø©" : "View Basket";
                textSpan.className = "font-bold"; // Reset font style
            }
        }

    } else {
        // --- CLOSE THE STORE ---
        console.log("â›” Store is now CLOSED");

        // 1. Show the Closed Modal
        if(modal) modal.classList.remove('-translate-y-full');
        if(backdrop) backdrop.classList.remove('opacity-0');

        // 2. Fetch Hours (Optional: refresh them)
        const { data: info } = await sb.from('settings').select('data').eq('id', 'info').single();
        if(info?.data?.hours) {
            const isArabic = document.documentElement.lang === 'ar';
            const hoursHtml = info.data.hours.map(h => 
                `<div class="flex justify-between w-full max-w-[200px] mx-auto"><span>${h.day}:</span> <span>${h.time}</span></div>`
            ).join('');
            if(document.getElementById('closed-hours-display')) 
                document.getElementById('closed-hours-display').innerHTML = hoursHtml;
        }

        // 3. Disable Cart Button
        if(cartBtn) {
            const isArabic = document.documentElement.lang === 'ar';
            
            cartBtn.onclick = () => showToast(isArabic ? "Ø§Ù„Ù…ØªØ¬Ø± Ù…ØºÙ„Ù‚ Ø­Ø§Ù„ÙŠØ§Ù‹" : "Store is closed", true);
            cartBtn.classList.add('grayscale', 'opacity-80', 'cursor-not-allowed', 'justify-center');
            cartBtn.classList.remove('justify-between');
            
            if(document.getElementById('cart-count')) document.getElementById('cart-count').style.display = 'none';
            if(document.getElementById('cart-total')) document.getElementById('cart-total').style.display = 'none';

            const textSpan = cartBtn.querySelector('div span'); 
            if(textSpan) {
                textSpan.innerText = isArabic ? "Ø§Ù„Ù…ØªØ¬Ø± Ù…ØºÙ„Ù‚" : "Store Closed";
                textSpan.className = "font-black text-lg uppercase tracking-widest";
            }
        }
    }
}

    // --- PRO MOVE: SMART GHOST BUTTON ---
    let lastScrollY = window.scrollY;
    let isScrollingDown = false;

    window.addEventListener('scroll', () => {
        const aiBtn = document.getElementById('ai-trigger');
        const fab = document.getElementById('fab-container');
        if(!aiBtn) return;

        const currentScroll = window.scrollY;
        
        // 1. Detect Scroll Direction
        if (currentScroll > lastScrollY && currentScroll > 50) {
            // SCROLLING DOWN -> HIDE
            isScrollingDown = true;
            aiBtn.classList.add('translate-y-32', 'opacity-0', 'scale-75'); // Send it down & shrink
        } else if (currentScroll < lastScrollY) {
            // SCROLLING UP -> SHOW
            isScrollingDown = false;
            
            // Check if Cart is visible to position correctly
            if (fab && !fab.classList.contains('translate-y-32')) {
                 // Cart is ON: Float ABOVE it
                 aiBtn.classList.remove('translate-y-32', 'opacity-0', 'scale-75');
                 aiBtn.classList.add('-translate-y-24'); 
            } else {
                 // Cart is OFF: Float at BOTTOM
                 aiBtn.classList.remove('translate-y-32', 'opacity-0', 'scale-75', '-translate-y-24');
            }
        }
        lastScrollY = currentScroll;
    });

    // 2. Update existing Cart Logic to respect this
    // (We hook into your existing updateCartUI function)
    const oldUpdateUI = window.updateCartUI;
    window.updateCartUI = function() {
        if(oldUpdateUI) oldUpdateUI(); // Run original
        
        // Force update position based on new Cart state
        const aiBtn = document.getElementById('ai-trigger');
        const fab = document.getElementById('fab-container');
        
        if (aiBtn && fab && !isScrollingDown) {
             if (!fab.classList.contains('translate-y-32')) {
                 aiBtn.classList.add('-translate-y-24');
             } else {
                 aiBtn.classList.remove('-translate-y-24');
             }
        }
    };



    setupSwipe('productCard', closeModal);
    setupSwipe('checkoutCard', closeCart);
    
    // --- âš¡ INSTANT WAKE UP LISTENER ---
// Triggers ONLY when the user switches back to this tab/app
document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible") {
        console.log("ğŸ“± App back in focus - Forcing Sync...");
        
        // This function already handles the cleanup, so it won't conflict
        if (typeof forceAppSync === 'function') {
            forceAppSync();
        }
    }
});

    // ==========================================
    // ğŸ›¡ï¸ GLOBAL NETWORK GUARD (The Failsafe)
    // ==========================================
    
    // 1. Listen for connection changes (Real-time)
    window.addEventListener('offline', () => {
        showToast("Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ğŸ“¡", true);
        document.body.classList.add('grayscale'); // Optional: Visual cue
    });

    window.addEventListener('online', () => {
        showToast("Ø¹Ø§Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª âš¡");
        document.body.classList.remove('grayscale');
        // Optional: Try to sync/reload data when back online
        if(typeof forceAppSync === 'function') forceAppSync();
    });

    // 2. Intercept ALL Network Requests (The "Guard Dog" for everything)
    const originalFetch = window.fetch;
    window.fetch = async (...args) => {
        // A. Check Connection BEFORE trying
        if (!navigator.onLine) {
            showToast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ğŸ“µ", true);
            throw new Error("No Internet Connection"); // This stops the function immediately
        }

        try {
            // B. Try the request
            const response = await originalFetch(...args);
            return response;
        } catch (error) {
            // C. Catch network failures (DNS errors, Server down)
            console.error("Global Network Error:", error);
            showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ - Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰", true);
            throw error;
        }
    };


    loadData();

</script>
</body>
</html>
