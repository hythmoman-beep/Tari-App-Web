<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TARI - Premium Food Truck</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Righteous&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    
    <style>
        
        #hero-slider-container {
    contain: paint;
    isolation: isolate;
    will-change: opacity;
}
        .modal-shell.active {
    pointer-events: auto;
}
.modal-shell {
    pointer-events: none;
}
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #F8FAFC; -webkit-tap-highlight-color: transparent; overflow-x: hidden; overscroll-behavior-y: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* THEME VARIABLES */
        :root { --primary: #FF5722; }
        .bg-brand { background-color: var(--primary) !important; }
        .text-brand { color: var(--primary) !important; }
        .border-brand { border-color: var(--primary) !important; }
        .nav-item.active { color: var(--primary); }
        .cat-btn.active { background-color: var(--primary) !important; color: white !important; border-color: var(--primary) !important; }

        /* ANIMATIONS */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .slide-up-enter { animation: slideUpEnter 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUpEnter { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        /* Force Green Button */
        .bg-green-force { background-color: #22c55e !important; color: white !important; border-color: #22c55e !important; }

        /* HERO SLIDER ‚Äì GPU STABLE VERSION */
.hero-slide {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;

    /* GPU stabilization */
    transform: translateZ(0) scale(1.05);
    opacity: 0;
    transition: opacity 0.8s ease-out, transform 0.8s ease-out;
    backface-visibility: hidden;
}

.hero-slide.active-slide {
    opacity: 1;
    transform: translateZ(0) scale(1);
}

        /* TOAST */
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #1E293B; color: white; padding: 12px 24px; border-radius: 50px; display: flex; align-items: center; gap: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 1000; opacity: 0; width: max-content; max-width: 90%; }
        #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        #toast i.error-icon { color: #F87171; }

        /* TRACKER STRIPE & SHINY DOT */
        .step-container { display: flex; align-items: center; justify-content: space-between; position: relative; margin-bottom: 24px; }
        .step-circle { width: 32px; height: 32px; border-radius: 50%; background: #F1F5F9; color: #94A3B8; font-weight: 800; font-size: 12px; display: flex; align-items: center; justify-content: center; z-index: 2; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: all 0.3s; }
        .step-circle.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(255, 87, 34, 0.3); transform: scale(1.1); }
        .step-line-container { position: absolute; top: 50%; left: 0; width: 100%; height: 4px; background: #E2E8F0; z-index: 1; transform: translateY(-50%); border-radius: 10px; overflow: hidden; }
        .step-line-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s ease-in-out; position: relative; }
        .step-line-fill::after { content: ''; position: absolute; top: 0; right: 0; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent); transform: translateX(-100%); animation: shinyDot 2s infinite ease-in-out; }
        @keyframes shinyDot { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        /* FLOATING ICONS */
        .floating-icon { position: absolute; font-size: 3.5rem; opacity: 0.8; z-index: 5; animation: floatHover 6s ease-in-out infinite; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }
        @keyframes floatHover { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-20px) rotate(10deg); } }

        /* CROPPER */
        #crop-modal { opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        #crop-modal.active { opacity: 1; pointer-events: auto; }
        
        /* SHIMMER BADGE */
        .shimmer { position: relative; overflow: hidden; }
        .shimmer::after { content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%; background: linear-gradient(to right, transparent 0%, rgba(255,255,255,0.4) 50%, transparent 100%); animation: shimmer 2s infinite; transform: skewX(-20deg); }
        @keyframes shimmer { 100% { left: 200%; } }

        /* SOLD OUT STATE */
        .sold-out-card { opacity: 0.6; filter: grayscale(100%); pointer-events: none; position: relative; }
        .sold-out-card::after { content: 'SOLD OUT'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-10deg); background: rgba(0,0,0,0.7); color: white; padding: 5px 15px; font-weight: 800; font-size: 12px; border-radius: 5px; z-index: 10; border: 2px solid white; white-space: nowrap; }

        /* SWIPE HANDLER */
        .drag-handle { width: 40px; height: 5px; background: #E2E8F0; border-radius: 10px; margin: 12px auto; }
        .modal-sheet { transition: transform 0.1s linear; will-change: transform; }
        .modal-sheet.snapping { transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }

        /* PRELOADER */
        #preloader { position: fixed; inset: 0; background: #F8FAFC; z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s; pointer-events: none; }      
       #preloader.loaded { opacity: 0; }
               /* PREMIUM GOLD ANIMATION */
        .text-gold-shine {
            background: linear-gradient(to right, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            background-size: 200% auto;
            animation: shineGold 3s linear infinite;
        }
        @keyframes shineGold {
            to { background-position: 200% center; }
        }
          
    </style>
</head>
<body class="text-slate-800 pb-24 select-none">

    <div id="preloader"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500"></div></div>

    <div id="toast"><i id="toast-icon" class="fa-solid fa-circle-check text-green-400 text-lg"></i><span id="toast-msg" class="font-bold text-sm">Notification</span></div>

    <div id="crop-modal" class="fixed inset-0 z-[200] bg-slate-900/95 backdrop-blur-sm flex flex-col items-center justify-center p-6">
        <div class="bg-white rounded-3xl w-full max-w-sm flex flex-col overflow-hidden shadow-2xl">
            <div class="p-4 border-b flex justify-between items-center bg-white z-10"><h3 class="font-bold text-lg">Adjust Profile Pic</h3><button onclick="closeCropper()" class="text-slate-400"><i class="fa-solid fa-xmark text-xl"></i></button></div>
            <div class="h-64 bg-slate-900 relative"><img id="crop-target" class="max-w-full max-h-full block"></div>
            <div class="p-4 border-t bg-white flex justify-end gap-3"><button onclick="finishCrop()" class="w-full bg-brand text-white py-3 rounded-xl font-bold shadow-lg">Save Picture</button></div>
        </div>
    </div>

    <div id="splash-screen" class="fixed inset-0 bg-slate-900 flex flex-col items-center justify-between pt-16 pb-10 px-6 z-[200] overflow-hidden transition-transform duration-700">
        <div class="floating-icon" style="top: 15%; left: 10%; animation-delay: 0s;">üçî</div>
        <div class="floating-icon" style="top: 25%; right: 10%; animation-delay: 1.5s;">üçü</div>
        <div class="floating-icon" style="bottom: 30%; left: 15%; animation-delay: 0.5s;">ü•§</div>
        <div class="floating-icon" style="top: 50%; right: 20%; animation-delay: 2s;">üçï</div>
        <div class="floating-icon" style="bottom: 40%; right: 5%; animation-delay: 1s;">üåÆ</div>
        <div class="floating-icon" style="top: 10%; left: 50%; animation-delay: 2.5s; font-size: 2.5rem;">üå≠</div>
        <img id="splash-bg-img" class="absolute inset-0 w-full h-full object-cover opacity-30 hidden z-0">
        <div class="absolute inset-0 bg-gradient-to-b from-transparent via-slate-900/60 to-slate-900 pointer-events-none z-0"></div>
        <div class="text-center z-10 flex flex-col items-center relative mt-10">
            <span id="splash-subtitle-text" class="bg-orange-500 text-white text-xs font-bold px-3 py-1 rounded-full mb-6 tracking-wider shadow-lg shadow-orange-500/30 btn-brand">PREMIUM FOOD TRUCK</span>
            <h1 id="splash-title-text" class="text-6xl font-extrabold text-white mb-2 leading-tight tracking-tighter drop-shadow-lg">TARI</h1>
            <p id="splash-intro" class="text-slate-300 text-sm font-medium max-w-[250px] leading-relaxed">Delicious burgers and fries made with passion and served fresh daily.</p>
        </div>
        <div class="relative w-64 h-64 z-10 my-auto"><img id="splash-circle-img" src="https://images.unsplash.com/photo-1568901346375-23c9450c58cd" class="w-full h-full object-cover rounded-full border-4 border-slate-800 shadow-2xl"></div>
        <button onclick="hideSplash()" class="w-full bg-orange-500 text-white font-bold py-4 rounded-2xl shadow-xl shadow-orange-500/20 active:scale-95 transition text-lg z-10 animate-pulse btn-brand flex items-center justify-center gap-2">Order Now <i class="fa-solid fa-arrow-up"></i></button>
    </div>

    <div id="view-auth" class="fixed inset-0 z-[200] bg-white flex flex-col items-center justify-center p-8 auth-hidden shadow-2xl transition-transform duration-300 transform translate-y-full">
        <button onclick="closeAuth()" class="absolute top-6 right-6 text-slate-400 p-2 hover:text-slate-800"><i class="fa-solid fa-xmark text-2xl"></i></button>
        <div class="w-20 h-20 bg-orange-500 rounded-2xl flex items-center justify-center mb-6 shadow-xl shadow-orange-200 btn-brand"><i class="fa-solid fa-lock text-4xl text-white"></i></div>
        <h1 class="text-3xl font-bold mb-2">Login Required</h1>
        <p class="text-slate-400 mb-8 text-center">Sign in to earn loyalty points<br>and track your food.</p>
        <div class="w-full max-w-sm space-y-4" id="auth-forms">
            <div id="login-form" class="space-y-4 fade-in">
                <input type="email" id="login-email" placeholder="Email Address" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none font-medium focus:border-orange-500">
                <input type="password" id="login-pass" placeholder="Password" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none font-medium focus:border-orange-500">
                <button onclick="handleLogin(this)" class="w-full bg-slate-900 text-white p-4 rounded-xl font-bold text-lg shadow-lg">Log In</button>
                <p class="text-center text-slate-500 text-sm mt-4">New here? <button onclick="toggleAuthMode()" class="text-orange-600 font-bold text-brand">Create Account</button></p>
            </div>
            <div id="signup-form" class="space-y-4 hidden fade-in">
                <input type="text" id="reg-name" placeholder="Full Name" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none font-medium focus:border-orange-500">
                <input type="email" id="reg-email" placeholder="Email Address" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none font-medium focus:border-orange-500">
                <input type="tel" id="reg-phone" placeholder="Phone Number" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none font-medium focus:border-orange-500">
                <input type="password" id="reg-pass" placeholder="Create Password" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none font-medium focus:border-orange-500">
                <button onclick="handleSignup(this)" class="w-full bg-orange-500 text-white p-4 rounded-xl font-bold text-lg shadow-lg btn-brand">Sign Up</button>
                <p class="text-center text-slate-500 text-sm mt-4">Have an account? <button onclick="toggleAuthMode()" class="text-slate-900 font-bold">Log In</button></p>
            </div>
        </div>
    </div>
                            <div id="app-header" class="fixed top-0 w-full z-40 px-6 py-4 flex justify-between items-center border-b border-slate-800 transition-all shadow-lg h-20">
            
            <div class="w-12 flex justify-start">
                <img id="header-truck-logo" class="h-10 w-auto object-contain hidden"> 
            </div>

            <div class="absolute left-1/2 transform -translate-x-1/2 flex flex-col items-center justify-center text-center w-full max-w-[200px]">
                <h1 class="text-2xl tracking-wide text-white" style="font-family: 'Righteous', cursive;">
    TARI<span class="text-orange-500">.</span>
</h1>


                <span class="text-[10px] font-bold uppercase tracking-[0.3em] mt-1 text-gold-shine whitespace-nowrap">Premium Food Truck</span>
            </div>

            <div class="w-12 flex justify-end">
                <div onclick="requireAuth()" class="w-10 h-10 rounded-full bg-slate-800 overflow-hidden border-2 border-yellow-600/50 shadow-md cursor-pointer flex items-center justify-center">
                    <img id="header-avatar" src="https://ui-avatars.com/api/?name=Guest&background=1e293b&color=fff" class="w-full h-full object-cover">
                </div>
            </div>
        </div>
       
        <div id="view-home" class="pt-24 px-4 pb-24 fade-in">
            <div class="bg-slate-900 rounded-3xl p-6 text-white mb-6 relative overflow-hidden shadow-xl shadow-slate-200 h-64 flex flex-col justify-center">
                <div id="hero-slider-container" class="absolute inset-0 z-0"></div>
                <div class="absolute inset-0 bg-gradient-to-r from-black/80 to-transparent z-0"></div>
                <div class="relative z-10">
                    <span class="bg-orange-500 text-white text-xs font-bold px-2 py-1 rounded-md mb-2 inline-block btn-brand">WELCOME</span>
                    <h2 id="hero-title-text" class="text-2xl font-bold mb-1">Hungry?</h2>
                    <p id="hero-subtitle-text" class="text-slate-200 text-sm mb-4 max-w-[200px]">Order premium burgers now.</p>
                </div>
            </div>

            <div id="best-seller-section" class="hidden mb-8">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2 text-slate-800"><i class="fa-solid fa-fire text-orange-500 text-brand"></i> Popular Now</h3>
                <div id="best-seller-list" class="flex gap-4 overflow-x-auto no-scrollbar pb-2"></div>
            </div>

            <div class="flex gap-3 overflow-x-auto no-scrollbar mb-6">
                <button onclick="filterMenu('all', this)" class="cat-btn active bg-white text-slate-600 border border-slate-200 px-5 py-2 rounded-full font-bold text-sm whitespace-nowrap shadow-sm">All</button>
                <button onclick="filterMenu('Burger', this)" class="cat-btn bg-white text-slate-600 border border-slate-200 px-5 py-2 rounded-full font-bold text-sm whitespace-nowrap shadow-sm">üçî Burgers</button>
                <button onclick="filterMenu('Fries', this)" class="cat-btn bg-white text-slate-600 border border-slate-200 px-5 py-2 rounded-full font-bold text-sm whitespace-nowrap shadow-sm">üçü Sides</button>
                <button onclick="filterMenu('Drink', this)" class="cat-btn bg-white text-slate-600 border border-slate-200 px-5 py-2 rounded-full font-bold text-sm whitespace-nowrap shadow-sm">ü•§ Drinks</button>
            </div>
            
            
            <div id="menu-list" class="space-y-4 mb-10">
                <div class="text-center py-10 text-slate-400 animate-pulse"><i class="fa-solid fa-circle-notch fa-spin text-3xl text-orange-500 mb-3 text-brand"></i><p>Loading tasty food...</p></div>
            </div>
            
            <div class="bg-slate-900 rounded-3xl p-8 text-white relative overflow-hidden" id="info-section">
                <h3 class="text-2xl font-bold mb-6 relative z-10">Visit Us</h3>
                <div class="space-y-6 relative z-10">
                    <div class="flex gap-4"><div class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center flex-shrink-0 text-orange-500 text-brand"><i class="fa-solid fa-location-dot"></i></div><div><p class="text-xs text-slate-400 uppercase font-bold tracking-wider mb-1">Location</p><p class="font-medium text-sm leading-relaxed" id="info-location">Loading...</p></div></div>
                    <div class="flex gap-4"><div class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center flex-shrink-0 text-orange-500 text-brand"><i class="fa-solid fa-clock"></i></div><div><p class="text-xs text-slate-400 uppercase font-bold tracking-wider mb-1">Working Hours</p><div class="font-medium text-sm" id="info-hours">Loading...</div></div></div>
                    <div class="flex gap-4"><div class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center flex-shrink-0 text-orange-500 text-brand"><i class="fa-solid fa-phone"></i></div><div><p class="text-xs text-slate-400 uppercase font-bold tracking-wider mb-1">Contact</p><p class="font-medium text-sm" id="info-phone">Loading...</p></div></div>
                </div>
            </div>
        </div>

        <div id="view-track" class="pt-24 px-6 pb-24 hidden fade-in h-screen bg-white overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Order Status</h2>
                <div class="bg-red-500 text-white text-[10px] font-bold px-2 py-1 rounded-full animate-pulse flex items-center gap-1 shadow-lg shadow-red-500/30"><div class="w-2 h-2 bg-white rounded-full"></div> LIVE</div>
            </div>
            <div id="active-tracker-container" class="space-y-6 pb-20"><div class="text-center py-20 text-slate-400"><i class="fa-solid fa-receipt text-4xl mb-4"></i><p>No active orders.</p></div></div>
        </div>

        <div id="view-profile" class="pt-24 px-6 pb-24 hidden fade-in">
            <div class="flex flex-col items-center mb-8">
                <div class="relative w-32 h-32 mb-4">
                    <img id="profile-avatar" src="https://ui-avatars.com/api/?name=User&background=FF5722&color=fff" class="w-full h-full rounded-full object-cover border-4 border-white shadow-xl bg-slate-100">
                </div>
                <div class="flex items-center gap-3">
                    <label for="upload-input" class="bg-slate-900 text-white px-4 py-2 rounded-full text-xs font-bold cursor-pointer shadow hover:bg-slate-800 transition flex items-center gap-2"><i class="fa-solid fa-camera"></i> Change Photo</label>
                    <button onclick="removeAvatar()" class="bg-red-50 text-red-500 border border-red-100 px-4 py-2 rounded-full text-xs font-bold shadow-sm hover:bg-red-100 transition flex items-center gap-2"><i class="fa-solid fa-trash"></i> Remove</button>
                    <input type="file" id="upload-input" class="hidden" accept="image/*" onchange="startCrop(this)">
                </div>
                <h2 id="profile-name" class="text-2xl font-black text-slate-900 mt-4">User</h2>
            </div>
            
            <div class="bg-gradient-to-r from-orange-500 to-red-500 rounded-3xl p-6 text-white shadow-xl shadow-orange-500/20 mb-8 relative overflow-hidden bg-brand-gradient">
                <div class="absolute -right-6 -top-6 text-white/10 text-9xl"><i class="fa-solid fa-crown"></i></div>
                <div class="relative z-10">
                    <div class="flex justify-between items-start mb-4"><div class="bg-white/20 backdrop-blur-sm px-3 py-1 rounded-lg border border-white/30 text-xs font-bold">GOLD MEMBER</div></div>
                    <p class="text-sm font-medium text-orange-100">Loyalty Points</p>
                    <h3 class="text-5xl font-black mt-1" id="loyalty-points">0</h3>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm text-center">
                    <div class="w-8 h-8 mx-auto bg-blue-50 text-blue-500 rounded-full flex items-center justify-center mb-2"><i class="fa-solid fa-calendar"></i></div>
                    <p class="text-xs text-slate-400 font-bold uppercase">Joined</p>
                    <p class="font-bold text-slate-800" id="profile-joined">--</p>
                </div>
                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm text-center">
                    <div class="w-8 h-8 mx-auto bg-purple-50 text-purple-500 rounded-full flex items-center justify-center mb-2"><i class="fa-solid fa-receipt"></i></div>
                    <p class="text-xs text-slate-400 font-bold uppercase">Total Orders</p>
                    <p class="font-bold text-slate-800" id="profile-total-orders">0</p>
                </div>
            </div>

            <div class="bg-white rounded-3xl border border-slate-100 p-5 shadow-sm mb-8 space-y-5">
                <h3 class="font-bold text-lg">Personal Info</h3>
                <div><label class="text-xs font-bold text-slate-400 uppercase ml-1">Email Address</label><div class="flex items-center gap-3 bg-slate-50 p-3 rounded-xl mt-1 border border-slate-100"><i class="fa-solid fa-envelope text-slate-400"></i><span id="profile-email" class="font-bold text-slate-700 text-sm flex-1 truncate">--</span><i class="fa-solid fa-lock text-slate-300 text-xs"></i></div></div>
                <div><label class="text-xs font-bold text-slate-400 uppercase ml-1">Phone Number</label><div class="flex gap-2 mt-1"><div class="flex-1 flex items-center gap-3 bg-slate-50 p-3 rounded-xl border border-slate-100 transition-colors" id="phone-container"><i class="fa-solid fa-phone text-slate-400"></i><input id="profile-phone-input" type="tel" readonly class="bg-transparent font-bold text-slate-700 text-sm w-full outline-none disabled:text-slate-500" placeholder="No phone added"></div><button onclick="togglePhoneEdit(this)" id="btn-phone-action" class="bg-slate-900 text-white px-5 rounded-xl font-bold text-xs shadow-lg hover:bg-slate-800 transition">Update</button></div></div>
            </div>

            <div class="mb-8"><h3 class="font-bold text-lg mb-4 px-1">Order History</h3><div id="order-history" class="space-y-4"></div></div>
            <button onclick="handleLogout()" class="w-full text-red-500 font-bold bg-red-50 border border-red-100 px-6 py-4 rounded-2xl mb-6 active:scale-95 transition"><i class="fa-solid fa-right-from-bracket mr-2"></i> Log Out</button>
        </div>

        <div class="fixed bottom-0 w-full bg-white border-t border-slate-100 pb-safe z-50 flex justify-around items-center h-20 shadow-[0_-5px_20px_rgba(0,0,0,0.03)]">
            <button onclick="switchView('home')" class="nav-item active flex flex-col items-center gap-1 text-slate-400 w-16"><i class="fa-solid fa-house text-xl"></i><span class="text-[10px] font-bold">Home</span></button>
            <button onclick="switchView('track')" class="nav-item flex flex-col items-center gap-1 text-slate-400 w-16 relative"><i class="fa-solid fa-list-check text-xl"></i><span class="text-[10px] font-bold">Orders</span><div id="track-badge" class="absolute top-0 right-3 w-2.5 h-2.5 bg-orange-500 rounded-full border-2 border-white hidden bg-brand"></div></button>
            <button onclick="switchView('profile')" class="nav-item flex flex-col items-center gap-1 text-slate-400 w-16"><i class="fa-solid fa-user text-xl"></i><span class="text-[10px] font-bold">Profile</span></button>
        </div>
           <div id="fab-container" class="fixed bottom-24 left-6 right-6 z-40 transform translate-y-32 transition duration-300">
            <button onclick="openCart()" id="fab-btn" class="w-full bg-slate-900 text-white p-4 rounded-2xl shadow-xl flex justify-between items-center"><div class="flex items-center gap-3"><div class="bg-orange-500 w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold btn-brand" id="cart-count">0</div><span class="font-bold">View Basket</span></div><span class="font-bold text-lg" id="cart-total">SR 0.00</span></button>
        </div>
    </div>
    <div id="productModal"
     class="fixed inset-0 z-[100] hidden modal-shell">
        <div class="absolute inset-0 bg-transparent opacity-0 transition-opacity duration-300" id="productBackdrop" onclick="closeModal()"></div>
        
        <div id="productCard" onclick="event.stopPropagation()" class="absolute bottom-0 w-full sm:max-w-md left-0 right-0 mx-auto bg-white h-[90vh] rounded-t-3xl shadow-2xl transform translate-y-full transition-transform duration-300 ease-out flex flex-col overflow-hidden">
            <div id="productDrag" class="absolute top-0 left-0 right-0 h-10 z-50 flex items-center justify-center bg-white/50 backdrop-blur-sm" onclick="closeModal()"><div class="w-12 h-1.5 bg-slate-300 rounded-full"></div></div>
            
            <div class="relative h-72 bg-slate-200 shrink-0">
                <img id="modal-img" class="w-full h-full object-cover">
                <button onclick="closeModal()" class="absolute top-4 right-4 bg-white/80 p-2 rounded-full shadow text-slate-900 hover:bg-white transition z-50"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>

            <div class="p-6 flex-1 overflow-y-auto bg-white -mt-6 rounded-t-3xl relative z-10" id="productContent">
                <div class="flex justify-between items-start mb-2"><h2 id="modal-title" class="text-2xl font-black text-slate-800"></h2><span id="modal-price" class="text-2xl font-black text-orange-500"></span></div>
                <p id="modal-desc" class="text-slate-500 text-sm mb-6"></p>
                
                <div class="flex justify-between items-center mb-6 pb-6 border-b border-slate-50">
                    <span class="font-bold text-sm uppercase">Quantity</span>
                    <div class="flex items-center bg-slate-100 rounded-xl p-1">
                        <button onclick="adjustModalQty(-1)" class="w-10 h-10 flex items-center justify-center font-bold text-lg">-</button>
                        <span id="modal-qty" class="w-10 text-center font-bold">1</span>
                        <button onclick="adjustModalQty(1)" class="w-10 h-10 flex items-center justify-center font-bold text-lg">+</button>
                    </div>
                </div>
                <div id="modal-modifiers" class="space-y-3"></div>
            </div>

            <div class="p-6 border-t border-slate-50 bg-white shrink-0">
                <button id="addToCartBtn" class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition">Add to Order</button>
            </div>
        </div>
    </div>
    
    <div <button
  id="addToCartBtn"
  class="w-full bg-slate-900 ..."
  ontouchstart="event.stopPropagation()"
  ontouchmove="event.stopPropagation()"
  ontouchend="event.stopPropagation()"
  onclick="event.stopPropagation()"
></div>
        
            <div id="checkoutModal" class="fixed inset-0 z-[100] hidden" aria-hidden="true">
        <div class="absolute inset-0 bg-black/60 opacity-0 transition-opacity duration-300" id="checkoutBackdrop" onclick="closeCart()"></div>
        
        <div id="checkoutCard" onclick="event.stopPropagation()" class="absolute bottom-0 w-full sm:max-w-md left-0 right-0 mx-auto bg-white h-[95vh] rounded-t-3xl shadow-2xl transform translate-y-full transition-transform duration-300 ease-out flex flex-col">
            <div id="checkoutDrag" class="p-4 border-b flex items-center gap-4 shrink-0 bg-white rounded-t-3xl z-20" onclick="closeCart()">
                <div class="mx-auto w-12 h-1.5 bg-slate-300 rounded-full mb-2 absolute top-3 left-0 right-0"></div>
                <button class="text-xl p-2 mt-4"><i class="fa-solid fa-chevron-down"></i></button>
                <h2 class="font-bold text-xl mt-4">Your Basket</h2>
            </div>

            <div class="flex-1 overflow-y-auto p-6" id="cart-items"></div>

            <div class="px-6 pb-4 space-y-4 shrink-0 bg-slate-50 pt-4 border-t border-slate-100">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Payment Method</label>
                    <div class="flex gap-3 mt-1">
                        <label class="flex-1 bg-white border border-slate-200 p-3 rounded-xl flex items-center justify-center gap-2 cursor-pointer has-[:checked]:border-orange-500 has-[:checked]:text-orange-600 has-[:checked]:bg-orange-50 transition shadow-sm"><input type="radio" name="payment" value="Cash" class="hidden" checked><i class="fa-solid fa-money-bill"></i> Cash</label>
                        <label class="flex-1 bg-white border border-slate-200 p-3 rounded-xl flex items-center justify-center gap-2 cursor-pointer has-[:checked]:border-orange-500 has-[:checked]:text-orange-600 has-[:checked]:bg-orange-50 transition shadow-sm"><input type="radio" name="payment" value="Card" class="hidden"><i class="fa-solid fa-credit-card"></i> Card</label>
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Promo Code</label>
                    <div class="flex gap-2 mt-1 relative">
                        <input id="promo-input" class="w-full bg-white border border-slate-200 rounded-xl p-3 text-sm outline-none focus:border-orange-500 disabled:bg-slate-100 disabled:text-slate-400 shadow-sm" placeholder="Enter code">
                        <button id="btn-apply-promo" onclick="applyPromo(this)" class="bg-slate-900 text-white px-5 rounded-xl font-bold text-sm shadow hover:bg-slate-800 transition">Apply</button>
                        <button id="btn-remove-promo" onclick="removePromo()" class="hidden bg-red-100 text-red-500 px-5 rounded-xl font-bold text-sm hover:bg-red-200 transition"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <p id="promo-msg" class="text-xs mt-1 font-bold ml-1 h-4"></p>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Note</label>
                    <textarea id="order-note" class="w-full bg-white border border-slate-200 rounded-xl p-3 text-sm h-16 outline-none focus:border-orange-500 mt-1 shadow-sm resize-none" placeholder="E.g. No onions..."></textarea>
                </div>
            </div>

            <div class="p-6 bg-slate-900 text-white shrink-0">
                <div class="flex justify-between text-sm text-slate-400 font-bold mb-1"><span>Subtotal</span><span id="cart-subtotal">SR 0.00</span></div>
                <div class="flex justify-between text-sm text-green-400 font-bold mb-3 hidden" id="discount-row"><span>Discount</span><span id="cart-discount">-SR 0.00</span></div>
                <div class="flex justify-between text-2xl font-black mb-4 items-end"><span>Total</span><span id="checkout-total">SR 0.00</span></div>
                <button onclick="placeOrder(this)" class="w-full bg-orange-500 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition hover:bg-orange-600">Place Order</button>
            </div>
        </div>
    </div>

                          <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">

    <script>
        const SUPABASE_URL = "https://fpgspmhgwcmhaaxsphcd.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZ3NwbWhnd2NtaGFheHNwaGNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MjYyMTEsImV4cCI6MjA4MTQwMjIxMX0.QyChZ3agLF1MiTzB8XzbrP4pCgBXsT1i9VWfQqu_VOw";
        
        // --- 1. INITIALIZE DATABASE ---
        let sb; 
        if (window.supabase) {
            sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } else {
            console.error("Supabase library not loaded!");
            setTimeout(() => location.reload(), 2000); 
        }

        let currentUser = null, userData = null, cart = [], allMenuItems = [], allModifiers = [], currentItem = null, modalQty = 1, editingCartIndex = -1, activeDiscount = 0, activePromoCode = "", sheetTimer = null;
        let modalOpen = false;
let heroTimer = null;
let lockProductSwipe = false;

        // --- CORE UI ---
        window.hideSplash = () => { document.getElementById('splash-screen').style.transform = 'translateY(-100%)'; setTimeout(()=>document.getElementById('splash-screen').classList.add('splash-gone'), 600); };
        window.showToast = (msg, isErr=false) => { const t = document.getElementById('toast'); document.getElementById('toast-msg').innerText = msg; document.getElementById('toast-icon').className = isErr ? "fa-solid fa-circle-xmark text-red-400" : "fa-solid fa-circle-check text-green-400"; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); };
        window.setBtnLoading = (btn, isLoading, text='Processing') => { if(isLoading) { btn.dataset.org = btn.innerText; btn.innerHTML=`<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> ${text}`; btn.disabled=true; } else { btn.innerText = btn.dataset.org || 'Submit'; btn.disabled=false; } };

        // --- AUTH & DATA ---
                // FIXED: Now fetches orders immediately when the page loads
        if(sb) { 
            sb.auth.onAuthStateChange((event, session) => { 
                if (session) { 
                    currentUser = session.user; 
                    closeAuth(); 
                    loadUserProfile(currentUser.id); 
                    listenToOrders(currentUser.id); // <--- THIS WAS MISSING
                } else { 
                    currentUser = null; 
                } 
            }); 
        }
        window.requireAuth = () => { if (currentUser) { switchView('profile'); } else { document.getElementById('view-auth').classList.remove('translate-y-full'); } };        
        window.closeAuth = () => { document.getElementById('view-auth').classList.add('translate-y-full'); };
        window.toggleAuthMode = () => { document.getElementById('login-form').classList.toggle('hidden'); document.getElementById('signup-form').classList.toggle('hidden'); };
        window.handleLogin = async (btn) => { setBtnLoading(btn, true); const { error } = await sb.auth.signInWithPassword({ email: document.getElementById('login-email').value, password: document.getElementById('login-pass').value }); if (error) { showToast(error.message, true); setBtnLoading(btn, false); } };
        window.handleSignup = async (btn) => { setBtnLoading(btn, true); const { data, error } = await sb.auth.signUp({ email: document.getElementById('reg-email').value, password: document.getElementById('reg-pass').value }); if (error) { showToast(error.message, true); setBtnLoading(btn, false); return; } if (data.user) { await sb.from('users').insert({ id: data.user.id, name: document.getElementById('reg-name').value, email: document.getElementById('reg-email').value, points: 50, joined: new Date().toLocaleDateString() }); showToast("Created!"); setBtnLoading(btn, false); } };
        window.handleLogout = async () => { await sb.auth.signOut(); localStorage.removeItem('sb-fpgspmhgwcmhaaxsphcd-auth-token'); location.reload(); };

                        async function loadData() {
            try {
                if(!sb) return;

                // 1. Hero Slider
                const { data: hero } = await sb.from('settings').select('data').eq('id', 'hero').single(); 
                if(hero?.data?.images) { 
                    document.getElementById('hero-slider-container').innerHTML = hero.data.images.map((img,i) => `<img src="${img}" class="hero-slide ${i===0?'active-slide':''}">`).join(''); 
                } 
                
                // Hero Timer
                let slideIdx = 0; 
                if (window.heroTimer) clearInterval(window.heroTimer);
                window.heroTimer = setInterval(() => {
                    const slides = document.querySelectorAll('.hero-slide');
                    if (slides.length > 1) {
                        slides[slideIdx].classList.remove('active-slide');
                        slideIdx = (slideIdx + 1) % slides.length;
                        slides[slideIdx].classList.add('active-slide');
                    }
                }, 3000);

                // 2. SPLASH SCREEN
                const { data: splash } = await sb.from('settings').select('data').eq('id', 'splash').single();
                if(splash?.data) { 
                    if(splash.data.title) document.getElementById('splash-title-text').innerText = splash.data.title; 
                    if(splash.data.subtitle) document.getElementById('splash-subtitle-text').innerText = splash.data.subtitle;
                    if(splash.data.intro) document.getElementById('splash-intro').innerText = splash.data.intro; 
                    if(splash.data.background) { 
                        const bg = document.getElementById('splash-bg-img');
                        bg.src = splash.data.background; 
                        bg.classList.remove('hidden'); 
                    } 
                    if(splash.data.circle) {
                        document.getElementById('splash-circle-img').src = splash.data.circle; 
                    }
                }
                
                // 3. APP DESIGN
                const { data: design } = await sb.from('settings').select('data').eq('id', 'design').single(); 
                if(design?.data) { 
                    if(design.data.primaryColor) { 
                        document.documentElement.style.setProperty('--primary', design.data.primaryColor); 
                        const style = document.createElement('style'); 
                        style.innerHTML = `.bg-brand{background-color:${design.data.primaryColor}!important}.text-brand{color:${design.data.primaryColor}!important}`; 
                        document.head.appendChild(style); 
                    } 
                    if(design.data.backgroundColor) { 
                        document.body.style.backgroundColor = design.data.backgroundColor; 
                        document.documentElement.style.backgroundColor = design.data.backgroundColor; 
                    } 
                }

                // 4. WEBSITE SETTINGS (The Fix is Here!)
                const { data: web } = await sb.from('settings').select('data').eq('id', 'website_settings').single(); 
                if(web?.data) { 
                    const header = document.getElementById('app-header'); 
                    if(header && web.data.header_color) { 
                        header.style.backgroundColor = web.data.header_color; 
                        header.classList.remove('bg-slate-900'); 
                    } 
                    if(web.data.logo) { 
                        const logoImg = document.getElementById('header-truck-logo'); 
                        if(logoImg) { 
                            // CACHE BUSTER: ?t=Date.now() forces a new download
                            logoImg.src = web.data.logo + '?t=' + Date.now(); 
                            logoImg.classList.remove('hidden'); 
                        } 
                    } 
                }
                
                // 5. INFO
                const { data: info } = await sb.from('settings').select('data').eq('id', 'info').single(); 
                if (info && info.data) { 
                    if(info.data.location) document.getElementById('info-location').innerText = info.data.location; 
                    if(info.data.phone) document.getElementById('info-phone').innerText = info.data.phone; 
                    if(info.data.hours && Array.isArray(info.data.hours)) { 
                        document.getElementById('info-hours').innerHTML = info.data.hours.map(h => `<div class="flex justify-between w-full max-w-[200px] mb-1 text-slate-300"><span>${h.day}:</span> <span class="font-bold text-white">${h.time}</span></div>`).join(''); 
                    } 
                }

                // 6. MENU
                const { data: mods } = await sb.from('modifier_groups').select('*').order('sort_order', {ascending: true}); 
                allModifiers = mods || []; 
                const { data: menu } = await sb.from('menu').select('*').order('sort_order', {ascending: true}); 
                allMenuItems = menu || []; 
                renderMenu(allMenuItems); 
                renderBestSellers(allMenuItems);

            } catch (err) { console.log(err); } finally { document.getElementById('preloader').classList.add('loaded'); }
        }

        // --- MENU RENDER ---
        function renderBestSellers(items) { const best = items.filter(i => i.is_best_seller === true && i.available !== false); const container = document.getElementById('best-seller-list'); if(best.length > 0) { document.getElementById('best-seller-section').classList.remove('hidden'); container.innerHTML = best.map(i => { const itemStr = JSON.stringify(i).replace(/'/g, "&#39;").replace(/"/g, "&quot;"); return `<div onclick='openCartItemFromMenu(${itemStr})' class="flex-shrink-0 w-40 bg-white rounded-2xl p-3 shadow-md border border-slate-100 cursor-pointer active:scale-95 transition relative overflow-hidden"><div class="h-32 w-full rounded-xl overflow-hidden mb-2 relative"><img src="${i.image||'https://via.placeholder.com/150'}" class="w-full h-full object-cover"></div><h4 class="font-bold text-sm truncate mt-2">${i.name}</h4><div class="flex justify-between items-center mt-1"><span class="text-orange-500 font-bold text-xs">SR ${i.price}</span><div class="w-6 h-6 bg-slate-900 text-white rounded-md flex items-center justify-center text-[10px]"><i class="fa-solid fa-plus"></i></div></div></div>`; }).join(''); } else { document.getElementById('best-seller-section').classList.add('hidden'); } }
                // FIXED: Now shows the "Best Seller" badge on items
                // FIXED: Removed item counter logic so it doesn't crash
        function renderMenu(items) { 
            // Removed the item-count line here
            
            document.getElementById('menu-list').innerHTML = items.length ? items.map(item => { 
                const itemStr = JSON.stringify(item).replace(/'/g, "&#39;").replace(/"/g, "&quot;"); 
                const isSoldOut = item.available === false; 
                
                const bestSellerBadge = item.is_best_seller 
                    ? `<div class="absolute top-0 left-0 bg-orange-500 text-white text-[10px] font-bold px-2 py-1 rounded-br-lg z-10 shadow-sm">Best Seller</div>` 
                    : '';

                return `
                <div onclick='${isSoldOut ? '' : `openCartItemFromMenu(${itemStr})`}' class="bg-white p-3 rounded-2xl shadow-sm border border-slate-100 flex gap-4 cursor-pointer active:scale-[0.98] transition group relative overflow-hidden ${isSoldOut ? 'sold-out-card' : ''}">
                    <div class="relative w-24 h-24 flex-shrink-0 rounded-xl overflow-hidden">
                        ${bestSellerBadge}
                        <img src="${item.image || 'https://via.placeholder.com/150'}" class="w-full h-full object-cover bg-slate-100 border-2 border-white shadow-sm">
                    </div>
                    <div class="flex flex-col justify-center flex-1">
                        <h3 class="font-bold text-slate-800 text-lg leading-tight mb-1">${item.name}</h3>
                        <p class="text-xs text-slate-500 line-clamp-2 mb-2">${item.description||''}</p>
                        <div class="flex justify-between items-center mt-auto">
                            <span class="font-bold text-slate-900">SR ${item.price}</span>
                            <div class="w-8 h-8 bg-slate-50 rounded-full flex items-center justify-center text-slate-400 group-hover:bg-orange-50 group-hover:text-orange-500 transition">
                                <i class="fa-solid fa-plus"></i>
                            </div>
                        </div>
                    </div>
                </div>`; 
            }).join('') : `<div class="text-center py-10 text-slate-400">No items found.</div>`; 
        }

        window.filterMenu = (cat, btn) => { document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); renderMenu(cat === 'all' ? allMenuItems : allMenuItems.filter(i => i.name.toLowerCase().includes(cat.toLowerCase()))); }
        
        // üö® Explain why Add to Order failed (REQUIRED MODIFIERS)
function explainMissingModifiers(groups) {
    showToast(
        `Please select: ${groups.map(g => g.name).join(', ')}`,
        true
    );

    if (!groups || !groups.length) return;

    const firstGroup = groups[0];

    const heading = [...document.querySelectorAll('#modal-modifiers h4')]
        .find(h => h.textContent.includes(firstGroup.name));

    if (heading) {
        heading.scrollIntoView({
            behavior: 'smooth',
            block: 'center'
        });

        flashModifierSection(heading);
    }
}

// üî¥ Visual flash for missing modifier section
function flashModifierSection(heading) {
    const section = heading.parentElement;

    section.classList.add('modifier-error');

    setTimeout(() => {
        section.classList.remove('modifier-error');
    }, 1200);
}

        // --- NEW SHEET LOGIC (CLEAN) ---
        function toggleSheet(id, show) {
            if (sheetTimer) clearTimeout(sheetTimer);
            
            const container = document.getElementById(id);
            // We find the children by ID to be safe, because the HTML structure is strict now
            let backdrop, card;
            
            if (id === 'productModal') {
                backdrop = document.getElementById('productBackdrop');
                card = document.getElementById('productCard');
            } else {
                backdrop = document.getElementById('checkoutBackdrop');
                card = document.getElementById('checkoutCard');
            }

            if (show) {
          
            modalOpen = true;  
                   
    // Prepare card FIRST (off-screen)
    card.style.transition = 'none';
    card.style.transform = 'translateY(100%)';

    // Prevent container from painting
    container.classList.add('modal-shell');

    // Force sync
    void card.offsetHeight;

    // Show container ONLY when ready
    container.classList.remove('hidden');
    container.classList.add('active');

    requestAnimationFrame(() => {
        card.style.transition = 'transform 0.45s cubic-bezier(0.32, 0.72, 0, 1)';
        card.style.transform = 'translateY(0)';
    });
    
} else {
               
    card.style.transition = 'transform 0.35s cubic-bezier(0.32, 0.72, 0, 1)';
    card.style.transform = 'translateY(100%)';

    sheetTimer = setTimeout(() => {
        container.classList.remove('active');
        container.classList.add('hidden');

        card.style.transform = '';
        card.style.transition = '';
        modalOpen = false;
    }, 350);
}
        }

        // --- ACTIONS ---
        window.openCartItemFromMenu = (item) => { editingCartIndex = -1; openProductModal(item); }
        window.editCartItem = (index) => { editingCartIndex = index; currentItem = cart[index]; closeCart(); setTimeout(() => openProductModal(currentItem, true), 350); }
        
        window.openProductModal = (item, isEdit = false) => {
            currentItem = item; modalQty = isEdit ? item.qty : 1;
            document.getElementById('modal-title').innerText = item.name; document.getElementById('modal-price').innerText = 'SR ' + item.price;
            document.getElementById('modal-desc').innerText = item.description||''; document.getElementById('modal-img').src = item.image||'https://via.placeholder.com/150';
            document.getElementById('modal-qty').innerText = modalQty; document.getElementById('addToCartBtn').innerText = isEdit ? "Update Order" : "Add to Order";
            
            const container = document.getElementById('modal-modifiers'); container.innerHTML = "";
            if(item.modifier_group_ids && item.modifier_group_ids.length > 0) {
                const relevantGroups = allModifiers.filter(g => item.modifier_group_ids.includes(g.id));
                relevantGroups.forEach(g => {
                    const options = typeof g.options === 'string' ? JSON.parse(g.options) : g.options;
                    // Add no-drag class to prevent swipe interference
                    const html = `<h4 class="font-bold text-sm mb-2 mt-4 text-slate-800 uppercase tracking-wide border-b border-slate-100 pb-1">${g.name} ${g.required?'<span class="text-red-500">*</span>':''}</h4>` + options.map((opt, i) => {
                        let isChecked = false; if(isEdit && item.selectedMods) { isChecked = item.selectedMods.some(m => m.name === opt.name && m.group === g.name); }
                        return `<label class="no-drag flex justify-between items-center p-3 border border-slate-200 rounded-xl mb-2 bg-slate-50 cursor-pointer hover:border-orange-200 transition"><div class="flex items-center gap-3"><input type="${g.required?'radio':'checkbox'}" name="mod-${g.id}" class="mod-checkbox w-5 h-5 accent-orange-500" data-group="${g.name}" data-name="${opt.name}" data-price="${opt.price||0}" ${isChecked?'checked':''}><span class="font-medium text-sm">${opt.name}</span></div><span class="text-xs font-bold text-slate-500">+SR ${opt.price||0}</span></label>`;
                    }).join('');
                    container.insertAdjacentHTML('beforeend', html);
                });
            }
            toggleSheet('productModal', true);
        }
        
        window.openCart = () => {
    hideFAB();               // üîΩ safely hide basket button
    renderCartItems();       // build checkout list
    toggleSheet('checkoutModal', true); // open checkout sheet
};
        window.closeModal = () => 
{ toggleSheet('productModal', false);         
setTimeout(() => updateCartUI(), 200);
if(editingCartIndex !== -1) setTimeout(openCart, 350); editingCartIndex = -1; }
                // FIXED: Closes modal AND brings back the basket button
        window.closeCart = () => { 
            toggleSheet('checkoutModal', false); 
            
            // Wait 200ms for the window to slide down, then show the button
            setTimeout(() => {
                const fab = document.getElementById('fab-container');
                // Only show if we actually have items in the cart
                if (fab && cart.length > 0) {
                    fab.classList.remove('translate-y-32'); 
                }
            }, 200);
        }
        window.adjustModalQty = (c) => { if(modalQty + c > 0) { modalQty += c; document.getElementById('modal-qty').innerText = modalQty; } }
        
        document.getElementById('addToCartBtn').addEventListener('click', () => {
    const btn = document.getElementById('addToCartBtn');

    let isValid = true;
    let missingGroups = [];

    if (currentItem.modifier_group_ids && currentItem.modifier_group_ids.length > 0) {
        currentItem.modifier_group_ids.forEach(gid => {
            const group = allModifiers.find(m => m.id === gid);
            if (group && group.required) {
                const checked = document.querySelector(`input[name="mod-${gid}"]:checked`);
                if (!checked) {
                    isValid = false;
                    missingGroups.push(group);
                }
            }
        });
    }

    // ‚õî STOP HERE IF INVALID (THIS RETURN IS NOW LEGAL)
    if (!isValid) {
    lockProductSwipe = true;
    explainMissingModifiers(missingGroups);

    // unlock swipe after user interaction
    setTimeout(() => {
        lockProductSwipe = false;
    }, 1200);

    return;
}

    // ‚úÖ ONLY VALID ORDERS CONTINUE
    setBtnLoading(btn, true, 'Adding...');

    setTimeout(() => {
        let unitPrice = parseFloat(currentItem.price);
        let selectedMods = [];

        document.querySelectorAll('.mod-checkbox:checked').forEach(c => {
            let p = parseFloat(c.dataset.price) || 0;
            unitPrice += p;
            selectedMods.push({
                name: c.dataset.name,
                price: p,
                group: c.dataset.group
            });
        });

        const newItem = {
            ...currentItem,
            qty: modalQty,
            unitPrice,
            selectedMods
        };

        if (editingCartIndex > -1) {
            cart[editingCartIndex] = newItem;
        } else {
            const exist = cart.findIndex(
                c => c.id === newItem.id &&
                     JSON.stringify(c.selectedMods) === JSON.stringify(newItem.selectedMods)
            );
            if (exist > -1) cart[exist].qty += newItem.qty;
            else cart.push(newItem);
        }

        updateCartUI();
        toggleSheet('productModal', false);
        setBtnLoading(btn, false);
    }, 300);
});

// üîΩ Hide floating basket button safely
function hideFAB() {
    const fab = document.getElementById('fab-container');
    if (!fab) return; // safety guard
    fab.classList.add('translate-y-32');
}
        function renderCartItems() { document.getElementById('cart-items').innerHTML = cart.map((i,x) => `<div class="flex justify-between items-center border-b pb-3 mb-3"><div class="flex-1" onclick="editCartItem(${x})"><p class="font-bold text-slate-800">${i.name} <i class="fa-solid fa-pencil text-slate-400 text-xs ml-1"></i></p>${i.selectedMods && i.selectedMods.length ? `<p class="text-xs text-slate-500 mt-1">+${i.selectedMods.map(m=>m.name).join(', ')}</p>`:''}<p class="text-xs font-bold text-orange-500 mt-1">SR ${i.unitPrice.toFixed(2)}</p></div><div class="flex items-center gap-3"><div class="flex items-center bg-slate-100 rounded-lg p-1"><button onclick="changeCartQty(${x}, -1)" class="w-8 h-8 flex items-center justify-center font-bold text-slate-500 bg-white rounded shadow-sm hover:bg-slate-50">-</button><span class="text-sm font-bold w-8 text-center">${i.qty}</span><button onclick="changeCartQty(${x}, 1)" class="w-8 h-8 flex items-center justify-center font-bold text-slate-900 bg-white rounded shadow-sm hover:bg-slate-50">+</button></div><button onclick="removeFromCart(${x})" class="text-red-400 w-8 flex justify-end hover:text-red-600"><i class="fa-solid fa-trash"></i></button></div></div>`).join(''); }
        window.changeCartQty = (index, delta) => { cart[index].qty += delta; if(cart[index].qty <= 0) cart.splice(index, 1); if(cart.length === 0) closeCart(); renderCartItems(); updateCartUI(); };
        window.removeFromCart = (i) => { cart.splice(i,1); updateCartUI(); if(cart.length===0) closeCart(); else renderCartItems(); }
        
        function updateCartUI() {
    const subtotal = cart.reduce((s,i) => s + (i.unitPrice * i.qty), 0); 
    const total = Math.max(0, subtotal - activeDiscount); 

    document.getElementById('cart-count').innerText =
        cart.reduce((s,i) => s + i.qty, 0);

    document.getElementById('cart-total').innerText =
        'SR ' + total.toFixed(2);

    if (document.getElementById('checkout-total'))
        document.getElementById('checkout-total').innerText =
            'SR ' + total.toFixed(2);

    // FAB Toggle (FINAL SAFE VERSION)
const fab = document.getElementById('fab-container');

if (fab) {
    if (cart.length > 0) {
        fab.classList.remove('translate-y-32');
    } else {
        fab.classList.add('translate-y-32');
    }
}
}
                // FIXED: Refreshes the tracker list immediately after success
        window.placeOrder = async (btn) => { 
            if(!currentUser) return window.requireAuth(); 
            
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Processing`; 
            btn.disabled = true; 
            
            setTimeout(async () => { 
                const subtotal = cart.reduce((s,i) => s + (i.unitPrice * i.qty), 0); 
                const total = Math.max(0, subtotal - activeDiscount); 
                const payMethod = document.querySelector('input[name="payment"]:checked').value; 
                
                try { 
                    // 1. Send to Database
                    await sb.from('orders').insert({ 
                        user_id: currentUser.id, 
                        items: cart, 
                        subtotal: subtotal, 
                        discount: activeDiscount, 
                        promo_code: activePromoCode, 
                        total: total, 
                        status: 'New Order', 
                        payment_method: payMethod, 
                        note: document.getElementById('order-note').value 
                    }); 
                    
                    // 2. Clear Cart & UI
                    cart = []; 
                    activeDiscount = 0; 
                    activePromoCode = ""; 
                    updateCartUI(); 
                    
                    // 3. Success Animation
                    btn.classList.add('bg-green-force'); 
                    btn.innerHTML = `<i class="fa-solid fa-check mr-2"></i> Success!`; 
                    showToast("Order placed successfully"); 
                    
                    // 4. FORCE REFRESH & SWITCH VIEW
                    setTimeout(async () => { 
                        closeCart(); 
                        await renderTrackerList(currentUser.id); // <--- THIS LINE FIXES IT
                        switchView('track'); 
                        
                        // Reset Button
                        btn.classList.remove('bg-green-force'); 
                        btn.innerText = 'Place Order'; 
                        btn.disabled = false; 
                    }, 1000); 
                    
                } catch(e) { 
                    console.log("Order Error", e); 
                    btn.innerText = "Try Again"; 
                    btn.disabled = false; 
                    showToast("Failed to place order", true);
                } 
            }, 1500); 
        };
        
        async function loadUserProfile(uid) { let { data, error } = await sb.from('users').select('*').eq('id', uid).single(); if(error || !data) { data = { name: currentUser.user_metadata?.name || 'User', email: currentUser.email, phone: currentUser.user_metadata?.phone || '', points: 0, joined: new Date().toLocaleDateString(), avatar: null }; } userData = data; document.getElementById('profile-name').innerText = userData.name || "User"; document.getElementById('profile-email').innerText = userData.email || "No Email"; document.getElementById('profile-phone-input').value = userData.phone || ""; document.getElementById('loyalty-points').innerText = userData.points || 0; document.getElementById('profile-joined').innerText = userData.joined || new Date(currentUser.created_at).toLocaleDateString(); if(userData.avatar) { document.getElementById('profile-avatar').src = userData.avatar; document.getElementById('header-avatar').src = userData.avatar; } else { const def = `https://ui-avatars.com/api/?name=${userData.name}&background=FF5722&color=fff`; document.getElementById('profile-avatar').src = def; document.getElementById('header-avatar').src = def; } const { data: orders, count } = await sb.from('orders').select('*', { count: 'exact' }).eq('user_id', uid).order('created_at', {ascending: false}); document.getElementById('profile-total-orders').innerText = count || 0; if(orders && orders.length) { document.getElementById('order-history').innerHTML = orders.map(o => `<div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group"><div class="flex justify-between items-start mb-3"><div><span class="bg-slate-100 text-slate-600 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wider">#${o.id}</span><span class="text-[10px] text-slate-400 font-bold ml-2">${new Date(o.created_at).toLocaleDateString()}</span></div><span class="font-black text-slate-800">SR ${o.total.toFixed(2)}</span></div><div class="flex justify-between items-center border-t border-slate-50 pt-3"><span class="text-xs font-bold text-orange-500">${o.status}</span><button onclick="triggerReorder(${o.id})" class="bg-orange-50 text-orange-600 text-xs font-bold px-4 py-2 rounded-lg hover:bg-orange-100 transition"><i class="fa-solid fa-rotate-right mr-1"></i> Reorder</button></div></div>`).join(''); } else { document.getElementById('order-history').innerHTML = `<div class="text-center py-8 text-slate-400 text-sm">No past orders found.</div>`; } }
        async function togglePhoneEdit(btn) { const input = document.getElementById('profile-phone-input'); const container = document.getElementById('phone-container'); const isReadOnly = input.hasAttribute('readonly'); if (isReadOnly) { input.removeAttribute('readonly'); input.focus(); btn.innerText = "Save"; btn.classList.add('bg-green-force'); container.classList.remove('bg-slate-50', 'border-slate-100'); container.classList.add('bg-white', 'border-orange-500', 'ring-2', 'ring-orange-100'); } else { setBtnLoading(btn, true, 'Saving'); const ph = input.value; try { await sb.auth.updateUser({ data: { phone: ph } }); await sb.from('users').update({ phone: ph }).eq('id', currentUser.id); showToast("Phone Saved!"); input.setAttribute('readonly', true); btn.innerHTML = "Update"; btn.classList.remove('bg-green-force'); container.classList.add('bg-slate-50', 'border-slate-100'); container.classList.remove('bg-white', 'border-orange-500', 'ring-2', 'ring-orange-100'); } catch(e) { showToast("Error updating phone"); } btn.disabled = false; } }
        window.removeAvatar = async () => { if(!currentUser) return; await sb.from('users').update({ avatar: null }).eq('id', currentUser.id); const meta = currentUser.user_metadata || {}; const def = `https://ui-avatars.com/api/?name=${meta.name||'User'}&background=FF5722&color=fff`; document.getElementById('profile-avatar').src = def; document.getElementById('header-avatar').src = def; showToast("Avatar Removed"); }
                // --- MISSING CROPPER LOGIC ---
        let cropper = null; 
        
        window.startCrop = (input) => { 
            if (input.files && input.files[0]) { 
                const reader = new FileReader(); 
                reader.onload = (e) => { 
                    const img = document.getElementById('crop-target'); 
                    img.src = e.target.result; 
                    document.getElementById('crop-modal').classList.add('active'); 
                    if(cropper) cropper.destroy(); 
                    cropper = new Cropper(img, { aspectRatio: 1, viewMode: 1 }); 
                    input.value = ''; 
                }; 
                reader.readAsDataURL(input.files[0]); 
            } 
        }; 
        
        window.closeCropper = () => { 
            document.getElementById('crop-modal').classList.remove('active'); 
            if(cropper) { cropper.destroy(); cropper = null; } 
        }; 
        
                        // FIXED: Saves as PNG to preserve transparency
        window.finishCrop = () => { 
            if(!cropper) return; 
            
            const btn = document.querySelector('#crop-modal button');
            setBtnLoading(btn, true, 'Saving');
            
            // 1. Get Canvas (PNG format)
            cropper.getCroppedCanvas({ 
                maxWidth: 300, 
                maxHeight: 300, 
                fillColor: 'transparent' // Ensure background stays transparent
            }).toBlob(async (blob) => { 
                const fileName = `${currentUser.id}-${Date.now()}.png`; // <--- Changed .jpg to .png
                
                // 2. Upload to Storage
                const { error: uploadErr } = await sb.storage.from('images').upload(fileName, blob); 
                
                if(uploadErr) {
                    console.error('Upload Failed:', uploadErr);
                    showToast("Image upload failed", true);
                    setBtnLoading(btn, false, 'Save Picture');
                    return;
                }

                // 3. Get Public URL
                const { data } = sb.storage.from('images').getPublicUrl(fileName); 
                const publicUrl = data.publicUrl;

                // 4. Save to Database
                const { error: dbErr } = await sb.from('users')
                    .update({ avatar: publicUrl })
                    .eq('id', currentUser.id);

                if (dbErr) {
                    console.error('Database Update Failed:', dbErr);
                    showToast("Could not save to profile", true);
                } else {
                    document.getElementById('profile-avatar').src = publicUrl; 
                    document.getElementById('header-avatar').src = publicUrl; 
                    showToast("Profile Picture Saved!"); 
                }
                
                setBtnLoading(btn, false, 'Save Picture');
                closeCropper(); 
            }, 'image/png'); // <--- CRITICAL CHANGE: 'image/png'
        };

        window.triggerReorder = async (oid) => { const { data } = await sb.from('orders').select('*').eq('id', oid).single(); if(data && data.items) { cart = data.items; updateCartUI(); openCart(); } }
        window.switchView = (v) => { if((v=='track'||v=='profile') && !currentUser) return window.requireAuth(); document.querySelectorAll('[id^="view-"]').forEach(e=>e.classList.add('hidden')); document.getElementById('view-'+v).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); if(v=='home') document.querySelectorAll('.nav-item')[0].classList.add('active'); if(v=='track') document.querySelectorAll('.nav-item')[1].classList.add('active'); if(v=='profile') document.querySelectorAll('.nav-item')[2].classList.add('active'); }
        window.applyPromo = async (btn) => { if (!currentUser) return window.requireAuth(); setBtnLoading(btn, true); const code = document.getElementById('promo-input').value.trim().toUpperCase(); if (!code) { setBtnLoading(btn, false); return; } const { data } = await sb.from('promocodes').select('*').eq('code', code); if (data && data.length) { const promo = data[0]; const { count } = await sb.from('orders').select('*', { count: 'exact', head: true }).eq('user_id', currentUser.id).eq('promo_code', code); if (count > 0) { document.getElementById('promo-msg').innerText = "Already used"; document.getElementById('promo-msg').className = "text-xs mt-1 font-bold text-red-500"; } else { const subtotal = cart.reduce((s,i) => s + (i.unitPrice * i.qty), 0); activeDiscount = promo.type === 'percent' ? subtotal * (promo.value / 100) : promo.value; activePromoCode = code; document.getElementById('promo-input').disabled = true; document.getElementById('btn-apply-promo').classList.add('hidden'); document.getElementById('btn-remove-promo').classList.remove('hidden'); document.getElementById('promo-msg').innerText = "Code applied!"; document.getElementById('promo-msg').className = "text-xs mt-1 font-bold text-green-600"; updateCartUI(); } } else { document.getElementById('promo-msg').innerText = "Invalid Code"; document.getElementById('promo-msg').className = "text-xs mt-1 font-bold text-red-500"; activeDiscount = 0; } setBtnLoading(btn, false); };
        window.removePromo = () => { activeDiscount = 0; activePromoCode = ""; const input = document.getElementById('promo-input'); input.value = ""; input.disabled = false; document.getElementById('btn-apply-promo').classList.remove('hidden'); document.getElementById('btn-remove-promo').classList.add('hidden'); document.getElementById('promo-msg').innerText = ""; updateCartUI(); };
        
        async function fetchQueueCount() { const { count } = await sb.from('orders').select('*', { count: 'exact', head: true }).or('status.eq.Preparing,status.eq.Cooking'); return count || 0; }
        function listenToOrders(uid) { sb.channel('public:orders').on('postgres_changes', { event: '*', schema: 'public', table: 'orders', filter: `user_id=eq.${uid}` }, (payload) => { if(payload.new && payload.new.status!=='Completed') renderTrackerList(uid); }).subscribe(); renderTrackerList(uid); }
        async function renderTrackerList(uid) { const {data} = await sb.from('orders').select('*').eq('user_id', uid).neq('status', 'Completed').order('created_at', {ascending: false}); const container = document.getElementById('active-tracker-container'); const queue = await fetchQueueCount(); if(!data || !data.length) { document.getElementById('track-badge').classList.add('hidden'); container.innerHTML='<div class="text-center py-20 text-slate-400"><i class="fa-solid fa-receipt text-4xl mb-4"></i><p>No active orders.</p></div>'; return; } document.getElementById('track-badge').classList.remove('hidden'); container.innerHTML = data.map(order => createTrackerCard(order, queue)).join(''); startTicker(); }
        function startTicker() { if(window.trackerInterval) clearInterval(window.trackerInterval); window.trackerInterval = setInterval(() => { document.querySelectorAll('.dynamic-timer').forEach(el => { if(el.dataset.status === 'New Order') { el.innerText = "Waiting for acceptance..."; return; } if(el.dataset.status === 'Ready') { el.innerText = "Ready for pickup!"; return; } const target = parseInt(el.dataset.target); const now = Date.now(); const diff = target - now; if(diff <= 0) { el.innerText = "Finishing up..."; } else { const m = Math.floor(diff / 60000); const s = Math.floor((diff % 60000) / 1000); el.innerText = `Est: ${m}m ${s}s`; } }); }, 1000); }
        function createTrackerCard(order, queueCount) { let step = 1; let txt = "We've received your order, waiting for the chef!"; const estimatedMins = order.estimated_mins || (10 + (queueCount * 3)); const createdAt = new Date(order.created_at).getTime(); const targetTime = createdAt + (estimatedMins * 60000); if(order.status === 'Preparing' || order.status === 'Cooking') { step = 2; txt = "Your food is sizzling on the grill!"; } if(order.status === 'Ready') { step = 3; txt = "It's ready! Come pick it up."; } let itemsHtml = order.items.map(i => { let mods = ''; if (i.selectedMods && i.selectedMods.length > 0) { mods = i.selectedMods.map(m => `<div class="text-xs text-slate-400 pl-4 py-0.5">‚Ä¢ ${m.name}</div>`).join(''); } return `<div class="mb-3 border-b border-slate-50 last:border-0 pb-2 last:pb-0"><div class="font-bold text-slate-700 text-sm flex justify-between"><span>${i.qty}x ${i.name}</span></div>${mods}</div>`; }).join(''); const payMethod = order.payment_method || 'Cash'; const promoBadge = order.promo_code ? `<span class="bg-purple-100 text-purple-600 px-1.5 py-0.5 rounded text-[10px] font-bold ml-1">PROMO: ${order.promo_code}</span>` : ''; const promoStrikethrough = order.promo_code ? `<span class="line-through text-slate-400 mr-2 text-[10px]">SR ${order.subtotal.toFixed(2)}</span>` : ''; return `<div class="bg-white rounded-3xl p-6 shadow-xl border border-slate-100 animate-[slideUp_0.4s] mb-4"><div class="flex justify-between items-center mb-6"><div><h3 class="text-xl font-bold">Order #${order.id}</h3><span class="dynamic-timer text-xs text-slate-400 font-bold" data-target="${targetTime}" data-status="${order.status}">Calculating...</span></div><span class="bg-slate-900 text-white text-xs px-2 py-1 rounded font-bold">${order.status}</span></div><div class="step-container flex justify-between items-center relative mb-6"><div class="step-line-container"><div class="step-line-fill" style="width: ${step === 1 ? '0%' : step === 2 ? '50%' : '100%'}"></div></div><div class="step-circle ${step >= 1 ? 'active' : ''}">1</div><div class="step-circle ${step >= 2 ? 'active' : ''}">2</div><div class="step-circle ${step >= 3 ? 'active' : ''}">3</div></div><div class="bg-orange-50 text-orange-600 rounded-xl p-4 text-center mb-6 text-sm font-bold shadow-sm"><i class="fa-solid fa-bell mr-2 animate-bounce"></i> ${txt}</div><div class="bg-slate-50 p-4 rounded-xl font-medium text-left">${itemsHtml}</div><div class="mt-3 pt-3 border-t border-slate-200 flex flex-col gap-2"><div class="flex justify-between items-center"><span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Total</span><div class="flex items-baseline">${promoStrikethrough}<span class="text-xs font-bold text-slate-800 mr-0.5">SR</span><span class="text-2xl font-black text-slate-900">${order.total.toFixed(2)}</span></div></div><div class="flex justify-between items-center"><span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Paid Via</span><div class="flex items-center"><span class="bg-orange-100 text-orange-600 px-2 py-0.5 rounded text-[10px] font-bold uppercase"><i class="fa-solid fa-credit-card mr-1"></i> ${payMethod}</span>${promoBadge}</div></div></div></div>`; }

        // --- SMART SWIPE (Scroll Awareness) ---
        const setupSwipe = (cardId, closeFn) => {
            const card = document.getElementById(cardId);
            const content = card.querySelector('.overflow-y-auto'); // Find scrolling area
            let startY = 0, currentY = 0, isDragging = false;
            const threshold = window.innerHeight * 0.25; 

            // TOUCH START
            card.addEventListener('touchstart', e => {
                // If touching an input or non-draggable area, ignore
                if (
    lockProductSwipe ||
    e.target.closest('input, textarea, button, .no-drag')
) return;
                
                // If scrolling content is NOT at top, allow native scroll (ignore swipe)
                if(content && content.scrollTop > 0) return;

                startY = e.touches[0].clientY;
                currentY = startY;
                isDragging = true;
                
                // Important: Do NOT disable transition yet. Only do it if we confirm it's a drag.
            }, {passive: true});

            // TOUCH MOVE
            card.addEventListener('touchmove', e => {
                if(!isDragging) return;
                currentY = e.touches[0].clientY;
                const diff = currentY - startY;

                // Case 1: Swiping UP (diff < 0) -> Allow native scroll (Modifiers)
                if (diff < 0) {
                    isDragging = false; // Stop tracking as swipe
                    return;
                }

                // Case 2: Swiping DOWN (diff > 0) -> Move Window
                if (diff > 0) {
                    e.preventDefault(); // Block native scroll
                    card.style.transition = 'none'; // Disable animation for instant follow
                    card.style.transform = `translateY(${diff}px)`; 
                }
            }, {passive: false});

            // TOUCH END
            card.addEventListener('touchend', e => {
                if(!isDragging) return;
                isDragging = false;
                
                // Re-enable smooth animation
                card.style.transition = 'transform 0.5s cubic-bezier(0.32, 0.72, 0, 1)'; 
                
                const diff = currentY - startY;
                if(diff > threshold) { 
                    closeFn(); 
                } else {
                    // Snap back
                    card.style.transform = '';
                    setTimeout(() => { card.style.transition = ''; }, 500);
                }
            });
        };
        
        setupSwipe('productCard', closeModal);

        loadData();
    </script>    
</body>
</html>
